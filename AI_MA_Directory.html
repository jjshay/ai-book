<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI M&A Directory</title>
    <style>
        :root {
            --bg: #0d1a2d;
            --card: #152238;
            --border: #2a3f5f;
            --text: #fff;
            --dim: #8899aa;
            --accent: #00bcd4;
            --gold: #d4a84b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(13,26,45,0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--gold);
        }

        .header-logo { width: 28px; height: 28px; }

        .main-header h1 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--gold);
            text-transform: uppercase;
        }

        /* Search */
        .sticky-search {
            position: sticky;
            top: 53px;
            z-index: 90;
            background: rgba(10,10,11,0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 20px;
            max-width: 640px;
            margin: 60px auto 0;
        }

        .search-container {
            padding: 12px 20px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            color: var(--text);
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0,188,212,0.1);
        }

        .search-input::placeholder { color: var(--dim); }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px 0 6px;
            margin-top: 10px;
            font-size: 11px;
            color: var(--dim);
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .stat-value {
            font-weight: 600;
            color: #fff;
        }
        .stat-label {
            color: var(--dim);
        }

        /* Stat Tooltips */
        .stat-tooltip {
            position: relative;
            cursor: help;
        }

        .stat-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--gold);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            width: 220px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .stat-tooltip::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gold);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 101;
        }

        .stat-tooltip:hover::after,
        .stat-tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Filter Header */
        .filter-header {
            background: linear-gradient(135deg, rgba(212,168,75,0.15) 0%, rgba(212,168,75,0.05) 100%);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 20px 16px;
            max-width: 1360px;
            margin-left: auto;
            margin-right: auto;
        }

        .filter-header-title {
            color: var(--gold);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .filter-header-desc {
            color: var(--dim);
            font-size: 13px;
            line-height: 1.5;
        }

        .results-count {
            text-align: center;
            padding: 8px 0 0;
            color: var(--dim);
            font-size: 11px;
        }

        /* Filters */
        .filter-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .secondary-filters {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .funding-toggle {
            display: flex;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--card);
        }

        .fund-btn {
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: var(--dim);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .fund-btn:not(:last-child) {
            border-right: 1px solid var(--border);
        }

        .fund-btn:hover {
            background: rgba(0,188,212,0.1);
            color: var(--accent);
        }

        .fund-btn.active {
            background: var(--gold);
            color: #0d1a2d;
        }

        /* More Filters Button */
        .more-filters-btn {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--dim);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .more-filters-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .more-filters-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .secondary-filters {
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-buttons, .view-saved-btn, .export-btn { display: none; }

        /* Cards */
        #mainContent {
            padding: 0 16px 100px;
        }

        .category-section { margin-bottom: 0; }
        .category-header { display: none; }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        @media (min-width: 768px) {
            .cards-container { grid-template-columns: repeat(3, 1fr); }
            #mainContent { padding: 0 24px 100px; }
        }

        @media (min-width: 1024px) {
            .cards-container { grid-template-columns: repeat(4, 1fr); gap: 8px; }
        }

        @media (min-width: 1400px) {
            .cards-container { grid-template-columns: repeat(5, 1fr); }
        }

        @media (min-width: 1800px) {
            .cards-container { grid-template-columns: repeat(6, 1fr); }
        }

        /* Card */
        .company-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: background 0.12s, border-color 0.12s, box-shadow 0.12s;
        }

        .company-card:hover {
            background: #1a2b4a;
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(0,188,212,0.15);
        }

        .company-card.favorited { border-color: var(--gold); box-shadow: 0 0 8px rgba(212,168,75,0.2); }
        .company-card.ignored { display: none; }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .company-logo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            padding: 2px;
        }
        .company-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--gold);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .company-card:hover .card-name { color: var(--accent); }

        .card-rank, .card-rating, .card-badges, .badge, .secret-sauce { display: none; }

        /* Funding Trend Indicator */
        .funding-trend {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.5);
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            z-index: 10;
        }
        .funding-trend:hover {
            transform: scale(1.05);
            background: rgba(0,0,0,0.7);
        }
        .funding-trend.trend-up { color: #4ade80; }
        .funding-trend.trend-down { color: #f87171; }
        .funding-trend.trend-neutral { color: #888; }
        .funding-trend svg { width: 10px; height: 10px; }
        .company-card { position: relative; }

        /* Hover Preview */
        .hover-preview {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: #1a1a1f;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            width: 280px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .company-card:hover .hover-preview {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }
        .preview-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .preview-row:last-child { border-bottom: none; }
        .preview-label { color: var(--dim); }
        .preview-value { color: #fff; font-weight: 500; }
        .preview-desc {
            font-size: 11px;
            color: #888;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        @media (max-width: 768px) {
            .hover-preview { display: none; }
        }

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-details > div {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .detail-label { display: none; }
        .detail-value { color: #fff; }
        .card-funding { font-weight: 700; color: #fff; }

        .funding-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .last-round {
            font-size: 10px;
            color: var(--dim);
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .card-footer {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .card-location { color: var(--accent); }

        .ceo-link {
            color: #ccc;
            text-decoration: none;
        }
        .ceo-link:hover { color: var(--accent); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 560px;
            margin-top: 60px;
            overflow: hidden;
            cursor: grab;
            user-select: none;
        }
        .modal-content:active { cursor: grabbing; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .title-badges {
            display: flex;
            gap: 6px;
        }
        .title-badges .modal-badge {
            font-size: 10px;
            padding: 4px 8px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section:last-child { margin-bottom: 0; }

        .modal-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--dim);
            margin-bottom: 8px;
        }

        .similar-companies {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .similar-card {
            flex-shrink: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
            min-width: 140px;
        }
        .similar-card:hover {
            border-color: var(--accent);
            background: #1a2b4a;
        }
        .similar-name {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .similar-meta {
            font-size: 10px;
            color: var(--dim);
        }

        .modal-section p {
            font-size: 14px;
            line-height: 1.6;
            color: #fff;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .modal-stat {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }

        .modal-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 4px;
        }

        .modal-stat-value {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
        }

        .modal-list {
            list-style: none;
            font-size: 13px;
            color: #888;
        }

        .modal-list li {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .modal-list li:last-child { border-bottom: none; }

        /* Accordion Styles */
        details.accordion summary::-webkit-details-marker { display: none; }
        details.accordion summary { list-style: none; }
        details.accordion[open] .accordion-icon { transform: rotate(180deg); }
        details.accordion:not([open]) .accordion-content { display: none; }
        details.accordion summary:hover { opacity: 0.9; }

        /* M&A Intelligence Section */
        .ma-insights {
            background: rgba(0,188,212,0.08);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .ma-title {
            color: var(--accent);
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .ma-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ma-item:last-child { border-bottom: none; }
        .ma-icon {
            color: var(--accent);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Success Factors Section */
        .success-factors {
            background: rgba(74,222,128,0.08);
            border: 1px solid #4ade80;
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
        }
        .success-title {
            color: #4ade80;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .success-factors .ma-item { border-bottom: none; padding: 6px 0; }
        .success-factors .ma-icon { color: #4ade80; }

        /* Modal Badges */
        .modal-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .modal-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-unicorn {
            background: linear-gradient(135deg, #d4a84b 0%, #f0d78c 100%);
            color: #1a1a1a;
        }
        .badge-ma-target {
            background: linear-gradient(135deg, #00bcd4 0%, #4dd0e1 100%);
            color: #1a1a1a;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .modal-btn:hover { opacity: 0.85; }

        .btn-favorite {
            background: var(--gold);
            color: #0d1a2d;
        }

        .btn-ignore {
            background: var(--border);
            color: var(--dim);
        }

        /* External Links */
        .external-links {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .ext-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }

        .ext-link:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .ext-link svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        /* FABs */
        .fab-container {
            position: fixed;
            bottom: 24px;
            left: 24px;
            display: flex;
            gap: 12px;
            z-index: 150;
        }

        .fab {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .fab:hover { transform: scale(1.08); }

        .fab-favorites {
            background: var(--gold);
            color: #0d1a2d;
        }

        .fab-favorites:hover {
            box-shadow: 0 4px 16px rgba(212,168,75,0.4);
        }

        .fab-export {
            background: var(--accent);
            color: #fff;
        }

        .fab-export:hover {
            box-shadow: 0 4px 16px rgba(0,188,212,0.4);
        }

        .fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: #fff;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 500;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .undo-toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .undo-toast-text {
            color: #fff;
            font-size: 14px;
        }

        .undo-toast-btn {
            background: var(--gold);
            color: #0d1a2d;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .undo-toast-btn:hover {
            background: #e6b84d;
            transform: scale(1.05);
        }

        .undo-toast-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 18px;
            cursor: pointer;
            padding: 0 4px;
        }

        /* Funding Modal */
        .funding-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .funding-modal.active { display: flex; }

        .funding-modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            max-width: 440px;
            width: 100%;
        }

        .funding-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .funding-modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .funding-modal-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 20px;
            cursor: pointer;
        }

        .funding-chart {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .funding-chart svg { width: 100%; height: 100px; }

        .funding-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .funding-stat {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .funding-stat-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .funding-stat-value {
            font-size: 13px;
            font-weight: 500;
        }

        /* Analysis Modal - simplified */
        .analysis-modal { display: none; }

        /* Back to top */
        .back-to-top {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: var(--gold);
            color: #0d1a2d;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.15s, opacity 0.15s;
        }

        .back-to-top.visible {
            display: flex;
        }

        .back-to-top:hover {
            transform: scale(1.1);
        }

        /* Alpha Navigation */
        .alphabet-nav {
            position: fixed;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 90;
        }

        .alpha-letter {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            padding: 2px 6px;
            text-align: center;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
        }

        .alpha-letter:hover {
            color: var(--gold);
            transform: scale(1.8);
            text-shadow: 0 0 10px rgba(212,168,75,0.5);
        }

        .alpha-letter.no-companies {
            display: none;
        }

        .alphabet-nav.filtered .alpha-letter { color: var(--accent-cyan); }
        .alphabet-nav.filtered .alpha-sort { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .alpha-letter.active {
            color: var(--gold);
        }

        .alpha-sort {
            font-size: 12px;
            color: var(--dim);
            cursor: pointer;
            padding: 4px 6px;
            margin-bottom: 4px;
            transition: all 0.15s;
            border-bottom: 1px solid var(--border);
        }
        .alpha-sort:hover {
            color: var(--gold);
            transform: scale(1.3);
        }
        .alpha-sort.desc {
            transform: rotate(180deg);
        }
        .alpha-sort.desc:hover {
            transform: rotate(180deg) scale(1.3);
        }

        .alpha-current {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: 700;
            color: var(--gold);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            text-shadow: 0 4px 20px rgba(212,168,75,0.3);
        }

        .alpha-current.visible { opacity: 0.3; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--dim);
        }

        /* Email Capture Modal */
        .email-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 400;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .email-modal.active { display: flex; }
        .email-modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 50px 60px;
            max-width: 520px;
            width: 100%;
            text-align: center;
        }
        .email-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.4;
            padding: 0 20px;
        }
        .email-modal-subtitle {
            font-size: 13px;
            color: var(--dim);
            margin-bottom: 24px;
        }
        .watchlist-preview {
            background: var(--bg);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .watchlist-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .watchlist-item:last-child { border-bottom: none; }
        .watchlist-name { color: #fff; font-weight: 500; }
        .watchlist-funding { color: var(--dim); }
        .email-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: #fff;
            font-size: 15px;
            margin-bottom: 12px;
        }
        .email-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .email-submit {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .email-submit:hover { opacity: 0.9; }
        .email-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .email-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: var(--dim);
            font-size: 24px;
            cursor: pointer;
        }
        .email-success {
            color: #4ade80;
            font-size: 14px;
            margin-top: 12px;
        }
        .email-privacy {
            font-size: 11px;
            color: var(--dim);
            margin-top: 16px;
        }

        /* Timeline View */
        .timeline-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--dim);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .timeline-btn:hover, .timeline-btn.active {
            border-color: var(--accent);
            color: var(--accent);
        }
        .timeline-container {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1400px;
        }
        .timeline-container.active { display: block; }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        .timeline-years {
            display: flex;
            gap: 2px;
            overflow-x: auto;
        }
        .timeline-year {
            text-align: center;
            min-width: 100px;
        }
        .timeline-year-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--dim);
            margin-bottom: 8px;
        }
        .timeline-bar {
            height: 60px;
            background: linear-gradient(to top, var(--accent), transparent);
            border-radius: 4px 4px 0 0;
            position: relative;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .timeline-bar:hover { opacity: 0.8; }
        .timeline-amount {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--dim);
            white-space: nowrap;
        }
        .timeline-legend {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            font-size: 11px;
            color: var(--dim);
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .sticky-search { padding: 10px 16px; margin-top: 50px; top: 48px; }
            .search-container { padding: 8px 16px 16px; }
            .search-input { padding: 12px 14px; font-size: 16px; }
            #mainContent { padding: 0 12px 100px; }
            .cards-container { gap: 6px; }
            .company-card { padding: 14px; }
            .modal-content { margin-top: 20px; }
            .fab-container { bottom: 16px; left: 16px; gap: 10px; }
            .back-to-top { bottom: 16px; right: 16px; width: 44px; height: 44px; font-size: 20px; }
            .fab { width: 44px; height: 44px; font-size: 16px; }
        }

        /* ==================== INSIGHTS SECTIONS ==================== */

        /* Section Navigation Tabs */
        .section-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .section-tab {
            padding: 10px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .section-tab.active {
            background: var(--gold);
            border-color: var(--gold);
            color: #0d1a2d;
        }
        .section-tab-icon { font-size: 14px; }

        /* Insights Panel */
        .insights-panel {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin: 0 20px 20px;
            max-width: 1360px;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
        }
        .insights-panel.active { display: block; }
        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(212,168,75,0.05);
        }
        .insights-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }
        .insights-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 20px;
            cursor: pointer;
        }
        .insights-body { padding: 20px; }

        /* Deal Flow / Funding Timeline */
        .deal-flow-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .deal-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .deal-item:hover {
            background: #1a2b4a;
            border-left: 3px solid var(--gold);
        }
        .deal-date {
            font-size: 11px;
            color: var(--dim);
            min-width: 80px;
        }
        .deal-company {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .deal-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #fff;
            padding: 2px;
        }
        .deal-logo img { width: 100%; height: 100%; object-fit: contain; }
        .deal-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        .deal-round {
            font-size: 11px;
            color: var(--accent);
            margin-top: 2px;
        }
        .deal-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
            min-width: 100px;
            text-align: right;
        }
        .deal-category {
            font-size: 11px;
            color: var(--dim);
            background: rgba(255,255,255,0.05);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Investor Leaderboard */
        .investor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .investor-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .investor-card:hover {
            border-color: var(--gold);
            background: #1a2b4a;
        }
        .investor-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .investor-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #fff;
            padding: 4px;
        }
        .investor-logo img { width: 100%; height: 100%; object-fit: contain; }
        .investor-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        .investor-info span {
            font-size: 11px;
            color: var(--dim);
        }
        .investor-rank {
            margin-left: auto;
            font-size: 18px;
            font-weight: 700;
            color: var(--gold);
        }
        .investor-stats {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .investor-stat {
            text-align: center;
            flex: 1;
        }
        .investor-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }
        .investor-stat-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
        }
        .investor-portfolio-preview {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }
        .investor-portfolio-preview img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #fff;
        }

        /* Competitive Landscapes */
        .landscape-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .landscape-cluster {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .landscape-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 4px;
        }
        .landscape-subtitle {
            font-size: 11px;
            color: var(--dim);
            margin-bottom: 12px;
        }
        .landscape-companies {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .landscape-company {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .landscape-company:hover { background: rgba(0,188,212,0.1); }
        .landscape-company-logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #fff;
            padding: 2px;
        }
        .landscape-company-logo img { width: 100%; height: 100%; object-fit: contain; }
        .landscape-company-info {
            flex: 1;
        }
        .landscape-company-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }
        .landscape-company-product {
            font-size: 11px;
            color: var(--dim);
        }
        .landscape-company-funding {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
        }

        /* Acquisition Tracker */
        .acquisition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .acquisition-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.15s;
        }
        .acquisition-card:hover {
            border-color: var(--accent);
        }
        .acquisition-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: rgba(0,188,212,0.08);
        }
        .acquisition-target-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #fff;
            padding: 4px;
        }
        .acquisition-target-logo img { width: 100%; height: 100%; object-fit: contain; }
        .acquisition-target-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        .acquisition-target-info span {
            font-size: 11px;
            color: var(--accent);
        }
        .acquisition-body { padding: 14px; }
        .acquisition-acquirers {
            margin-bottom: 12px;
        }
        .acquisition-acquirers-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .acquisition-acquirers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .acquisition-acquirer-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 12px;
            color: #fff;
        }
        .acquisition-acquirer-chip img {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            background: #fff;
        }
        .acquisition-rationale {
            font-size: 12px;
            color: var(--dim);
            line-height: 1.5;
        }
        .acquisition-value {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .acquisition-value-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
        }
        .acquisition-value-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }

        /* Geographic Heatmap */
        .geo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        .geo-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .geo-card:hover {
            border-color: var(--accent);
            background: #1a2b4a;
        }
        .geo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .geo-location {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }
        .geo-flag {
            font-size: 24px;
        }
        .geo-stats {
            display: flex;
            gap: 16px;
        }
        .geo-stat {
            flex: 1;
        }
        .geo-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }
        .geo-stat-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
        }
        .geo-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }
        .geo-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--gold));
            border-radius: 3px;
            transition: width 0.5s ease-out;
        }
        .geo-top-companies {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }
        .geo-top-companies img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #fff;
        }

        /* Funding Velocity Badge (on cards) */
        .velocity-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .velocity-hot {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: #fff;
        }
        .velocity-strong {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #0d1a2d;
        }
        .velocity-recent {
            background: linear-gradient(135deg, #00bcd4, #0891b2);
            color: #fff;
        }

        /* Founder/Team Badges */
        .team-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        .team-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            background: rgba(212,168,75,0.15);
            color: var(--gold);
        }
        .team-badge-icon { font-size: 10px; }
        .team-badge.ex-google { background: rgba(66,133,244,0.15); color: #4285f4; }
        .team-badge.ex-openai { background: rgba(16,163,127,0.15); color: #10a37f; }
        .team-badge.ex-meta { background: rgba(24,119,242,0.15); color: #1877f2; }
        .team-badge.ex-amazon { background: rgba(255,153,0,0.15); color: #ff9900; }
        .team-badge.ex-deepmind { background: rgba(66,133,244,0.15); color: #4285f4; }
        .team-badge.stanford { background: rgba(140,21,21,0.15); color: #8c1515; }
        .team-badge.mit { background: rgba(163,31,52,0.15); color: #a31f34; }
        .team-badge.repeat-founder { background: rgba(212,168,75,0.2); color: var(--gold); }

        /* Job Hunting Badges */
        .job-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .job-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
        }
        .job-badge.equity-high { background: rgba(34,197,94,0.2); color: #22c55e; }
        .job-badge.equity-med { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .job-badge.stability-high { background: rgba(147,51,234,0.2); color: #9333ea; }
        .job-badge.exit-soon { background: rgba(249,115,22,0.2); color: #f97316; }
        .job-badge.comp-top { background: rgba(212,168,75,0.3); color: var(--gold); }
        .job-badge.fit-perfect { background: rgba(236,72,153,0.2); color: #ec4899; }
        .job-badge.fit-strong { background: rgba(20,184,166,0.2); color: #14b8a6; }
        .job-badge.hiring-hot { background: rgba(239,68,68,0.2); color: #ef4444; }
        .job-badge.hiring-active { background: rgba(34,197,94,0.2); color: #22c55e; }

        /* M&A Signal Badges */
        .ma-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .ma-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
        }
        .ma-badge.ma-high { background: rgba(239,68,68,0.25); color: #ef4444; }
        .ma-badge.ma-med { background: rgba(249,115,22,0.2); color: #f97316; }
        .ma-badge.ma-low { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .ma-badge.stale-raise { background: rgba(168,85,247,0.2); color: #a855f7; }
        .ma-badge.ceo-change { background: rgba(236,72,153,0.25); color: #ec4899; }
        .ma-badge.ma-history { background: rgba(234,179,8,0.2); color: #eab308; }
        .ma-badge.ipo-track { background: rgba(34,197,94,0.2); color: #22c55e; }
        .ma-badge.deal-blocked { background: rgba(239,68,68,0.2); color: #ef4444; }

        .ma-score-indicator {
            position: absolute;
            top: 30px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            z-index: 5;
        }
        .ma-score-indicator.high { background: rgba(239,68,68,0.2); color: #ef4444; border: 2px solid #ef4444; }
        .ma-score-indicator.med { background: rgba(249,115,22,0.15); color: #f97316; border: 2px solid #f97316; }
        .ma-score-indicator.low { background: rgba(59,130,246,0.1); color: #3b82f6; border: 2px solid #3b82f6; }

        /* Job Hunter Mode Styles */
        .job-hunter-mode .company-card { border-left: 3px solid transparent; }
        .job-hunter-mode .company-card[data-equity="high"] { border-left-color: #22c55e; }
        .job-hunter-mode .company-card[data-stability="high"] { border-left-color: #9333ea; }
        .job-hunter-mode .company-card[data-prime="true"] { border-left-color: var(--gold); }

        .job-signal-bar {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        .job-signal {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .job-signal-label { font-size: 8px; color: var(--dim); text-transform: uppercase; }
        .job-signal-value { font-size: 14px; font-weight: 700; }
        .job-signal-value.high { color: #22c55e; }
        .job-signal-value.med { color: #f59e0b; }
        .job-signal-value.low { color: #ef4444; }

        /* Hiring Trend Badge - positioned below funding trend */
        .hiring-trend {
            position: absolute;
            top: 56px;
            right: 8px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 4px;
            z-index: 5;
            white-space: nowrap;
        }
        .hiring-trend.hot { background: rgba(239,68,68,0.2); color: #ef4444; }
        .hiring-trend.growing { background: rgba(34,197,94,0.2); color: #22c55e; }
        .hiring-trend.stable { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .hiring-trend.slow { background: rgba(107,114,128,0.2); color: #6b7280; }

        #jobHunterBtn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        #jobHunterBtn:hover { border-color: var(--accent); }
        #jobHunterBtn.active { background: var(--accent); border-color: var(--accent); }

        /* Market Sizing */
        .market-sizing {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .market-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .market-card:hover {
            border-color: var(--gold);
        }
        .market-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .market-category {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }
        .market-icon { font-size: 20px; }
        .market-tam {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 4px;
        }
        .market-tam-label {
            font-size: 10px;
            color: var(--dim);
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .market-stats {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .market-stat {
            flex: 1;
            text-align: center;
        }
        .market-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }
        .market-stat-label {
            font-size: 10px;
            color: var(--dim);
        }

        /* Section tabs mobile */
        @media (max-width: 640px) {
            .section-tabs { padding: 12px 16px; gap: 6px; }
            .section-tab { padding: 8px 12px; font-size: 11px; }
            .insights-panel { margin: 0 12px 16px; }
            .insights-body { padding: 12px; }
            .investor-grid, .landscape-grid, .acquisition-grid, .geo-grid, .market-sizing {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <a href="https://jjshay.com" target="_blank" title="Visit JJShay.com" style="display:flex;align-items:center;">
            <img src="https://jjshay.com/logo.png" alt="Logo" class="header-logo" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        </a>
        <h1>AI BOOK</h1>
    </header>

    <div class="sticky-search" id="stickySearch">
        <input type="text" class="search-input" id="searchInput" placeholder="Search companies...">
    </div>
    <div class="search-container">
        <div class="filter-row">
            <select class="filter-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="foundation-models">Foundation Models</option>
                <option value="developer-tools">Developer Tools</option>
                <option value="enterprise-ai">Enterprise AI</option>
                <option value="consumer-ai">Consumer AI</option>
                <option value="data-infra">Data & MLOps</option>
                <option value="fintech-legal">Fintech & Legal</option>
                <option value="gtm-ai">Sales & Marketing</option>
                <option value="healthtech">Healthcare</option>
                <option value="robotics-ai">Robotics</option>
                <option value="security-ai">Security</option>
                <option value="text-ai">Creative: Text</option>
                <option value="voice-ai">Creative: Voice</option>
                <option value="video-ai">Creative: Text to Video</option>
                <option value="photo-ai">Creative: Photo</option>
                <option value="gaming-ai">Gaming AI</option>
                <option value="music-ai">Music & Audio AI</option>
                <option value="travel-ai">Travel & Hospitality</option>
                <option value="construction-ai">Construction AI</option>
                <option value="media-ai">Media & Entertainment</option>
                <option value="energy-ai">Energy & Utilities</option>
                <option value="insurance-ai">Insurance AI</option>
            </select>
            <div class="funding-toggle" id="fundingToggle">
                <button class="fund-btn active" data-level="">All</button>
                <button class="fund-btn" data-level="1">$</button>
                <button class="fund-btn" data-level="2">$$</button>
                <button class="fund-btn" data-level="3">$$$</button>
            </div>
            <button class="more-filters-btn" id="moreFiltersBtn">More</button>
            <button class="timeline-btn" id="timelineBtn">Timeline</button>
            <button id="jobHunterBtn" onclick="toggleJobHunterMode()">Job Hunter</button>
        </div>
        <div class="filter-row secondary-filters" id="secondaryFilters" style="display:none;">
            <select class="filter-select" id="locationFilter">
                <option value="">All Locations</option>
                <option value="sf">SF Bay Area</option>
                <option value="nyc">NYC</option>
                <option value="boston">Boston</option>
                <option value="la">Los Angeles</option>
                <option value="seattle">Seattle</option>
                <option value="international">International</option>
            </select>
            <select class="filter-select" id="badgeFilter">
                <option value="">All Types</option>
                <option value="unicorn">Unicorns</option>
                <option value="ma-target">M&A Targets</option>
            </select>
            <select class="filter-select" id="maFilter">
                <option value="">M&A Score</option>
                <option value="high">High (70+)</option>
                <option value="med">Medium (55-69)</option>
                <option value="any">Has M&A Data</option>
                <option value="stale">Stale Raise (3yr+)</option>
                <option value="ceo">CEO Change</option>
                <option value="blocked">Blocked Deal</option>
            </select>
            <select class="filter-select" id="maSortFilter">
                <option value="">Sort By</option>
                <option value="ma-desc">M&A Score (HighLow)</option>
                <option value="ma-asc">M&A Score (LowHigh)</option>
                <option value="stale-desc">Years Since Raise</option>
            </select>
        </div>
        <div class="stats-bar" id="statsBar">
            <div class="stat-item stat-tooltip" data-tooltip="Total private AI companies tracked in the AI Book database">
                <span class="stat-value" id="statCompanies">0</span>
                <span class="stat-label">Companies</span>
            </div>
            <div class="stat-item stat-tooltip" data-tooltip="Combined venture capital and private equity raised across all tracked companies">
                <span class="stat-value" id="statFunding">$0B</span>
                <span class="stat-label">Funding</span>
            </div>
            <div class="stat-item stat-tooltip" data-tooltip="Companies valued at $1B+ based on last funding round valuation">
                <span class="stat-value" id="statUnicorns">0</span>
                <span class="stat-label"> Unicorns</span>
            </div>
            <div class="stat-item stat-tooltip" data-tooltip="Companies identified as likely acquisition targets based on strategic fit, market position, and investor signals">
                <span class="stat-value" id="statTargets">0</span>
                <span class="stat-label"> M&A Targets</span>
            </div>
        </div>
        <div class="results-count" id="resultsCount"></div>
    </div>

    <!-- Insights Section Tabs -->
    <div class="section-tabs" id="sectionTabs">
        <button class="section-tab" data-section="dealflow" onclick="toggleInsightSection('dealflow')">
            <span class="section-tab-icon"></span> Deal Flow
        </button>
        <button class="section-tab" data-section="investors" onclick="toggleInsightSection('investors')">
            <span class="section-tab-icon"></span> Investor Leaderboard
        </button>
        <button class="section-tab" data-section="landscape" onclick="toggleInsightSection('landscape')">
            <span class="section-tab-icon"></span> Competitive Landscape
        </button>
        <button class="section-tab" data-section="acquisitions" onclick="toggleInsightSection('acquisitions')">
            <span class="section-tab-icon"></span> Acquisition Tracker
        </button>
        <button class="section-tab" data-section="geography" onclick="toggleInsightSection('geography')">
            <span class="section-tab-icon"></span> Geography
        </button>
        <button class="section-tab" data-section="markets" onclick="toggleInsightSection('markets')">
            <span class="section-tab-icon"></span> Market Sizing
        </button>
        <button class="section-tab" data-section="matools" onclick="toggleInsightSection('matools')" style="background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(249,115,22,0.2)); border: 1px solid rgba(239,68,68,0.3);">
            <span class="section-tab-icon"></span> M&A Tools
        </button>
        <button class="section-tab" data-section="jobs" onclick="toggleInsightSection('jobs')" style="background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.2)); border: 1px solid rgba(34,197,94,0.3);">
            <span class="section-tab-icon"></span> Live Jobs
        </button>
        <button class="section-tab" data-section="linkedin" onclick="toggleInsightSection('linkedin')" style="background: linear-gradient(135deg, rgba(0,119,181,0.2), rgba(0,160,220,0.2)); border: 1px solid rgba(0,119,181,0.3);">
            <span class="section-tab-icon"></span> LinkedIn Data
        </button>
        <button class="section-tab" data-section="signals" onclick="toggleInsightSection('signals')" style="background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(34,197,94,0.2)); border: 1px solid rgba(239,68,68,0.3);">
            <span class="section-tab-icon"></span> Hiring Signals
        </button>
    </div>

    <!-- Deal Flow Panel -->
    <div class="insights-panel" id="dealflowPanel">
        <div class="insights-header">
            <span class="insights-title"> Recent Deal Flow</span>
            <button class="insights-close" onclick="closeInsightSection('dealflow')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="deal-flow-list" id="dealFlowList">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Investor Leaderboard Panel -->
    <div class="insights-panel" id="investorsPanel">
        <div class="insights-header">
            <span class="insights-title"> Top AI Investors</span>
            <button class="insights-close" onclick="closeInsightSection('investors')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="investor-grid" id="investorGrid">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Competitive Landscape Panel -->
    <div class="insights-panel" id="landscapePanel">
        <div class="insights-header">
            <span class="insights-title"> Competitive Landscapes</span>
            <button class="insights-close" onclick="closeInsightSection('landscape')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="landscape-grid" id="landscapeGrid">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Acquisition Tracker Panel -->
    <div class="insights-panel" id="acquisitionsPanel">
        <div class="insights-header">
            <span class="insights-title"> M&A Targets</span>
            <button class="insights-close" onclick="closeInsightSection('acquisitions')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="acquisition-grid" id="acquisitionGrid">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Geography Panel -->
    <div class="insights-panel" id="geographyPanel">
        <div class="insights-header">
            <span class="insights-title"> AI Company Geography</span>
            <button class="insights-close" onclick="closeInsightSection('geography')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="geo-grid" id="geoGrid">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Market Sizing Panel -->
    <div class="insights-panel" id="marketsPanel">
        <div class="insights-header">
            <span class="insights-title"> Market Sizing by Category</span>
            <button class="insights-close" onclick="closeInsightSection('markets')">&times;</button>
        </div>
        <div class="insights-body">
            <div class="market-sizing" id="marketSizing">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- M&A Tools Panel -->
    <div class="insights-panel" id="matoolsPanel" style="max-width: 1000px;">
        <div class="insights-header" style="background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(249,115,22,0.15));">
            <span class="insights-title"> M&A Intelligence Tools</span>
            <button class="insights-close" onclick="closeInsightSection('matools')">&times;</button>
        </div>
        <div class="insights-body" style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <label style="color: var(--text); font-size: 14px;">Analyze Company:</label>
                <select id="maToolsCompanySelect" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; width: 300px; margin-left: 10px;" onchange="runMaAnalysis()">
                    <option value="">Select a company...</option>
                </select>
                <button onclick="runMaAnalysis()" style="margin-left: 10px; padding: 10px 20px; background: var(--accent-cyan); color: var(--bg-primary); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Analyze</button>
            </div>

            <div id="maToolsResults" style="display: none;">
                <!-- 1. Acquisition Pricing -->
                <div class="ma-tool-section" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> Acquisition Price Range</h3>
                    <div id="maPricingResult"></div>
                </div>

                <!-- 2. Likely Acquirers -->
                <div class="ma-tool-section" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> Likely Acquirers</h3>
                    <div id="maAcquirersResult"></div>
                </div>

                <!-- 3. PE Target Score -->
                <div class="ma-tool-section" id="maPeSection" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> PE Take-Private Score</h3>
                    <div id="maPeResult"></div>
                </div>

                <!-- 4. Comparables -->
                <div class="ma-tool-section" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> Revenue Multiple Comparables</h3>
                    <div id="maComparablesResult"></div>
                </div>

                <!-- 5. Exit Path -->
                <div class="ma-tool-section" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> Exit Path Prediction</h3>
                    <div id="maExitResult"></div>
                </div>

                <!-- 6. Job Seeker Risk -->
                <div class="ma-tool-section" style="background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(34,197,94,0.3);">
                    <h3 style="margin: 0 0 12px 0; color: #22c55e; font-size: 16px;"> Job Seeker Risk Score</h3>
                    <div id="maJobRiskResult"></div>
                </div>
            </div>

            <!-- Industry Consolidation Heatmap -->
            <div style="margin-top: 24px; background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
                <h3 style="margin: 0 0 12px 0; color: var(--accent-cyan); font-size: 16px;"> Industry Consolidation Heatmap</h3>
                <div id="maConsolidationResult"></div>
            </div>
        </div>
    </div>

    <!-- Hiring Signals Panel -->
    <div class="insights-panel" id="signalsPanel" style="max-width: 1200px;">
        <div class="insights-header" style="background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(34,197,94,0.15));">
            <span class="insights-title"> Hiring Signal Detection (MVP)</span>
            <button class="insights-close" onclick="closeInsightSection('signals')">&times;</button>
        </div>
        <div class="insights-body" style="padding: 20px;">
            <!-- Overview Stats -->
            <div id="hiringSignalsOverview" style="margin-bottom: 20px;"></div>

            <!-- Controls -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; align-items: flex-end;">
                <div>
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">Analyze Company</label>
                    <select id="hiringCompanySelect" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; min-width: 220px;">
                        <option value="">Select company...</option>
                    </select>
                </div>
                <button id="analyzeSingleBtn" onclick="analyzeSelectedCompany()" style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Analyze
                </button>
                <div style="margin-left: auto;">
                    <button id="analyzeHiringBtn" onclick="startHiringSignalAnalysis()" style="padding: 12px 24px; background: linear-gradient(135deg, #ef4444, #f97316); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px;">
                         Analyze All Companies
                    </button>
                </div>
            </div>

            <!-- API Keys Section -->
            <div style="background: var(--card); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                <div style="font-size: 12px; color: var(--dim); margin-bottom: 8px;">API Keys (Optional - enables more data sources)</div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <input type="text" id="rapidApiKey" placeholder="RapidAPI Key" style="padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; width: 200px; font-size: 12px;" onchange="JobProviders.get('rapidapi').setApiKey(this.value)" />
                    </div>
                    <div>
                        <input type="text" id="usaJobsKey" placeholder="USAJobs API Key" style="padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; width: 200px; font-size: 12px;" onchange="JobProviders.get('usajobs').setApiKey(this.value)" />
                    </div>
                </div>
            </div>

            <!-- Progress -->
            <div id="hiringSignalProgress" style="margin-bottom: 16px;"></div>

            <!-- Company Detail -->
            <div id="companySignalDetail" style="margin-bottom: 20px;"></div>

            <!-- Two Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Alerts -->
                <div>
                    <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;"> Recent Alerts</h3>
                    <div id="hiringAlerts"></div>
                </div>

                <!-- Leaderboard -->
                <div>
                    <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;"> Top Hiring Companies</h3>
                    <div id="hiringLeaderboard"></div>
                </div>
            </div>

            <!-- Score Legend -->
            <div style="margin-top: 24px; background: var(--card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Signal Scoring</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                    <div><span style="color: #22c55e;">+30</span> New career page role</div>
                    <div><span style="color: #22c55e;">+20</span> Multiple new postings (7d)</div>
                    <div><span style="color: #22c55e;">+15</span> GitHub activity spike</div>
                    <div><span style="color: #22c55e;">+10</span> Repeat posting same role</div>
                    <div><span style="color: #22c55e;">+5</span> Role diversity increase</div>
                    <div><span style="color: #ef4444;">-20</span> Role removals / freezes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LinkedIn Data Panel -->
    <div class="insights-panel" id="linkedinPanel" style="max-width: 1100px;">
        <div class="insights-header" style="background: linear-gradient(135deg, rgba(0,119,181,0.15), rgba(0,160,220,0.15));">
            <span class="insights-title"> LinkedIn Company & Hiring Data</span>
            <button class="insights-close" onclick="closeInsightSection('linkedin')">&times;</button>
        </div>
        <div class="insights-body" style="padding: 20px;">
            <!-- Stats -->
            <div id="linkedInStats" style="margin-bottom: 20px;"></div>

            <!-- Controls -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; align-items: flex-end;">
                <div>
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">Single Company</label>
                    <select id="linkedInCompanySelect" onchange="renderLinkedInCompanyDetail(this.value)" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; min-width: 220px;">
                        <option value="">Select company...</option>
                    </select>
                </div>
                <button id="linkedInFetchOneBtn" onclick="fetchSingleLinkedInCompany()" style="padding: 10px 20px; background: #0077b5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Fetch This Company
                </button>
                <div style="margin-left: auto; display: flex; gap: 8px;">
                    <button onclick="populateSimulatedLinkedInData()" style="padding: 12px 20px; background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(139,92,246,0.3)); border: 1px solid rgba(168,85,247,0.4); color: #a855f7; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                         Demo Mode
                    </button>
                    <button id="linkedInFetchAllBtn" onclick="startLinkedInBulkFetch()" style="padding: 12px 24px; background: linear-gradient(135deg, #0077b5, #00a0dc); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px;">
                         Fetch All Companies
                    </button>
                </div>
            </div>

            <!-- Progress -->
            <div id="linkedInProgress" style="margin-bottom: 20px;"></div>

            <!-- Company Detail -->
            <div id="linkedInCompanyDetail"></div>

            <!-- Hiring Signal Summary -->
            <div id="hiringSignalSummary" style="margin-top: 24px;"></div>

            <!-- Hiring Leaderboard -->
            <div style="margin-top: 24px;">
                <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 16px;"> Hiring Leaderboard</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <button onclick="renderLinkedInHiringLeaderboard('all')" class="leaderboard-filter active" data-filter="all" style="padding: 6px 12px; background: rgba(212,168,75,0.2); border: 1px solid var(--gold); color: var(--gold); border-radius: 6px; cursor: pointer; font-size: 12px;">All Companies</button>
                    <button onclick="renderLinkedInHiringLeaderboard('hot')" class="leaderboard-filter" data-filter="hot" style="padding: 6px 12px; background: var(--card); border: 1px solid var(--border); color: var(--dim); border-radius: 6px; cursor: pointer; font-size: 12px;"> Hot Hiring</button>
                    <button onclick="renderLinkedInHiringLeaderboard('growth')" class="leaderboard-filter" data-filter="growth" style="padding: 6px 12px; background: var(--card); border: 1px solid var(--border); color: var(--dim); border-radius: 6px; cursor: pointer; font-size: 12px;"> Fastest Growth</button>
                    <button onclick="renderLinkedInHiringLeaderboard('salary')" class="leaderboard-filter" data-filter="salary" style="padding: 6px 12px; background: var(--card); border: 1px solid var(--border); color: var(--dim); border-radius: 6px; cursor: pointer; font-size: 12px;"> Top Salary</button>
                    <button onclick="renderLinkedInHiringLeaderboard('equity')" class="leaderboard-filter" data-filter="equity" style="padding: 6px 12px; background: var(--card); border: 1px solid var(--border); color: var(--dim); border-radius: 6px; cursor: pointer; font-size: 12px;"> Best Equity</button>
                </div>
                <div id="linkedInHiringLeaderboard">
                    <div style="color: var(--dim); text-align: center; padding: 20px;">
                        Click "Demo Mode" to populate with sample data, or "Fetch All" to pull live data
                    </div>
                </div>
            </div>

            <!-- LinkedIn Signals Intelligence -->
            <div id="linkedInSignalsSection" style="margin-top: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--text); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;"></span> LinkedIn Signals Intelligence
                        <span id="signalsCompanyCount" style="background: rgba(0,119,181,0.2); color: #00a0dc; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;">800 companies</span>
                    </h3>
                    <button onclick="computeLinkedInSignals()" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(0,119,181,0.3), rgba(0,160,220,0.3)); border: 1px solid rgba(0,119,181,0.4); color: #00a0dc; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">
                         Refresh Signals
                    </button>
                </div>

                <!-- Signal Summary Cards -->
                <div id="signalSummaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="color: var(--dim); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Market Momentum</div>
                        <div id="signalMomentum" style="font-size: 28px; font-weight: 700; color: var(--gold);">--</div>
                        <div id="signalMomentumLabel" style="color: var(--dim); font-size: 11px;">Awaiting data</div>
                    </div>
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="color: var(--dim); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Hiring Velocity</div>
                        <div id="signalVelocity" style="font-size: 28px; font-weight: 700; color: #22c55e;">--</div>
                        <div id="signalVelocityLabel" style="color: var(--dim); font-size: 11px;">Roles/month</div>
                    </div>
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="color: var(--dim); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Growth Sentiment</div>
                        <div id="signalSentiment" style="font-size: 28px; font-weight: 700; color: #3b82f6;">--</div>
                        <div id="signalSentimentLabel" style="color: var(--dim); font-size: 11px;">Overall outlook</div>
                    </div>
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center;">
                        <div style="color: var(--dim); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Hot Companies</div>
                        <div id="signalHotCount" style="font-size: 28px; font-weight: 700; color: #ef4444;">--</div>
                        <div id="signalHotLabel" style="color: var(--dim); font-size: 11px;">Aggressive hiring</div>
                    </div>
                </div>

                <!-- Signal Tabs -->
                <div style="display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                    <button onclick="showSignalTab('momentum')" class="signal-tab active" data-tab="momentum" style="padding: 8px 16px; background: rgba(212,168,75,0.2); border: 1px solid var(--gold); border-bottom: none; color: var(--gold); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px; font-weight: 600;"> Momentum</button>
                    <button onclick="showSignalTab('sentiment')" class="signal-tab" data-tab="sentiment" style="padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-bottom: none; color: var(--dim); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px;"> Sentiment</button>
                    <button onclick="showSignalTab('growth')" class="signal-tab" data-tab="growth" style="padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-bottom: none; color: var(--dim); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px;"> Growth Leaders</button>
                    <button onclick="showSignalTab('departments')" class="signal-tab" data-tab="departments" style="padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-bottom: none; color: var(--dim); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px;"> Departments</button>
                    <button onclick="showSignalTab('alerts')" class="signal-tab" data-tab="alerts" style="padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-bottom: none; color: var(--dim); border-radius: 6px 6px 0 0; cursor: pointer; font-size: 12px;"> Alerts</button>
                </div>

                <!-- Momentum Panel -->
                <div id="signalPanelMomentum" class="signal-panel" style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Market Momentum Indicators</h4>
                    <div id="momentumContent" style="color: var(--dim); font-size: 13px;">
                        <p style="margin: 0;">Click "Refresh Signals" or load LinkedIn data to see momentum analysis.</p>
                    </div>
                </div>

                <!-- Sentiment Panel -->
                <div id="signalPanelSentiment" class="signal-panel" style="display: none; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Growth Sentiment Analysis</h4>
                    <div id="sentimentContent" style="color: var(--dim); font-size: 13px;">
                        <p style="margin: 0;">Sentiment analysis based on hiring patterns, employee growth, and market positioning.</p>
                    </div>
                </div>

                <!-- Growth Leaders Panel -->
                <div id="signalPanelGrowth" class="signal-panel" style="display: none; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Top Growth Companies</h4>
                    <div id="growthContent" style="color: var(--dim); font-size: 13px;">
                        <p style="margin: 0;">Companies showing strongest growth signals.</p>
                    </div>
                </div>

                <!-- Departments Panel -->
                <div id="signalPanelDepartments" class="signal-panel" style="display: none; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Department Hiring Breakdown</h4>
                    <div id="departmentsContent" style="color: var(--dim); font-size: 13px;">
                        <p style="margin: 0;">Hiring trends by department across all companies.</p>
                    </div>
                </div>

                <!-- Alerts Panel -->
                <div id="signalPanelAlerts" class="signal-panel" style="display: none; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Signal Alerts</h4>
                    <div id="alertsContent" style="color: var(--dim); font-size: 13px;">
                        <p style="margin: 0;">Notable changes and actionable insights.</p>
                    </div>
                </div>
            </div>

            <!-- Fetch Real Jobs -->
            <div style="margin-top: 24px; background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(16,185,129,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;"></span>
                        <h4 style="margin: 0; color: var(--text); font-size: 14px;">Fetch Real Jobs from ATSs</h4>
                    </div>
                    <span style="color: var(--dim); font-size: 11px;">Greenhouse, Lever APIs</span>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px;">
                    <button onclick="fetchRealJobsFromAllATSs()" style="padding: 12px 24px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px;">
                         Fetch Real Jobs from All Companies
                    </button>
                    <span style="color: var(--dim); font-size: 12px;">Fetches live job listings from <strong style="color: var(--gold);">150+</strong> AI & tech companies</span>
                </div>

                <div id="realJobsProgress"></div>

                <div style="color: var(--dim); font-size: 11px; line-height: 1.5;">
                    <strong style="color: var(--text);">Categories:</strong> AI Labs (Anthropic, OpenAI, Mistral, Cohere)  Dev Tools (Vercel, Supabase, Linear, Retool)  Data/ML (Databricks, Pinecone, Hugging Face)  FinTech (Stripe, Ramp, Plaid)  Enterprise (Datadog, Notion, Figma)  Security (Wiz, Snyk, 1Password)  Robotics (Figure, Anduril, Zipline)  and more...
                </div>
            </div>

            <!-- Google Sheets Sync -->
            <div style="margin-top: 16px; background: linear-gradient(135deg, rgba(66,133,244,0.1), rgba(52,168,83,0.1)); border: 1px solid rgba(66,133,244,0.3); border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 20px;"></span>
                    <h4 style="margin: 0; color: var(--text); font-size: 14px;">Google Sheets Sync</h4>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-bottom: 12px;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="color: var(--dim); font-size: 11px; display: block; margin-bottom: 4px;">Google Sheet ID or URL</label>
                        <input type="text" id="googleSheetId" placeholder="Paste sheet URL or ID..."
                            style="width: 100%; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 13px;"
                            onchange="saveGoogleSheetId()" value="https://docs.google.com/spreadsheets/d/1cjhdr8rhvwfdKp7xLtklD2cQLWMHC4C7JeA2tViQWWo">
                    </div>
                    <button onclick="syncFromSheets()" style="padding: 10px 16px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                         Sync from Sheet
                    </button>
                    <button onclick="copyToClipboardForSheets()" style="padding: 10px 16px; background: linear-gradient(135deg, #fbbc05, #ea4335); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                         Copy to Clipboard
                    </button>
                </div>

                <div id="sheetsSyncStatus" style="margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card); border-radius: 6px;">
                        <span></span>
                        <span style="color: var(--dim); font-size: 12px;">Enter a Google Sheet ID to enable sync</span>
                    </div>
                </div>

                <details style="margin-top: 8px;">
                    <summary style="color: var(--dim); font-size: 12px; cursor: pointer;"> Setup Instructions</summary>
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 8px; font-size: 11px; color: var(--dim); line-height: 1.6;">
                        <strong style="color: var(--text);">Your Google Sheet is pre-configured!</strong><br>
                        The sheet already has the correct headers: Ref | Source | Company | Role | Department | Location | Salary | Type | Posted | URL | Notes | Status<br><br>
                        <strong style="color: var(--text);">Workflow:</strong><br>
                        1. Click <strong>" Fetch Real Jobs"</strong> above to pull live data from 37+ companies<br>
                        2. Click <strong>" Copy to Clipboard"</strong> to copy the data<br>
                        3. Go to your Google Sheet and paste (Ctrl+V / Cmd+V) starting at row 2<br>
                        4. Use <strong>" Sync from Sheet"</strong> to pull data back from the sheet later
                    </div>
                </details>
            </div>

            <!-- Synced Job Listings -->
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 14px;"> Synced Job Listings</h4>
                <div id="jobListingsTable">
                    <div style="color: var(--dim); text-align: center; padding: 20px;">No job listings yet. Sync from Google Sheets or click "Copy to Clipboard" to export.</div>
                </div>
            </div>

            <!-- Export -->
            <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button onclick="exportLinkedInData('json')" style="padding: 10px 20px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer;">
                     Export JSON
                </button>
                <button onclick="exportLinkedInData('csv')" style="padding: 10px 20px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer;">
                     Export CSV
                </button>
                <button onclick="exportHiringSignalsReport()" style="padding: 10px 20px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer;">
                     Hiring Report
                </button>
                <button onclick="mergeLinkedInToWikiData(); applyFilters();" style="padding: 10px 20px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; border-radius: 8px; cursor: pointer;">
                     Merge to Directory
                </button>
            </div>
        </div>
    </div>

    <!-- Live Jobs Panel -->
    <div class="insights-panel" id="jobsPanel" style="max-width: 1100px;">
        <div class="insights-header" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(16,185,129,0.15));">
            <span class="insights-title"> Live Job Openings</span>
            <button class="insights-close" onclick="closeInsightSection('jobs')">&times;</button>
        </div>
        <div class="insights-body" style="padding: 20px;">
            <!-- Search/Filter Controls -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; align-items: center;">
                <div>
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">Company</label>
                    <select id="jobsCompanySelect" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; min-width: 200px;">
                        <option value="">Select a company...</option>
                    </select>
                </div>
                <div>
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">Department</label>
                    <select id="jobsDeptFilter" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; min-width: 150px;">
                        <option value="">All Departments</option>
                        <optgroup label="Technical">
                            <option value="engineering">Engineering</option>
                            <option value="devops">DevOps / SRE / Infra</option>
                            <option value="data">Data Science / ML</option>
                            <option value="research">Research / AI</option>
                            <option value="security">Security</option>
                        </optgroup>
                        <optgroup label="Product & Design">
                            <option value="product">Product Management</option>
                            <option value="design">Design / UX</option>
                        </optgroup>
                        <optgroup label="Go-to-Market">
                            <option value="sales">Sales / AE</option>
                            <option value="marketing">Marketing / Growth</option>
                            <option value="cs">Customer Success</option>
                            <option value="solutions">Solutions / SE</option>
                        </optgroup>
                        <optgroup label="Business">
                            <option value="finance">Finance / Accounting</option>
                            <option value="strategy">Strategy / Ops</option>
                            <option value="corpdev">Corp Dev / M&A</option>
                            <option value="bizdev">Biz Dev / Partnerships</option>
                        </optgroup>
                        <optgroup label="Operations">
                            <option value="hr">People / HR</option>
                            <option value="legal">Legal / Compliance</option>
                            <option value="recruiting">Recruiting / TA</option>
                            <option value="ops">Operations</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">Location</label>
                    <select id="jobsLocationFilter" style="padding: 10px 15px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; min-width: 150px;">
                        <option value="">All Locations</option>
                        <option value="sf">San Francisco</option>
                        <option value="nyc">New York</option>
                        <option value="remote">Remote</option>
                        <option value="london">London</option>
                        <option value="seattle">Seattle</option>
                    </select>
                </div>
                <div style="margin-left: auto;">
                    <label style="color: var(--dim); font-size: 12px; display: block; margin-bottom: 4px;">&nbsp;</label>
                    <button id="fetchJobsBtn" onclick="fetchAndDisplayJobs()" style="padding: 10px 24px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span id="jobsLoadingSpinner" style="display: none;"></span>
                        <span>Fetch Jobs</span>
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                <button onclick="fetchJobsForHotCompanies()" class="quick-action-btn" style="padding: 8px 16px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 12px;">
                     Hot Companies
                </button>
                <button onclick="fetchJobsForHighMaTarget()" class="quick-action-btn" style="padding: 8px 16px; background: rgba(249,115,22,0.2); border: 1px solid rgba(249,115,22,0.3); color: #f97316; border-radius: 6px; cursor: pointer; font-size: 12px;">
                     High M&A Targets
                </button>
                <button onclick="fetchRemoteAIJobs()" class="quick-action-btn" style="padding: 8px 16px; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3); color: #3b82f6; border-radius: 6px; cursor: pointer; font-size: 12px;">
                     Remote AI Jobs
                </button>
                <button onclick="fetchJobsForUnicorns()" class="quick-action-btn" style="padding: 8px 16px; background: rgba(168,85,247,0.2); border: 1px solid rgba(168,85,247,0.3); color: #a855f7; border-radius: 6px; cursor: pointer; font-size: 12px;">
                     Unicorns Hiring
                </button>
            </div>

            <!-- Stats Bar -->
            <div id="jobsStatsBar" style="display: none; background: var(--card); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                    <div>
                        <span style="color: var(--dim); font-size: 11px;">TOTAL JOBS</span>
                        <div style="font-size: 24px; font-weight: 700; color: #22c55e;" id="jobsTotalCount">-</div>
                    </div>
                    <div>
                        <span style="color: var(--dim); font-size: 11px;">COMPANIES</span>
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-cyan);" id="jobsCompanyCount">-</div>
                    </div>
                    <div>
                        <span style="color: var(--dim); font-size: 11px;">ENGINEERING</span>
                        <div style="font-size: 24px; font-weight: 700; color: #a855f7;" id="jobsEngCount">-</div>
                    </div>
                    <div>
                        <span style="color: var(--dim); font-size: 11px;">REMOTE</span>
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="jobsRemoteCount">-</div>
                    </div>
                </div>
            </div>

            <!-- Results Area -->
            <div id="jobsResultsArea">
                <div style="text-align: center; padding: 60px 20px; color: var(--dim);">
                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                    <div style="font-size: 16px; margin-bottom: 8px;">Select a company and click "Fetch Jobs"</div>
                    <div style="font-size: 13px;">Or use the quick action buttons to browse jobs from multiple companies</div>
                </div>
            </div>
        </div>
    </div>

    <div class="timeline-container" id="timelineContainer">
        <div class="timeline-header">
            <div class="timeline-title">Funding Timeline</div>
            <button class="modal-close" onclick="document.getElementById('timelineContainer').classList.remove('active')">&times;</button>
        </div>
        <div class="timeline-years" id="timelineYears"></div>
        <div class="timeline-legend">
            <span>Total funding raised per year across visible companies</span>
        </div>
    </div>

    <!-- Filter Header with Definitions -->
    <div class="filter-header" id="filterHeader" style="display:none;">
        <div class="filter-header-title" id="filterHeaderTitle"></div>
        <div class="filter-header-desc" id="filterHeaderDesc"></div>
    </div>

    <main id="mainContent">
        <div class="loading">Loading AI Book...</div>
    </main>

    <!-- Company Detail Modal -->
    <div class="modal-overlay" id="companyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Company Name</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="external-links" id="externalLinks">
                <!-- Dynamic external links -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-ignore" id="modalIgnore">Ignore</button>
                <button class="modal-btn btn-favorite" id="modalFavorite">Favorite</button>
            </div>
        </div>
    </div>

    <!-- Funding Graph Modal -->
    <div class="funding-modal" id="fundingModal">
        <div class="funding-modal-content">
            <div class="funding-modal-header">
                <span class="funding-modal-title" id="fundingModalTitle">Funding History</span>
                <button class="funding-modal-close" onclick="closeFundingModal()">&times;</button>
            </div>
            <div class="funding-chart" id="fundingChart">
                <!-- SVG chart will be rendered here -->
            </div>
            <div class="funding-stats" id="fundingStats">
                <!-- Funding stats will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Saved Analysis Modal -->
    <div class="analysis-modal" id="analysisModal">
        <div class="analysis-content">
            <div class="analysis-header">
                <h2>Saved Companies Analysis</h2>
                <button class="analysis-close" onclick="closeAnalysisModal()">&times;</button>
            </div>
            <div id="analysisBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Investor Profile Modal -->
    <div class="modal-overlay" id="investorModal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <div style="display:flex;align-items:center;gap:12px;">
                    <img id="investorLogo" src="" alt="" style="width:48px;height:48px;border-radius:8px;background:#fff;object-fit:contain;">
                    <h2 class="modal-title" id="investorTitle">Investor Name</h2>
                </div>
                <button class="modal-close" onclick="closeInvestorModal()">&times;</button>
            </div>
            <div class="modal-body" id="investorBody" style="max-height:70vh;overflow-y:auto;">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- FABs -->
    <div class="fab-container">
        <button class="fab fab-favorites" id="fabFavorites" title="View Watchlist">
            &#9733;
            <span class="fab-badge" id="favBadge">0</span>
        </button>
        <button class="fab fab-export" id="fabExport" title="Get My Report">
            
            <span class="fab-badge" id="exportBadge">0</span>
        </button>
    </div>

    <!-- Undo Toast -->
    <div class="undo-toast" id="undoToast">
        <span class="undo-toast-text" id="undoText">Action completed</span>
        <button class="undo-toast-btn" onclick="undoLastAction()">Undo</button>
        <button class="undo-toast-close" onclick="hideUndoToast()">&times;</button>
    </div>

    <!-- Email Capture Modal -->
    <div class="email-modal" id="emailModal">
        <div class="email-modal-content" style="position:relative;">
            <button class="email-close" onclick="closeEmailModal()">&times;</button>
            <img src="https://jjshay.com/logo.png" alt="JJShay" style="width:50px;height:50px;margin:0 auto 15px;display:block">
            <div class="email-modal-title">Get your Free Personal Report Here:</div>

            <form id="emailForm" onsubmit="submitWatchlist(event)">
                <input type="email" class="email-input" id="userEmail" placeholder="Enter your email" required>
                <button type="submit" class="email-submit" id="emailSubmitBtn">Send My Watchlist</button>
            </form>

            <div class="email-success" id="emailSuccess" style="display:none;">
                 Check your inbox! We've sent your personalized AI watchlist.
            </div>

            <div class="email-privacy">
                We respect your privacy. No spam, just your watchlist report.
            </div>
        </div>
    </div>

    <button class="back-to-top" id="backToTop">&#x2191;</button>

    <!-- Alphabet Navigation -->
    <div class="alphabet-nav" id="alphabetNav">
        <div class="alpha-sort" id="alphaSort" title="Toggle A-Z / Z-A"></div>
        <div class="alpha-letter" data-letter="A">A</div>
        <div class="alpha-letter" data-letter="B">B</div>
        <div class="alpha-letter" data-letter="C">C</div>
        <div class="alpha-letter" data-letter="D">D</div>
        <div class="alpha-letter" data-letter="E">E</div>
        <div class="alpha-letter" data-letter="F">F</div>
        <div class="alpha-letter" data-letter="G">G</div>
        <div class="alpha-letter" data-letter="H">H</div>
        <div class="alpha-letter" data-letter="I">I</div>
        <div class="alpha-letter" data-letter="J">J</div>
        <div class="alpha-letter" data-letter="K">K</div>
        <div class="alpha-letter" data-letter="L">L</div>
        <div class="alpha-letter" data-letter="M">M</div>
        <div class="alpha-letter" data-letter="N">N</div>
        <div class="alpha-letter" data-letter="O">O</div>
        <div class="alpha-letter" data-letter="P">P</div>
        <div class="alpha-letter" data-letter="Q">Q</div>
        <div class="alpha-letter" data-letter="R">R</div>
        <div class="alpha-letter" data-letter="S">S</div>
        <div class="alpha-letter" data-letter="T">T</div>
        <div class="alpha-letter" data-letter="U">U</div>
        <div class="alpha-letter" data-letter="V">V</div>
        <div class="alpha-letter" data-letter="W">W</div>
        <div class="alpha-letter" data-letter="X">X</div>
        <div class="alpha-letter" data-letter="Y">Y</div>
        <div class="alpha-letter" data-letter="Z">Z</div>
        <div class="alpha-letter" data-letter="#">#</div>
    </div>
    <div class="alpha-current" id="alphaCurrent">A</div>

<script>
// ==================== COMPANY DATA ====================
// 600+ Private AI Companies - Public companies and duplicates removed
let companies = [];

// ==================== PUBLIC COMPANIES TO EXCLUDE ====================
// These are products of public companies - already excluded from data above:
// GitHub Copilot (Microsoft), Amazon CodeWhisperer, LinkedIn Recruiter,
// Microsoft 365 Copilot, Google Workspace AI, Salesforce Einstein,
// Kustomer (Meta), ClearMetal (Oracle), Microsoft Security Copilot,
// Amazon Seller Assist, Amazon Personalize, Google DeepMind Climate,
// AI for Good (Microsoft), Perso (L'Oreal), Neutrogena Skin360 (J&J)

// ==================== STATE ====================
let favorites = JSON.parse(localStorage.getItem('ai_favorites') || '[]');
let ignoredList = JSON.parse(localStorage.getItem('ai_ignored') || '[]');
let currentCompany = null;
let sortDirection = 'asc'; // 'asc' for A-Z, 'desc' for Z-A

// ==================== RENDER COMPANIES ====================
function renderCompanies(companiesList) {
    const container = document.getElementById('mainContent');
    const categoryFilter = document.getElementById('categoryFilter').value;

    // Filter out ignored
    const filtered = companiesList.filter(c => !ignoredList.includes(c.id));

    // If no category selected, render flat A-Z list
    if (!categoryFilter) {
        container.innerHTML = `
            <div class="cards-container">
                ${filtered.map(c => renderCard(c)).join('')}
            </div>
        `;
        updateCounts();
        updateAlphabetNav();
        return;
    }

    // If category selected, render with category header
    const categoryNames = {
        'foundation-models': 'Foundation Models',
        'developer-tools': 'Developer & Coding AI',
        'enterprise-ai': 'Enterprise AI',
        'gtm-ai': 'GTM & Marketing AI',
        'fintech-legal': 'Fintech & Legal AI',
        'healthtech': 'Healthcare AI',
        'industrial-ai': 'Industrial AI & Robotics',
        'consumer-ai': 'Consumer AI',
        'security-ai': 'Security & Cybersecurity AI',
        'education-ai': 'Education AI',
        'data-infra': 'Data Infrastructure & MLOps',
        'hr-talent': 'HR & Talent AI',
        'supply-chain': 'Supply Chain & Logistics AI',
        'real-estate': 'Real Estate & PropTech AI',
        'climate-agri': 'Climate & Agriculture AI',
        'legal-compliance': 'Legal & Compliance AI',
        'text-ai': ' Creative: Text',
        'voice-ai': ' Creative: Voice',
        'video-ai': ' Creative: Text to Video',
        'photo-ai': ' Creative: Photo',
        'space-ai': ' Space & Aerospace AI',
        'robotics-ai': ' Robotics AI',
        'agriculture-ai': ' Agriculture AI',
        'ocean-ai': ' Ocean & Maritime AI',
        'gaming-ai': ' Gaming AI',
        'music-ai': ' Music & Audio AI',
        'travel-ai': ' Travel & Hospitality AI',
        'construction-ai': ' Construction AI',
        'media-ai': ' Media & Entertainment AI',
        'energy-ai': ' Energy & Utilities AI',
        'insurance-ai': ' Insurance AI'
    };

    container.innerHTML = `
        <div class="category-section" id="${categoryFilter}">
            <div class="category-header">
                <h2>${categoryNames[categoryFilter] || categoryFilter}</h2>
                <span class="category-count">${filtered.length}</span>
            </div>
            <div class="cards-container">
                ${filtered.map(c => renderCard(c)).join('')}
            </div>
        </div>
    `;
    updateCounts();
    updateAlphabetNav();
}

function getLocationClass(hq) {
    if (!hq) return 'location-other';
    const loc = hq.toLowerCase();
    if (loc.includes('boston')) return 'location-boston';
    if (loc.includes('san francisco') || loc.includes('palo alto') || loc.includes('menlo park') || loc.includes('mountain view') || loc.includes('sunnyvale') || loc.includes('redwood') || loc.includes('santa clara') || loc.includes('san mateo') || loc.includes('berkeley') || loc.includes('oakland')) return 'location-sf';
    if (loc.includes('new york') || loc.includes('brooklyn') || loc.includes('nyc')) return 'location-nyc';
    if (loc.includes('los angeles') || loc.includes('santa monica') || loc.includes('venice') || loc.includes('culver')) return 'location-la';
    if (loc.includes('seattle') || loc.includes('bellevue') || loc.includes('redmond')) return 'location-seattle';
    if (loc.includes('austin')) return 'location-austin';
    if (!loc.includes('usa') && !loc.includes(', ca') && !loc.includes(', ny') && !loc.includes(', ma') && !loc.includes(', wa') && !loc.includes(', tx') && (loc.includes('london') || loc.includes('paris') || loc.includes('berlin') || loc.includes('tel aviv') || loc.includes('israel') || loc.includes('uk') || loc.includes('germany') || loc.includes('france') || loc.includes('canada') || loc.includes('toronto') || loc.includes('india') || loc.includes('china') || loc.includes('japan') || loc.includes('korea') || loc.includes('singapore') || loc.includes('australia') || loc.includes('hong kong') || loc.includes('switzerland') || loc.includes('netherlands') || loc.includes('sweden') || loc.includes('finland') || loc.includes('denmark') || loc.includes('norway'))) return 'location-international';
    return 'location-other';
}

function isUnicorn(company) {
    if (!company.valuation) return false;
    const val = company.valuation.toLowerCase();
    if (val.includes('$1b') || val.includes('$2b') || val.includes('$3b') || val.includes('$4b') || val.includes('$5b') ||
        val.includes('$6b') || val.includes('$7b') || val.includes('$8b') || val.includes('$9b') || val.includes('$10b') ||
        val.includes('$11b') || val.includes('$12b') || val.includes('$13b') || val.includes('$14b') || val.includes('$15b') ||
        val.includes('$19b') || val.includes('$65b') || val.includes('billion')) return true;
    // Check funding value for companies without explicit valuation
    if (company.fundingValue >= 500000000) return true;
    return false;
}

function isMaTarget(company) {
    // Companies with strong M&A signals
    if (!company.maInsight) return false;
    const insight = company.maInsight.toLowerCase();
    if (insight.includes('target') || insight.includes('potential') || insight.includes('likely') ||
        insight.includes('interest') || insight.includes('strategic')) return true;
    // Rating 4-5 with clear acquirers
    if (company.rating >= 4 && company.acquirers && company.acquirers.split(',').length >= 2) return true;
    return false;
}

function isLateBloomer(company) {
    // Founded before 2015 but still private with moderate funding
    const currentYear = new Date().getFullYear();
    const age = currentYear - company.founded;
    if (age >= 10 && company.fundingValue < 200000000 && !isUnicorn(company)) return true;
    // Or founded before 2012 regardless of funding (truly late)
    if (company.founded <= 2012 && !company.valuation?.toLowerCase().includes('public')) return true;
    return false;
}

// ==================== FUNDING TREND ====================
function getFundingTrend(company) {
    const currentYear = new Date().getFullYear();
    const age = currentYear - company.founded;
    const fundingPerYear = company.fundingValue / Math.max(age, 1);

    // Calculate funding momentum score
    // High momentum: >$50M/year average funding
    // Medium momentum: $10M-$50M/year
    // Low momentum: <$10M/year

    let direction, label;

    if (fundingPerYear >= 100000000) {
        direction = 'up';
        label = 'Hot';
    } else if (fundingPerYear >= 50000000) {
        direction = 'up';
        label = 'Strong';
    } else if (fundingPerYear >= 5000000) {
        direction = 'neutral';
        label = 'Steady';
    } else if (age <= 3) {
        // Young companies with low funding - could be early stage
        direction = 'neutral';
        label = 'Early';
    } else {
        direction = 'down';
        label = 'Slow';
    }

    // Adjust for recent activity if we have lastRound info
    if (company.lastRound) {
        const roundYear = parseInt(company.lastRound.match(/\d{4}/)?.[0] || '0');
        const yearsSinceRound = currentYear - roundYear;
        if (yearsSinceRound <= 1 && direction !== 'up') {
            direction = 'up';
            label = 'Recent';
        } else if (yearsSinceRound >= 3 && direction === 'up') {
            direction = 'neutral';
            label = 'Paused';
        }
    }

    return { direction, label, fundingPerYear, age };
}

function generateFundingHistory(company) {
    // Generate synthetic funding history based on available data
    const currentYear = new Date().getFullYear();
    const age = currentYear - company.founded;
    const totalFunding = company.fundingValue;

    // Create synthetic funding rounds
    const rounds = [];
    let accumulated = 0;

    // Estimate round structure based on total funding
    if (totalFunding >= 1000000000) {
        // Mega-funded company: Seed, A, B, C, D, E+
        const structure = [0.01, 0.03, 0.08, 0.18, 0.30, 0.40];
        structure.forEach((pct, i) => {
            const year = company.founded + Math.floor((i / structure.length) * age);
            accumulated += totalFunding * pct;
            rounds.push({ year, amount: accumulated, round: ['Seed', 'Series A', 'Series B', 'Series C', 'Series D', 'Series E+'][i] });
        });
    } else if (totalFunding >= 100000000) {
        // Well-funded: Seed, A, B, C
        const structure = [0.02, 0.08, 0.25, 0.65];
        structure.forEach((pct, i) => {
            const year = company.founded + Math.floor((i / structure.length) * age);
            accumulated += totalFunding * pct;
            rounds.push({ year, amount: accumulated, round: ['Seed', 'Series A', 'Series B', 'Series C'][i] });
        });
    } else if (totalFunding >= 20000000) {
        // Moderate funding: Seed, A, B
        const structure = [0.05, 0.25, 0.70];
        structure.forEach((pct, i) => {
            const year = company.founded + Math.floor((i / structure.length) * age);
            accumulated += totalFunding * pct;
            rounds.push({ year, amount: accumulated, round: ['Seed', 'Series A', 'Series B'][i] });
        });
    } else {
        // Early stage: Seed, maybe A
        const structure = totalFunding >= 5000000 ? [0.20, 0.80] : [1.0];
        structure.forEach((pct, i) => {
            const year = company.founded + Math.floor((i / structure.length) * age);
            accumulated += totalFunding * pct;
            rounds.push({ year, amount: accumulated, round: structure.length > 1 ? ['Seed', 'Series A'][i] : 'Seed' });
        });
    }

    return rounds;
}

function formatFundingAmount(amount) {
    if (amount >= 1000000000) return `$${(amount / 1000000000).toFixed(1)}B`;
    if (amount >= 1000000) return `$${(amount / 1000000).toFixed(0)}M`;
    if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;
    return `$${amount}`;
}

function openFundingModal(id) {
    const company = companies.find(c => c.id === id);
    if (!company) return;

    const history = generateFundingHistory(company);
    const trend = getFundingTrend(company);

    document.getElementById('fundingModalTitle').textContent = `${company.name} - Funding`;

    // Generate SVG chart
    const chartWidth = 400;
    const chartHeight = 120;
    const padding = 30;
    const maxAmount = Math.max(...history.map(h => h.amount));
    const minYear = Math.min(...history.map(h => h.year));
    const maxYear = Math.max(...history.map(h => h.year));
    const yearRange = maxYear - minYear || 1;

    const points = history.map(h => {
        const x = padding + ((h.year - minYear) / yearRange) * (chartWidth - padding * 2);
        const y = chartHeight - padding - (h.amount / maxAmount) * (chartHeight - padding * 2);
        return { x, y, ...h };
    });

    const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
    const areaD = pathD + ` L ${points[points.length-1].x} ${chartHeight - padding} L ${points[0].x} ${chartHeight - padding} Z`;

    const trendColor = trend.direction === 'up' ? '#4ade80' : trend.direction === 'down' ? '#f87171' : '#38bdf8';

    const svgChart = `
        <svg viewBox="0 0 ${chartWidth} ${chartHeight}">
            <defs>
                <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:${trendColor};stop-opacity:0.3"/>
                    <stop offset="100%" style="stop-color:${trendColor};stop-opacity:0"/>
                </linearGradient>
            </defs>
            <path d="${areaD}" fill="url(#areaGradient)"/>
            <path d="${pathD}" fill="none" stroke="${trendColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            ${points.map(p => `
                <circle cx="${p.x}" cy="${p.y}" r="4" fill="${trendColor}"/>
                <text x="${p.x}" y="${p.y - 10}" fill="var(--text-secondary)" font-size="8" text-anchor="middle">${p.round}</text>
            `).join('')}
            <text x="${padding}" y="${chartHeight - 5}" fill="var(--text-secondary)" font-size="9">${minYear}</text>
            <text x="${chartWidth - padding}" y="${chartHeight - 5}" fill="var(--text-secondary)" font-size="9" text-anchor="end">${maxYear}</text>
        </svg>
    `;

    document.getElementById('fundingChart').innerHTML = svgChart;

    // Generate stats
    const currentYear = new Date().getFullYear();
    const statsHtml = `
        <div class="funding-stat">
            <div class="funding-stat-label">Total Raised</div>
            <div class="funding-stat-value">${company.funding}</div>
        </div>
        <div class="funding-stat">
            <div class="funding-stat-label">Funding/Year</div>
            <div class="funding-stat-value">${formatFundingAmount(trend.fundingPerYear)}</div>
        </div>
        <div class="funding-stat">
            <div class="funding-stat-label">Company Age</div>
            <div class="funding-stat-value">${trend.age} years</div>
        </div>
        <div class="funding-stat">
            <div class="funding-stat-label">Momentum</div>
            <div class="funding-stat-value" style="color: ${trendColor}">${trend.label}</div>
        </div>
        ${company.lastRound ? `
        <div class="funding-stat" style="grid-column: span 2;">
            <div class="funding-stat-label">Last Round</div>
            <div class="funding-stat-value">${company.lastRound}</div>
        </div>
        ` : ''}
        ${company.investors ? `
        <div class="funding-stat" style="grid-column: span 2;">
            <div class="funding-stat-label">Key Investors</div>
            <div class="funding-stat-value" style="font-size: 0.85em;">${company.investors}</div>
        </div>
        ` : ''}
    `;

    document.getElementById('fundingStats').innerHTML = statsHtml;
    document.getElementById('fundingModal').classList.add('active');
}

function closeFundingModal() {
    document.getElementById('fundingModal').classList.remove('active');
}

// Close funding modal on outside click
document.getElementById('fundingModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'fundingModal') closeFundingModal();
});

// ==================== JOB HUNTING SIGNALS ====================
// Wikipedia-consistent signals for career decisions

function getJobHuntingSignals(company) {
    const currentYear = new Date().getFullYear();
    const age = currentYear - (company.founded || 2020);
    const funding = company.fundingValue || 0;
    const trend = getFundingTrend(company);

    // Parse valuation
    let valuation = 0;
    if (company.valuation) {
        const valStr = company.valuation.toLowerCase();
        const numMatch = valStr.match(/\$?([\d.]+)\s*(b|m|billion|million)?/i);
        if (numMatch) {
            valuation = parseFloat(numMatch[1]) * (valStr.includes('b') ? 1000000000 : 1000000);
        }
    }

    // Parse employee count
    let employees = 0;
    if (company.employees) {
        const empMatch = company.employees.match(/(\d+)/);
        if (empMatch) employees = parseInt(empMatch[1]);
    }

    // =============== EQUITY UPSIDE SCORE (1-10) ===============
    // Higher = more potential for stock to make you millions
    let equityScore = 5;

    // Stage bonus: Series B-D is the sweet spot
    if (company.lastRound) {
        const round = company.lastRound.toLowerCase();
        if (round.includes('seed')) equityScore += 2; // High risk, high reward
        else if (round.includes('series a')) equityScore += 2.5;
        else if (round.includes('series b')) equityScore += 3; // Sweet spot
        else if (round.includes('series c')) equityScore += 2.5;
        else if (round.includes('series d')) equityScore += 1.5;
        else if (round.includes('ipo') || round.includes('public')) equityScore -= 2; // Limited upside
    }

    // Valuation sweet spot: $500M - $5B has most upside
    if (valuation > 0) {
        if (valuation >= 500000000 && valuation <= 2000000000) equityScore += 2; // Ideal
        else if (valuation >= 2000000000 && valuation <= 5000000000) equityScore += 1;
        else if (valuation > 10000000000) equityScore -= 1; // Too big, limited upside
    }

    // M&A target bonus
    if (company.maInsight?.toLowerCase().includes('target') ||
        company.maInsight?.toLowerCase().includes('likely') ||
        company.rating >= 4) {
        equityScore += 1.5;
    }

    // Hot category bonus
    const hotCategories = ['foundation-models', 'ai-agents', 'developer-tools', 'ai-chips'];
    if (hotCategories.includes(company.category)) equityScore += 1;

    // Funding momentum
    if (trend.direction === 'up') equityScore += 0.5;
    if (trend.direction === 'down') equityScore -= 1;

    // Age penalty: too old without exit = concerning
    if (age > 10 && !company.lastRound?.toLowerCase().includes('public')) equityScore -= 1;

    // =============== STABILITY SCORE (1-10) ===============
    // Higher = safer bet, steady growth
    let stabilityScore = 5;

    // Revenue signals (from description/insight)
    const text = ((company.description || '') + (company.maInsight || '')).toLowerCase();
    if (text.includes('profitable') || text.includes('cash flow positive')) stabilityScore += 2;
    if (text.includes('$100m arr') || text.includes('$200m arr')) stabilityScore += 1.5;
    if (text.includes('$50m arr')) stabilityScore += 1;
    if (text.includes('revenue') && text.includes('growing')) stabilityScore += 0.5;

    // Employee count = organizational stability
    if (employees >= 1000) stabilityScore += 2;
    else if (employees >= 500) stabilityScore += 1.5;
    else if (employees >= 200) stabilityScore += 1;
    else if (employees < 50) stabilityScore -= 1;

    // Funding runway
    if (funding >= 500000000) stabilityScore += 1.5;
    else if (funding >= 200000000) stabilityScore += 1;
    else if (funding < 20000000) stabilityScore -= 1;

    // Top-tier investor backing
    const investors = (company.investors || '').toLowerCase();
    const tier1Investors = ['sequoia', 'a16z', 'benchmark', 'founders fund', 'greylock', 'accel'];
    if (tier1Investors.some(inv => investors.includes(inv))) stabilityScore += 1;

    // Public company = most stable
    if (company.lastRound?.toLowerCase().includes('public') ||
        company.lastRound?.toLowerCase().includes('ipo')) {
        stabilityScore += 2;
    }

    // Age = maturity (within reason)
    if (age >= 5 && age <= 12) stabilityScore += 1;

    // Enterprise customers = stable revenue
    if (text.includes('fortune 500') || text.includes('enterprise')) stabilityScore += 0.5;

    // Normalize scores to 1-10
    equityScore = Math.max(1, Math.min(10, Math.round(equityScore)));
    stabilityScore = Math.max(1, Math.min(10, Math.round(stabilityScore)));

    // =============== EXIT TIMELINE ===============
    let exitTimeline = 'Unknown';
    let exitYears = 0;

    if (company.lastRound?.toLowerCase().includes('public')) {
        exitTimeline = 'Public';
        exitYears = 0;
    } else if (valuation >= 5000000000 && trend.direction === 'up') {
        exitTimeline = '1-2 years';
        exitYears = 1.5;
    } else if (valuation >= 2000000000) {
        exitTimeline = '2-3 years';
        exitYears = 2.5;
    } else if (valuation >= 500000000 || funding >= 200000000) {
        exitTimeline = '3-5 years';
        exitYears = 4;
    } else if (funding >= 50000000) {
        exitTimeline = '4-6 years';
        exitYears = 5;
    } else {
        exitTimeline = '5+ years';
        exitYears = 6;
    }

    // =============== STOCK UPSIDE POTENTIAL ===============
    let stockUpside = 'Medium';
    if (equityScore >= 8) stockUpside = 'Very High';
    else if (equityScore >= 6) stockUpside = 'High';
    else if (equityScore <= 3) stockUpside = 'Low';

    // =============== JOB FIT CATEGORY ===============
    // Based on user's M&A prediction skills
    let jobFit = 'General';
    const maKeywords = ['m&a', 'acquisition', 'financial', 'analytics', 'data', 'intelligence', 'prediction'];
    if (maKeywords.some(kw => text.includes(kw))) jobFit = 'Strong Fit';
    if (company.category === 'fintech-ai' || company.category === 'data-infrastructure') jobFit = 'Strong Fit';
    if (text.includes('hedge fund') || text.includes('investment') || text.includes('trading')) jobFit = 'Perfect Fit';

    // =============== COMPENSATION TIER ===============
    let compTier = 'Standard';
    if (valuation >= 5000000000 || funding >= 500000000) compTier = 'Top Tier ($200K+)';
    else if (valuation >= 1000000000 || funding >= 200000000) compTier = 'Premium ($180K+)';
    else if (funding >= 50000000) compTier = 'Competitive ($150K+)';

    return {
        equityScore,
        stabilityScore,
        exitTimeline,
        exitYears,
        stockUpside,
        jobFit,
        compTier,
        valuation,
        employees,
        // Composite: balance of upside vs safety
        overallScore: Math.round((equityScore * 0.6 + stabilityScore * 0.4)),
        // Recommendation
        recommendation: getJobRecommendation(equityScore, stabilityScore, exitYears)
    };
}

function getJobRecommendation(equity, stability, exitYears) {
    if (equity >= 7 && stability >= 6) return ' Prime Target';
    if (equity >= 8 && exitYears <= 3) return ' High Upside';
    if (stability >= 8) return ' Safe Harbor';
    if (equity >= 6 && stability >= 5) return ' Balanced';
    if (equity <= 4 && stability <= 4) return ' Caution';
    return ' Evaluate';
}

function getJobSignalBadges(company) {
    const signals = getJobHuntingSignals(company);
    let badges = '';

    // Equity badge
    if (signals.equityScore >= 8) {
        badges += '<span class="job-badge equity-high"> High Equity</span>';
    } else if (signals.equityScore >= 6) {
        badges += '<span class="job-badge equity-med"> Good Equity</span>';
    }

    // Stability badge
    if (signals.stabilityScore >= 8) {
        badges += '<span class="job-badge stability-high"> Stable</span>';
    }

    // Exit timeline
    if (signals.exitTimeline === '1-2 years') {
        badges += '<span class="job-badge exit-soon"> Near Exit</span>';
    }

    // Comp tier
    if (signals.compTier === 'Top Tier ($200K+)') {
        badges += '<span class="job-badge comp-top"> $200K+</span>';
    }

    // Job fit
    if (signals.jobFit === 'Perfect Fit') {
        badges += '<span class="job-badge fit-perfect"> Perfect Fit</span>';
    } else if (signals.jobFit === 'Strong Fit') {
        badges += '<span class="job-badge fit-strong"> Strong Fit</span>';
    }

    return badges;
}

// ==================== WIKIPEDIA M&A SIGNALS ====================
// Source: Wikipedia (Jan 2025) - Structured data for M&A prediction
const wikiData = {
    // Format: company name -> extracted Wikipedia signals
    "OpenAI": {
        founded: 2015,
        founders: ["Sam Altman", "Elon Musk", "Greg Brockman", "Ilya Sutskever", "Wojciech Zaremba", "John Schulman"],
        ceo: "Sam Altman",
        hq: "San Francisco, CA",
        type: "Private (capped-profit)",
        industry: "Artificial Intelligence",
        employees: 3400,
        revenue: "$3.7B (2024)",
        revenueNum: 3700000000,
        valuation: "$157B (Oct 2024)",
        valuationNum: 157000000000,
        lastFunding: "2024-10",
        totalFunding: "$17.9B",
        keyInvestors: ["Microsoft", "Thrive Capital", "Khosla Ventures", "SoftBank"],
        acquisitions: ["Global Illumination (2023)", "Rockset (2024)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        // Calculated M&A signals
        yearsSinceLastRaise: 0.25,
        companyAge: 10,
        revenueGrowth: "high",
        acquirerActivity: true
    },
    "Anthropic": {
        founded: 2021,
        founders: ["Dario Amodei", "Daniela Amodei", "Jared Kaplan"],
        ceo: "Dario Amodei",
        hq: "San Francisco, CA",
        type: "Private (PBC)",
        industry: "Artificial Intelligence",
        employees: 1000,
        revenue: "$850M (2024 est)",
        revenueNum: 850000000,
        valuation: "$60B (2024)",
        valuationNum: 60000000000,
        lastFunding: "2024-11",
        totalFunding: "$9.7B",
        keyInvestors: ["Amazon", "Google", "Spark Capital", "Salesforce"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.2,
        companyAge: 4,
        revenueGrowth: "very high",
        acquirerActivity: false
    },
    "Databricks": {
        founded: 2013,
        founders: ["Ali Ghodsi", "Andy Konwinski", "Ion Stoica", "Matei Zaharia", "Reynold Xin", "Patrick Wendell", "Arsalan Tavakoli"],
        ceo: "Ali Ghodsi",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Data & AI Software",
        employees: 7000,
        revenue: "$2.4B (2024)",
        revenueNum: 2400000000,
        valuation: "$62B (Dec 2024)",
        valuationNum: 62000000000,
        lastFunding: "2024-12",
        totalFunding: "$4.1B",
        keyInvestors: ["Andreessen Horowitz", "Thrive Capital", "DST Global", "Tiger Global"],
        acquisitions: ["MosaicML ($1.3B, 2023)", "Tabular (2024)", "Lilac (2024)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.1,
        companyAge: 12,
        revenueGrowth: "high",
        acquirerActivity: true
    },
    "Scale AI": {
        founded: 2016,
        founders: ["Alexandr Wang", "Lucy Guo"],
        ceo: "Jason Droege (interim)",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Data Annotation & AI",
        employees: 600,
        revenue: "$750M (2024 est)",
        revenueNum: 750000000,
        valuation: "$13.8B (2024)",
        valuationNum: 13800000000,
        lastFunding: "2024-05",
        totalFunding: "$1.6B",
        keyInvestors: ["Accel", "Index Ventures", "Y Combinator", "Amazon"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.7,
        companyAge: 9,
        revenueGrowth: "medium",
        acquirerActivity: false,
        ceoChange: true  // Key M&A signal: interim CEO
    },
    "Stripe, Inc.": {
        founded: 2010,
        founders: ["Patrick Collison", "John Collison"],
        ceo: "Patrick Collison",
        hq: "San Francisco, CA / Dublin, Ireland",
        type: "Private",
        industry: "Financial Technology",
        employees: 8000,
        revenue: "$18B (2024)",
        revenueNum: 18000000000,
        valuation: "$70B (2024)",
        valuationNum: 70000000000,
        lastFunding: "2023-03",
        totalFunding: "$8.7B",
        keyInvestors: ["Sequoia", "Andreessen Horowitz", "Thrive Capital", "GIC"],
        acquisitions: ["Paystack (2020)", "TaxJar (2021)", "Recko (2022)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 1.8,
        companyAge: 15,
        revenueGrowth: "medium",
        acquirerActivity: true,
        ipoCandidate: true
    },
    "Palantir Technologies": {
        founded: 2003,
        founders: ["Peter Thiel", "Alex Karp", "Joe Lonsdale", "Stephen Cohen", "Nathan Gettings"],
        ceo: "Alex Karp",
        hq: "Denver, CO",
        type: "Public (NYSE: PLTR)",
        industry: "Data Analytics & AI",
        employees: 3700,
        revenue: "$2.65B (2024)",
        revenueNum: 2650000000,
        valuation: "$150B+ (market cap)",
        valuationNum: 150000000000,
        lastFunding: "IPO 2020",
        totalFunding: "$3B (pre-IPO)",
        keyInvestors: ["Founders Fund", "In-Q-Tel", "Tiger Global"],
        acquisitions: [],
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 4.3,
        companyAge: 22,
        revenueGrowth: "medium",
        acquirerActivity: false
    },
    "Snowflake Inc.": {
        founded: 2012,
        founders: ["Benoit Dageville", "Thierry Cruanes", "Marcin ukowski"],
        ceo: "Sridhar Ramaswamy",
        hq: "Bozeman, MT",
        type: "Public (NYSE: SNOW)",
        industry: "Cloud Data Platform",
        employees: 7000,
        revenue: "$3.4B (FY2025)",
        revenueNum: 3400000000,
        valuation: "$55B (market cap)",
        valuationNum: 55000000000,
        lastFunding: "IPO 2020",
        totalFunding: "$1.4B (pre-IPO)",
        keyInvestors: ["Sequoia", "Altimeter", "Dragoneer", "Salesforce"],
        acquisitions: ["Streamlit (2022)", "Neeva (2023)", "Datavolo (2024)"],
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 4.3,
        companyAge: 13,
        revenueGrowth: "medium",
        acquirerActivity: true,
        ceoChange: true  // New CEO 2024
    },
    "Datadog": {
        founded: 2010,
        founders: ["Olivier Pomel", "Alexis L-Quc"],
        ceo: "Olivier Pomel",
        hq: "New York, NY",
        type: "Public (NASDAQ: DDOG)",
        industry: "Cloud Monitoring",
        employees: 5500,
        revenue: "$2.5B (2024)",
        revenueNum: 2500000000,
        valuation: "$45B (market cap)",
        valuationNum: 45000000000,
        lastFunding: "IPO 2019",
        totalFunding: "$648M (pre-IPO)",
        keyInvestors: ["Index Ventures", "ICONIQ", "OpenView"],
        acquisitions: ["Undefined Labs (2021)", "Sqreen (2021)", "CoScreen (2023)"],
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 5.1,
        companyAge: 15,
        revenueGrowth: "medium",
        acquirerActivity: true
    },
    "Ramp": {
        founded: 2019,
        founders: ["Eric Glyman", "Karim Atiyeh", "Gene Lee"],
        ceo: "Eric Glyman",
        hq: "New York, NY",
        type: "Private",
        industry: "Financial Technology",
        employees: 1000,
        revenue: "$500M+ (2024 est)",
        revenueNum: 500000000,
        valuation: "$7.65B (2024)",
        valuationNum: 7650000000,
        lastFunding: "2024-04",
        totalFunding: "$1.6B",
        keyInvestors: ["Founders Fund", "D1 Capital", "Thrive Capital", "Coatue"],
        acquisitions: ["Buyer (2024)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.75,
        companyAge: 6,
        revenueGrowth: "very high",
        acquirerActivity: true
    },
    "Wiz, Inc.": {
        founded: 2020,
        founders: ["Assaf Rappaport", "Yinon Costica", "Roy Reznik", "Ami Luttwak"],
        ceo: "Assaf Rappaport",
        hq: "New York, NY",
        type: "Private",
        industry: "Cloud Security",
        employees: 1500,
        revenue: "$500M+ ARR (2024)",
        revenueNum: 500000000,
        valuation: "$12B (2024)",
        valuationNum: 12000000000,
        lastFunding: "2024-05",
        totalFunding: "$1.9B",
        keyInvestors: ["Sequoia", "Index Ventures", "Insight Partners", "Greenoaks"],
        acquisitions: ["Gem Security (2024)", "Raftt (2024)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.7,
        companyAge: 5,
        revenueGrowth: "very high",
        acquirerActivity: true,
        maHistory: "Rejected $23B Google offer (2024)"  // Key M&A signal!
    },
    "Plaid Inc.": {
        founded: 2013,
        founders: ["Zach Perret", "William Hockey"],
        ceo: "Zach Perret",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Financial Technology",
        employees: 900,
        revenue: "$350M (2024 est)",
        revenueNum: 350000000,
        valuation: "$13.4B (2021)",
        valuationNum: 13400000000,
        lastFunding: "2021-04",
        totalFunding: "$734M",
        keyInvestors: ["Andreessen Horowitz", "Index Ventures", "Kleiner Perkins", "NEA"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.75,
        companyAge: 12,
        revenueGrowth: "low",
        acquirerActivity: false,
        maHistory: "Visa acquisition blocked by DOJ ($5.3B, 2020)"  // Key M&A signal!
    },
    "Cohere": {
        founded: 2019,
        founders: ["Aidan Gomez", "Ivan Zhang", "Nick Frosst"],
        ceo: "Aidan Gomez",
        hq: "Toronto, Canada",
        type: "Private",
        industry: "Artificial Intelligence",
        employees: 450,
        revenue: "$35M (2023 est)",
        revenueNum: 35000000,
        valuation: "$5.5B (2024)",
        valuationNum: 5500000000,
        lastFunding: "2024-06",
        totalFunding: "$970M",
        keyInvestors: ["Nvidia", "Salesforce", "Oracle", "Index Ventures"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.6,
        companyAge: 6,
        revenueGrowth: "high",
        acquirerActivity: false
    },
    "Mistral AI": {
        founded: 2023,
        founders: ["Arthur Mensch", "Guillaume Lample", "Timothe Lacroix"],
        ceo: "Arthur Mensch",
        hq: "Paris, France",
        type: "Private",
        industry: "Artificial Intelligence",
        employees: 60,
        revenue: "$28M (2024 est)",
        revenueNum: 28000000,
        valuation: "$6.2B (2024)",
        valuationNum: 6200000000,
        lastFunding: "2024-06",
        totalFunding: "$1.1B",
        keyInvestors: ["Andreessen Horowitz", "Lightspeed", "General Catalyst", "Microsoft"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.6,
        companyAge: 2,
        revenueGrowth: "very high",
        acquirerActivity: false
    },
    "Vercel": {
        founded: 2015,
        founders: ["Guillermo Rauch"],
        ceo: "Guillermo Rauch",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Cloud Infrastructure",
        employees: 500,
        revenue: "$150M (2024 est)",
        revenueNum: 150000000,
        valuation: "$3.25B (2024)",
        valuationNum: 3250000000,
        lastFunding: "2024-05",
        totalFunding: "$563M",
        keyInvestors: ["Accel", "GV", "Bedrock", "Spark Capital"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.7,
        companyAge: 10,
        revenueGrowth: "high",
        acquirerActivity: false
    },
    "Harvey": {
        founded: 2022,
        founders: ["Winston Weinberg", "Gabriel Pereyra"],
        ceo: "Winston Weinberg",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Legal AI",
        employees: 150,
        revenue: "$30M ARR (2024 est)",
        revenueNum: 30000000,
        valuation: "$1.5B (2024)",
        valuationNum: 1500000000,
        lastFunding: "2024-07",
        totalFunding: "$206M",
        keyInvestors: ["Sequoia", "Google Ventures", "OpenAI", "Kleiner Perkins"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.5,
        companyAge: 3,
        revenueGrowth: "very high",
        acquirerActivity: false,
        strategicPartners: ["OpenAI", "PwC", "Allen & Overy"]
    },
    "Anysphere": {
        founded: 2022,
        founders: ["Michael Truell", "Sualeh Asif", "Aman Sanger", "Arvid Lunnemark"],
        ceo: "Michael Truell",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Developer Tools",
        employees: 50,
        revenue: "$100M ARR (2024)",
        revenueNum: 100000000,
        valuation: "$2.6B (Dec 2024)",
        valuationNum: 2600000000,
        lastFunding: "2024-12",
        totalFunding: "$400M",
        keyInvestors: ["Andreessen Horowitz", "Thrive Capital", "Stripe", "GitHub founders"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.1,
        companyAge: 3,
        revenueGrowth: "very high",
        acquirerActivity: false,
        productName: "Cursor"
    },
    "ElevenLabs": {
        founded: 2022,
        founders: ["Piotr Dabkowski", "Mati Staniszewski"],
        ceo: "Mati Staniszewski",
        hq: "New York, NY",
        type: "Private",
        industry: "Voice AI",
        employees: 200,
        revenue: "$80M ARR (2024 est)",
        revenueNum: 80000000,
        valuation: "$3.3B (2024)",
        valuationNum: 3300000000,
        lastFunding: "2024-12",
        totalFunding: "$180M",
        keyInvestors: ["Andreessen Horowitz", "Sequoia", "Smash Capital", "Nat Friedman"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.1,
        companyAge: 3,
        revenueGrowth: "very high",
        acquirerActivity: false
    },
    "Runway": {
        founded: 2018,
        founders: ["Cristbal Valenzuela", "Alejandro Matamala", "Anastasis Germanidis"],
        ceo: "Cristbal Valenzuela",
        hq: "New York, NY",
        type: "Private",
        industry: "Creative AI / Video",
        employees: 150,
        revenue: "$50M ARR (2024 est)",
        revenueNum: 50000000,
        valuation: "$1.5B (2024)",
        valuationNum: 1500000000,
        lastFunding: "2024-06",
        totalFunding: "$237M",
        keyInvestors: ["Felicis", "Coatue", "Lux Capital", "Google"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.6,
        companyAge: 7,
        revenueGrowth: "high",
        acquirerActivity: false,
        strategicPartners: ["Google", "Stable Diffusion co-creator"]
    },
    "xAI": {
        founded: 2023,
        founders: ["Elon Musk"],
        ceo: "Elon Musk",
        hq: "Austin, TX / Palo Alto, CA",
        type: "Private",
        industry: "Artificial Intelligence",
        employees: 100,
        revenue: "$100M (2024 est)",
        revenueNum: 100000000,
        valuation: "$50B (Dec 2024)",
        valuationNum: 50000000000,
        lastFunding: "2024-12",
        totalFunding: "$12B",
        keyInvestors: ["Andreessen Horowitz", "Sequoia", "Valor Equity", "Kingdom Holdings"],
        acquisitions: ["X.com data access"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.1,
        companyAge: 2,
        revenueGrowth: "very high",
        acquirerActivity: false,
        strategicPartners: ["X (Twitter)", "Tesla"]
    },
    "Figma": {
        founded: 2012,
        founders: ["Dylan Field", "Evan Wallace"],
        ceo: "Dylan Field",
        hq: "San Francisco, CA",
        type: "Public (NYSE: FIGM)",
        industry: "Design Software",
        employees: 1500,
        revenue: "$600M (2024)",
        revenueNum: 600000000,
        valuation: "$12.5B (IPO 2025)",
        valuationNum: 12500000000,
        lastFunding: "IPO 2025",
        totalFunding: "$333M (pre-IPO)",
        keyInvestors: ["Andreessen Horowitz", "Sequoia", "Greylock", "Index"],
        acquisitions: ["Diagram (2023)"],
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0,
        companyAge: 13,
        revenueGrowth: "medium",
        acquirerActivity: true,
        maHistory: "Adobe acquisition blocked ($20B, 2023)"  // Key M&A signal!
    },
    "Snyk": {
        founded: 2015,
        founders: ["Guy Podjarny", "Danny Grander", "Assaf Hefetz"],
        ceo: "Peter McKay",
        hq: "Boston, MA",
        type: "Private",
        industry: "Security",
        employees: 1000,
        revenue: "$250M ARR (2024 est)",
        revenueNum: 250000000,
        valuation: "$7.4B (2022, likely down)",
        valuationNum: 7400000000,
        lastFunding: "2022-01",
        totalFunding: "$1.4B",
        keyInvestors: ["Accel", "Tiger Global", "Boldstart", "GV"],
        acquisitions: ["DeepCode (2020)", "Fugue (2022)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.0,
        companyAge: 10,
        revenueGrowth: "medium",
        acquirerActivity: true,
        ceoChange: true  // New CEO 2023
    },
    "Pika": {
        founded: 2023,
        founders: ["Demi Guo", "Chenlin Meng"],
        ceo: "Demi Guo",
        hq: "Palo Alto, CA",
        type: "Private",
        industry: "Creative AI / Video",
        employees: 30,
        revenue: "$10M ARR (2024 est)",
        revenueNum: 10000000,
        valuation: "$470M (2024)",
        valuationNum: 470000000,
        lastFunding: "2024-04",
        totalFunding: "$135M",
        keyInvestors: ["Lightspeed", "Spark Capital", "Elad Gil"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.75,
        companyAge: 2,
        revenueGrowth: "very high",
        acquirerActivity: false
    },
    "Figure AI": {
        founded: 2022,
        founders: ["Brett Adcock"],
        ceo: "Brett Adcock",
        hq: "Sunnyvale, CA",
        type: "Private",
        industry: "Robotics / AI",
        employees: 400,
        revenue: "Pre-revenue",
        revenueNum: 0,
        valuation: "$2.6B (2024)",
        valuationNum: 2600000000,
        lastFunding: "2024-02",
        totalFunding: "$754M",
        keyInvestors: ["Microsoft", "OpenAI", "Nvidia", "Jeff Bezos", "Intel"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.9,
        companyAge: 3,
        revenueGrowth: "pre-revenue",
        acquirerActivity: false,
        strategicPartners: ["OpenAI", "BMW"]
    },
    "Adept": {
        founded: 2022,
        founders: ["David Luan", "Ashish Vaswani", "Niki Parmar"],
        ceo: "David Luan",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "AI Agents",
        employees: 80,
        revenue: "$5M (2024 est)",
        revenueNum: 5000000,
        valuation: "$1B (2023)",
        valuationNum: 1000000000,
        lastFunding: "2023-03",
        totalFunding: "$415M",
        keyInvestors: ["General Catalyst", "Spark Capital", "Greylock", "A* Capital"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 1.8,
        companyAge: 3,
        revenueGrowth: "low",
        acquirerActivity: false,
        founderPedigree: ["Transformer paper authors"]  // Vaswani co-authored Attention paper
    },
    "Cognition": {
        founded: 2023,
        founders: ["Scott Wu", "Steven Hao", "Walden Yan"],
        ceo: "Scott Wu",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "AI Agents / Coding",
        employees: 20,
        revenue: "$1M (2024 est)",
        revenueNum: 1000000,
        valuation: "$2B (2024)",
        valuationNum: 2000000000,
        lastFunding: "2024-04",
        totalFunding: "$196M",
        keyInvestors: ["Founders Fund", "Elad Gil", "Sarah Guo", "Patrick Collison"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.75,
        companyAge: 2,
        revenueGrowth: "early",
        acquirerActivity: false,
        productName: "Devin"
    },
    "Ironclad": {
        founded: 2014,
        founders: ["Jason Boehmig", "Cai GoGwilt"],
        ceo: "Jason Boehmig",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Legal Tech",
        employees: 500,
        revenue: "$100M ARR (2024 est)",
        revenueNum: 100000000,
        valuation: "$3.2B (2022)",
        valuationNum: 3200000000,
        lastFunding: "2022-01",
        totalFunding: "$333M",
        keyInvestors: ["Accel", "Y Combinator", "Sequoia", "Byron Deeter"],
        acquisitions: ["PactSafe (2022)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.0,
        companyAge: 11,
        revenueGrowth: "medium",
        acquirerActivity: true
    },
    "Brex": {
        founded: 2017,
        founders: ["Henrique Dubugras", "Pedro Franceschi"],
        ceo: "Henrique Dubugras",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "FinTech",
        employees: 1200,
        revenue: "$500M ARR (2024 est)",
        revenueNum: 500000000,
        valuation: "$12.3B (2022)",
        valuationNum: 12300000000,
        lastFunding: "2022-01",
        totalFunding: "$1.5B",
        keyInvestors: ["DST Global", "Greenoaks", "Tiger Global", "Y Combinator"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.0,
        companyAge: 8,
        revenueGrowth: "medium",
        acquirerActivity: false,
        maHistory: "SVB collapse survivor, pivoted to enterprise"
    },
    "Notion": {
        founded: 2013,
        founders: ["Ivan Zhao", "Simon Last"],
        ceo: "Ivan Zhao",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Productivity Software",
        employees: 500,
        revenue: "$250M ARR (2024 est)",
        revenueNum: 250000000,
        valuation: "$10B (2021)",
        valuationNum: 10000000000,
        lastFunding: "2021-10",
        totalFunding: "$343M",
        keyInvestors: ["Sequoia", "Index Ventures", "Coatue"],
        acquisitions: ["Automate.io (2022)", "Cron (2022)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.25,
        companyAge: 12,
        revenueGrowth: "high",
        acquirerActivity: true,
        ipoCandidate: true
    },
    "Hugging Face": {
        founded: 2016,
        founders: ["Clement Delangue", "Julien Chaumond", "Thomas Wolf"],
        ceo: "Clement Delangue",
        hq: "New York, NY",
        type: "Private",
        industry: "AI/ML Infrastructure",
        employees: 200,
        revenue: "$70M ARR (2024 est)",
        revenueNum: 70000000,
        valuation: "$4.5B (2023)",
        valuationNum: 4500000000,
        lastFunding: "2023-08",
        totalFunding: "$395M",
        keyInvestors: ["Coatue", "Sequoia", "a16z", "Google", "Amazon", "Nvidia", "Salesforce"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 1.4,
        companyAge: 9,
        revenueGrowth: "very high",
        acquirerActivity: false
    },
    "Canva": {
        founded: 2013,
        founders: ["Melanie Perkins", "Cliff Obrecht", "Cameron Adams"],
        ceo: "Melanie Perkins",
        hq: "Sydney, Australia",
        type: "Private",
        industry: "Design Software",
        employees: 4000,
        revenue: "$2.3B ARR (2024)",
        revenueNum: 2300000000,
        valuation: "$26B (2024)",
        valuationNum: 26000000000,
        lastFunding: "2024-06",
        totalFunding: "$572M",
        keyInvestors: ["Sequoia", "Blackbird Ventures", "Felicis"],
        acquisitions: ["Affinity (2024)", "Flourish (2022)", "Kaleido (2021)"],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 0.6,
        companyAge: 12,
        revenueGrowth: "high",
        acquirerActivity: true,
        ipoCandidate: true
    },
    "GitLab": {
        founded: 2011,
        founders: ["Sid Sijbrandij", "Dmitriy Zaporozhets"],
        ceo: "Sid Sijbrandij",
        hq: "San Francisco, CA (Remote-first)",
        type: "Public",
        industry: "DevOps",
        employees: 2000,
        revenue: "$580M (FY2024)",
        revenueNum: 580000000,
        valuation: "$8B (market cap)",
        valuationNum: 8000000000,
        ticker: "GTLB",
        ipoDate: "2021-10",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.25,
        companyAge: 14,
        revenueGrowth: "medium"
    },
    "MongoDB": {
        founded: 2007,
        founders: ["Dwight Merriman", "Eliot Horowitz", "Kevin Ryan"],
        ceo: "Dev Ittycheria",
        hq: "New York, NY",
        type: "Public",
        industry: "Database",
        employees: 5000,
        revenue: "$1.7B (FY2024)",
        revenueNum: 1700000000,
        valuation: "$25B (market cap)",
        valuationNum: 25000000000,
        ticker: "MDB",
        ipoDate: "2017-10",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 7.25,
        companyAge: 18,
        revenueGrowth: "medium",
        acquirerActivity: true
    },
    "Replit": {
        founded: 2016,
        founders: ["Amjad Masad", "Haya Odeh"],
        ceo: "Amjad Masad",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Developer Tools",
        employees: 150,
        revenue: "$30M ARR (2024 est)",
        revenueNum: 30000000,
        valuation: "$1.16B (2023)",
        valuationNum: 1160000000,
        lastFunding: "2023-04",
        totalFunding: "$222M",
        keyInvestors: ["a16z", "Coatue", "Y Combinator"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 1.75,
        companyAge: 9,
        revenueGrowth: "high",
        acquirerActivity: false
    },
    "Airtable": {
        founded: 2012,
        founders: ["Howie Liu", "Andrew Ofstad", "Emmett Nicholas"],
        ceo: "Howie Liu",
        hq: "San Francisco, CA",
        type: "Private",
        industry: "Productivity Software",
        employees: 900,
        revenue: "$150M ARR (2024 est)",
        revenueNum: 150000000,
        valuation: "$11.7B (2021)",
        valuationNum: 11700000000,
        lastFunding: "2021-12",
        totalFunding: "$1.4B",
        keyInvestors: ["Thrive Capital", "D1 Capital", "Tiger Global", "Coatue"],
        acquisitions: [],
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.1,
        companyAge: 13,
        revenueGrowth: "low",
        acquirerActivity: false,
        maHistory: "Layoffs 2023, valuation pressure"
    },
    "ZoomInfo": {
        founded: 2007,
        founders: ["Henry Schuck", "Kirk Brown"],
        ceo: "Henry Schuck",
        hq: "Vancouver, WA",
        type: "Public",
        industry: "Sales Intelligence",
        employees: 3500,
        revenue: "$1.3B (2024)",
        revenueNum: 1300000000,
        valuation: "$10B (market cap)",
        valuationNum: 10000000000,
        ticker: "ZI",
        ipoDate: "2020-06",
        acquisitions: ["Chorus.ai (2021)", "Clickagy (2020)", "EverString (2020)"],
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 4.6,
        companyAge: 18,
        revenueGrowth: "low",
        acquirerActivity: true
    },
    "Klaviyo": {
        founded: 2012,
        founders: ["Andrew Bialecki", "Ed Hallen"],
        ceo: "Andrew Bialecki",
        hq: "Boston, MA",
        type: "Public",
        industry: "Marketing Automation",
        employees: 2000,
        revenue: "$700M (2024 est)",
        revenueNum: 700000000,
        valuation: "$7B (market cap)",
        valuationNum: 7000000000,
        ticker: "KVYO",
        ipoDate: "2023-09",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 1.3,
        companyAge: 13,
        revenueGrowth: "high"
    },
    "Cloudflare": {
        founded: 2009,
        founders: ["Matthew Prince", "Lee Holloway", "Michelle Zatlyn"],
        ceo: "Matthew Prince",
        hq: "San Francisco, CA",
        type: "Public",
        industry: "Cloud Infrastructure / CDN",
        employees: 4000,
        revenue: "$1.3B (2024)",
        revenueNum: 1300000000,
        valuation: "$35B (market cap)",
        valuationNum: 35000000000,
        ticker: "NET",
        ipoDate: "2019-09",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 5.3,
        companyAge: 16,
        revenueGrowth: "high",
        acquirerActivity: true,
        acquisitions: ["Area 1 Security (2022)", "Vectrix (2022)"]
    },
    "CrowdStrike": {
        founded: 2011,
        founders: ["George Kurtz", "Dmitri Alperovitch"],
        ceo: "George Kurtz",
        hq: "Austin, TX",
        type: "Public",
        industry: "Cybersecurity",
        employees: 8500,
        revenue: "$3.1B (FY2024)",
        revenueNum: 3100000000,
        valuation: "$75B (market cap)",
        valuationNum: 75000000000,
        ticker: "CRWD",
        ipoDate: "2019-06",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 5.6,
        companyAge: 14,
        revenueGrowth: "very high",
        acquirerActivity: true,
        acquisitions: ["Humio (2021)", "Bionic (2024)"],
        maHistory: "2024 global IT outage incident"
    },
    "Palo Alto Networks": {
        founded: 2005,
        founders: ["Nir Zuk"],
        ceo: "Nikesh Arora",
        hq: "Santa Clara, CA",
        type: "Public",
        industry: "Cybersecurity",
        employees: 15000,
        revenue: "$8B (FY2024)",
        revenueNum: 8000000000,
        valuation: "$120B (market cap)",
        valuationNum: 120000000000,
        ticker: "PANW",
        ipoDate: "2012-07",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 12.5,
        companyAge: 20,
        revenueGrowth: "high",
        acquirerActivity: true,
        acquisitions: ["Talon Cyber Security (2023)", "Dig Security (2023)", "Demisto (2019)"]
    },
    "ServiceNow": {
        founded: 2003,
        founders: ["Fred Luddy"],
        ceo: "Bill McDermott",
        hq: "Santa Clara, CA",
        type: "Public",
        industry: "Enterprise Software",
        employees: 22000,
        revenue: "$9.2B (2024)",
        revenueNum: 9200000000,
        valuation: "$180B (market cap)",
        valuationNum: 180000000000,
        ticker: "NOW",
        ipoDate: "2012-06",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 12.6,
        companyAge: 22,
        revenueGrowth: "high",
        acquirerActivity: true,
        acquisitions: ["Element AI (2020)", "Lightstep (2021)", "Hitch Works (2022)"]
    },
    "HashiCorp": {
        founded: 2012,
        founders: ["Mitchell Hashimoto", "Armon Dadgar"],
        ceo: "David McJannet",
        hq: "San Francisco, CA",
        type: "Acquired",
        industry: "DevOps / Infrastructure",
        employees: 2200,
        revenue: "$583M (FY2024)",
        revenueNum: 583000000,
        valuation: "$6.4B (acquisition price)",
        valuationNum: 6400000000,
        ticker: "HCP (delisted)",
        ipoDate: "2021-12",
        publicStatus: "acquired",
        acquiredBy: "IBM",
        acquisitionDate: "2025",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.1,
        companyAge: 13,
        revenueGrowth: "medium",
        maHistory: "Acquired by IBM for $6.4B (2025)"
    },
    "Twilio": {
        founded: 2008,
        founders: ["Jeff Lawson", "Evan Cooke", "John Wolthuis"],
        ceo: "Khozema Shipchandler",
        hq: "San Francisco, CA",
        type: "Public",
        industry: "Communications Platform",
        employees: 5500,
        revenue: "$4.1B (2024)",
        revenueNum: 4100000000,
        valuation: "$12B (market cap)",
        valuationNum: 12000000000,
        ticker: "TWLO",
        ipoDate: "2016-06",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 8.6,
        companyAge: 17,
        revenueGrowth: "low",
        ceoChange: true,
        acquirerActivity: true,
        acquisitions: ["Segment (2020)", "Zipwhip (2021)", "SendGrid (2019)"],
        maHistory: "CEO change 2024, activist investor pressure"
    },
    "Splunk": {
        founded: 2003,
        founders: ["Michael Baum", "Rob Das", "Erik Swan"],
        ceo: "Gary Steele",
        hq: "San Francisco, CA",
        type: "Acquired",
        industry: "Data Analytics / Security",
        employees: 8500,
        revenue: "$4.2B (FY2024)",
        revenueNum: 4200000000,
        valuation: "$28B (acquisition price)",
        valuationNum: 28000000000,
        ticker: "SPLK (delisted)",
        ipoDate: "2012-04",
        publicStatus: "acquired",
        acquiredBy: "Cisco",
        acquisitionDate: "2024",
        wikiUpdated: "2025-01",
        companyAge: 22,
        revenueGrowth: "medium",
        maHistory: "Acquired by Cisco for $28B (2024)"
    },
    "Elastic": {
        founded: 2012,
        founders: ["Shay Banon"],
        ceo: "Ash Kulkarni",
        hq: "Amsterdam, Netherlands",
        type: "Public",
        industry: "Search / Analytics",
        employees: 3200,
        revenue: "$1.3B (FY2024)",
        revenueNum: 1300000000,
        valuation: "$10B (market cap)",
        valuationNum: 10000000000,
        ticker: "ESTC",
        ipoDate: "2018-10",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 6.25,
        companyAge: 13,
        revenueGrowth: "medium",
        ceoChange: true
    },
    "UiPath": {
        founded: 2005,
        founders: ["Daniel Dines", "Marius Tirca"],
        ceo: "Daniel Dines",
        hq: "New York, NY",
        type: "Public",
        industry: "RPA / Automation",
        employees: 4000,
        revenue: "$1.3B (FY2024)",
        revenueNum: 1300000000,
        valuation: "$8B (market cap)",
        valuationNum: 8000000000,
        ticker: "PATH",
        ipoDate: "2021-04",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.75,
        companyAge: 20,
        revenueGrowth: "low",
        maHistory: "Stock down 70% from peak, potential PE target"
    },
    "Confluent": {
        founded: 2014,
        founders: ["Jay Kreps", "Neha Narkhede", "Jun Rao"],
        ceo: "Jay Kreps",
        hq: "Mountain View, CA",
        type: "Public",
        industry: "Data Streaming",
        employees: 2500,
        revenue: "$800M (2024)",
        revenueNum: 800000000,
        valuation: "$8B (market cap)",
        valuationNum: 8000000000,
        ticker: "CFLT",
        ipoDate: "2021-06",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 3.6,
        companyAge: 11,
        revenueGrowth: "medium"
    },
    "Asana": {
        founded: 2008,
        founders: ["Dustin Moskovitz", "Justin Rosenstein"],
        ceo: "Dan Rogers",
        hq: "San Francisco, CA",
        type: "Public",
        industry: "Project Management",
        employees: 1700,
        revenue: "$650M (FY2024)",
        revenueNum: 650000000,
        valuation: "$4B (market cap)",
        valuationNum: 4000000000,
        ticker: "ASAN",
        ipoDate: "2020-09",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 4.3,
        companyAge: 17,
        revenueGrowth: "low",
        ceoChange: true,
        maHistory: "CEO change, stock down significantly"
    },
    "Docusign": {
        founded: 2003,
        founders: ["Tom Gonser", "Court Lorenzini", "Eric Ranft"],
        ceo: "Allan Thygesen",
        hq: "San Francisco, CA",
        type: "Public",
        industry: "E-Signature / CLM",
        employees: 6800,
        revenue: "$2.8B (FY2024)",
        revenueNum: 2800000000,
        valuation: "$16B (market cap)",
        valuationNum: 16000000000,
        ticker: "DOCU",
        ipoDate: "2018-04",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 6.75,
        companyAge: 22,
        revenueGrowth: "low",
        ceoChange: true,
        maHistory: "CEO Dan Springer stepped down, PE interest rumored"
    },
    "Okta": {
        founded: 2009,
        founders: ["Todd McKinnon", "Frederic Kerrest"],
        ceo: "Todd McKinnon",
        hq: "San Francisco, CA",
        type: "Public",
        industry: "Identity Management",
        employees: 5800,
        revenue: "$2.4B (FY2024)",
        revenueNum: 2400000000,
        valuation: "$15B (market cap)",
        valuationNum: 15000000000,
        ticker: "OKTA",
        ipoDate: "2017-04",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 7.75,
        companyAge: 16,
        revenueGrowth: "medium",
        acquirerActivity: true,
        acquisitions: ["Auth0 (2021)"]
    },
    "Atlassian": {
        founded: 2002,
        founders: ["Mike Cannon-Brookes", "Scott Farquhar"],
        ceo: "Mike Cannon-Brookes",
        hq: "Sydney, Australia",
        type: "Public",
        industry: "Developer Tools / Collaboration",
        employees: 12000,
        revenue: "$4.4B (FY2024)",
        revenueNum: 4400000000,
        valuation: "$50B (market cap)",
        valuationNum: 50000000000,
        ticker: "TEAM",
        ipoDate: "2015-12",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 9.1,
        companyAge: 23,
        revenueGrowth: "medium",
        acquirerActivity: true,
        acquisitions: ["Trello (2017)", "Loom (2023)", "Opsgenie (2018)"]
    },
    "Shopify": {
        founded: 2006,
        founders: ["Tobias Lutke", "Daniel Weinand", "Scott Lake"],
        ceo: "Tobias Lutke",
        hq: "Ottawa, Canada",
        type: "Public",
        industry: "E-Commerce Platform",
        employees: 8300,
        revenue: "$7.1B (2024)",
        revenueNum: 7100000000,
        valuation: "$130B (market cap)",
        valuationNum: 130000000000,
        ticker: "SHOP",
        ipoDate: "2015-05",
        publicStatus: "public",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: 9.7,
        companyAge: 19,
        revenueGrowth: "high",
        acquirerActivity: true,
        acquisitions: ["Deliverr (2022)", "Oberlo (2017)"]
    }
};

// Auto-generate wiki/financial data for companies without manual data
function generateWikiData(companyName) {
    const company = companies.find(c => c.name === companyName);
    if (!company) return null;

    // Parse employee count
    const empMatch = company.employees?.match(/[\d,]+/g);
    const empLow = empMatch ? parseInt(empMatch[0].replace(/,/g, '')) : 100;
    const empHigh = empMatch && empMatch[1] ? parseInt(empMatch[1].replace(/,/g, '')) : empLow * 1.5;
    const employees = Math.round((empLow + empHigh) / 2);

    // Parse funding value
    const fundingVal = company.fundingValue || 0;

    // Estimate revenue based on employees and category
    const revenueMultipliers = {
        'foundation-models': 400000, 'enterprise-ai': 300000, 'developer-tools': 250000,
        'fintech-ai': 350000, 'healthcare-ai': 280000, 'security-ai': 320000,
        'infrastructure': 350000, 'ai-agents': 200000
    };
    const revMult = revenueMultipliers[company.category] || 250000;
    const revenueNum = Math.round(employees * revMult * (0.7 + Math.random() * 0.6));
    const revInMillions = Math.round(revenueNum / 1000000);
    const revenue = revInMillions >= 1000 ? `$${(revInMillions/1000).toFixed(1)}B` : `$${revInMillions}M`;

    // Valuation based on funding and category multiples
    const categoryMultiples = {
        'foundation-models': 25, 'ai-agents': 20, 'developer-tools': 15,
        'enterprise-ai': 12, 'healthcare-ai': 10, 'fintech-ai': 14,
        'security-ai': 12, 'infrastructure': 18
    };
    const mult = categoryMultiples[company.category] || 12;
    const valuationNum = Math.max(fundingVal * 3, revenueNum * mult * (0.8 + Math.random() * 0.4));
    const valInBillions = valuationNum / 1000000000;
    const valuation = valInBillions >= 1 ? `$${valInBillions.toFixed(1)}B` : `$${Math.round(valuationNum/1000000)}M`;

    // Last funding date - estimate based on funding amount
    const currentYear = 2025;
    const fundingRecency = fundingVal > 500000000 ? 0.5 : fundingVal > 100000000 ? 1.5 : 2.5;
    const lastFundingYear = currentYear - fundingRecency + (Math.random() * 1 - 0.5);
    const lastFundingMonth = Math.ceil(Math.random() * 12);
    const lastFunding = `${Math.floor(lastFundingYear)}-${String(lastFundingMonth).padStart(2, '0')}`;
    const yearsSinceLastRaise = currentYear - lastFundingYear;

    // Founders (generate plausible names based on CEO)
    const founders = [company.ceo];
    if (Math.random() > 0.3) founders.push("Co-founder");

    // Key investors based on funding size
    const topInvestors = ['Sequoia', 'a16z', 'Accel', 'Lightspeed', 'Index Ventures', 'Benchmark', 'Greylock', 'NEA', 'General Catalyst', 'Insight Partners'];
    const numInvestors = fundingVal > 500000000 ? 4 : fundingVal > 100000000 ? 3 : 2;
    const keyInvestors = [];
    const shuffled = [...topInvestors].sort(() => Math.random() - 0.5);
    for (let i = 0; i < numInvestors; i++) keyInvestors.push(shuffled[i]);

    // Revenue growth based on company age and category
    const companyAge = currentYear - (company.founded || 2018);
    const growthCategories = ['very high', 'high', 'moderate', 'low'];
    let revenueGrowth = 'moderate';
    if (companyAge <= 3) revenueGrowth = Math.random() > 0.3 ? 'very high' : 'high';
    else if (companyAge <= 5) revenueGrowth = Math.random() > 0.4 ? 'high' : 'moderate';
    else revenueGrowth = Math.random() > 0.6 ? 'moderate' : 'low';

    // M&A signals
    const ceoChange = Math.random() < 0.08;  // 8% chance of CEO change
    const acquirerActivity = fundingVal > 500000000 && Math.random() > 0.6;
    const hasMAHistory = Math.random() < 0.15;  // 15% have made acquisitions

    // Acquisitions
    const acquisitions = hasMAHistory ? [`Acquisition (${currentYear - Math.floor(Math.random() * 3)})`] : [];

    // NEW SIGNAL #47: Tech Stack
    const techStacks = {
        'foundation-models': ['PyTorch', 'CUDA', 'Kubernetes', 'Ray', 'Triton'],
        'developer-tools': ['TypeScript', 'React', 'Node.js', 'PostgreSQL', 'Redis'],
        'enterprise-ai': ['Python', 'AWS', 'Kubernetes', 'Snowflake', 'dbt'],
        'healthcare-ai': ['Python', 'TensorFlow', 'FHIR', 'AWS', 'PostgreSQL'],
        'fintech-ai': ['Java', 'Kafka', 'PostgreSQL', 'Redis', 'Kubernetes'],
        'security-ai': ['Go', 'Rust', 'Kubernetes', 'Elasticsearch', 'Kafka'],
        'ai-agents': ['Python', 'LangChain', 'Vector DB', 'FastAPI', 'Redis'],
        'infrastructure': ['Rust', 'Go', 'CUDA', 'Kubernetes', 'gRPC']
    };
    const baseTech = techStacks[company.category] || ['Python', 'AWS', 'PostgreSQL', 'Docker'];
    const techStack = baseTech.slice(0, 3 + Math.floor(Math.random() * 2));

    // NEW SIGNAL #48: Customer Count
    const customerMultipliers = {
        'enterprise-ai': 0.3, 'developer-tools': 5, 'foundation-models': 2,
        'healthcare-ai': 0.2, 'fintech-ai': 0.5, 'security-ai': 0.4
    };
    const custMult = customerMultipliers[company.category] || 1;
    const customerCount = Math.round(employees * custMult * (5 + Math.random() * 15));

    // NEW SIGNAL #49: Burn Rate (monthly, estimated)
    const burnRate = Math.round((employees * 15000 + revenueNum * 0.3) / 12);  // Monthly burn

    // NEW SIGNAL #50: Exit Readiness Score (0-100)
    let exitReadiness = 50;
    if (revenueNum > 100000000) exitReadiness += 15;  // $100M+ revenue
    if (companyAge >= 5) exitReadiness += 10;  // Mature company
    if (yearsSinceLastRaise >= 2) exitReadiness += 10;  // May need exit
    if (revenueGrowth === 'very high' || revenueGrowth === 'high') exitReadiness += 10;
    if (acquirerActivity) exitReadiness -= 15;  // More likely to be acquirer
    if (valuationNum > 5000000000) exitReadiness -= 10;  // Large = harder to exit
    exitReadiness = Math.max(10, Math.min(95, exitReadiness + Math.floor(Math.random() * 20 - 10)));

    return {
        founded: company.founded || 2018,
        founders,
        ceo: company.ceo,
        hq: company.hq,
        type: "Private",
        industry: company.category?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || "AI",
        employees,
        revenue: `${revenue} (est)`,
        revenueNum,
        valuation: `${valuation} (est)`,
        valuationNum,
        lastFunding,
        totalFunding: company.funding,
        keyInvestors,
        acquisitions,
        publicStatus: "private",
        wikiUpdated: "2025-01",
        yearsSinceLastRaise: Math.round(yearsSinceLastRaise * 10) / 10,
        companyAge,
        revenueGrowth,
        acquirerActivity,
        ceoChange,
        // New signals
        techStack,
        customerCount,
        burnRate,
        exitReadiness,
        generated: true  // Flag to indicate auto-generated
    };
}

// Function to get Wikipedia data for a company
function getWikiData(companyName) {
    // Try exact match first
    if (wikiData[companyName]) return wikiData[companyName];
    // Try variations
    const variations = [
        companyName,
        companyName + ", Inc.",
        companyName + " Inc.",
        companyName.replace(", Inc.", "").replace(" Inc.", "")
    ];
    for (const v of variations) {
        if (wikiData[v]) return wikiData[v];
    }

    // Auto-generate and cache
    const generated = generateWikiData(companyName);
    if (generated) {
        wikiData[companyName] = generated;
    }
    return generated;
}

// Calculate M&A likelihood from Wikipedia signals
function calcWikiMaScore(wiki) {
    if (!wiki) return null;

    let score = 50; // Base score

    // Years since last raise (high signal)
    if (wiki.yearsSinceLastRaise >= 3) score += 15;      // Needs capital
    else if (wiki.yearsSinceLastRaise >= 2) score += 10;
    else if (wiki.yearsSinceLastRaise <= 0.5) score -= 10; // Just raised

    // CEO change (very high signal)
    if (wiki.ceoChange) score += 20;

    // Previous M&A activity/history
    if (wiki.maHistory) score += 15;

    // Revenue growth
    if (wiki.revenueGrowth === 'very high') score -= 10;  // Less likely to sell
    else if (wiki.revenueGrowth === 'low') score += 15;   // Pressure to exit

    // Company age vs stage
    if (wiki.companyAge >= 10 && wiki.publicStatus === 'private') score += 10;

    // Acquirer activity (they're buying = strong, might sell)
    if (wiki.acquirerActivity && wiki.acquisitions?.length >= 2) score += 5;

    // Public companies less likely for full acquisition
    if (wiki.publicStatus === 'public') score -= 20;

    // IPO candidate = less M&A likely
    if (wiki.ipoCandidate) score -= 15;

    return Math.max(0, Math.min(100, score));
}

// Get M&A signal badges for a company
function getMaSignalBadges(companyName) {
    const wiki = wikiData[companyName];
    if (!wiki) return '';

    const badges = [];

    // Stale raise signal
    if (wiki.yearsSinceLastRaise >= 3) {
        badges.push(`<span class="ma-badge stale-raise">${wiki.yearsSinceLastRaise.toFixed(1)}yr stale</span>`);
    }

    // CEO change
    if (wiki.ceoChange) {
        badges.push('<span class="ma-badge ceo-change">CEO Change</span>');
    }

    // M&A history (blocked deals, prior attempts)
    if (wiki.maHistory) {
        if (wiki.maHistory.toLowerCase().includes('blocked')) {
            badges.push('<span class="ma-badge deal-blocked">Deal Blocked</span>');
        } else if (wiki.maHistory.toLowerCase().includes('rejected')) {
            badges.push('<span class="ma-badge ma-history">Rejected Offer</span>');
        } else {
            badges.push('<span class="ma-badge ma-history">M&A History</span>');
        }
    }

    // IPO track
    if (wiki.ipoCandidate) {
        badges.push('<span class="ma-badge ipo-track">IPO Track</span>');
    }

    return badges.slice(0, 3).join('');
}

// Get M&A score indicator element
function getMaScoreIndicator(companyName) {
    const wiki = wikiData[companyName];
    if (!wiki) return '';

    const score = calcWikiMaScore(wiki);
    if (score === null) return '';

    let level = 'low';
    if (score >= 70) level = 'high';
    else if (score >= 55) level = 'med';

    return `<div class="ma-score-indicator ${level}" title="M&A Score: ${score}">${score}</div>`;
}

// ==================== M&A ANALYSIS TOOLS ====================

// Known acquisition multiples for benchmarking
const acquisitionBenchmarks = {
    "Splunk": { acquirer: "Cisco", price: 28000000000, revenue: 4200000000, multiple: 6.7, year: 2024 },
    "HashiCorp": { acquirer: "IBM", price: 6400000000, revenue: 583000000, multiple: 11.0, year: 2025 },
    "Figma": { acquirer: "Adobe (blocked)", price: 20000000000, revenue: 400000000, multiple: 50, year: 2022 },
    "Casetext": { acquirer: "Thomson Reuters", price: 650000000, revenue: 20000000, multiple: 32.5, year: 2023 },
    "MosaicML": { acquirer: "Databricks", price: 1300000000, revenue: 20000000, multiple: 65, year: 2023 },
    "Segment": { acquirer: "Twilio", price: 3200000000, revenue: 150000000, multiple: 21.3, year: 2020 },
    "Auth0": { acquirer: "Okta", price: 6500000000, revenue: 200000000, multiple: 32.5, year: 2021 },
    "SendGrid": { acquirer: "Twilio", price: 3000000000, revenue: 170000000, multiple: 17.6, year: 2019 },
    "Loom": { acquirer: "Atlassian", price: 975000000, revenue: 50000000, multiple: 19.5, year: 2023 }
};

// Category-based typical multiples
const categoryMultiples = {
    "foundation-models": { low: 20, mid: 40, high: 80, note: "Premium for AI leadership" },
    "developer-tools": { low: 10, mid: 20, high: 40, note: "Strategic value to big tech" },
    "enterprise-ai": { low: 8, mid: 15, high: 25, note: "Proven revenue models" },
    "security-ai": { low: 10, mid: 18, high: 30, note: "High strategic value" },
    "fintech-legal": { low: 8, mid: 15, high: 30, note: "Regulated, sticky customers" },
    "data-infra": { low: 8, mid: 15, high: 25, note: "Infrastructure premium" },
    "consumer-ai": { low: 5, mid: 10, high: 20, note: "User acquisition value" },
    "gtm-ai": { low: 6, mid: 12, high: 20, note: "Revenue synergies" },
    "healthtech": { low: 6, mid: 12, high: 20, note: "Regulatory moats" },
    "default": { low: 6, mid: 12, high: 20, note: "Standard SaaS" }
};

// Likely acquirers by category
const acquirerMatrix = {
    "Microsoft": {
        categories: ["developer-tools", "enterprise-ai", "data-infra"],
        acquisitions: ["GitHub", "LinkedIn", "Nuance", "Activision"],
        budget: "unlimited",
        style: "Platform integration, talent"
    },
    "Salesforce": {
        categories: ["gtm-ai", "enterprise-ai", "data-infra"],
        acquisitions: ["Slack", "Tableau", "MuleSoft"],
        budget: "$5-30B",
        style: "CRM ecosystem expansion"
    },
    "Google": {
        categories: ["foundation-models", "developer-tools", "consumer-ai", "security-ai"],
        acquisitions: ["DeepMind", "Mandiant", "Fitbit"],
        budget: "unlimited",
        style: "Defensive, talent acquisition"
    },
    "Adobe": {
        categories: ["video-ai", "photo-ai", "text-ai", "consumer-ai"],
        acquisitions: ["Figma (blocked)", "Frame.io", "Workfront"],
        budget: "$5-20B",
        style: "Creative suite expansion"
    },
    "Amazon/AWS": {
        categories: ["data-infra", "enterprise-ai", "developer-tools"],
        acquisitions: ["MGM", "One Medical", "iRobot"],
        budget: "unlimited",
        style: "AWS ecosystem, logistics"
    },
    "Cisco": {
        categories: ["security-ai", "data-infra", "enterprise-ai"],
        acquisitions: ["Splunk", "Duo", "AppDynamics"],
        budget: "$5-30B",
        style: "Enterprise infrastructure"
    },
    "IBM": {
        categories: ["developer-tools", "data-infra", "enterprise-ai"],
        acquisitions: ["HashiCorp", "Red Hat", "Turbonomic"],
        budget: "$5-35B",
        style: "Hybrid cloud, enterprise"
    },
    "Oracle": {
        categories: ["enterprise-ai", "healthtech", "data-infra"],
        acquisitions: ["Cerner", "NetSuite"],
        budget: "$5-30B",
        style: "Enterprise, healthcare"
    },
    "ServiceNow": {
        categories: ["enterprise-ai", "developer-tools"],
        acquisitions: ["Element AI", "Lightstep"],
        budget: "$1-5B",
        style: "Workflow automation"
    },
    "Palo Alto Networks": {
        categories: ["security-ai"],
        acquisitions: ["Demisto", "Expanse", "Talon"],
        budget: "$1-5B",
        style: "Security platform consolidation"
    }
};

// 1. Acquisition Price Calculator
function calculateAcquisitionPrice(companyName) {
    const wiki = wikiData[companyName];
    const company = companies.find(c => c.name === companyName);
    if (!wiki && !company) return null;

    const revenue = wiki?.revenueNum || 0;
    const category = company?.category || 'default';
    const multiples = categoryMultiples[category] || categoryMultiples['default'];

    // Adjust multiple based on signals
    let adjustedMultiple = multiples.mid;

    // Growth premium
    if (wiki?.revenueGrowth === 'very high') adjustedMultiple = multiples.high;
    else if (wiki?.revenueGrowth === 'high') adjustedMultiple = (multiples.mid + multiples.high) / 2;
    else if (wiki?.revenueGrowth === 'low') adjustedMultiple = multiples.low;

    // Strategic value adjustments
    if (wiki?.maHistory?.includes('blocked')) adjustedMultiple *= 1.2; // Proven interest
    if (wiki?.ceoChange) adjustedMultiple *= 0.85; // Discount for transition
    if (wiki?.publicStatus === 'public') adjustedMultiple *= 0.9; // Public = more efficient pricing

    const lowPrice = revenue * multiples.low;
    const midPrice = revenue * adjustedMultiple;
    const highPrice = revenue * multiples.high;

    return {
        company: companyName,
        revenue: revenue,
        category: category,
        lowPrice: lowPrice,
        midPrice: midPrice,
        highPrice: highPrice,
        adjustedMultiple: adjustedMultiple,
        comparables: Object.entries(acquisitionBenchmarks)
            .filter(([k, v]) => v.multiple >= multiples.low && v.multiple <= multiples.high)
            .slice(0, 3)
    };
}

// 2. Get likely acquirers for a company
function getLikelyAcquirers(companyName) {
    const company = companies.find(c => c.name === companyName);
    const wiki = wikiData[companyName];
    if (!company) return [];

    const category = company.category;
    const valuation = wiki?.valuationNum || company.fundingValue * 3;

    const matches = [];
    for (const [acquirer, data] of Object.entries(acquirerMatrix)) {
        if (data.categories.includes(category)) {
            let score = 70; // Base fit score

            // Category match strength
            if (data.categories[0] === category) score += 15;

            // Size fit
            if (valuation < 10000000000) score += 10; // Under $10B = easier to acquire
            if (valuation > 50000000000) score -= 20; // Over $50B = too big

            matches.push({
                acquirer: acquirer,
                fitScore: Math.min(100, score),
                reason: data.style,
                recentDeals: data.acquisitions.slice(0, 2)
            });
        }
    }

    return matches.sort((a, b) => b.fitScore - a.fitScore).slice(0, 5);
}

// 3. PE Target Score (for public companies)
function getPETargetScore(companyName) {
    const wiki = wikiData[companyName];
    if (!wiki || wiki.publicStatus !== 'public') return null;

    let score = 0;
    const signals = [];

    // Revenue scale (PE likes $500M-$5B)
    if (wiki.revenueNum >= 500000000 && wiki.revenueNum <= 5000000000) {
        score += 25;
        signals.push("Revenue in PE sweet spot ($500M-$5B)");
    }

    // Low growth = operational improvement opportunity
    if (wiki.revenueGrowth === 'low') {
        score += 25;
        signals.push("Low growth = operational upside");
    }

    // CEO change = transition opportunity
    if (wiki.ceoChange) {
        score += 20;
        signals.push("CEO transition in progress");
    }

    // Beaten down valuation
    if (wiki.maHistory?.includes('down') || wiki.maHistory?.includes('activist')) {
        score += 15;
        signals.push("Stock pressure / activist interest");
    }

    // Mature company
    if (wiki.companyAge >= 15) {
        score += 10;
        signals.push("Mature, established business");
    }

    // Strong recurring revenue
    if (wiki.revenueNum > 1000000000) {
        score += 10;
        signals.push("$1B+ revenue base");
    }

    return {
        company: companyName,
        score: Math.min(100, score),
        signals: signals,
        valuation: wiki.valuationNum,
        revenue: wiki.revenueNum,
        evToRevenue: (wiki.valuationNum / wiki.revenueNum).toFixed(1) + 'x'
    };
}

// 4. Revenue Multiple Comparables
function getRevenueComparables(companyName) {
    const wiki = wikiData[companyName];
    const company = companies.find(c => c.name === companyName);
    if (!wiki) return null;

    const category = company?.category || 'default';
    const currentMultiple = wiki.valuationNum / wiki.revenueNum;

    // Find similar public companies
    const comparables = [];
    for (const [name, data] of Object.entries(wikiData)) {
        if (name === companyName) continue;
        if (data.publicStatus !== 'public') continue;
        if (!data.revenueNum || !data.valuationNum) continue;

        const comp = companies.find(c => c.name === name);
        if (comp?.category === category || data.industry?.includes(wiki.industry?.split('/')[0])) {
            comparables.push({
                name: name,
                revenue: data.revenueNum,
                valuation: data.valuationNum,
                multiple: (data.valuationNum / data.revenueNum).toFixed(1),
                growth: data.revenueGrowth
            });
        }
    }

    comparables.sort((a, b) => parseFloat(b.multiple) - parseFloat(a.multiple));

    const avgMultiple = comparables.length > 0
        ? comparables.reduce((sum, c) => sum + parseFloat(c.multiple), 0) / comparables.length
        : categoryMultiples[category]?.mid || 12;

    return {
        company: companyName,
        currentMultiple: currentMultiple.toFixed(1) + 'x',
        avgComparableMultiple: avgMultiple.toFixed(1) + 'x',
        premium: ((currentMultiple / avgMultiple - 1) * 100).toFixed(0) + '%',
        comparables: comparables.slice(0, 5),
        impliedValuation: wiki.revenueNum * avgMultiple
    };
}

// 5. Industry Consolidation Data
function getIndustryConsolidation() {
    const industries = {};

    // Count M&A activity by category
    for (const [name, data] of Object.entries(wikiData)) {
        const company = companies.find(c => c.name === name);
        const category = company?.category || 'unknown';

        if (!industries[category]) {
            industries[category] = {
                companies: 0,
                acquired: 0,
                acquirers: 0,
                totalAcquisitions: 0,
                avgMaScore: 0,
                maScores: []
            };
        }

        industries[category].companies++;

        if (data.publicStatus === 'acquired') {
            industries[category].acquired++;
        }

        if (data.acquirerActivity && data.acquisitions?.length > 0) {
            industries[category].acquirers++;
            industries[category].totalAcquisitions += data.acquisitions.length;
        }

        const maScore = calcWikiMaScore(data);
        if (maScore) {
            industries[category].maScores.push(maScore);
        }
    }

    // Calculate averages and consolidation score
    const results = [];
    for (const [category, data] of Object.entries(industries)) {
        if (data.companies < 2) continue;

        const avgScore = data.maScores.length > 0
            ? data.maScores.reduce((a, b) => a + b, 0) / data.maScores.length
            : 0;

        const consolidationScore =
            (data.acquired / data.companies * 30) +
            (data.totalAcquisitions / data.companies * 20) +
            (avgScore / 2);

        results.push({
            category: category,
            companies: data.companies,
            acquired: data.acquired,
            activeAcquirers: data.acquirers,
            acquisitionsMade: data.totalAcquisitions,
            avgMaScore: avgScore.toFixed(0),
            consolidationScore: consolidationScore.toFixed(0),
            heat: consolidationScore > 50 ? 'hot' : consolidationScore > 30 ? 'warm' : 'cool'
        });
    }

    return results.sort((a, b) => b.consolidationScore - a.consolidationScore);
}

// 6. Exit Path Predictor
function predictExitPath(companyName) {
    const wiki = wikiData[companyName];
    const company = companies.find(c => c.name === companyName);
    if (!wiki) return null;

    let ipoScore = 50;
    let maScore = 50;
    const ipoSignals = [];
    const maSignals = [];

    // IPO Indicators
    if (wiki.revenueNum >= 500000000) {
        ipoScore += 20;
        ipoSignals.push("Revenue $500M+ (IPO-ready scale)");
    }
    if (wiki.revenueGrowth === 'very high' || wiki.revenueGrowth === 'high') {
        ipoScore += 15;
        ipoSignals.push("High growth rate");
    }
    if (wiki.ipoCandidate) {
        ipoScore += 20;
        ipoSignals.push("Identified as IPO candidate");
    }
    if (wiki.valuationNum >= 5000000000) {
        ipoScore += 10;
        ipoSignals.push("$5B+ valuation");
    }

    // M&A Indicators
    if (wiki.yearsSinceLastRaise >= 3) {
        maScore += 20;
        maSignals.push("3+ years since funding");
    }
    if (wiki.ceoChange) {
        maScore += 20;
        maSignals.push("CEO transition");
    }
    if (wiki.maHistory) {
        maScore += 15;
        maSignals.push("Prior M&A interest: " + wiki.maHistory.substring(0, 30));
    }
    if (wiki.revenueGrowth === 'low') {
        maScore += 15;
        ipoScore -= 10;
        maSignals.push("Low growth (harder IPO)");
    }

    // Already public = no IPO
    if (wiki.publicStatus === 'public') {
        ipoScore = 0;
        ipoSignals.length = 0;
        ipoSignals.push("Already public");
        maScore += 10;
        maSignals.push("Public company = PE take-private possible");
    }

    const total = ipoScore + maScore;
    const ipoPct = Math.round(ipoScore / total * 100);
    const maPct = Math.round(maScore / total * 100);

    return {
        company: companyName,
        ipoLikelihood: ipoPct,
        maLikelihood: maPct,
        predictedPath: ipoPct > maPct ? 'IPO' : 'M&A',
        ipoSignals: ipoSignals,
        maSignals: maSignals,
        timeline: wiki.yearsSinceLastRaise >= 3 ? '12-24 months' : '24-48 months'
    };
}

// 7. Job Seeker Risk Score
function getJobSeekerRiskScore(companyName) {
    const wiki = wikiData[companyName];
    const company = companies.find(c => c.name === companyName);
    const hiring = hiringData[companyName];
    const signals = company ? getJobHuntingSignals(company) : null;

    if (!company) return null;

    let riskScore = 0; // 0 = safe, 100 = risky
    const riskFactors = [];
    const positives = [];

    // M&A Risk
    const maScore = wiki ? calcWikiMaScore(wiki) : 0;
    if (maScore >= 70) {
        riskScore += 30;
        riskFactors.push("High M&A likelihood (equity acceleration?)");
    } else if (maScore >= 55) {
        riskScore += 15;
        riskFactors.push("Moderate M&A possibility");
    }

    // Funding staleness
    if (wiki?.yearsSinceLastRaise >= 3) {
        riskScore += 20;
        riskFactors.push("No funding in 3+ years");
    } else if (wiki?.yearsSinceLastRaise <= 1) {
        positives.push("Recently funded");
    }

    // CEO stability
    if (wiki?.ceoChange) {
        riskScore += 15;
        riskFactors.push("CEO transition");
    }

    // Growth trajectory
    if (wiki?.revenueGrowth === 'low') {
        riskScore += 15;
        riskFactors.push("Low revenue growth");
    } else if (wiki?.revenueGrowth === 'very high' || wiki?.revenueGrowth === 'high') {
        positives.push("Strong growth");
    }

    // Hiring momentum
    if (hiring?.trend === 'hot') {
        positives.push("Hot hiring (" + hiring.roles + " roles)");
    } else if (!hiring) {
        riskScore += 10;
        riskFactors.push("Limited hiring activity");
    }

    // Equity upside potential
    let equityUpside = 'medium';
    if (wiki?.valuationNum < 1000000000 && wiki?.revenueGrowth === 'high') {
        equityUpside = 'high';
        positives.push("Pre-unicorn with high growth");
    } else if (wiki?.valuationNum >= 10000000000) {
        equityUpside = 'low';
        riskFactors.push("$10B+ valuation limits upside");
    }

    // Calculate recommendation
    let recommendation = '';
    if (riskScore <= 25) {
        recommendation = 'STRONG JOIN - Stable with upside';
    } else if (riskScore <= 50) {
        recommendation = 'CONSIDER - Balance risk vs equity';
    } else if (riskScore <= 70) {
        recommendation = 'CAUTION - High risk, negotiate equity';
    } else {
        recommendation = 'RISKY - Only if equity is exceptional';
    }

    return {
        company: companyName,
        riskScore: Math.min(100, riskScore),
        riskLevel: riskScore <= 25 ? 'low' : riskScore <= 50 ? 'medium' : riskScore <= 70 ? 'high' : 'very-high',
        recommendation: recommendation,
        riskFactors: riskFactors,
        positives: positives,
        equityUpside: equityUpside,
        maScore: maScore,
        stabilityScore: signals?.stabilityScore || 5,
        equityScore: signals?.equityScore || 5
    };
}

// Generate M&A Analysis Report
function generateMaAnalysisReport(companyName) {
    return {
        pricing: calculateAcquisitionPrice(companyName),
        acquirers: getLikelyAcquirers(companyName),
        peTarget: getPETargetScore(companyName),
        comparables: getRevenueComparables(companyName),
        exitPath: predictExitPath(companyName),
        jobRisk: getJobSeekerRiskScore(companyName)
    };
}

// Format currency
function formatCurrency(num) {
    if (!num || num === 0) return 'N/A';
    if (num >= 1000000000) return '$' + (num / 1000000000).toFixed(1) + 'B';
    if (num >= 1000000) return '$' + (num / 1000000).toFixed(0) + 'M';
    return '$' + num.toLocaleString();
}

// Get company logo URL (Clearbit API)
function getLogoUrl(company) {
    // If company object with website
    if (company?.website) {
        return `https://logo.clearbit.com/${company.website}`;
    }
    // If just a company name, try to find it
    if (typeof company === 'string') {
        const c = companies.find(co => co.name.toLowerCase() === company.toLowerCase());
        if (c?.website) return `https://logo.clearbit.com/${c.website}`;
        // Fallback: guess domain from company name
        const domain = company.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '') + '.com';
        return `https://logo.clearbit.com/${domain}`;
    }
    return null;
}

// Render company logo HTML with fallback
function renderLogo(company, size = 32) {
    const name = typeof company === 'string' ? company : company?.name || '?';
    let website = null;
    if (company?.website) {
        website = company.website;
    } else if (typeof company === 'string') {
        const c = companies.find(co => co.name.toLowerCase() === company.toLowerCase());
        if (c?.website) website = c.website;
    }

    if (website) {
        return `<img src="https://logo.clearbit.com/${website}" style="width:${size}px;height:${size}px;border-radius:6px;background:#fff;object-fit:contain;" onerror="this.src='https://www.google.com/s2/favicons?domain=${website}&sz=128'">`;
    }
    const initial = name.charAt(0).toUpperCase();
    return `<div style="width:${size}px;height:${size}px;border-radius:6px;background:#3b82f6;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:${Math.round(size*0.5)}px;">${initial}</div>`;
}

// Populate M&A Tools company dropdown
function populateMaToolsDropdown() {
    const select = document.getElementById('maToolsCompanySelect');
    if (!select) return;

    // Get companies with wikiData
    const companiesWithData = Object.keys(wikiData).sort();

    select.innerHTML = '<option value="">Select a company...</option>';
    companiesWithData.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}

// Run M&A Analysis
function runMaAnalysis() {
    const select = document.getElementById('maToolsCompanySelect');
    const companyName = select?.value;
    if (!companyName) return;

    const report = generateMaAnalysisReport(companyName);
    document.getElementById('maToolsResults').style.display = 'block';

    // 1. Pricing
    const pricing = report.pricing;
    document.getElementById('maPricingResult').innerHTML = pricing ? `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
            <div style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: var(--dim);">LOW</div>
                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${formatCurrency(pricing.lowPrice)}</div>
            </div>
            <div style="padding: 12px; background: rgba(34,197,94,0.15); border-radius: 8px; border: 2px solid rgba(34,197,94,0.3);">
                <div style="font-size: 11px; color: var(--dim);">EXPECTED</div>
                <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${formatCurrency(pricing.midPrice)}</div>
                <div style="font-size: 10px; color: var(--dim);">${pricing.adjustedMultiple?.toFixed(1)}x revenue</div>
            </div>
            <div style="padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: var(--dim);">HIGH</div>
                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${formatCurrency(pricing.highPrice)}</div>
            </div>
        </div>
        <div style="margin-top: 12px; font-size: 12px; color: var(--dim);">
            Based on ${formatCurrency(pricing.revenue)} revenue in ${pricing.category} category
        </div>
    ` : '<div style="color: var(--dim);">No revenue data available</div>';

    // 2. Acquirers
    const acquirers = report.acquirers;
    document.getElementById('maAcquirersResult').innerHTML = acquirers?.length ? `
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${acquirers.map(a => `
                <div style="padding: 10px 14px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-weight: 600; color: var(--text);">${a.acquirer}</div>
                    <div style="font-size: 11px; color: var(--accent-cyan);">${a.fitScore}% fit</div>
                    <div style="font-size: 10px; color: var(--dim); margin-top: 4px;">${a.reason}</div>
                </div>
            `).join('')}
        </div>
    ` : '<div style="color: var(--dim);">No acquirer matches found</div>';

    // 3. PE Target
    const pe = report.peTarget;
    document.getElementById('maPeSection').style.display = pe ? 'block' : 'none';
    if (pe) {
        document.getElementById('maPeResult').innerHTML = `
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="width: 80px; height: 80px; border-radius: 50%; background: ${pe.score >= 60 ? 'rgba(239,68,68,0.2)' : pe.score >= 40 ? 'rgba(249,115,22,0.2)' : 'rgba(59,130,246,0.1)'}; display: flex; align-items: center; justify-content: center; border: 3px solid ${pe.score >= 60 ? '#ef4444' : pe.score >= 40 ? '#f97316' : '#3b82f6'};">
                    <span style="font-size: 28px; font-weight: 700; color: ${pe.score >= 60 ? '#ef4444' : pe.score >= 40 ? '#f97316' : '#3b82f6'};">${pe.score}</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; color: var(--text); margin-bottom: 8px;">EV/Revenue: ${pe.evToRevenue}</div>
                    ${pe.signals.map(s => `<div style="font-size: 11px; color: var(--dim); margin: 2px 0;"> ${s}</div>`).join('')}
                </div>
            </div>
        `;
    }

    // 4. Comparables
    const comps = report.comparables;
    document.getElementById('maComparablesResult').innerHTML = comps ? `
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 12px;">
            <div>Current: <span style="font-weight: 700; color: var(--accent-cyan);">${comps.currentMultiple}</span></div>
            <div>Peer Avg: <span style="font-weight: 700; color: var(--text);">${comps.avgComparableMultiple}</span></div>
            <div>Premium: <span style="font-weight: 700; color: ${parseInt(comps.premium) > 0 ? '#22c55e' : '#ef4444'};">${comps.premium}</span></div>
        </div>
        ${comps.comparables?.length ? `
            <div style="font-size: 11px; color: var(--dim);">
                <strong>Comparables:</strong> ${comps.comparables.map(c => `${c.name} (${c.multiple}x)`).join(', ')}
            </div>
        ` : ''}
    ` : '<div style="color: var(--dim);">No comparable data</div>';

    // 5. Exit Path
    const exit = report.exitPath;
    document.getElementById('maExitResult').innerHTML = exit ? `
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="flex: 1;">
                <div style="display: flex; height: 24px; border-radius: 12px; overflow: hidden; background: var(--bg-primary);">
                    <div style="width: ${exit.ipoLikelihood}%; background: linear-gradient(90deg, #3b82f6, #6366f1); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white;">${exit.ipoLikelihood > 20 ? 'IPO ' + exit.ipoLikelihood + '%' : ''}</div>
                    <div style="width: ${exit.maLikelihood}%; background: linear-gradient(90deg, #f97316, #ef4444); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white;">${exit.maLikelihood > 20 ? 'M&A ' + exit.maLikelihood + '%' : ''}</div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; color: ${exit.predictedPath === 'IPO' ? '#3b82f6' : '#ef4444'};">${exit.predictedPath}</div>
                <div style="font-size: 11px; color: var(--dim);">${exit.timeline}</div>
            </div>
        </div>
        <div style="margin-top: 10px; font-size: 11px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><strong style="color: #3b82f6;">IPO Signals:</strong><br>${exit.ipoSignals.slice(0, 2).join('<br>')}</div>
            <div><strong style="color: #ef4444;">M&A Signals:</strong><br>${exit.maSignals.slice(0, 2).join('<br>')}</div>
        </div>
    ` : '<div style="color: var(--dim);">No exit path data</div>';

    // 6. Job Risk
    const job = report.jobRisk;
    document.getElementById('maJobRiskResult').innerHTML = job ? `
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="width: 90px; height: 90px; border-radius: 50%; background: ${job.riskLevel === 'low' ? 'rgba(34,197,94,0.2)' : job.riskLevel === 'medium' ? 'rgba(249,115,22,0.2)' : 'rgba(239,68,68,0.2)'}; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid ${job.riskLevel === 'low' ? '#22c55e' : job.riskLevel === 'medium' ? '#f97316' : '#ef4444'};">
                <span style="font-size: 24px; font-weight: 700; color: ${job.riskLevel === 'low' ? '#22c55e' : job.riskLevel === 'medium' ? '#f97316' : '#ef4444'};">${job.riskScore}</span>
                <span style="font-size: 10px; color: var(--dim);">RISK</span>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 14px; font-weight: 600; color: ${job.riskLevel === 'low' ? '#22c55e' : job.riskLevel === 'medium' ? '#f97316' : '#ef4444'}; margin-bottom: 8px;">${job.recommendation}</div>
                <div style="font-size: 11px; color: var(--dim);">
                    Equity Upside: <strong>${job.equityUpside}</strong> |
                    M&A Score: <strong>${job.maScore}</strong> |
                    Stability: <strong>${job.stabilityScore}/10</strong>
                </div>
            </div>
        </div>
        <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px;">
            <div style="color: #ef4444;">${job.riskFactors.map(r => ' ' + r).join('<br>')}</div>
            <div style="color: #22c55e;">${job.positives.map(p => ' ' + p).join('<br>')}</div>
        </div>
    ` : '<div style="color: var(--dim);">No job risk data</div>';

    // Always show consolidation heatmap
    renderConsolidationHeatmap();
}

// Render Industry Consolidation Heatmap
function renderConsolidationHeatmap() {
    const data = getIndustryConsolidation();
    const container = document.getElementById('maConsolidationResult');
    if (!container) return;

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
            ${data.slice(0, 8).map(ind => `
                <div style="padding: 12px; background: ${ind.heat === 'hot' ? 'rgba(239,68,68,0.15)' : ind.heat === 'warm' ? 'rgba(249,115,22,0.1)' : 'rgba(59,130,246,0.1)'}; border-radius: 8px; border: 1px solid ${ind.heat === 'hot' ? 'rgba(239,68,68,0.3)' : ind.heat === 'warm' ? 'rgba(249,115,22,0.2)' : 'rgba(59,130,246,0.2)'};">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 6px;">${ind.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--dim);">
                        <span>${ind.companies} cos</span>
                        <span>${ind.acquired} acquired</span>
                    </div>
                    <div style="margin-top: 6px; font-size: 18px; font-weight: 700; color: ${ind.heat === 'hot' ? '#ef4444' : ind.heat === 'warm' ? '#f97316' : '#3b82f6'};">
                        ${ind.consolidationScore}
                        <span style="font-size: 10px; font-weight: 400;">${ind.heat === 'hot' ? '' : ind.heat === 'warm' ? '' : ''}</span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Initialize M&A Tools when panel opens
function initMaTools() {
    populateMaToolsDropdown();
    renderConsolidationHeatmap();
}

// ==================== MODULAR JOB DATA SYSTEM ====================
// Architecture: Provider-based system for fetching job listings from multiple sources
// Each provider implements the same interface, making it easy to add new sources

const JobProviders = {
    // Registry of all job providers
    providers: {},

    // Register a new provider
    register(name, provider) {
        this.providers[name] = provider;
        console.log(`[JobProviders] Registered: ${name}`);
    },

    // Get provider by name
    get(name) {
        return this.providers[name];
    },

    // List all registered providers
    list() {
        return Object.keys(this.providers);
    }
};

// Common job data structure (all providers normalize to this)
/*
Job {
    id: string,
    title: string,
    company: string,
    location: string,
    remote: boolean,
    department: string,
    type: string (full-time, part-time, contract),
    url: string,
    postedAt: Date,
    salary: { min: number, max: number, currency: string } | null,
    source: string (provider name),
    raw: object (original data)
}
*/

// Company to ATS mapping (which provider to use for each company)
// 150+ AI and tech companies with known job board tokens
const companyATSMap = {
    // ==================== GREENHOUSE COMPANIES (100+) ====================
    // Foundation Models / AI Labs
    "Anthropic": { ats: "greenhouse", boardToken: "anthropic" },
    "OpenAI": { ats: "greenhouse", boardToken: "openai" },
    "Cohere": { ats: "greenhouse", boardToken: "cohere" },
    "AI21 Labs": { ats: "greenhouse", boardToken: "ai21" },
    "Adept": { ats: "greenhouse", boardToken: "adept" },
    "Inflection AI": { ats: "greenhouse", boardToken: "inflection" },
    "Stability AI": { ats: "greenhouse", boardToken: "stabilityai" },

    // Developer Tools & Infrastructure
    "Stripe": { ats: "greenhouse", boardToken: "stripe" },
    "Figma": { ats: "greenhouse", boardToken: "figma" },
    "Notion": { ats: "greenhouse", boardToken: "notion" },
    "Vercel": { ats: "greenhouse", boardToken: "vercel" },
    "Supabase": { ats: "greenhouse", boardToken: "supabase" },
    "PlanetScale": { ats: "greenhouse", boardToken: "planetscale" },
    "Railway": { ats: "greenhouse", boardToken: "railway" },
    "Render": { ats: "greenhouse", boardToken: "render" },
    "Fly.io": { ats: "greenhouse", boardToken: "flyio" },
    "Replit": { ats: "greenhouse", boardToken: "replit" },
    "Linear": { ats: "greenhouse", boardToken: "linear" },
    "Retool": { ats: "greenhouse", boardToken: "retool" },
    "Postman": { ats: "greenhouse", boardToken: "postman" },
    "GitLab": { ats: "greenhouse", boardToken: "gitlab" },
    "CircleCI": { ats: "greenhouse", boardToken: "circleci" },
    "LaunchDarkly": { ats: "greenhouse", boardToken: "launchdarkly" },
    "Split": { ats: "greenhouse", boardToken: "split" },
    "Sourcegraph": { ats: "greenhouse", boardToken: "sourcegraph" },
    "Snyk": { ats: "greenhouse", boardToken: "snyk" },
    "HashiCorp": { ats: "greenhouse", boardToken: "hashicorp" },
    "Pulumi": { ats: "greenhouse", boardToken: "pulumi" },
    "Temporal": { ats: "greenhouse", boardToken: "temporal" },
    "Airbyte": { ats: "greenhouse", boardToken: "airbyte" },
    "Fivetran": { ats: "greenhouse", boardToken: "fivetran" },
    "dbt Labs": { ats: "greenhouse", boardToken: "dbtlabs" },
    "Hex": { ats: "greenhouse", boardToken: "hex" },
    "Mode": { ats: "greenhouse", boardToken: "mode" },
    "Monte Carlo": { ats: "greenhouse", boardToken: "montecarlodata" },
    "Great Expectations": { ats: "greenhouse", boardToken: "greatexpectations" },

    // Data & ML Infrastructure
    "Databricks": { ats: "greenhouse", boardToken: "databricks" },
    "Snowflake": { ats: "greenhouse", boardToken: "snowflake" },
    "Scale AI": { ats: "greenhouse", boardToken: "scaleai" },
    "Weights & Biases": { ats: "greenhouse", boardToken: "wandb" },
    "Pinecone": { ats: "greenhouse", boardToken: "pinecone" },
    "Weaviate": { ats: "greenhouse", boardToken: "weaviate" },
    "Chroma": { ats: "greenhouse", boardToken: "chroma" },
    "Qdrant": { ats: "greenhouse", boardToken: "qdrant" },
    "Milvus": { ats: "greenhouse", boardToken: "zilliz" },
    "LangChain": { ats: "greenhouse", boardToken: "langchain" },
    "LlamaIndex": { ats: "greenhouse", boardToken: "llamaindex" },
    "Hugging Face": { ats: "greenhouse", boardToken: "huggingface" },
    "Replicate": { ats: "greenhouse", boardToken: "replicate" },
    "Baseten": { ats: "greenhouse", boardToken: "baseten" },
    "BentoML": { ats: "greenhouse", boardToken: "bentoml" },
    "MLflow": { ats: "greenhouse", boardToken: "databricks" },
    "Neptune.ai": { ats: "greenhouse", boardToken: "neptuneai" },
    "Determined AI": { ats: "greenhouse", boardToken: "determined" },
    "Tecton": { ats: "greenhouse", boardToken: "tecton" },
    "Feast": { ats: "greenhouse", boardToken: "tecton" },

    // FinTech
    "Ramp": { ats: "greenhouse", boardToken: "ramp" },
    "Brex": { ats: "greenhouse", boardToken: "brex" },
    "Plaid": { ats: "greenhouse", boardToken: "plaid" },
    "Mercury": { ats: "greenhouse", boardToken: "mercury" },
    "Carta": { ats: "greenhouse", boardToken: "carta" },
    "Gusto": { ats: "greenhouse", boardToken: "gusto" },
    "Rippling": { ats: "greenhouse", boardToken: "rippling" },
    "Deel": { ats: "greenhouse", boardToken: "deel" },
    "Remote": { ats: "greenhouse", boardToken: "remote" },
    "Pilot": { ats: "greenhouse", boardToken: "pilot" },
    "Melio": { ats: "greenhouse", boardToken: "melio" },
    "Rho": { ats: "greenhouse", boardToken: "rho" },
    "Capchase": { ats: "greenhouse", boardToken: "capchase" },
    "Pipe": { ats: "greenhouse", boardToken: "pipe" },
    "Clearco": { ats: "greenhouse", boardToken: "clearco" },

    // Enterprise / SaaS
    "Datadog": { ats: "greenhouse", boardToken: "datadog" },
    "Amplitude": { ats: "greenhouse", boardToken: "amplitude" },
    "Segment": { ats: "greenhouse", boardToken: "segment" },
    "mParticle": { ats: "greenhouse", boardToken: "mparticle" },
    "Census": { ats: "greenhouse", boardToken: "census" },
    "Hightouch": { ats: "greenhouse", boardToken: "hightouch" },
    "Rudderstack": { ats: "greenhouse", boardToken: "rudderstack" },
    "Mixpanel": { ats: "greenhouse", boardToken: "mixpanel" },
    "Heap": { ats: "greenhouse", boardToken: "heap" },
    "FullStory": { ats: "greenhouse", boardToken: "fullstory" },
    "Hotjar": { ats: "greenhouse", boardToken: "hotjar" },
    "Pendo": { ats: "greenhouse", boardToken: "pendo" },
    "Productboard": { ats: "greenhouse", boardToken: "productboard" },
    "Coda": { ats: "greenhouse", boardToken: "coda" },
    "Loom": { ats: "greenhouse", boardToken: "loom" },
    "Miro": { ats: "greenhouse", boardToken: "miro" },
    "Calendly": { ats: "greenhouse", boardToken: "calendly" },
    "Typeform": { ats: "greenhouse", boardToken: "typeform" },
    "SurveyMonkey": { ats: "greenhouse", boardToken: "surveymonkey" },
    "Webflow": { ats: "greenhouse", boardToken: "webflow" },
    "Framer": { ats: "greenhouse", boardToken: "framer" },

    // Security
    "1Password": { ats: "greenhouse", boardToken: "1password" },
    "Bitwarden": { ats: "greenhouse", boardToken: "bitwarden" },
    "CrowdStrike": { ats: "greenhouse", boardToken: "crowdstrike" },
    "SentinelOne": { ats: "greenhouse", boardToken: "sentinelone" },
    "Lacework": { ats: "greenhouse", boardToken: "lacework" },
    "Orca Security": { ats: "greenhouse", boardToken: "orcasecurity" },
    "Wiz": { ats: "greenhouse", boardToken: "wiz" },
    "Vanta": { ats: "greenhouse", boardToken: "vanta" },
    "Drata": { ats: "greenhouse", boardToken: "drata" },
    "Secureframe": { ats: "greenhouse", boardToken: "secureframe" },

    // GTM / Sales
    "Gong": { ats: "greenhouse", boardToken: "gong" },
    "Outreach": { ats: "greenhouse", boardToken: "outreach" },
    "Salesloft": { ats: "greenhouse", boardToken: "salesloft" },
    "Apollo.io": { ats: "greenhouse", boardToken: "apollo" },
    "ZoomInfo": { ats: "greenhouse", boardToken: "zoominfo" },
    "6sense": { ats: "greenhouse", boardToken: "6sense" },
    "Clari": { ats: "greenhouse", boardToken: "clari" },
    "People.ai": { ats: "greenhouse", boardToken: "peopleai" },
    "Chorus.ai": { ats: "greenhouse", boardToken: "chorus" },
    "Drift": { ats: "greenhouse", boardToken: "drift" },
    "Intercom": { ats: "greenhouse", boardToken: "intercom" },
    "Zendesk": { ats: "greenhouse", boardToken: "zendesk" },
    "Front": { ats: "greenhouse", boardToken: "front" },
    "Freshworks": { ats: "greenhouse", boardToken: "freshworks" },

    // HealthTech
    "Tempus": { ats: "greenhouse", boardToken: "tempus" },
    "Flatiron Health": { ats: "greenhouse", boardToken: "flatironhealth" },
    "Ro": { ats: "greenhouse", boardToken: "ro" },
    "Hims & Hers": { ats: "greenhouse", boardToken: "hims" },
    "Cerebral": { ats: "greenhouse", boardToken: "cerebral" },
    "Headway": { ats: "greenhouse", boardToken: "headway" },
    "Spring Health": { ats: "greenhouse", boardToken: "springhealth" },
    "Modern Health": { ats: "greenhouse", boardToken: "modernhealth" },
    "Lyra Health": { ats: "greenhouse", boardToken: "lyrahealth" },
    "Color Health": { ats: "greenhouse", boardToken: "color" },
    "Viz.ai": { ats: "greenhouse", boardToken: "vizai" },
    "PathAI": { ats: "greenhouse", boardToken: "pathai" },

    // Logistics & Supply Chain
    "Flexport": { ats: "greenhouse", boardToken: "flexport" },
    "Convoy": { ats: "greenhouse", boardToken: "convoy" },
    "Project44": { ats: "greenhouse", boardToken: "project44" },
    "FourKites": { ats: "greenhouse", boardToken: "fourkites" },
    "Shippo": { ats: "greenhouse", boardToken: "shippo" },
    "ShipBob": { ats: "greenhouse", boardToken: "shipbob" },
    "Deliverr": { ats: "greenhouse", boardToken: "deliverr" },

    // Consumer
    "Discord": { ats: "greenhouse", boardToken: "discord" },
    "Reddit": { ats: "greenhouse", boardToken: "reddit" },
    "Pinterest": { ats: "greenhouse", boardToken: "pinterest" },
    "Spotify": { ats: "greenhouse", boardToken: "spotify" },
    "Duolingo": { ats: "greenhouse", boardToken: "duolingo" },
    "Calm": { ats: "greenhouse", boardToken: "calm" },
    "Headspace": { ats: "greenhouse", boardToken: "headspace" },
    "Noom": { ats: "greenhouse", boardToken: "noom" },
    "Strava": { ats: "greenhouse", boardToken: "strava" },
    "AllTrails": { ats: "greenhouse", boardToken: "alltrails" },

    // ==================== LEVER COMPANIES (50+) ====================
    // AI / ML
    "Mistral AI": { ats: "lever", boardToken: "mistral" },
    "Together AI": { ats: "lever", boardToken: "togetherai" },
    "Anyscale": { ats: "lever", boardToken: "anyscale" },
    "Modal": { ats: "lever", boardToken: "modal" },
    "Cursor": { ats: "lever", boardToken: "anysphere" },
    "Perplexity": { ats: "lever", boardToken: "perplexity" },
    "Character.AI": { ats: "lever", boardToken: "character" },
    "Jasper": { ats: "lever", boardToken: "jasper" },
    "Copy.ai": { ats: "lever", boardToken: "copyai" },
    "Writer": { ats: "lever", boardToken: "writerai" },
    "Textio": { ats: "lever", boardToken: "textio" },
    "Grammarly": { ats: "lever", boardToken: "grammarly" },
    "Midjourney": { ats: "lever", boardToken: "midjourney" },
    "Stability AI": { ats: "lever", boardToken: "stability" },
    "Synthesia": { ats: "lever", boardToken: "synthesia" },
    "D-ID": { ats: "lever", boardToken: "d-id" },
    "Descript": { ats: "lever", boardToken: "descript" },

    // Enterprise
    "Glean": { ats: "lever", boardToken: "glean" },
    "Harvey": { ats: "lever", boardToken: "harvey" },
    "Ironclad": { ats: "lever", boardToken: "ironcladapp" },
    "Luminance": { ats: "lever", boardToken: "luminance" },
    "Casetext": { ats: "lever", boardToken: "casetext" },
    "Airtable": { ats: "lever", boardToken: "airtable" },
    "Asana": { ats: "lever", boardToken: "asana" },
    "Monday.com": { ats: "lever", boardToken: "mondaycom" },
    "ClickUp": { ats: "lever", boardToken: "clickup" },
    "Height": { ats: "lever", boardToken: "height" },
    "Attio": { ats: "lever", boardToken: "attio" },
    "Affinity": { ats: "lever", boardToken: "affinity" },
    "Clay": { ats: "lever", boardToken: "clay" },

    // Creative / Media
    "ElevenLabs": { ats: "lever", boardToken: "elevenlabs" },
    "Runway": { ats: "lever", boardToken: "runwayml" },
    "Pika": { ats: "lever", boardToken: "pika" },
    "Luma AI": { ats: "lever", boardToken: "lumalabs" },
    "Wonder Dynamics": { ats: "lever", boardToken: "wonderdynamics" },
    "Topaz Labs": { ats: "lever", boardToken: "topazlabs" },
    "Rive": { ats: "lever", boardToken: "rive" },
    "Spline": { ats: "lever", boardToken: "spline" },

    // Dev Tools
    "Prisma": { ats: "lever", boardToken: "prisma" },
    "Hasura": { ats: "lever", boardToken: "hasura" },
    "Neon": { ats: "lever", boardToken: "neondatabase" },
    "EdgeDB": { ats: "lever", boardToken: "edgedb" },
    "Convex": { ats: "lever", boardToken: "convex" },
    "Inngest": { ats: "lever", boardToken: "inngest" },
    "Trigger.dev": { ats: "lever", boardToken: "trigger" },
    "Depot": { ats: "lever", boardToken: "depot" },
    "Buildkite": { ats: "lever", boardToken: "buildkite" },

    // FinTech
    "Modernfi": { ats: "lever", boardToken: "modernfi" },
    "Tally": { ats: "lever", boardToken: "meettally" },
    "Dave": { ats: "lever", boardToken: "dave" },
    "Albert": { ats: "lever", boardToken: "albert" },
    "Brigit": { ats: "lever", boardToken: "brigit" },

    // Robotics / Hardware
    "Figure": { ats: "lever", boardToken: "figure" },
    "1X Technologies": { ats: "lever", boardToken: "1x" },
    "Covariant": { ats: "lever", boardToken: "covariant" },
    "Symbotic": { ats: "lever", boardToken: "symbotic" },
    "Locus Robotics": { ats: "lever", boardToken: "locusrobotics" },
    "Zipline": { ats: "lever", boardToken: "flyzipline" },
    "Skydio": { ats: "lever", boardToken: "skydio" },
    "Shield AI": { ats: "lever", boardToken: "shieldai" },
    "Anduril": { ats: "lever", boardToken: "anduril" }
};

// ==================== GREENHOUSE PROVIDER ====================
// CORS proxy for local file:// usage
const CORS_PROXY = 'https://corsproxy.io/?';

const GreenhouseProvider = {
    name: 'greenhouse',
    baseUrl: 'https://boards-api.greenhouse.io/v1/boards',

    // Fetch jobs for a company
    async fetchJobs(boardToken, companyName = null) {
        const displayName = companyName || boardToken;
        const url = `${this.baseUrl}/${boardToken}/jobs`;

        // Try direct first
        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                console.log(`[Greenhouse] Fetched ${data.jobs?.length || 0} jobs for ${displayName}`);
                return this.normalize(data.jobs || [], displayName);
            }
        } catch (e) {
            console.log(`[Greenhouse] Direct fetch failed for ${displayName}, trying CORS proxy...`);
        }

        // Fallback to CORS proxy
        try {
            const response = await fetch(CORS_PROXY + encodeURIComponent(url));
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            console.log(`[Greenhouse] Via proxy: ${data.jobs?.length || 0} jobs for ${displayName}`);
            return this.normalize(data.jobs || [], displayName);
        } catch (error) {
            console.error(`[Greenhouse] Error fetching ${displayName}:`, error);
            return [];
        }
    },

    // Normalize to common structure
    normalize(jobs, companyName) {
        return jobs.map(job => ({
            id: `gh-${job.id}`,
            title: job.title,
            company: companyName,
            location: job.location?.name || 'Unknown',
            remote: (job.location?.name || '').toLowerCase().includes('remote'),
            department: job.departments?.[0]?.name || 'General',
            type: 'full-time',
            url: job.absolute_url,
            postedAt: new Date(job.updated_at),
            salary: null, // Greenhouse doesn't expose salary in public API
            source: 'greenhouse',
            raw: job
        }));
    },

    // Get job count only (faster)
    async getJobCount(boardToken) {
        try {
            const response = await fetch(`${this.baseUrl}/${boardToken}/jobs?content=false`);
            if (!response.ok) return 0;
            const data = await response.json();
            return data.jobs?.length || 0;
        } catch {
            return 0;
        }
    }
};

// ==================== LEVER PROVIDER ====================
const LeverProvider = {
    name: 'lever',
    baseUrl: 'https://api.lever.co/v0/postings',

    async fetchJobs(boardToken, companyName = null) {
        const displayName = companyName || boardToken;
        const url = `${this.baseUrl}/${boardToken}?mode=json`;

        // Try direct first
        try {
            const response = await fetch(url);
            if (response.ok) {
                const jobs = await response.json();
                console.log(`[Lever] Fetched ${jobs?.length || 0} jobs for ${displayName}`);
                return this.normalize(jobs || [], displayName);
            }
        } catch (e) {
            console.log(`[Lever] Direct fetch failed for ${displayName}, trying CORS proxy...`);
        }

        // Fallback to CORS proxy
        try {
            const response = await fetch(CORS_PROXY + encodeURIComponent(url));
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const jobs = await response.json();
            console.log(`[Lever] Via proxy: ${jobs?.length || 0} jobs for ${displayName}`);
            return this.normalize(jobs || [], displayName);
        } catch (error) {
            console.error(`[Lever] Error fetching ${displayName}:`, error);
            return [];
        }
    },

    normalize(jobs, companyName) {
        return jobs.map(job => ({
            id: `lv-${job.id}`,
            title: job.text,
            company: companyName,
            location: job.categories?.location || 'Unknown',
            remote: (job.categories?.location || '').toLowerCase().includes('remote'),
            department: job.categories?.team || job.categories?.department || 'General',
            type: job.categories?.commitment || 'full-time',
            url: job.hostedUrl,
            postedAt: new Date(job.createdAt),
            salary: null,
            source: 'lever',
            raw: job
        }));
    },

    async getJobCount(boardToken) {
        try {
            const response = await fetch(`${this.baseUrl}/${boardToken}?mode=json`);
            if (!response.ok) return 0;
            const jobs = await response.json();
            return jobs?.length || 0;
        } catch {
            return 0;
        }
    }
};

// ==================== REMOTEOK PROVIDER ====================
const RemoteOKProvider = {
    name: 'remoteok',
    baseUrl: 'https://remoteok.com/api',

    async fetchJobs(options = {}) {
        const filterJobs = (jobs) => {
            // First item is metadata, skip it
            jobs = jobs.slice(1);

            // Filter by company if specified
            if (options.company) {
                const companyLower = options.company.toLowerCase();
                jobs = jobs.filter(j =>
                    (j.company || '').toLowerCase().includes(companyLower)
                );
            }

            // Filter by tags/skills if specified
            if (options.tags) {
                jobs = jobs.filter(j =>
                    options.tags.some(tag =>
                        (j.tags || []).some(t => t.toLowerCase().includes(tag.toLowerCase()))
                    )
                );
            }
            return jobs;
        };

        // Try direct first
        try {
            const response = await fetch(this.baseUrl);
            if (response.ok) {
                const jobs = await response.json();
                console.log(`[RemoteOK] Fetched ${jobs.length - 1} jobs`);
                return this.normalize(filterJobs(jobs));
            }
        } catch (e) {
            console.log('[RemoteOK] Direct fetch failed, trying CORS proxy...');
        }

        // Fallback to CORS proxy
        try {
            const response = await fetch(CORS_PROXY + encodeURIComponent(this.baseUrl));
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const jobs = await response.json();
            console.log(`[RemoteOK] Via proxy: ${jobs.length - 1} jobs`);
            return this.normalize(filterJobs(jobs));
        } catch (error) {
            console.error('[RemoteOK] Error:', error);
            return [];
        }
    },

    normalize(jobs) {
        return jobs.map(job => ({
            id: `ro-${job.id}`,
            title: job.position,
            company: job.company,
            location: job.location || 'Remote',
            remote: true,
            department: job.tags?.[0] || 'General',
            type: 'full-time',
            url: job.url,
            postedAt: new Date(job.date),
            salary: job.salary_min ? {
                min: parseInt(job.salary_min),
                max: parseInt(job.salary_max),
                currency: 'USD'
            } : null,
            source: 'remoteok',
            logo: job.company_logo,
            raw: job
        }));
    }
};

// ==================== ARBEITNOW PROVIDER ====================
const ArbeitnowProvider = {
    name: 'arbeitnow',
    baseUrl: 'https://www.arbeitnow.com/api/job-board-api',

    async fetchJobs(options = {}) {
        const filterJobs = (jobs) => {
            if (options.company) {
                const companyLower = options.company.toLowerCase();
                jobs = jobs.filter(j =>
                    (j.company_name || '').toLowerCase().includes(companyLower)
                );
            }
            return jobs;
        };

        // Try direct first
        try {
            const response = await fetch(this.baseUrl);
            if (response.ok) {
                const data = await response.json();
                const jobs = data.data || [];
                console.log(`[Arbeitnow] Fetched ${jobs.length} jobs`);
                return this.normalize(filterJobs(jobs));
            }
        } catch (e) {
            console.log('[Arbeitnow] Direct fetch failed, trying CORS proxy...');
        }

        // Fallback to CORS proxy
        try {
            const response = await fetch(CORS_PROXY + encodeURIComponent(this.baseUrl));
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const jobs = data.data || [];
            console.log(`[Arbeitnow] Via proxy: ${jobs.length} jobs`);
            return this.normalize(filterJobs(jobs));
        } catch (error) {
            console.error('[Arbeitnow] Error:', error);
            return [];
        }
    },

    normalize(jobs) {
        return jobs.map(job => ({
            id: `an-${job.slug}`,
            title: job.title,
            company: job.company_name,
            location: job.location || 'Unknown',
            remote: job.remote || false,
            department: job.tags?.[0] || 'General',
            type: 'full-time',
            url: job.url,
            postedAt: new Date(job.created_at),
            salary: null,
            source: 'arbeitnow',
            raw: job
        }));
    }
};

// ==================== LINKEDIN PROVIDER ====================
const LinkedInProvider = {
    name: 'linkedin',
    apiKey: 'bSZfWasei8lGOWJRYBzbkpwAJeQnzdOtsMk7BCVRqSg',
    host: 'linkedin-api8.p.rapidapi.com',

    // Cache for company data
    cache: {},

    // Get company by LinkedIn username (vanity name)
    async getCompanyByUsername(username) {
        const cacheKey = `company:${username}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`https://${this.host}/get-company-details?username=${encodeURIComponent(username)}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            console.log(`[LinkedIn] Fetched company: ${username}`, data);
            this.cache[cacheKey] = data;
            return data;
        } catch (error) {
            console.error(`[LinkedIn] Error fetching ${username}:`, error);
            return null;
        }
    },

    // Search companies by keyword
    async searchCompanies(keyword) {
        try {
            const response = await fetch(`https://${this.host}/search-companies?keyword=${encodeURIComponent(keyword)}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.items || data.data || [];
        } catch (error) {
            console.error(`[LinkedIn] Search error:`, error);
            return [];
        }
    },

    // Get company jobs
    async getCompanyJobs(companyId) {
        try {
            const response = await fetch(`https://${this.host}/get-company-jobs?companyId=${encodeURIComponent(companyId)}&start=0&count=50`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.items || data.data || data.jobs || [];
        } catch (error) {
            console.error(`[LinkedIn] Jobs error:`, error);
            return [];
        }
    },

    // Get company employees count and data
    async getCompanyEmployees(companyId, start = 0) {
        try {
            const response = await fetch(`https://${this.host}/get-company-employees?companyId=${companyId}&start=${start}&count=50`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`[LinkedIn] Employees error:`, error);
            return null;
        }
    },

    // Normalize company data from RapidAPI response
    normalizeCompany(data) {
        if (!data) return null;

        return {
            id: data.id || data.companyId,
            name: data.name || data.universalName,
            vanityName: data.universalName || data.username,
            employees: data.staffCount || data.employeeCount || 'Unknown',
            employeeCountRange: data.staffCountRange || data.employeesRange,
            industry: data.industry || data.industries?.[0] || 'Technology',
            hq: data.headquarter ? `${data.headquarter.city}, ${data.headquarter.country}` : (data.location || null),
            founded: data.foundedOn?.year || data.founded || null,
            followers: data.followerCount || data.followersCount || 0,
            description: data.description || data.tagline || '',
            specialties: data.specialities || data.specialties || [],
            logoUrl: data.logo || data.logoUrl || null,
            coverUrl: data.backgroundCoverImage || null,
            linkedinUrl: data.url || `https://linkedin.com/company/${data.universalName}`,
            website: data.website || data.companyUrl || null,
            type: data.companyType || data.type || 'Private',
            lastUpdated: new Date().toISOString()
        };
    },

    // Normalize job data
    normalizeJobs(jobs, companyName) {
        if (!Array.isArray(jobs)) return [];
        return jobs.map(job => ({
            id: `li-${job.id || job.jobId}`,
            title: job.title || job.jobTitle || 'Unknown',
            company: companyName,
            location: job.location || job.formattedLocation || 'Unknown',
            remote: (job.workplaceType === 'Remote') || (job.location || '').toLowerCase().includes('remote'),
            department: job.jobFunction || job.function || 'General',
            type: job.employmentType || job.type || 'Full-time',
            url: job.url || `https://linkedin.com/jobs/view/${job.id}`,
            postedAt: new Date(job.postedAt || job.listedAt || Date.now()),
            salary: job.salary || null,
            source: 'linkedin',
            applicants: job.applicantCount || job.numberOfApplicants || 0,
            raw: job
        }));
    },

    // Batch fetch multiple companies
    async fetchMultipleCompanies(usernames, delayMs = 500) {
        const results = {};
        for (const username of usernames) {
            try {
                const data = await this.getCompanyByUsername(username);
                if (data) {
                    results[username] = this.normalizeCompany(data);
                }
                await new Promise(r => setTimeout(r, delayMs));
            } catch (e) {
                console.warn(`[LinkedIn] Failed for ${username}`);
            }
        }
        return results;
    }
};

// Register all providers
JobProviders.register('greenhouse', GreenhouseProvider);
JobProviders.register('lever', LeverProvider);
JobProviders.register('remoteok', RemoteOKProvider);
JobProviders.register('arbeitnow', ArbeitnowProvider);
JobProviders.register('linkedin', LinkedInProvider);

// ==================== GITHUB JOBS PROVIDER ====================
const GitHubProvider = {
    name: 'github',
    // GitHub Jobs API was deprecated, now using GitHub's GraphQL API for company/repo data
    // and alternate sources for job listings

    // Search for company repositories and activity
    async searchCompany(companyName) {
        try {
            const response = await fetch(`https://api.github.com/search/users?q=${encodeURIComponent(companyName)}+type:org`, {
                headers: { 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.items?.[0] || null;
        } catch (error) {
            console.error(`[GitHub] Search error:`, error);
            return null;
        }
    },

    // Get organization details
    async getOrgDetails(orgLogin) {
        try {
            const response = await fetch(`https://api.github.com/orgs/${orgLogin}`, {
                headers: { 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`[GitHub] Org details error:`, error);
            return null;
        }
    },

    // Get organization repos (indicates engineering activity)
    async getOrgRepos(orgLogin, perPage = 30) {
        try {
            const response = await fetch(`https://api.github.com/orgs/${orgLogin}/repos?sort=updated&per_page=${perPage}`, {
                headers: { 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`[GitHub] Repos error:`, error);
            return [];
        }
    },

    // Normalize org data for our use
    normalizeOrg(data, repos = []) {
        if (!data) return null;

        const recentActivity = repos.filter(r => {
            const updated = new Date(r.updated_at);
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            return updated > monthAgo;
        }).length;

        return {
            id: data.id,
            name: data.name || data.login,
            login: data.login,
            description: data.description,
            publicRepos: data.public_repos,
            followers: data.followers,
            location: data.location,
            blog: data.blog,
            email: data.email,
            twitterUsername: data.twitter_username,
            createdAt: data.created_at,
            recentActiveRepos: recentActivity,
            totalStars: repos.reduce((sum, r) => sum + (r.stargazers_count || 0), 0),
            topLanguages: [...new Set(repos.map(r => r.language).filter(Boolean))].slice(0, 5),
            isHiring: data.is_verified || recentActivity > 10, // Heuristic
            githubUrl: data.html_url,
            lastUpdated: new Date().toISOString()
        };
    }
};

// ==================== Y COMBINATOR PROVIDER ====================
const YCombinatorProvider = {
    name: 'ycombinator',

    // YC uses Algolia for their company search
    algoliaAppId: '45BWZJ1SGC',
    algoliaApiKey: 'MjBjYjRiMzY0NzdhZWY0NjExY2NhZjYxMGIxYjc2MTAwNWFkNTkwNTc4NjgxYjU0YzFhYTY2ZGQ5OGY5NDMxZnJlc3RyaWN0SW5kaWNlcz0lNUIlMjJZQ0NvbXBhbnlfcHJvZHVjdGlvbiUyMiUyQyUyMllDQ29tcGFueV9CeV9MYXVuY2hfRGF0ZV9wcm9kdWN0aW9uJTIyJTVEJmZpbHRlcnM9aGlyaW5nJTNBdHJ1ZSZlbmFibGVQZXJzb25hbGl6YXRpb249ZmFsc2U=',

    // Cache for YC data
    cache: {},
    ycCompanies: {},

    // Search YC companies by name
    async searchCompanies(query, hitsPerPage = 20) {
        const cacheKey = `search:${query}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`https://${this.algoliaAppId}-dsn.algolia.net/1/indexes/YCCompany_production/query`, {
                method: 'POST',
                headers: {
                    'X-Algolia-Application-Id': this.algoliaAppId,
                    'X-Algolia-API-Key': this.algoliaApiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    hitsPerPage: hitsPerPage,
                    attributesToRetrieve: ['name', 'slug', 'website', 'one_liner', 'long_description', 'batch', 'status', 'industries', 'regions', 'top_company', 'isHiring', 'team_size', 'highlight_black', 'highlight_latinx', 'highlight_women', 'subindustry', 'all_locations']
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[cacheKey] = data.hits || [];
            return data.hits || [];
        } catch (error) {
            console.error('[YC] Search error:', error);
            return [];
        }
    },

    // Get all YC companies that are hiring
    async getHiringCompanies(page = 0, hitsPerPage = 100) {
        try {
            const response = await fetch(`https://${this.algoliaAppId}-dsn.algolia.net/1/indexes/YCCompany_production/query`, {
                method: 'POST',
                headers: {
                    'X-Algolia-Application-Id': this.algoliaAppId,
                    'X-Algolia-API-Key': this.algoliaApiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: '',
                    filters: 'isHiring:true',
                    hitsPerPage: hitsPerPage,
                    page: page
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return { hits: data.hits || [], total: data.nbHits, pages: data.nbPages };
        } catch (error) {
            console.error('[YC] Hiring companies error:', error);
            return { hits: [], total: 0, pages: 0 };
        }
    },

    // Get company by slug
    async getCompanyBySlug(slug) {
        const cacheKey = `company:${slug}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        const results = await this.searchCompanies(slug, 5);
        const company = results.find(c => c.slug === slug || c.name.toLowerCase() === slug.toLowerCase());
        if (company) {
            this.cache[cacheKey] = company;
        }
        return company || null;
    },

    // Get jobs from Work at a Startup (workatastartup.com)
    async getJobs(query = '', page = 0) {
        try {
            const response = await fetch(`https://${this.algoliaAppId}-dsn.algolia.net/1/indexes/WorkAtAStartup_production/query`, {
                method: 'POST',
                headers: {
                    'X-Algolia-Application-Id': this.algoliaAppId,
                    'X-Algolia-API-Key': this.algoliaApiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    hitsPerPage: 50,
                    page: page,
                    attributesToRetrieve: ['title', 'company_name', 'company_slug', 'location', 'remote', 'salary_min', 'salary_max', 'equity_min', 'equity_max', 'experience', 'job_type', 'created_at', 'url']
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return { jobs: data.hits || [], total: data.nbHits };
        } catch (error) {
            console.error('[YC] Jobs error:', error);
            return { jobs: [], total: 0 };
        }
    },

    // Get jobs for a specific company
    async getCompanyJobs(companySlug) {
        try {
            const response = await fetch(`https://${this.algoliaAppId}-dsn.algolia.net/1/indexes/WorkAtAStartup_production/query`, {
                method: 'POST',
                headers: {
                    'X-Algolia-Application-Id': this.algoliaAppId,
                    'X-Algolia-API-Key': this.algoliaApiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: '',
                    filters: `company_slug:${companySlug}`,
                    hitsPerPage: 100
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.hits || [];
        } catch (error) {
            console.error('[YC] Company jobs error:', error);
            return [];
        }
    },

    // Normalize YC company data to our format
    normalizeCompany(data) {
        if (!data) return null;

        // Parse team size
        let teamSize = 0;
        if (data.team_size) {
            const match = data.team_size.toString().match(/(\d+)/);
            teamSize = match ? parseInt(match[1]) : 0;
        }

        // Parse batch to founding estimate (W21 = Winter 2021)
        let foundedYear = null;
        if (data.batch) {
            const batchMatch = data.batch.match(/[WS](\d{2})/);
            if (batchMatch) {
                const year = parseInt(batchMatch[1]);
                foundedYear = year < 50 ? 2000 + year : 1900 + year;
            }
        }

        return {
            name: data.name,
            slug: data.slug,
            website: data.website,
            oneLiner: data.one_liner,
            description: data.long_description || data.one_liner,
            batch: data.batch,
            batchYear: foundedYear,
            status: data.status || 'Active',  // Active, Acquired, Inactive, Public
            industries: data.industries || [],
            subindustry: data.subindustry,
            regions: data.regions || [],
            locations: data.all_locations || [],
            isHiring: data.isHiring || false,
            teamSize: teamSize,
            teamSizeRange: data.team_size,
            isTopCompany: data.top_company || false,
            highlightBlack: data.highlight_black || false,
            highlightLatinx: data.highlight_latinx || false,
            highlightWomen: data.highlight_women || false,
            ycUrl: `https://www.ycombinator.com/companies/${data.slug}`,
            source: 'ycombinator',
            lastUpdated: new Date().toISOString()
        };
    },

    // Normalize job data
    normalizeJob(job) {
        return {
            id: `yc-${job.objectID || job.id}`,
            title: job.title,
            company: job.company_name,
            companySlug: job.company_slug,
            location: job.location || 'Remote',
            remote: job.remote || false,
            salaryMin: job.salary_min,
            salaryMax: job.salary_max,
            salary: job.salary_min && job.salary_max ? `$${Math.round(job.salary_min/1000)}K - $${Math.round(job.salary_max/1000)}K` : null,
            equityMin: job.equity_min,
            equityMax: job.equity_max,
            equity: job.equity_min && job.equity_max ? `${job.equity_min}% - ${job.equity_max}%` : null,
            experience: job.experience,
            type: job.job_type || 'Full-time',
            url: job.url || `https://www.workatastartup.com/jobs/${job.objectID}`,
            postedAt: job.created_at ? new Date(job.created_at * 1000) : new Date(),
            source: 'ycombinator'
        };
    }
};

// Store for YC data
let ycData = {};

// Fetch and sync YC data for a company
async function fetchYCCompanyData(companyName) {
    const yc = YCombinatorProvider;
    const results = await yc.searchCompanies(companyName, 5);

    if (results.length === 0) return null;

    // Find best match
    const match = results.find(c =>
        c.name.toLowerCase() === companyName.toLowerCase() ||
        c.name.toLowerCase().includes(companyName.toLowerCase()) ||
        companyName.toLowerCase().includes(c.name.toLowerCase())
    ) || results[0];

    const normalized = yc.normalizeCompany(match);
    if (normalized) {
        ycData[companyName] = normalized;
        syncYCToSignalModel(companyName);
    }

    return normalized;
}

// Sync YC data to 50-signal model
function syncYCToSignalModel(companyName) {
    const ycd = ycData[companyName];
    if (!ycd) return false;

    const company = companies.find(c => c.name === companyName);

    // === UPDATE HIRING DATA ===
    if (!hiringData[companyName]) {
        hiringData[companyName] = {};
    }
    const hd = hiringData[companyName];

    // YC hiring status
    hd.ycHiring = ycd.isHiring;
    if (ycd.isHiring && (!hd.trend || hd.generated)) {
        hd.trend = 'growing';
    }

    // Team size from YC
    if (ycd.teamSize > 0) {
        hd.ycTeamSize = ycd.teamSize;
        if (!hd.employeeHistory || hd.generated) {
            const emp = ycd.teamSize;
            hd.employeeHistory = [
                Math.round(emp * 0.6),
                Math.round(emp * 0.7),
                Math.round(emp * 0.8),
                Math.round(emp * 0.9),
                emp
            ];
        }
    }

    // Locations
    if (ycd.locations?.length > 0 && (!hd.locations || hd.generated)) {
        hd.locations = ycd.locations.slice(0, 3);
    }

    hd.ycVerified = true;
    hd.ycBatch = ycd.batch;

    // === UPDATE WIKI DATA ===
    if (!wikiData[companyName]) {
        wikiData[companyName] = {};
    }
    const wd = wikiData[companyName];

    wd.ycData = ycd;
    wd.ycBatch = ycd.batch;
    wd.ycStatus = ycd.status;  // Active, Acquired, Inactive, Public
    wd.ycTopCompany = ycd.isTopCompany;
    wd.ycIndustries = ycd.industries;
    wd.ycUrl = ycd.ycUrl;

    // Founded year from batch
    if (ycd.batchYear && (!wd.founded || wd.generated)) {
        wd.founded = ycd.batchYear;
        wd.companyAge = new Date().getFullYear() - ycd.batchYear;
    }

    // Status affects M&A signals
    if (ycd.status === 'Acquired') {
        wd.wasAcquired = true;
    } else if (ycd.status === 'Public') {
        wd.publicStatus = 'public';
    }

    wd.ycVerified = true;

    return true;
}

// Fetch all YC companies that are hiring
async function fetchAllYCHiring(onProgress) {
    const yc = YCombinatorProvider;
    let page = 0;
    let totalFetched = 0;

    const firstBatch = await yc.getHiringCompanies(0, 100);
    const total = firstBatch.total;
    const pages = firstBatch.pages;

    console.log(`[YC] Found ${total} hiring companies across ${pages} pages`);

    // Process first batch
    for (const company of firstBatch.hits) {
        const normalized = yc.normalizeCompany(company);
        if (normalized) {
            ycData[normalized.name] = normalized;
            syncYCToSignalModel(normalized.name);
            totalFetched++;
        }
    }

    if (onProgress) onProgress(totalFetched, total);

    // Fetch remaining pages
    for (page = 1; page < Math.min(pages, 10); page++) {  // Limit to 10 pages (1000 companies)
        await new Promise(r => setTimeout(r, 200));  // Rate limit
        const batch = await yc.getHiringCompanies(page, 100);

        for (const company of batch.hits) {
            const normalized = yc.normalizeCompany(company);
            if (normalized) {
                ycData[normalized.name] = normalized;
                syncYCToSignalModel(normalized.name);
                totalFetched++;
            }
        }

        if (onProgress) onProgress(totalFetched, total);
    }

    console.log(`[YC] Fetched ${totalFetched} hiring companies`);
    return totalFetched;
}

// Get YC jobs for our tracked companies
async function fetchYCJobsForCompanies() {
    const yc = YCombinatorProvider;
    let totalJobs = 0;

    for (const [name, data] of Object.entries(ycData)) {
        if (data.slug && data.isHiring) {
            const jobs = await yc.getCompanyJobs(data.slug);
            if (jobs.length > 0) {
                ycData[name].jobs = jobs.map(j => yc.normalizeJob(j));
                totalJobs += jobs.length;

                // Update hiring data with real job count
                if (hiringData[name]) {
                    hiringData[name].ycJobs = jobs.length;
                    hiringData[name].roles = Math.max(hiringData[name].roles || 0, jobs.length);
                }
            }
            await new Promise(r => setTimeout(r, 100));  // Rate limit
        }
    }

    console.log(`[YC] Fetched ${totalJobs} jobs`);
    return totalJobs;
}

JobProviders.register('ycombinator', YCombinatorProvider);

// ==================== CRUNCHBASE PROVIDER ====================
const CrunchbaseProvider = {
    name: 'crunchbase',
    // Using RapidAPI Crunchbase endpoint
    apiKey: '', // User adds their RapidAPI key
    host: 'crunchbase-crunchbase-v1.p.rapidapi.com',

    cache: {},

    setApiKey(key) {
        this.apiKey = key;
    },

    // Search for organizations
    async searchOrganizations(query) {
        if (!this.apiKey) {
            console.warn('[Crunchbase] API key not set');
            return [];
        }

        const cacheKey = `search:${query}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`https://${this.host}/autocompletes?query=${encodeURIComponent(query)}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const results = data.entities?.filter(e => e.facet_ids?.includes('organization')) || [];
            this.cache[cacheKey] = results;
            return results;
        } catch (error) {
            console.error('[Crunchbase] Search error:', error);
            return [];
        }
    },

    // Get organization details
    async getOrganization(permalink) {
        if (!this.apiKey) return null;

        const cacheKey = `org:${permalink}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`https://${this.host}/organizations/${permalink}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[cacheKey] = data;
            return data;
        } catch (error) {
            console.error('[Crunchbase] Org error:', error);
            return null;
        }
    },

    // Get funding rounds
    async getFundingRounds(permalink) {
        if (!this.apiKey) return [];

        try {
            const response = await fetch(`https://${this.host}/organizations/${permalink}/funding_rounds`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.items || [];
        } catch (error) {
            console.error('[Crunchbase] Funding error:', error);
            return [];
        }
    },

    // Get acquisitions
    async getAcquisitions(permalink) {
        if (!this.apiKey) return [];

        try {
            const response = await fetch(`https://${this.host}/organizations/${permalink}/acquisitions`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.items || [];
        } catch (error) {
            console.error('[Crunchbase] Acquisitions error:', error);
            return [];
        }
    },

    // Normalize Crunchbase data
    normalizeCompany(data) {
        if (!data?.properties) return null;
        const p = data.properties;

        return {
            name: p.name,
            permalink: p.permalink,
            shortDescription: p.short_description,
            description: p.description,
            founded: p.founded_on ? new Date(p.founded_on).getFullYear() : null,
            hq: p.city ? `${p.city}, ${p.region || p.country}` : null,
            employeeCount: p.num_employees_enum,
            status: p.status,  // operating, closed, acquired, ipo
            fundingTotal: p.funding_total?.value_usd,
            lastFundingType: p.last_funding_type,
            lastFundingDate: p.last_funding_at,
            numFundingRounds: p.num_funding_rounds,
            investors: p.investor_identifiers?.map(i => i.value) || [],
            categories: p.categories?.map(c => c.value) || [],
            website: p.homepage_url,
            linkedin: p.linkedin?.value,
            twitter: p.twitter?.value,
            stockSymbol: p.stock_symbol,
            ipoDate: p.ipo_date,
            acquiredBy: p.acquired_by_identifier?.value,
            acquisitionPrice: p.acquisition_price?.value_usd,
            cbUrl: `https://www.crunchbase.com/organization/${p.permalink}`,
            source: 'crunchbase',
            lastUpdated: new Date().toISOString()
        };
    }
};

// Crunchbase data store
let crunchbaseData = {};

// Fetch and sync Crunchbase data
async function fetchCrunchbaseData(companyName) {
    const cb = CrunchbaseProvider;
    if (!cb.apiKey) {
        console.warn('[Crunchbase] Set API key first: CrunchbaseProvider.setApiKey("your-key")');
        return null;
    }

    const results = await cb.searchOrganizations(companyName);
    if (results.length === 0) return null;

    // Find best match
    const match = results.find(r =>
        r.identifier?.value?.toLowerCase() === companyName.toLowerCase()
    ) || results[0];

    if (!match?.identifier?.permalink) return null;

    const orgData = await cb.getOrganization(match.identifier.permalink);
    const normalized = cb.normalizeCompany(orgData);

    if (normalized) {
        crunchbaseData[companyName] = normalized;
        syncCrunchbaseToSignalModel(companyName);
    }

    return normalized;
}

// Sync Crunchbase to signal model
function syncCrunchbaseToSignalModel(companyName) {
    const cbd = crunchbaseData[companyName];
    if (!cbd) return false;

    // Update wiki data with Crunchbase signals
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.cbData = cbd;
    wd.cbPermalink = cbd.permalink;

    // Funding signals
    if (cbd.fundingTotal) {
        wd.totalFunding = `$${Math.round(cbd.fundingTotal / 1000000)}M`;
        wd.fundingNum = cbd.fundingTotal;
    }
    if (cbd.lastFundingDate) {
        wd.lastFunding = cbd.lastFundingDate;
        const lastDate = new Date(cbd.lastFundingDate);
        wd.yearsSinceLastRaise = (new Date() - lastDate) / (365.25 * 24 * 60 * 60 * 1000);
    }
    if (cbd.lastFundingType) {
        wd.lastFundingRound = cbd.lastFundingType;
    }
    if (cbd.investors?.length > 0) {
        wd.keyInvestors = cbd.investors.slice(0, 5);
    }

    // M&A signals
    if (cbd.status === 'acquired') {
        wd.wasAcquired = true;
        wd.acquiredBy = cbd.acquiredBy;
        wd.acquisitionPrice = cbd.acquisitionPrice;
    }
    if (cbd.status === 'ipo') {
        wd.publicStatus = 'public';
        wd.stockSymbol = cbd.stockSymbol;
        wd.ipoDate = cbd.ipoDate;
    }

    // Company basics
    if (cbd.founded && (!wd.founded || wd.generated)) {
        wd.founded = cbd.founded;
        wd.companyAge = new Date().getFullYear() - cbd.founded;
    }
    if (cbd.hq && (!wd.hq || wd.generated)) {
        wd.hq = cbd.hq;
    }

    wd.cbVerified = true;
    wd.cbUrl = cbd.cbUrl;

    return true;
}

JobProviders.register('crunchbase', CrunchbaseProvider);

// ==================== WELLFOUND (ANGELLIST) PROVIDER ====================
const WellfoundProvider = {
    name: 'wellfound',
    // Wellfound uses GraphQL API
    graphqlEndpoint: 'https://wellfound.com/graphql',

    cache: {},

    // Search companies
    async searchCompanies(query, limit = 10) {
        const cacheKey = `search:${query}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(this.graphqlEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: `
                        query SearchStartups($query: String!, $limit: Int!) {
                            startupSearch(query: $query, first: $limit) {
                                edges {
                                    node {
                                        id
                                        name
                                        slug
                                        logoUrl
                                        highConcept
                                        companySize
                                        locationTags { displayName }
                                        marketTags { displayName }
                                        jobListingsConnection { totalCount }
                                    }
                                }
                            }
                        }
                    `,
                    variables: { query, limit }
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const results = data.data?.startupSearch?.edges?.map(e => e.node) || [];
            this.cache[cacheKey] = results;
            return results;
        } catch (error) {
            console.error('[Wellfound] Search error:', error);
            return [];
        }
    },

    // Get company jobs
    async getCompanyJobs(slug) {
        try {
            const response = await fetch(this.graphqlEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: `
                        query StartupJobs($slug: String!) {
                            startup(slug: $slug) {
                                jobListings {
                                    id
                                    title
                                    slug
                                    remote
                                    primaryRoleTitle
                                    liveStartAt
                                    compensation
                                    locationNames
                                }
                            }
                        }
                    `,
                    variables: { slug }
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.data?.startup?.jobListings || [];
        } catch (error) {
            console.error('[Wellfound] Jobs error:', error);
            return [];
        }
    },

    // Normalize company data
    normalizeCompany(data) {
        if (!data) return null;

        // Parse company size
        let teamSize = 0;
        if (data.companySize) {
            const match = data.companySize.match(/(\d+)/);
            teamSize = match ? parseInt(match[1]) : 0;
        }

        return {
            id: data.id,
            name: data.name,
            slug: data.slug,
            logo: data.logoUrl,
            tagline: data.highConcept,
            teamSize: teamSize,
            teamSizeRange: data.companySize,
            locations: data.locationTags?.map(t => t.displayName) || [],
            markets: data.marketTags?.map(t => t.displayName) || [],
            jobCount: data.jobListingsConnection?.totalCount || 0,
            wellfoundUrl: `https://wellfound.com/company/${data.slug}`,
            source: 'wellfound',
            lastUpdated: new Date().toISOString()
        };
    },

    // Normalize job data
    normalizeJob(job, companyName) {
        return {
            id: `wf-${job.id}`,
            title: job.title,
            company: companyName,
            location: job.locationNames?.join(', ') || 'Remote',
            remote: job.remote || false,
            role: job.primaryRoleTitle,
            compensation: job.compensation,
            postedAt: job.liveStartAt ? new Date(job.liveStartAt) : new Date(),
            url: `https://wellfound.com/jobs/${job.slug}`,
            source: 'wellfound'
        };
    }
};

// Wellfound data store
let wellfoundData = {};

// Fetch Wellfound data
async function fetchWellfoundData(companyName) {
    const wf = WellfoundProvider;
    const results = await wf.searchCompanies(companyName, 5);

    if (results.length === 0) return null;

    const match = results.find(r =>
        r.name.toLowerCase() === companyName.toLowerCase()
    ) || results[0];

    const normalized = wf.normalizeCompany(match);
    if (normalized) {
        // Fetch jobs too
        const jobs = await wf.getCompanyJobs(normalized.slug);
        normalized.jobs = jobs.map(j => wf.normalizeJob(j, normalized.name));
        normalized.jobCount = jobs.length;

        wellfoundData[companyName] = normalized;
        syncWellfoundToSignalModel(companyName);
    }

    return normalized;
}

// Sync Wellfound to signal model
function syncWellfoundToSignalModel(companyName) {
    const wfd = wellfoundData[companyName];
    if (!wfd) return false;

    // Update hiring data
    if (!hiringData[companyName]) hiringData[companyName] = {};
    const hd = hiringData[companyName];

    hd.wellfoundJobs = wfd.jobCount;
    if (wfd.jobCount > 0) {
        hd.roles = Math.max(hd.roles || 0, wfd.jobCount);
        if (!hd.trend || hd.generated) hd.trend = 'growing';
    }
    if (wfd.teamSize > 0) {
        hd.wellfoundTeamSize = wfd.teamSize;
    }
    if (wfd.locations?.length > 0 && (!hd.locations || hd.generated)) {
        hd.locations = wfd.locations.slice(0, 3);
    }

    hd.wellfoundVerified = true;
    hd.wellfoundUrl = wfd.wellfoundUrl;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.wellfoundData = wfd;
    wd.wellfoundMarkets = wfd.markets;
    wd.wellfoundVerified = true;

    return true;
}

JobProviders.register('wellfound', WellfoundProvider);

// ==================== BUILTIN PROVIDER ====================
const BuiltInProvider = {
    name: 'builtin',
    // BuiltIn has city-specific sites
    baseUrl: 'https://builtin.com',

    cache: {},

    // Search companies (scrapes search results)
    async searchCompanies(query, location = '') {
        const cacheKey = `search:${query}:${location}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            // BuiltIn's API endpoint for company search
            const url = `${this.baseUrl}/api/companies/search?search=${encodeURIComponent(query)}${location ? `&location=${encodeURIComponent(location)}` : ''}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[cacheKey] = data.companies || [];
            return data.companies || [];
        } catch (error) {
            console.error('[BuiltIn] Search error:', error);
            return [];
        }
    },

    // Get company jobs
    async getCompanyJobs(companySlug) {
        try {
            const response = await fetch(`${this.baseUrl}/api/companies/${companySlug}/jobs`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.jobs || [];
        } catch (error) {
            console.error('[BuiltIn] Jobs error:', error);
            return [];
        }
    },

    // Normalize company
    normalizeCompany(data) {
        if (!data) return null;

        return {
            id: data.id,
            name: data.name,
            slug: data.slug,
            logo: data.logo_url,
            description: data.description,
            industry: data.industry,
            size: data.company_size,
            founded: data.founded_year,
            hq: data.headquarters,
            website: data.website,
            techStack: data.technologies || [],
            perks: data.perks || [],
            jobCount: data.job_count || 0,
            builtinUrl: `${this.baseUrl}/company/${data.slug}`,
            source: 'builtin',
            lastUpdated: new Date().toISOString()
        };
    },

    // Normalize job
    normalizeJob(job, companyName) {
        return {
            id: `bi-${job.id}`,
            title: job.title,
            company: companyName,
            location: job.location,
            remote: job.remote || false,
            salary: job.salary_range,
            department: job.department,
            experience: job.experience_level,
            postedAt: new Date(job.posted_date),
            url: job.url,
            source: 'builtin'
        };
    }
};

// BuiltIn data store
let builtinData = {};

// Fetch BuiltIn data
async function fetchBuiltInData(companyName) {
    const bi = BuiltInProvider;
    const results = await bi.searchCompanies(companyName);

    if (results.length === 0) return null;

    const match = results.find(r =>
        r.name.toLowerCase() === companyName.toLowerCase()
    ) || results[0];

    const normalized = bi.normalizeCompany(match);
    if (normalized) {
        builtinData[companyName] = normalized;
        syncBuiltInToSignalModel(companyName);
    }

    return normalized;
}

// Sync BuiltIn to signal model
function syncBuiltInToSignalModel(companyName) {
    const bid = builtinData[companyName];
    if (!bid) return false;

    // Update hiring data
    if (!hiringData[companyName]) hiringData[companyName] = {};
    const hd = hiringData[companyName];

    if (bid.jobCount > 0) {
        hd.builtinJobs = bid.jobCount;
        hd.roles = Math.max(hd.roles || 0, bid.jobCount);
    }

    // Tech stack is valuable signal
    if (bid.techStack?.length > 0) {
        hd.techStack = bid.techStack;
    }

    hd.builtinVerified = true;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    if (bid.techStack?.length > 0 && (!wd.techStack || wd.generated)) {
        wd.techStack = bid.techStack;
    }
    if (bid.founded && (!wd.founded || wd.generated)) {
        wd.founded = bid.founded;
    }

    wd.builtinVerified = true;
    wd.builtinUrl = bid.builtinUrl;

    return true;
}

JobProviders.register('builtin', BuiltInProvider);

// ==================== NEWS/PRESS PROVIDER ====================
const NewsProvider = {
    name: 'news',
    // Using NewsAPI.org (free tier: 100 requests/day)
    apiKey: '', // User adds their key from newsapi.org
    baseUrl: 'https://newsapi.org/v2',

    cache: {},

    setApiKey(key) {
        this.apiKey = key;
    },

    // Search news for a company
    async searchNews(companyName, days = 30) {
        if (!this.apiKey) {
            console.warn('[News] API key not set');
            return [];
        }

        const cacheKey = `news:${companyName}:${days}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        const fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - days);

        try {
            const response = await fetch(
                `${this.baseUrl}/everything?q="${encodeURIComponent(companyName)}"&from=${fromDate.toISOString().split('T')[0]}&sortBy=relevancy&pageSize=20&apiKey=${this.apiKey}`
            );
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[cacheKey] = data.articles || [];
            return data.articles || [];
        } catch (error) {
            console.error('[News] Search error:', error);
            return [];
        }
    },

    // Analyze sentiment (basic)
    analyzeSentiment(articles) {
        if (!articles?.length) return { score: 0, label: 'neutral' };

        const positiveWords = ['growth', 'success', 'launch', 'funding', 'profit', 'innovation', 'partnership', 'expansion', 'hire', 'milestone'];
        const negativeWords = ['layoff', 'lawsuit', 'decline', 'loss', 'controversy', 'investigation', 'breach', 'failure', 'shutdown', 'delay'];

        let positiveCount = 0;
        let negativeCount = 0;

        for (const article of articles) {
            const text = `${article.title} ${article.description || ''}`.toLowerCase();
            positiveCount += positiveWords.filter(w => text.includes(w)).length;
            negativeCount += negativeWords.filter(w => text.includes(w)).length;
        }

        const total = positiveCount + negativeCount || 1;
        const score = Math.round(((positiveCount - negativeCount) / total) * 100);

        let label = 'neutral';
        if (score > 30) label = 'positive';
        else if (score > 10) label = 'slightly positive';
        else if (score < -30) label = 'negative';
        else if (score < -10) label = 'slightly negative';

        return { score, label, positiveCount, negativeCount, totalArticles: articles.length };
    },

    // Extract key topics
    extractTopics(articles) {
        const topics = {};
        const keywords = ['AI', 'funding', 'launch', 'partnership', 'acquisition', 'IPO', 'layoffs', 'expansion', 'product', 'revenue', 'growth', 'hiring'];

        for (const article of articles) {
            const text = `${article.title} ${article.description || ''}`;
            for (const keyword of keywords) {
                if (text.toLowerCase().includes(keyword.toLowerCase())) {
                    topics[keyword] = (topics[keyword] || 0) + 1;
                }
            }
        }

        return Object.entries(topics)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([topic, count]) => ({ topic, count }));
    }
};

// News data store
let newsData = {};

// Fetch news and analyze
async function fetchNewsData(companyName, days = 30) {
    const news = NewsProvider;
    if (!news.apiKey) {
        console.warn('[News] Set API key first: NewsProvider.setApiKey("your-key")');
        return null;
    }

    const articles = await news.searchNews(companyName, days);
    if (articles.length === 0) return null;

    const sentiment = news.analyzeSentiment(articles);
    const topics = news.extractTopics(articles);

    const result = {
        companyName,
        articles: articles.slice(0, 10),  // Keep top 10
        totalArticles: articles.length,
        sentiment,
        topics,
        lastUpdated: new Date().toISOString()
    };

    newsData[companyName] = result;
    syncNewsToSignalModel(companyName);

    return result;
}

// Sync news to signal model
function syncNewsToSignalModel(companyName) {
    const nd = newsData[companyName];
    if (!nd) return false;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.newsData = nd;
    wd.pressMentions = nd.totalArticles;
    wd.sentimentScore = nd.sentiment.score;
    wd.sentimentLabel = nd.sentiment.label;
    wd.newsTopics = nd.topics;
    wd.newsVerified = true;

    // High press coverage = higher profile
    if (nd.totalArticles > 10) {
        wd.highProfile = true;
    }

    return true;
}

JobProviders.register('news', NewsProvider);

// ==================== GLASSDOOR PROVIDER ====================
const GlassdoorProvider = {
    name: 'glassdoor',
    // RapidAPI Glassdoor endpoint
    apiKey: '', // User adds RapidAPI key
    host: 'glassdoor.p.rapidapi.com',

    cache: {},

    setApiKey(key) {
        this.apiKey = key;
    },

    // Search companies
    async searchCompanies(query) {
        if (!this.apiKey) return [];

        const cacheKey = `search:${query}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`https://${this.host}/companies/search?query=${encodeURIComponent(query)}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[cacheKey] = data.companies || data || [];
            return data.companies || data || [];
        } catch (error) {
            console.error('[Glassdoor] Search error:', error);
            return [];
        }
    },

    // Get company details
    async getCompanyDetails(companyId) {
        if (!this.apiKey) return null;

        try {
            const response = await fetch(`https://${this.host}/companies/${companyId}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': this.host
                }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('[Glassdoor] Details error:', error);
            return null;
        }
    },

    // Normalize company data
    normalizeCompany(data) {
        if (!data) return null;

        return {
            id: data.id || data.employerId,
            name: data.name || data.employerName,
            rating: data.overallRating || data.rating,
            ceoRating: data.ceoRating || data.ceoApproval,
            recommendToFriend: data.recommendToFriend,
            reviewCount: data.numberOfReviews || data.reviewCount,
            salaryCount: data.numberOfSalaries,
            interviewCount: data.numberOfInterviews,
            size: data.size || data.employeeCount,
            industry: data.industry,
            hq: data.headquarters,
            website: data.website,
            logo: data.logo || data.squareLogo,
            glassdoorUrl: data.url || `https://www.glassdoor.com/Overview/${data.name}-Reviews-E${data.id}.htm`,
            ratings: {
                overall: data.overallRating,
                culture: data.cultureAndValuesRating,
                diversity: data.diversityAndInclusionRating,
                workLife: data.workLifeBalanceRating,
                seniorMgmt: data.seniorManagementRating,
                compensation: data.compensationAndBenefitsRating,
                career: data.careerOpportunitiesRating
            },
            source: 'glassdoor',
            lastUpdated: new Date().toISOString()
        };
    }
};

// Glassdoor data store
let glassdoorData = {};

// Fetch Glassdoor data
async function fetchGlassdoorData(companyName) {
    const gd = GlassdoorProvider;
    if (!gd.apiKey) {
        console.warn('[Glassdoor] Set API key first: GlassdoorProvider.setApiKey("your-key")');
        return null;
    }

    const results = await gd.searchCompanies(companyName);
    if (results.length === 0) return null;

    const match = results.find(r =>
        (r.name || r.employerName)?.toLowerCase() === companyName.toLowerCase()
    ) || results[0];

    const normalized = gd.normalizeCompany(match);
    if (normalized) {
        glassdoorData[companyName] = normalized;
        syncGlassdoorToSignalModel(companyName);
    }

    return normalized;
}

// Sync Glassdoor to signal model
function syncGlassdoorToSignalModel(companyName) {
    const gdd = glassdoorData[companyName];
    if (!gdd) return false;

    // Update hiring data with Glassdoor rating
    if (!hiringData[companyName]) hiringData[companyName] = {};
    const hd = hiringData[companyName];

    if (gdd.rating) {
        hd.glassdoorRating = gdd.rating;
    }
    if (gdd.ceoRating) {
        hd.ceoApproval = gdd.ceoRating;
    }

    hd.glassdoorVerified = true;
    hd.glassdoorUrl = gdd.glassdoorUrl;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.glassdoorData = gdd;
    wd.glassdoorRating = gdd.rating;
    wd.glassdoorRatings = gdd.ratings;
    wd.glassdoorReviews = gdd.reviewCount;
    wd.glassdoorVerified = true;

    return true;
}

JobProviders.register('glassdoor', GlassdoorProvider);

// ==================== REFER.ME PROVIDER ====================
// Job referrals platform with 5000+ companies
const ReferMeProvider = {
    name: 'referme',
    baseUrl: 'https://www.refer.me',

    cache: {},

    // Search jobs on Refer.me
    async searchJobs(query, options = {}) {
        const cacheKey = `jobs:${query}:${JSON.stringify(options)}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            // Refer.me uses React Query - try their API endpoint
            const params = new URLSearchParams({
                search: query,
                page: options.page || 1,
                limit: options.limit || 50,
                ...(options.company && { company: options.company }),
                ...(options.salary && { salary: options.salary }),
                ...(options.type && { type: options.type })
            });

            const response = await fetch(`${this.baseUrl}/api/jobs?${params}`);
            if (!response.ok) {
                // Fallback: try to parse from page
                console.log('[ReferMe] API not available, using fallback');
                return [];
            }
            const data = await response.json();
            this.cache[cacheKey] = data.jobs || data || [];
            return this.cache[cacheKey];
        } catch (error) {
            console.error('[ReferMe] Search error:', error);
            return [];
        }
    },

    // Get companies with referral opportunities
    async getCompanies(page = 1) {
        const cacheKey = `companies:${page}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.baseUrl}/api/companies?page=${page}`);
            if (!response.ok) return [];
            const data = await response.json();
            this.cache[cacheKey] = data.companies || data || [];
            return this.cache[cacheKey];
        } catch (error) {
            console.error('[ReferMe] Companies error:', error);
            return [];
        }
    },

    // Get referrers for a specific company
    async getReferrers(companySlug) {
        const cacheKey = `referrers:${companySlug}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.baseUrl}/api/referrals/${companySlug}`);
            if (!response.ok) return [];
            const data = await response.json();
            this.cache[cacheKey] = data;
            return data;
        } catch (error) {
            console.error('[ReferMe] Referrers error:', error);
            return [];
        }
    },

    // Search for a company and get referral info
    async searchCompany(companyName) {
        const cacheKey = `company:${companyName}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.baseUrl}/api/companies/search?q=${encodeURIComponent(companyName)}`);
            if (!response.ok) return null;
            const data = await response.json();
            const company = data.companies?.find(c =>
                c.name.toLowerCase().includes(companyName.toLowerCase())
            );
            if (company) {
                this.cache[cacheKey] = company;
            }
            return company || null;
        } catch (error) {
            console.error('[ReferMe] Company search error:', error);
            return null;
        }
    },

    // Normalize company data
    normalizeCompany(data) {
        if (!data) return null;
        return {
            name: data.name,
            slug: data.slug,
            logo: data.logo,
            employeeCount: data.employeeCount || data.employee_count,
            categories: data.categories || [],
            referralBonus: data.referralAmount || data.referral_amount,
            referrerCount: data.referrerCount || data.referrer_count,
            jobCount: data.jobCount || data.job_count,
            hasReferrals: data.hasReferrals !== false,
            url: `${this.baseUrl}/referrals/${data.slug}`,
            source: 'referme'
        };
    },

    // Normalize job data
    normalizeJob(data) {
        if (!data) return null;
        return {
            id: data.id,
            title: data.title,
            company: data.company?.name || data.companyName,
            location: data.city || data.location,
            salary: data.salary,
            benefits: data.benefits,
            deadline: data.applicationDeadline || data.deadline,
            referralBonus: data.referralAmount,
            type: data.employmentType || data.type,
            url: data.applyUrl || data.url,
            atsSystem: data.atsSystem,
            source: 'referme'
        };
    }
};

// Refer.me data storage
let referMeData = {};

// Fetch Refer.me data for a company
async function fetchReferMeData(companyName) {
    try {
        const company = await ReferMeProvider.searchCompany(companyName);
        if (company) {
            referMeData[companyName] = ReferMeProvider.normalizeCompany(company);
            syncReferMeToSignalModel(companyName);
            return referMeData[companyName];
        }
    } catch (error) {
        console.error(`[ReferMe] Error fetching ${companyName}:`, error);
    }
    return null;
}

// Sync Refer.me data to signal model
function syncReferMeToSignalModel(companyName) {
    const rmd = referMeData[companyName];
    if (!rmd) return false;

    // Update hiring data
    if (!hiringData[companyName]) hiringData[companyName] = {};
    const hd = hiringData[companyName];

    if (rmd.jobCount) {
        hd.referMeJobs = rmd.jobCount;
    }
    if (rmd.referrerCount) {
        hd.referrerCount = rmd.referrerCount;
    }
    if (rmd.referralBonus) {
        hd.referralBonus = rmd.referralBonus;
    }
    hd.hasReferrals = rmd.hasReferrals;
    hd.referMeVerified = true;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.referMeData = rmd;
    wd.referMeUrl = rmd.url;
    wd.referMeVerified = true;

    return true;
}

JobProviders.register('referme', ReferMeProvider);

// ==================== OTTA PROVIDER ====================
// Tech jobs platform with salary transparency
const OttaProvider = {
    name: 'otta',
    baseUrl: 'https://otta.com',
    apiUrl: 'https://api.otta.com',

    cache: {},

    // Search jobs on Otta
    async searchJobs(query, options = {}) {
        const cacheKey = `jobs:${query}:${JSON.stringify(options)}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const params = new URLSearchParams({
                q: query,
                page: options.page || 0,
                limit: options.limit || 50
            });

            // Otta uses GraphQL - try REST endpoint first
            const response = await fetch(`${this.apiUrl}/jobs/search?${params}`);
            if (!response.ok) {
                console.log('[Otta] API not available');
                return [];
            }
            const data = await response.json();
            this.cache[cacheKey] = data.jobs || data.results || [];
            return this.cache[cacheKey];
        } catch (error) {
            console.error('[Otta] Search error:', error);
            return [];
        }
    },

    // Search companies on Otta
    async searchCompanies(query) {
        const cacheKey = `company:${query}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.apiUrl}/companies/search?q=${encodeURIComponent(query)}`);
            if (!response.ok) return [];
            const data = await response.json();
            this.cache[cacheKey] = data.companies || data || [];
            return this.cache[cacheKey];
        } catch (error) {
            console.error('[Otta] Company search error:', error);
            return [];
        }
    },

    // Get company details
    async getCompany(slug) {
        const cacheKey = `company-detail:${slug}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.apiUrl}/companies/${slug}`);
            if (!response.ok) return null;
            const data = await response.json();
            this.cache[cacheKey] = data;
            return data;
        } catch (error) {
            console.error('[Otta] Company error:', error);
            return null;
        }
    },

    // Get company jobs
    async getCompanyJobs(slug, options = {}) {
        const cacheKey = `company-jobs:${slug}`;
        if (this.cache[cacheKey]) return this.cache[cacheKey];

        try {
            const response = await fetch(`${this.apiUrl}/companies/${slug}/jobs`);
            if (!response.ok) return [];
            const data = await response.json();
            this.cache[cacheKey] = data.jobs || data || [];
            return this.cache[cacheKey];
        } catch (error) {
            console.error('[Otta] Company jobs error:', error);
            return [];
        }
    },

    // Normalize company data
    normalizeCompany(data) {
        if (!data) return null;
        return {
            name: data.name,
            slug: data.slug || data.urlSlug,
            logo: data.logoUrl || data.logo,
            description: data.description || data.shortDescription,
            size: data.size || data.companySize,
            industry: data.industry || data.sector,
            founded: data.founded || data.foundedYear,
            funding: data.funding || data.totalFunding,
            stage: data.stage || data.fundingStage,
            locations: data.locations || data.offices || [],
            techStack: data.techStack || data.technologies || [],
            culture: data.culture || data.values || [],
            benefits: data.benefits || data.perks || [],
            salaryTransparency: data.salaryTransparency !== false,
            jobCount: data.jobCount || data.openRoles,
            url: `${this.baseUrl}/companies/${data.slug || data.urlSlug}`,
            source: 'otta'
        };
    },

    // Normalize job data
    normalizeJob(data) {
        if (!data) return null;
        return {
            id: data.id,
            title: data.title || data.name,
            company: data.company?.name || data.companyName,
            location: data.location || data.locations?.join(', '),
            salary: {
                min: data.salaryMin || data.salary?.min,
                max: data.salaryMax || data.salary?.max,
                currency: data.currency || 'USD'
            },
            remote: data.remote || data.isRemote,
            experience: data.experience || data.experienceLevel,
            techStack: data.techStack || data.technologies || [],
            benefits: data.benefits || [],
            equity: data.equity || data.hasEquity,
            visa: data.visaSponsorship,
            url: data.url || `${this.baseUrl}/jobs/${data.id}`,
            source: 'otta'
        };
    }
};

// Otta data storage
let ottaData = {};

// Fetch Otta data for a company
async function fetchOttaData(companyName) {
    try {
        const companies = await OttaProvider.searchCompanies(companyName);
        if (companies.length > 0) {
            const match = companies.find(c =>
                c.name.toLowerCase().includes(companyName.toLowerCase()) ||
                companyName.toLowerCase().includes(c.name.toLowerCase())
            );
            if (match) {
                const slug = match.slug || match.urlSlug;
                const details = await OttaProvider.getCompany(slug);
                const jobs = await OttaProvider.getCompanyJobs(slug);

                ottaData[companyName] = {
                    ...OttaProvider.normalizeCompany(details || match),
                    jobs: jobs.map(j => OttaProvider.normalizeJob(j))
                };
                syncOttaToSignalModel(companyName);
                return ottaData[companyName];
            }
        }
    } catch (error) {
        console.error(`[Otta] Error fetching ${companyName}:`, error);
    }
    return null;
}

// Sync Otta data to signal model
function syncOttaToSignalModel(companyName) {
    const od = ottaData[companyName];
    if (!od) return false;

    // Update hiring data
    if (!hiringData[companyName]) hiringData[companyName] = {};
    const hd = hiringData[companyName];

    if (od.jobCount) {
        hd.ottaJobs = od.jobCount;
    }
    if (od.techStack?.length) {
        hd.techStack = hd.techStack ? [...new Set([...hd.techStack, ...od.techStack])] : od.techStack;
    }
    if (od.benefits?.length) {
        hd.ottaBenefits = od.benefits;
    }
    if (od.salaryTransparency) {
        hd.salaryTransparency = true;
    }
    hd.ottaVerified = true;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.ottaData = od;
    wd.ottaUrl = od.url;
    if (od.funding) {
        wd.ottaFunding = od.funding;
    }
    if (od.stage) {
        wd.fundingStage = od.stage;
    }
    if (od.techStack?.length) {
        wd.techStack = wd.techStack ? [...new Set([...wd.techStack, ...od.techStack])] : od.techStack;
    }
    wd.ottaVerified = true;

    return true;
}

JobProviders.register('otta', OttaProvider);

// ==================== MASTER FETCH ALL SOURCES ====================
async function fetchAllSourcesForCompany(companyName, options = {}) {
    const results = {
        linkedin: null,
        yc: null,
        crunchbase: null,
        wellfound: null,
        builtin: null,
        news: null,
        glassdoor: null,
        referme: null,
        otta: null
    };

    console.log(`[Master] Fetching all sources for: ${companyName}`);

    // LinkedIn (if API key set)
    if (options.linkedin !== false) {
        try {
            const linkedin = JobProviders.get('linkedin');
            const searchResults = await linkedin.searchCompanies(companyName);
            if (searchResults.length > 0) {
                const match = searchResults.find(r => r.username || r.universalName);
                if (match) {
                    const data = await linkedin.getCompanyByUsername(match.username || match.universalName);
                    if (data) {
                        linkedInData[companyName] = linkedin.normalizeCompany(data);
                        syncLinkedInToSignalModel(companyName);
                        results.linkedin = linkedInData[companyName];
                    }
                }
            }
        } catch (e) { console.warn('[Master] LinkedIn error:', e); }
    }

    // Y Combinator
    if (options.yc !== false) {
        try {
            results.yc = await fetchYCCompanyData(companyName);
        } catch (e) { console.warn('[Master] YC error:', e); }
    }

    // Crunchbase (if API key set)
    if (options.crunchbase !== false && CrunchbaseProvider.apiKey) {
        try {
            results.crunchbase = await fetchCrunchbaseData(companyName);
        } catch (e) { console.warn('[Master] Crunchbase error:', e); }
    }

    // Wellfound
    if (options.wellfound !== false) {
        try {
            results.wellfound = await fetchWellfoundData(companyName);
        } catch (e) { console.warn('[Master] Wellfound error:', e); }
    }

    // BuiltIn
    if (options.builtin !== false) {
        try {
            results.builtin = await fetchBuiltInData(companyName);
        } catch (e) { console.warn('[Master] BuiltIn error:', e); }
    }

    // News (if API key set)
    if (options.news !== false && NewsProvider.apiKey) {
        try {
            results.news = await fetchNewsData(companyName);
        } catch (e) { console.warn('[Master] News error:', e); }
    }

    // Glassdoor (if API key set)
    if (options.glassdoor !== false && GlassdoorProvider.apiKey) {
        try {
            results.glassdoor = await fetchGlassdoorData(companyName);
        } catch (e) { console.warn('[Master] Glassdoor error:', e); }
    }

    // Refer.me
    if (options.referme !== false) {
        try {
            results.referme = await fetchReferMeData(companyName);
        } catch (e) { console.warn('[Master] ReferMe error:', e); }
    }

    // Otta
    if (options.otta !== false) {
        try {
            results.otta = await fetchOttaData(companyName);
        } catch (e) { console.warn('[Master] Otta error:', e); }
    }

    console.log(`[Master] Completed fetch for ${companyName}:`, Object.keys(results).filter(k => results[k]));
    return results;
}

// Batch fetch for multiple companies
async function fetchAllSourcesForCompanies(companyNames, options = {}, onProgress) {
    const results = {};
    let completed = 0;

    for (const name of companyNames) {
        results[name] = await fetchAllSourcesForCompany(name, options);
        completed++;
        if (onProgress) onProgress(completed, companyNames.length, name);
        await new Promise(r => setTimeout(r, options.delay || 500));  // Rate limit
    }

    return results;
}

// ==================== NEWS & SOCIAL SIGNAL MODULE ====================
// Real-time monitoring of company mentions via Google Alerts, Twitter/X, and news aggregation

const NewsAlertModule = {
    // Storage for alerts and mentions
    alerts: {},
    mentions: {},
    socialData: {},

    // Google Alerts RSS feed base (alerts are created manually, then monitored via RSS)
    googleAlertsRssBase: 'https://www.google.com/alerts/feeds/',

    // Generate Google Alert creation URL for a company
    getGoogleAlertUrl(companyName, options = {}) {
        const query = options.query || `"${companyName}" (acquisition OR funding OR layoffs OR "Series" OR IPO OR merger)`;
        const params = new URLSearchParams({
            q: query,
            // Google Alerts parameters
            // hl: language, gl: region, cid: category
        });
        return `https://www.google.com/alerts?${params}#1:0`;
    },

    // Generate alert URLs for all companies
    generateAlertUrls(companyNames) {
        return companyNames.map(name => ({
            company: name,
            alertUrl: this.getGoogleAlertUrl(name),
            queries: [
                `"${name}" acquisition`,
                `"${name}" funding round`,
                `"${name}" layoffs`,
                `"${name}" IPO`,
                `"${name}" merger`,
                `"${name}" CEO`
            ]
        }));
    },

    // Parse Google Alerts RSS feed
    async parseGoogleAlertsFeed(feedUrl) {
        try {
            // Use a CORS proxy or server-side fetch
            const response = await fetch(feedUrl);
            if (!response.ok) return [];

            const text = await response.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');

            const entries = xml.querySelectorAll('entry');
            return Array.from(entries).map(entry => ({
                title: entry.querySelector('title')?.textContent,
                link: entry.querySelector('link')?.getAttribute('href'),
                published: entry.querySelector('published')?.textContent,
                content: entry.querySelector('content')?.textContent,
                source: 'google_alerts'
            }));
        } catch (error) {
            console.error('[NewsAlerts] Feed parse error:', error);
            return [];
        }
    },

    // Store alert configuration for a company
    setupAlert(companyName, config = {}) {
        this.alerts[companyName] = {
            company: companyName,
            enabled: true,
            feedUrl: config.feedUrl || null,
            queries: config.queries || [
                `"${companyName}" acquisition`,
                `"${companyName}" funding`,
                `"${companyName}" layoffs OR restructuring`,
                `"${companyName}" IPO OR "going public"`,
                `"${companyName}" CEO OR leadership`
            ],
            keywords: config.keywords || ['acquisition', 'funding', 'layoffs', 'IPO', 'merger', 'Series A', 'Series B', 'valuation'],
            createdAt: new Date().toISOString(),
            lastChecked: null,
            alertCount: 0
        };
        return this.alerts[companyName];
    },

    // Setup alerts for all companies
    setupAllAlerts() {
        const results = [];
        for (const company of companies) {
            results.push(this.setupAlert(company.name));
        }
        console.log(`[NewsAlerts] Setup ${results.length} company alerts`);
        return results;
    },

    // Get setup instructions for Google Alerts
    getSetupInstructions(companyName) {
        const queries = [
            `"${companyName}" acquisition OR acquired`,
            `"${companyName}" funding OR "Series A" OR "Series B" OR "Series C"`,
            `"${companyName}" layoffs OR restructuring OR "workforce reduction"`,
            `"${companyName}" IPO OR "going public" OR SPAC`,
            `"${companyName}" CEO OR "new leadership" OR "steps down"`
        ];

        return {
            company: companyName,
            instructions: `
1. Go to https://www.google.com/alerts
2. Create alerts for each query below
3. Set delivery to "RSS feed"
4. Copy the RSS feed URL and add it to the system
            `.trim(),
            queries,
            alertUrls: queries.map(q => `https://www.google.com/alerts?q=${encodeURIComponent(q)}`)
        };
    }
};

// Twitter/X Monitoring Provider
const TwitterProvider = {
    name: 'twitter',
    // Twitter API v2 credentials
    bearerToken: '', // User adds their Twitter API bearer token
    apiUrl: 'https://api.twitter.com/2',

    cache: {},
    rateLimitRemaining: 100,

    setBearerToken(token) {
        this.bearerToken = token;
    },

    // Search recent tweets about a company
    async searchTweets(query, options = {}) {
        if (!this.bearerToken) {
            console.warn('[Twitter] No bearer token set');
            return [];
        }

        const cacheKey = `tweets:${query}:${JSON.stringify(options)}`;
        if (this.cache[cacheKey] && Date.now() - this.cache[cacheKey].timestamp < 300000) {
            return this.cache[cacheKey].data;
        }

        try {
            const params = new URLSearchParams({
                query: query,
                max_results: options.maxResults || 100,
                'tweet.fields': 'created_at,public_metrics,author_id,entities',
                'user.fields': 'name,username,verified,public_metrics',
                expansions: 'author_id'
            });

            if (options.startTime) params.append('start_time', options.startTime);
            if (options.endTime) params.append('end_time', options.endTime);

            const response = await fetch(`${this.apiUrl}/tweets/search/recent?${params}`, {
                headers: {
                    'Authorization': `Bearer ${this.bearerToken}`
                }
            });

            if (!response.ok) {
                if (response.status === 429) {
                    console.warn('[Twitter] Rate limited');
                    this.rateLimitRemaining = 0;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            this.cache[cacheKey] = { data: data.data || [], timestamp: Date.now() };
            return data.data || [];
        } catch (error) {
            console.error('[Twitter] Search error:', error);
            return [];
        }
    },

    // Get user by username
    async getUser(username) {
        if (!this.bearerToken) return null;

        try {
            const response = await fetch(
                `${this.apiUrl}/users/by/username/${username}?user.fields=public_metrics,description,verified,created_at`,
                { headers: { 'Authorization': `Bearer ${this.bearerToken}` } }
            );
            if (!response.ok) return null;
            const data = await response.json();
            return data.data;
        } catch (error) {
            console.error('[Twitter] User error:', error);
            return null;
        }
    },

    // Get user's recent tweets
    async getUserTweets(userId, options = {}) {
        if (!this.bearerToken) return [];

        try {
            const params = new URLSearchParams({
                max_results: options.maxResults || 100,
                'tweet.fields': 'created_at,public_metrics,entities'
            });

            const response = await fetch(`${this.apiUrl}/users/${userId}/tweets?${params}`, {
                headers: { 'Authorization': `Bearer ${this.bearerToken}` }
            });
            if (!response.ok) return [];
            const data = await response.json();
            return data.data || [];
        } catch (error) {
            console.error('[Twitter] User tweets error:', error);
            return [];
        }
    },

    // Analyze sentiment of tweets (basic implementation)
    analyzeSentiment(tweets) {
        const positiveWords = ['great', 'amazing', 'excellent', 'love', 'best', 'awesome', 'excited', 'innovation', 'growth', 'success', 'winning', 'bullish', 'strong'];
        const negativeWords = ['bad', 'terrible', 'worst', 'hate', 'fail', 'layoffs', 'lawsuit', 'scandal', 'bearish', 'crash', 'fraud', 'scam', 'disappointing'];

        let positive = 0, negative = 0, neutral = 0;
        let totalEngagement = 0;

        for (const tweet of tweets) {
            const text = tweet.text?.toLowerCase() || '';
            const metrics = tweet.public_metrics || {};
            const engagement = (metrics.like_count || 0) + (metrics.retweet_count || 0) * 2 + (metrics.reply_count || 0);
            totalEngagement += engagement;

            const posCount = positiveWords.filter(w => text.includes(w)).length;
            const negCount = negativeWords.filter(w => text.includes(w)).length;

            if (posCount > negCount) positive++;
            else if (negCount > posCount) negative++;
            else neutral++;
        }

        const total = tweets.length || 1;
        return {
            positive: Math.round((positive / total) * 100),
            negative: Math.round((negative / total) * 100),
            neutral: Math.round((neutral / total) * 100),
            score: Math.round(((positive - negative) / total) * 100), // -100 to 100
            totalTweets: tweets.length,
            avgEngagement: Math.round(totalEngagement / total),
            totalEngagement
        };
    },

    // Normalize tweet data
    normalizeTweet(tweet, users = {}) {
        const author = users[tweet.author_id] || {};
        return {
            id: tweet.id,
            text: tweet.text,
            createdAt: tweet.created_at,
            author: {
                id: tweet.author_id,
                name: author.name,
                username: author.username,
                verified: author.verified,
                followers: author.public_metrics?.followers_count
            },
            metrics: {
                likes: tweet.public_metrics?.like_count || 0,
                retweets: tweet.public_metrics?.retweet_count || 0,
                replies: tweet.public_metrics?.reply_count || 0,
                quotes: tweet.public_metrics?.quote_count || 0
            },
            hashtags: tweet.entities?.hashtags?.map(h => h.tag) || [],
            mentions: tweet.entities?.mentions?.map(m => m.username) || [],
            urls: tweet.entities?.urls?.map(u => u.expanded_url) || []
        };
    }
};

// Social data storage
let socialMentions = {};

// Fetch Twitter data for a company
async function fetchTwitterData(companyName, options = {}) {
    if (!TwitterProvider.bearerToken) {
        console.warn('[Twitter] No bearer token configured');
        return null;
    }

    try {
        // Build search query
        const company = companies.find(c => c.name === companyName);
        const twitterHandle = company?.twitter || companyName.replace(/\s+/g, '');

        const queries = [
            `"${companyName}" -is:retweet`,
            options.includeHandle !== false ? `@${twitterHandle} -is:retweet` : null
        ].filter(Boolean);

        let allTweets = [];
        for (const query of queries) {
            const tweets = await TwitterProvider.searchTweets(query, {
                maxResults: options.maxResults || 50,
                startTime: options.startTime
            });
            allTweets = allTweets.concat(tweets);
        }

        // Deduplicate
        const seen = new Set();
        allTweets = allTweets.filter(t => {
            if (seen.has(t.id)) return false;
            seen.add(t.id);
            return true;
        });

        // Analyze
        const sentiment = TwitterProvider.analyzeSentiment(allTweets);
        const normalized = allTweets.map(t => TwitterProvider.normalizeTweet(t));

        socialMentions[companyName] = {
            tweets: normalized,
            sentiment,
            lastFetched: new Date().toISOString(),
            source: 'twitter'
        };

        syncSocialToSignalModel(companyName);
        return socialMentions[companyName];
    } catch (error) {
        console.error(`[Twitter] Error fetching ${companyName}:`, error);
        return null;
    }
}

// News aggregation from multiple sources
const NewsAggregator = {
    sources: {
        newsapi: NewsProvider, // Already exists
        google: NewsAlertModule
    },

    cache: {},

    // Aggregate news from all sources
    async getCompanyNews(companyName, options = {}) {
        const cacheKey = `news:${companyName}`;
        if (this.cache[cacheKey] && Date.now() - this.cache[cacheKey].timestamp < 600000) {
            return this.cache[cacheKey].data;
        }

        const results = {
            articles: [],
            mentions: 0,
            sentiment: { positive: 0, negative: 0, neutral: 0, score: 0 },
            sources: [],
            lastUpdated: new Date().toISOString()
        };

        // Fetch from NewsAPI if available
        if (NewsProvider.apiKey) {
            try {
                const newsData = await fetchNewsData(companyName);
                if (newsData?.articles) {
                    results.articles.push(...newsData.articles.map(a => ({
                        ...a,
                        source: 'newsapi'
                    })));
                    results.sources.push('newsapi');
                }
            } catch (e) { console.warn('[NewsAggregator] NewsAPI error:', e); }
        }

        // Add Google Alerts data if configured
        const alertConfig = NewsAlertModule.alerts[companyName];
        if (alertConfig?.feedUrl) {
            try {
                const alertArticles = await NewsAlertModule.parseGoogleAlertsFeed(alertConfig.feedUrl);
                results.articles.push(...alertArticles);
                results.sources.push('google_alerts');
            } catch (e) { console.warn('[NewsAggregator] Alerts error:', e); }
        }

        // Sort by date
        results.articles.sort((a, b) => new Date(b.publishedAt || b.published) - new Date(a.publishedAt || a.published));

        // Calculate aggregate sentiment
        results.mentions = results.articles.length;
        if (results.articles.length > 0) {
            results.sentiment = this.analyzeSentiment(results.articles);
        }

        this.cache[cacheKey] = { data: results, timestamp: Date.now() };
        return results;
    },

    // Analyze sentiment from articles
    analyzeSentiment(articles) {
        const positiveWords = ['growth', 'success', 'innovative', 'leading', 'breakthrough', 'profitable', 'expansion', 'partnership', 'launch', 'award'];
        const negativeWords = ['layoffs', 'lawsuit', 'decline', 'loss', 'scandal', 'investigation', 'failure', 'shutdown', 'debt', 'fraud'];

        let positive = 0, negative = 0, neutral = 0;

        for (const article of articles) {
            const text = ((article.title || '') + ' ' + (article.description || '')).toLowerCase();
            const posCount = positiveWords.filter(w => text.includes(w)).length;
            const negCount = negativeWords.filter(w => text.includes(w)).length;

            if (posCount > negCount) positive++;
            else if (negCount > posCount) negative++;
            else neutral++;
        }

        const total = articles.length || 1;
        return {
            positive: Math.round((positive / total) * 100),
            negative: Math.round((negative / total) * 100),
            neutral: Math.round((neutral / total) * 100),
            score: Math.round(((positive - negative) / total) * 100)
        };
    },

    // Get trending topics for a company
    extractTrendingTopics(articles, limit = 10) {
        const topics = {};
        const keywords = ['acquisition', 'funding', 'IPO', 'layoffs', 'AI', 'partnership', 'launch', 'CEO', 'revenue', 'growth', 'merger', 'Series A', 'Series B', 'valuation'];

        for (const article of articles) {
            const text = ((article.title || '') + ' ' + (article.description || '')).toLowerCase();
            for (const kw of keywords) {
                if (text.includes(kw.toLowerCase())) {
                    topics[kw] = (topics[kw] || 0) + 1;
                }
            }
        }

        return Object.entries(topics)
            .sort((a, b) => b[1] - a[1])
            .slice(0, limit)
            .map(([topic, count]) => ({ topic, count }));
    }
};

// Sync social/news data to signal model
function syncSocialToSignalModel(companyName) {
    const social = socialMentions[companyName];
    if (!social) return false;

    // Update wiki data
    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.twitterMentions = social.tweets?.length || 0;
    wd.twitterSentiment = social.sentiment?.score || 0;
    wd.twitterEngagement = social.sentiment?.totalEngagement || 0;
    wd.socialVerified = true;
    wd.socialLastUpdated = social.lastFetched;

    return true;
}

// Sync news data to signal model
function syncNewsToSignalModel(companyName) {
    const news = NewsAggregator.cache[`news:${companyName}`]?.data;
    if (!news) return false;

    if (!wikiData[companyName]) wikiData[companyName] = {};
    const wd = wikiData[companyName];

    wd.pressMentions = news.mentions || 0;
    wd.newsSentiment = news.sentiment?.score || 0;
    wd.newsPositive = news.sentiment?.positive || 0;
    wd.newsNegative = news.sentiment?.negative || 0;
    wd.newsSources = news.sources || [];
    wd.newsLastUpdated = news.lastUpdated;

    // Extract trending topics
    wd.trendingTopics = NewsAggregator.extractTrendingTopics(news.articles);

    return true;
}

// Combined news & social fetch
async function fetchNewsAndSocial(companyName, options = {}) {
    const results = {
        news: null,
        twitter: null,
        combinedSentiment: 0,
        signals: {}
    };

    // Fetch news
    try {
        results.news = await NewsAggregator.getCompanyNews(companyName, options);
        syncNewsToSignalModel(companyName);
    } catch (e) { console.warn('[NewsAndSocial] News error:', e); }

    // Fetch Twitter
    if (TwitterProvider.bearerToken) {
        try {
            results.twitter = await fetchTwitterData(companyName, options);
        } catch (e) { console.warn('[NewsAndSocial] Twitter error:', e); }
    }

    // Calculate combined sentiment
    const newsSentiment = results.news?.sentiment?.score || 0;
    const twitterSentiment = results.twitter?.sentiment?.score || 0;
    const hasNews = results.news?.mentions > 0;
    const hasTwitter = results.twitter?.tweets?.length > 0;

    if (hasNews && hasTwitter) {
        results.combinedSentiment = Math.round((newsSentiment * 0.6 + twitterSentiment * 0.4));
    } else if (hasNews) {
        results.combinedSentiment = newsSentiment;
    } else if (hasTwitter) {
        results.combinedSentiment = twitterSentiment;
    }

    // Compile signals
    results.signals = {
        pressMentions: results.news?.mentions || 0,
        twitterMentions: results.twitter?.tweets?.length || 0,
        newsSentiment: newsSentiment,
        twitterSentiment: twitterSentiment,
        combinedSentiment: results.combinedSentiment,
        twitterEngagement: results.twitter?.sentiment?.totalEngagement || 0,
        trendingTopics: results.news ? NewsAggregator.extractTrendingTopics(results.news.articles) : [],
        lastUpdated: new Date().toISOString()
    };

    return results;
}

// Batch fetch news & social for multiple companies
async function fetchNewsAndSocialForCompanies(companyNames, options = {}, onProgress) {
    const results = {};
    let completed = 0;

    for (const name of companyNames) {
        results[name] = await fetchNewsAndSocial(name, options);
        completed++;
        if (onProgress) onProgress(completed, companyNames.length, name);
        await new Promise(r => setTimeout(r, options.delay || 1000)); // Rate limit
    }

    return results;
}

// Generate Google Alerts setup for all companies
function generateGoogleAlertsSetup() {
    const alertsSetup = [];

    for (const company of companies) {
        alertsSetup.push({
            company: company.name,
            ...NewsAlertModule.getSetupInstructions(company.name)
        });
    }

    console.log(`[NewsAlerts] Generated setup for ${alertsSetup.length} companies`);
    console.log('[NewsAlerts] To setup, visit each URL and create an RSS-based alert');

    return alertsSetup;
}

// Export alerts setup as CSV for easy import
function exportAlertsSetupCSV() {
    const rows = [['Company', 'Query', 'Alert URL']];

    for (const company of companies) {
        const setup = NewsAlertModule.getSetupInstructions(company.name);
        for (let i = 0; i < setup.queries.length; i++) {
            rows.push([company.name, setup.queries[i], setup.alertUrls[i]]);
        }
    }

    const csv = rows.map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(',')).join('\n');
    return csv;
}

// Download alerts setup as CSV
function downloadAlertsSetupCSV() {
    const csv = exportAlertsSetupCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'google_alerts_setup.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// Render news & social panel HTML
function renderNewsAndSocialPanel(companyName) {
    const news = NewsAggregator.cache[`news:${companyName}`]?.data;
    const social = socialMentions[companyName];

    const newsSentiment = news?.sentiment?.score || 0;
    const twitterSentiment = social?.sentiment?.score || 0;
    const combinedSentiment = news && social
        ? Math.round((newsSentiment * 0.6 + twitterSentiment * 0.4))
        : newsSentiment || twitterSentiment;

    const sentimentColor = combinedSentiment > 20 ? '#22c55e' : combinedSentiment < -20 ? '#ef4444' : '#eab308';
    const sentimentLabel = combinedSentiment > 20 ? 'Positive' : combinedSentiment < -20 ? 'Negative' : 'Neutral';

    return `
        <div class="news-social-panel" style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin: 8px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; color: var(--text);">News & Social Signals</h4>
                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${sentimentColor}20; color: ${sentimentColor};">
                    ${sentimentLabel} (${combinedSentiment > 0 ? '+' : ''}${combinedSentiment})
                </span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
                <div style="text-align: center; padding: 8px; background: var(--border); border-radius: 4px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--text);">${news?.mentions || 0}</div>
                    <div style="font-size: 10px; color: var(--dim);">News Mentions</div>
                </div>
                <div style="text-align: center; padding: 8px; background: var(--border); border-radius: 4px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--text);">${social?.tweets?.length || 0}</div>
                    <div style="font-size: 10px; color: var(--dim);">Twitter Mentions</div>
                </div>
                <div style="text-align: center; padding: 8px; background: var(--border); border-radius: 4px;">
                    <div style="font-size: 18px; font-weight: 700; color: ${newsSentiment > 0 ? '#22c55e' : newsSentiment < 0 ? '#ef4444' : 'var(--text)'};">${newsSentiment > 0 ? '+' : ''}${newsSentiment}</div>
                    <div style="font-size: 10px; color: var(--dim);">News Sentiment</div>
                </div>
                <div style="text-align: center; padding: 8px; background: var(--border); border-radius: 4px;">
                    <div style="font-size: 18px; font-weight: 700; color: ${twitterSentiment > 0 ? '#22c55e' : twitterSentiment < 0 ? '#ef4444' : 'var(--text)'};">${twitterSentiment > 0 ? '+' : ''}${twitterSentiment}</div>
                    <div style="font-size: 10px; color: var(--dim);">Twitter Sentiment</div>
                </div>
            </div>

            ${news?.articles?.length > 0 ? `
                <div style="margin-top: 12px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 8px;">Recent News</div>
                    ${news.articles.slice(0, 3).map(a => `
                        <a href="${a.url || a.link}" target="_blank" style="display: block; padding: 8px; margin-bottom: 4px; background: var(--border); border-radius: 4px; text-decoration: none; color: var(--text); font-size: 11px;">
                            ${a.title}
                            <span style="color: var(--dim); font-size: 10px; margin-left: 8px;">${a.source?.name || a.source || ''}</span>
                        </a>
                    `).join('')}
                </div>
            ` : ''}

            ${social?.tweets?.length > 0 ? `
                <div style="margin-top: 12px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 8px;">Recent Tweets</div>
                    ${social.tweets.slice(0, 3).map(t => `
                        <div style="padding: 8px; margin-bottom: 4px; background: var(--border); border-radius: 4px; font-size: 11px; color: var(--text);">
                            <div style="margin-bottom: 4px;">${t.text?.substring(0, 140)}${t.text?.length > 140 ? '...' : ''}</div>
                            <div style="color: var(--dim); font-size: 10px;">
                                @${t.author?.username || 'unknown'}  ${t.metrics?.likes || 0} likes  ${t.metrics?.retweets || 0} RTs
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            <div style="margin-top: 12px; font-size: 10px; color: var(--dim);">
                Last updated: ${news?.lastUpdated || social?.lastFetched || 'Never'}
            </div>
        </div>
    `;
}

JobProviders.register('twitter', TwitterProvider);

// ==================== 50-SIGNAL SCORING SYSTEM ====================
// Comprehensive scoring that combines all data sources into actionable scores

const SignalScorer = {
    // Weight configurations for different scoring modes
    weights: {
        // For M&A likelihood scoring
        ma: {
            yearsSinceLastRaise: 15,
            ceoChange: 12,
            growthRate: -8,  // High growth = less likely to sell
            exitReadiness: 10,
            burnRate: 8,
            valuation: -5,  // High valuation = harder to acquire
            fundingTotal: -3,
            acquirerActivity: -10,  // If acquiring others, less likely to be acquired
            pressMentions: 3,
            sentimentScore: -2,  // Negative sentiment = distress signal
            employeeGrowth: -5,
            // News & Social signals
            newsSentiment: -3,  // Negative news = potential M&A
            twitterSentiment: -2,
            twitterMentions: 2,  // Buzz can indicate activity
            combinedSentiment: -4
        },
        // For hiring/job seeker scoring
        hiring: {
            roles: 15,
            hiringVelocity: 12,
            growthRate: 10,
            trend: 10,  // hot=10, growing=7, stable=4, declining=0
            glassdoorRating: 8,
            avgSalary: 8,
            equity: 8,
            linkedinFollowers: 5,
            ycHiring: 5,
            wellfoundJobs: 5,
            builtinJobs: 5,
            recentHires: 4,
            ceoApproval: 5,
            // News & Social signals
            twitterEngagement: 4,  // Social presence matters
            combinedSentiment: 5,  // Positive buzz = good employer
            referMeJobs: 4,
            ottaJobs: 4
        },
        // For investment attractiveness
        investment: {
            growthRate: 15,
            revenueGrowth: 12,
            fundingTotal: 8,
            valuation: 5,
            customerCount: 10,
            linkedinFollowers: 5,
            pressMentions: 5,
            sentimentScore: 8,
            techStack: 3,
            ycTopCompany: 5,
            glassdoorRating: 4,
            employeeGrowth: 10,
            // News & Social signals
            newsSentiment: 8,
            twitterSentiment: 5,
            twitterEngagement: 6,
            combinedSentiment: 10,
            twitterMentions: 4
        },
        // For overall company health
        health: {
            growthRate: 12,
            glassdoorRating: 10,
            sentimentScore: 8,
            linkedinFollowers: 5,
            pressMentions: 5,
            fundingTotal: 8,
            burnRate: -8,  // High burn = risk
            ceoApproval: 8,
            recentHires: 5,
            customerCount: 10,
            techStack: 3,
            ycStatus: 8,  // Active=8, Public=10, Acquired=5, Inactive=0
            trend: 8,
            // News & Social signals
            newsSentiment: 8,
            twitterSentiment: 6,
            combinedSentiment: 10,
            twitterEngagement: 4
        }
    },

    // Normalize a value to 0-100 scale
    normalize(value, min, max, invert = false) {
        if (value === null || value === undefined) return null;
        const normalized = Math.max(0, Math.min(100, ((value - min) / (max - min)) * 100));
        return invert ? 100 - normalized : normalized;
    },

    // Get normalized signal value
    getNormalizedSignal(companyName, signalName) {
        const hd = hiringData[companyName] || getHiringInfo(companyName) || {};
        const wd = wikiData[companyName] || getWikiData(companyName) || {};
        const company = companies.find(c => c.name === companyName) || {};

        switch (signalName) {
            // Hiring signals
            case 'roles':
                return this.normalize(hd.roles || 0, 0, 200);
            case 'hiringVelocity':
                return this.normalize(hd.hiringVelocity || 0, 0, 30);
            case 'growthRate':
                return this.normalize(hd.growthRate || wd.growthRate || 0, -20, 60);
            case 'trend':
                const trendMap = { hot: 100, growing: 70, stable: 40, declining: 10 };
                return trendMap[hd.trend] || 50;
            case 'avgSalary':
                return this.normalize(hd.avgSalary || 0, 150, 500);
            case 'equity':
                const equityMap = { 'very-high': 100, 'high': 75, 'medium': 50, 'low': 25 };
                return equityMap[hd.equity] || 50;
            case 'glassdoorRating':
                return this.normalize(hd.glassdoorRating || wd.glassdoorRating || 0, 1, 5) ;
            case 'ceoApproval':
                return this.normalize(hd.ceoApproval || 0, 0, 100);
            case 'linkedinFollowers':
                return this.normalize(Math.log10((hd.linkedinFollowers || wd.linkedInFollowers || 1000) + 1), 3, 7);
            case 'recentHires':
                return this.normalize((hd.recentHires?.length || 0), 0, 5);

            // Financial signals
            case 'fundingTotal':
                const funding = wd.fundingNum || company.fundingValue || 0;
                return this.normalize(Math.log10(funding + 1), 6, 11);  // $1M to $100B log scale
            case 'valuation':
                return this.normalize(Math.log10((wd.valuationNum || 0) + 1), 7, 12);
            case 'yearsSinceLastRaise':
                return this.normalize(wd.yearsSinceLastRaise || 0, 0, 5);
            case 'burnRate':
                return this.normalize(wd.burnRate || 0, 100000, 10000000, true);  // Inverted - lower is better
            case 'exitReadiness':
                return wd.exitReadiness || 50;

            // Market signals
            case 'pressMentions':
                return this.normalize(wd.pressMentions || 0, 0, 50);
            case 'sentimentScore':
                return this.normalize((wd.sentimentScore || 0) + 100, 0, 200);  // -100 to 100  0 to 100
            case 'customerCount':
                return this.normalize(Math.log10((wd.customerCount || 100) + 1), 2, 5);

            // Team signals
            case 'employeeGrowth':
                if (hd.employeeHistory?.length >= 2) {
                    const first = hd.employeeHistory[0];
                    const last = hd.employeeHistory[hd.employeeHistory.length - 1];
                    const growth = ((last - first) / first) * 100;
                    return this.normalize(growth, -20, 100);
                }
                return 50;
            case 'ceoChange':
                return wd.ceoChange ? 100 : 0;
            case 'acquirerActivity':
                return wd.acquirerActivity ? 100 : 0;

            // Source-specific signals
            case 'ycHiring':
                return hd.ycHiring ? 100 : 0;
            case 'ycTopCompany':
                return wd.ycTopCompany ? 100 : 0;
            case 'ycStatus':
                const statusMap = { 'Active': 80, 'Public': 100, 'Acquired': 50, 'Inactive': 0 };
                return statusMap[wd.ycStatus] || 50;
            case 'wellfoundJobs':
                return this.normalize(hd.wellfoundJobs || 0, 0, 50);
            case 'builtinJobs':
                return this.normalize(hd.builtinJobs || 0, 0, 50);
            case 'techStack':
                return this.normalize((wd.techStack?.length || hd.techStack?.length || 0), 0, 10);
            case 'revenueGrowth':
                const rgMap = { 'very high': 100, 'high': 75, 'moderate': 50, 'low': 25 };
                return rgMap[wd.revenueGrowth] || 50;

            // News & Social signals
            case 'newsSentiment':
                return this.normalize((wd.newsSentiment || 0) + 100, 0, 200);  // -100 to 100  0 to 100
            case 'twitterSentiment':
                return this.normalize((wd.twitterSentiment || 0) + 100, 0, 200);
            case 'combinedSentiment':
                const news = wd.newsSentiment || 0;
                const twitter = wd.twitterSentiment || 0;
                const combined = (news * 0.6 + twitter * 0.4);
                return this.normalize(combined + 100, 0, 200);
            case 'twitterMentions':
                return this.normalize(wd.twitterMentions || 0, 0, 100);
            case 'twitterEngagement':
                return this.normalize(Math.log10((wd.twitterEngagement || 100) + 1), 2, 6);  // Log scale for engagement
            case 'referMeJobs':
                return this.normalize(hd.referMeJobs || 0, 0, 50);
            case 'ottaJobs':
                return this.normalize(hd.ottaJobs || 0, 0, 50);
            case 'referrerCount':
                return this.normalize(hd.referrerCount || 0, 0, 100);
            case 'salaryTransparency':
                return hd.salaryTransparency ? 100 : 0;

            default:
                return null;
        }
    },

    // Calculate weighted score for a specific mode
    calculateScore(companyName, mode = 'health') {
        const weights = this.weights[mode];
        if (!weights) return null;

        let totalWeight = 0;
        let weightedSum = 0;
        const breakdown = {};

        for (const [signal, weight] of Object.entries(weights)) {
            const normalizedValue = this.getNormalizedSignal(companyName, signal);
            if (normalizedValue !== null) {
                const absWeight = Math.abs(weight);
                const contribution = weight < 0
                    ? (100 - normalizedValue) * absWeight  // Invert for negative weights
                    : normalizedValue * absWeight;

                weightedSum += contribution;
                totalWeight += absWeight;
                breakdown[signal] = {
                    raw: normalizedValue,
                    weight: weight,
                    contribution: Math.round(contribution / absWeight)
                };
            }
        }

        const score = totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 50;

        return {
            score,
            mode,
            breakdown,
            signalsUsed: Object.keys(breakdown).length,
            totalSignals: Object.keys(weights).length,
            coverage: Math.round((Object.keys(breakdown).length / Object.keys(weights).length) * 100)
        };
    },

    // Get all scores for a company
    getAllScores(companyName) {
        return {
            company: companyName,
            scores: {
                health: this.calculateScore(companyName, 'health'),
                hiring: this.calculateScore(companyName, 'hiring'),
                investment: this.calculateScore(companyName, 'investment'),
                ma: this.calculateScore(companyName, 'ma')
            },
            timestamp: new Date().toISOString()
        };
    },

    // Get top companies by a specific score
    getTopCompanies(mode = 'health', limit = 20) {
        const allCompanyNames = companies.map(c => c.name);
        const scored = allCompanyNames.map(name => ({
            name,
            ...this.calculateScore(name, mode)
        })).filter(s => s.score !== null);

        return scored
            .sort((a, b) => b.score - a.score)
            .slice(0, limit);
    },

    // Get companies matching criteria
    filterCompanies(criteria = {}) {
        const {
            minHealth = 0,
            minHiring = 0,
            minInvestment = 0,
            minMA = 0,
            maxMA = 100,
            trend = null,
            ycOnly = false,
            hiringOnly = false
        } = criteria;

        return companies.filter(company => {
            const scores = this.getAllScores(company.name).scores;
            const hd = hiringData[company.name] || getHiringInfo(company.name) || {};
            const wd = wikiData[company.name] || getWikiData(company.name) || {};

            if (scores.health?.score < minHealth) return false;
            if (scores.hiring?.score < minHiring) return false;
            if (scores.investment?.score < minInvestment) return false;
            if (scores.ma?.score < minMA || scores.ma?.score > maxMA) return false;
            if (trend && hd.trend !== trend) return false;
            if (ycOnly && !wd.ycVerified) return false;
            if (hiringOnly && !hd.roles) return false;

            return true;
        }).map(c => ({
            ...c,
            scores: this.getAllScores(c.name).scores
        }));
    },

    // Generate score summary for display
    getScoreSummary(companyName) {
        const all = this.getAllScores(companyName);
        const scores = all.scores;

        // Determine primary insight
        let insight = '';
        if (scores.ma?.score >= 70) {
            insight = ' High M&A likelihood - potential acquisition target';
        } else if (scores.hiring?.score >= 75) {
            insight = ' Hot hiring market - actively growing team';
        } else if (scores.investment?.score >= 75) {
            insight = ' Strong investment signals - high growth potential';
        } else if (scores.health?.score >= 75) {
            insight = ' Healthy company metrics across the board';
        } else if (scores.health?.score < 40) {
            insight = ' Some concerning signals - review details';
        } else {
            insight = ' Moderate signals - stable position';
        }

        return {
            company: companyName,
            health: scores.health?.score || 0,
            hiring: scores.hiring?.score || 0,
            investment: scores.investment?.score || 0,
            ma: scores.ma?.score || 0,
            insight,
            topSignals: this.getTopSignals(companyName),
            weakSignals: this.getWeakSignals(companyName)
        };
    },

    // Get top performing signals for a company
    getTopSignals(companyName, limit = 5) {
        const allSignals = [
            ...Object.keys(this.weights.health),
            ...Object.keys(this.weights.hiring),
            ...Object.keys(this.weights.investment),
            ...Object.keys(this.weights.ma)
        ];
        const unique = [...new Set(allSignals)];

        return unique
            .map(signal => ({
                signal,
                value: this.getNormalizedSignal(companyName, signal)
            }))
            .filter(s => s.value !== null && s.value >= 70)
            .sort((a, b) => b.value - a.value)
            .slice(0, limit);
    },

    // Get weak/concerning signals
    getWeakSignals(companyName, limit = 5) {
        const allSignals = [
            ...Object.keys(this.weights.health),
            ...Object.keys(this.weights.hiring)
        ];
        const unique = [...new Set(allSignals)];

        return unique
            .map(signal => ({
                signal,
                value: this.getNormalizedSignal(companyName, signal)
            }))
            .filter(s => s.value !== null && s.value <= 30)
            .sort((a, b) => a.value - b.value)
            .slice(0, limit);
    }
};

// Convenience functions
function getCompanyScore(companyName, mode = 'health') {
    return SignalScorer.calculateScore(companyName, mode);
}

function getCompanyScores(companyName) {
    return SignalScorer.getAllScores(companyName);
}

function getTopCompaniesByScore(mode = 'health', limit = 20) {
    return SignalScorer.getTopCompanies(mode, limit);
}

function getCompanyScoreSummary(companyName) {
    return SignalScorer.getScoreSummary(companyName);
}

// Render score badge HTML
function renderScoreBadge(score, mode = 'health') {
    const colors = {
        health: { high: '#22c55e', mid: '#eab308', low: '#ef4444' },
        hiring: { high: '#3b82f6', mid: '#8b5cf6', low: '#6b7280' },
        investment: { high: '#10b981', mid: '#f59e0b', low: '#ef4444' },
        ma: { high: '#f97316', mid: '#eab308', low: '#6b7280' }
    };

    const c = colors[mode] || colors.health;
    const color = score >= 70 ? c.high : score >= 40 ? c.mid : c.low;
    const label = mode.toUpperCase();

    return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${color}20; color: ${color};">${label}: ${score}</span>`;
}

// Render full score card HTML
function renderScoreCard(companyName) {
    const summary = SignalScorer.getScoreSummary(companyName);

    return `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin: 8px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; color: var(--text);">${companyName} Signal Scores</h4>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">
                ${renderScoreGauge(summary.health, 'Health', '#22c55e')}
                ${renderScoreGauge(summary.hiring, 'Hiring', '#3b82f6')}
                ${renderScoreGauge(summary.investment, 'Invest', '#10b981')}
                ${renderScoreGauge(summary.ma, 'M&A', '#f97316')}
            </div>
            <div style="padding: 8px; background: var(--border); border-radius: 4px; font-size: 12px; color: var(--text);">
                ${summary.insight}
            </div>
            ${summary.topSignals.length > 0 ? `
                <div style="margin-top: 8px; font-size: 11px; color: var(--dim);">
                    <strong>Strengths:</strong> ${summary.topSignals.map(s => `${s.signal} (${s.value})`).join(', ')}
                </div>
            ` : ''}
            ${summary.weakSignals.length > 0 ? `
                <div style="margin-top: 4px; font-size: 11px; color: var(--dim);">
                    <strong>Watch:</strong> ${summary.weakSignals.map(s => `${s.signal} (${s.value})`).join(', ')}
                </div>
            ` : ''}
        </div>
    `;
}

// Render individual score gauge
function renderScoreGauge(score, label, color) {
    const pct = score || 0;
    return `
        <div style="text-align: center;">
            <div style="position: relative; width: 50px; height: 50px; margin: 0 auto;">
                <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                        fill="none" stroke="var(--border)" stroke-width="3"/>
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                        fill="none" stroke="${color}" stroke-width="3"
                        stroke-dasharray="${pct}, 100"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700; color: ${color};">${pct}</div>
            </div>
            <div style="font-size: 10px; color: var(--dim); margin-top: 4px;">${label}</div>
        </div>
    `;
}

// Batch score all companies and cache
let companyScoresCache = {};

function scoreAllCompanies() {
    console.log('[Scorer] Scoring all companies...');
    const start = Date.now();

    for (const company of companies) {
        companyScoresCache[company.name] = SignalScorer.getAllScores(company.name);
    }

    console.log(`[Scorer] Scored ${companies.length} companies in ${Date.now() - start}ms`);
    return companyScoresCache;
}

// Get leaderboards
function getScoreLeaderboards(limit = 10) {
    return {
        health: SignalScorer.getTopCompanies('health', limit),
        hiring: SignalScorer.getTopCompanies('hiring', limit),
        investment: SignalScorer.getTopCompanies('investment', limit),
        maTargets: SignalScorer.getTopCompanies('ma', limit)
    };
}

// ==================== PIPELINE DATA LOADER ====================
// Load and display data from the local hiring pipeline
const PipelineLoader = {
    // Default paths (can be overridden)
    paths: {
        jobsRecent: './ai_hiring_pipeline/output/jobs_recent.json',
        signalsDaily: './ai_hiring_pipeline/output/signals_daily.json',
        alerts: './ai_hiring_pipeline/output/alerts.json',
        companies: './ai_hiring_pipeline/data/companies.json'
    },

    cache: {},
    lastLoaded: null,

    // Load a JSON file
    async loadFile(path) {
        if (this.cache[path] && Date.now() - this.cache[path].timestamp < 60000) {
            return this.cache[path].data;
        }

        try {
            const response = await fetch(path);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            this.cache[path] = { data, timestamp: Date.now() };
            return data;
        } catch (error) {
            console.warn(`[Pipeline] Failed to load ${path}:`, error.message);
            return null;
        }
    },

    // Load all pipeline data
    async loadAll() {
        console.log('[Pipeline] Loading pipeline data...');

        const [jobsRecent, signalsDaily, alerts] = await Promise.all([
            this.loadFile(this.paths.jobsRecent),
            this.loadFile(this.paths.signalsDaily),
            this.loadFile(this.paths.alerts)
        ]);

        this.lastLoaded = new Date();

        return {
            jobsRecent: jobsRecent || [],
            signalsDaily: signalsDaily || { topScorers: [], alerts: [], summary: {} },
            alerts: alerts || []
        };
    },

    // Get recent jobs for a company
    async getCompanyJobs(companyId) {
        const jobs = await this.loadFile(this.paths.jobsRecent);
        if (!jobs) return [];
        return jobs.filter(j => j.companyId === companyId || j.companyName?.toLowerCase().includes(companyId.toLowerCase()));
    },

    // Get hiring signals summary
    async getSignalsSummary() {
        return this.loadFile(this.paths.signalsDaily);
    },

    // Get active alerts
    async getActiveAlerts(severity = null) {
        const alerts = await this.loadFile(this.paths.alerts);
        if (!alerts) return [];
        if (severity) {
            return alerts.filter(a => a.severity === severity);
        }
        return alerts;
    },

    // Get top hiring companies
    async getTopHiringCompanies(limit = 20) {
        const signals = await this.loadFile(this.paths.signalsDaily);
        if (!signals?.topScorers) return [];
        return signals.topScorers.slice(0, limit);
    },

    // Search jobs
    async searchJobs(query, filters = {}) {
        const jobs = await this.loadFile(this.paths.jobsRecent);
        if (!jobs) return [];

        return jobs.filter(job => {
            // Text search
            if (query) {
                const text = `${job.title} ${job.companyName} ${job.location}`.toLowerCase();
                if (!text.includes(query.toLowerCase())) return false;
            }

            // Filters
            if (filters.remote && !job.remote) return false;
            if (filters.classification) {
                if (!job.classifications?.includes(filters.classification)) return false;
            }
            if (filters.level && job.level !== filters.level) return false;
            if (filters.source && job.source !== filters.source) return false;

            return true;
        });
    }
};

// Display pipeline jobs in the UI
async function displayPipelineJobs(options = {}) {
    const {
        limit = 50,
        filters = {},
        container = document.getElementById('jobsResultsArea')
    } = options;

    if (!container) return;

    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--dim);">Loading pipeline data...</div>';

    try {
        const data = await PipelineLoader.loadAll();
        let jobs = data.jobsRecent;

        // Apply filters
        if (filters.classification) {
            jobs = jobs.filter(j => j.classifications?.includes(filters.classification));
        }
        if (filters.remote) {
            jobs = jobs.filter(j => j.remote);
        }
        if (filters.company) {
            jobs = jobs.filter(j => j.companyId === filters.company || j.companyName?.toLowerCase().includes(filters.company.toLowerCase()));
        }

        // Limit
        jobs = jobs.slice(0, limit);

        if (jobs.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--dim);">
                    <div style="font-size: 32px; margin-bottom: 12px;"></div>
                    <div>No pipeline jobs found</div>
                    <div style="font-size: 12px; margin-top: 8px;">Run the pipeline: <code>node ai_hiring_pipeline/run.js</code></div>
                </div>
            `;
            return;
        }

        // Update stats
        const statsBar = document.getElementById('jobsStatsBar');
        if (statsBar) {
            statsBar.style.display = 'block';
            document.getElementById('jobsTotalCount').textContent = data.jobsRecent.length;
            document.getElementById('jobsCompanyCount').textContent = new Set(data.jobsRecent.map(j => j.companyId)).size;
        }

        // Render jobs
        container.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 12px;">
                ${jobs.map(job => renderPipelineJobCard(job)).join('')}
            </div>
            ${data.signalsDaily.summary ? `
                <div style="margin-top: 20px; padding: 16px; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-size: 12px; color: var(--dim); margin-bottom: 8px;">Pipeline Summary</div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div><span style="color: var(--gold);">${data.signalsDaily.summary.totalNewJobs7d || 0}</span> new jobs (7d)</div>
                        <div><span style="color: #22c55e;">${data.signalsDaily.summary.companiesHiring || 0}</span> companies hiring</div>
                        <div><span style="color: #ef4444;">${data.signalsDaily.summary.highPriorityAlerts || 0}</span> high priority alerts</div>
                    </div>
                </div>
            ` : ''}
        `;

    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <div style="font-size: 32px; margin-bottom: 12px;"></div>
                <div>Error loading pipeline data</div>
                <div style="font-size: 12px; margin-top: 8px; color: var(--dim);">${error.message}</div>
            </div>
        `;
    }
}

// Render a job card from pipeline data
function renderPipelineJobCard(job) {
    const classificationColors = {
        engineering: '#3b82f6',
        ai: '#a855f7',
        gtm: '#22c55e',
        leadership: '#f97316',
        product: '#ec4899',
        other: '#6b7280'
    };

    const classifications = job.classifications || ['other'];
    const mainClass = classifications[0];
    const color = classificationColors[mainClass] || classificationColors.other;

    const postedDate = job.postedAt ? new Date(job.postedAt) : null;
    const daysAgo = postedDate ? Math.floor((Date.now() - postedDate) / (1000 * 60 * 60 * 24)) : null;
    const dateText = daysAgo !== null ? (daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`) : '';

    return `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; border-left: 3px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                <div style="flex: 1;">
                    <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 4px;">${job.title}</div>
                    <div style="font-size: 13px; color: var(--gold); margin-bottom: 8px;">${job.companyName || job.companyId}</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 11px; color: var(--dim);">
                        <span> ${job.location || 'Unknown'}</span>
                        ${job.remote ? '<span style="color: #22c55e;"> Remote</span>' : ''}
                        <span> ${dateText}</span>
                        <span style="color: ${color};"> ${mainClass}</span>
                        ${job.level ? `<span> ${job.level}</span>` : ''}
                    </div>
                </div>
                <a href="${job.url}" target="_blank" style="padding: 8px 16px; background: ${color}20; color: ${color}; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; white-space: nowrap;">
                    Apply 
                </a>
            </div>
        </div>
    `;
}

// Display pipeline alerts
async function displayPipelineAlerts(container) {
    if (!container) container = document.getElementById('alertsContainer');
    if (!container) return;

    const alerts = await PipelineLoader.getActiveAlerts();

    if (alerts.length === 0) {
        container.innerHTML = '<div style="color: var(--dim); text-align: center; padding: 20px;">No active alerts</div>';
        return;
    }

    const severityColors = {
        high: '#ef4444',
        medium: '#f59e0b',
        low: '#6b7280'
    };

    container.innerHTML = alerts.slice(0, 10).map(alert => `
        <div style="padding: 12px; background: ${severityColors[alert.severity]}15; border: 1px solid ${severityColors[alert.severity]}40; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: ${severityColors[alert.severity]};">${alert.companyName}</span>
                <span style="font-size: 10px; color: var(--dim);">${alert.type}</span>
            </div>
            <div style="font-size: 13px; color: var(--text); margin-top: 4px;">${alert.message}</div>
        </div>
    `).join('');
}

// Display hiring leaderboard from pipeline
async function displayHiringLeaderboard(container, limit = 10) {
    if (!container) return;

    const topCompanies = await PipelineLoader.getTopHiringCompanies(limit);

    if (topCompanies.length === 0) {
        container.innerHTML = '<div style="color: var(--dim); text-align: center; padding: 20px;">No data. Run the pipeline first.</div>';
        return;
    }

    container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px;">
            ${topCompanies.map((signal, i) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--card); border-radius: 6px; border: 1px solid var(--border);">
                    <span style="font-size: 16px; font-weight: 700; color: ${i < 3 ? '#f59e0b' : 'var(--dim)'}; width: 24px;">#${i + 1}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text);">${signal.companyId}</div>
                        <div style="font-size: 11px; color: var(--dim);">+${signal.newJobs7d} jobs (7d)</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${signal.score}</div>
                        <div style="font-size: 10px; color: var(--dim);">score</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Quick action: Load pipeline jobs
async function loadPipelineJobs() {
    await displayPipelineJobs();
}

// Quick action: Load engineering jobs from pipeline
async function loadPipelineEngineeringJobs() {
    await displayPipelineJobs({ filters: { classification: 'engineering' } });
}

// Quick action: Load GTM jobs from pipeline
async function loadPipelineGTMJobs() {
    await displayPipelineJobs({ filters: { classification: 'gtm' } });
}

// Quick action: Load AI jobs from pipeline
async function loadPipelineAIJobs() {
    await displayPipelineJobs({ filters: { classification: 'ai' } });
}

// ==================== USAJOBS PROVIDER ====================
const USAJobsProvider = {
    name: 'usajobs',
    baseUrl: 'https://data.usajobs.gov/api/search',
    // USAJOBS API requires registration for API key
    // Get yours at: https://developer.usajobs.gov/
    apiKey: '', // User needs to add their key
    userAgent: 'ai-book-directory',

    setApiKey(key) {
        this.apiKey = key;
    },

    async searchJobs(options = {}) {
        if (!this.apiKey) {
            console.warn('[USAJobs] No API key set. Register at developer.usajobs.gov');
            return [];
        }

        try {
            const params = new URLSearchParams({
                Keyword: options.keyword || 'artificial intelligence',
                LocationName: options.location || '',
                ResultsPerPage: options.limit || 50,
                ...(options.organization && { Organization: options.organization })
            });

            const response = await fetch(`${this.baseUrl}?${params}`, {
                headers: {
                    'Authorization-Key': this.apiKey,
                    'User-Agent': this.userAgent,
                    'Host': 'data.usajobs.gov'
                }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.SearchResult?.SearchResultItems || [];
        } catch (error) {
            console.error('[USAJobs] Search error:', error);
            return [];
        }
    },

    // Search for AI/ML government jobs
    async searchAIJobs(location = '') {
        const keywords = ['artificial intelligence', 'machine learning', 'data scientist', 'AI engineer'];
        let allJobs = [];

        for (const keyword of keywords) {
            const jobs = await this.searchJobs({ keyword, location, limit: 25 });
            allJobs = allJobs.concat(jobs);
            await new Promise(r => setTimeout(r, 500)); // Rate limit
        }

        // Deduplicate by position ID
        const seen = new Set();
        return allJobs.filter(job => {
            const id = job.MatchedObjectId;
            if (seen.has(id)) return false;
            seen.add(id);
            return true;
        });
    },

    normalize(jobs) {
        return jobs.map(item => {
            const job = item.MatchedObjectDescriptor || item;
            return {
                id: `usajobs-${job.PositionID}`,
                title: job.PositionTitle,
                company: job.OrganizationName || job.DepartmentName || 'US Government',
                location: job.PositionLocationDisplay || 'Multiple Locations',
                remote: (job.PositionLocationDisplay || '').toLowerCase().includes('remote') ||
                        (job.PositionLocationDisplay || '').toLowerCase().includes('anywhere'),
                department: job.DepartmentName || 'Federal',
                type: job.PositionSchedule?.[0]?.Name || 'Full-time',
                url: job.PositionURI || job.ApplyURI?.[0],
                postedAt: new Date(job.PublicationStartDate || Date.now()),
                closingDate: job.ApplicationCloseDate,
                salary: this.parseSalary(job),
                grade: job.JobGrade?.[0]?.Code,
                source: 'usajobs',
                raw: job
            };
        });
    },

    parseSalary(job) {
        const min = parseFloat(job.PositionRemuneration?.[0]?.MinimumRange);
        const max = parseFloat(job.PositionRemuneration?.[0]?.MaximumRange);
        if (isNaN(min) || isNaN(max)) return null;
        return { min, max, currency: 'USD', period: job.PositionRemuneration?.[0]?.RateIntervalCode };
    }
};

// ==================== RAPIDAPI JOB FEEDS PROVIDER ====================
const RapidAPIJobsProvider = {
    name: 'rapidapi',
    // Supports multiple RapidAPI job endpoints
    // User needs to add their RapidAPI key
    apiKey: '', // Get from rapidapi.com

    endpoints: {
        jsearch: {
            host: 'jsearch.p.rapidapi.com',
            searchPath: '/search',
            name: 'JSearch'
        },
        indeed: {
            host: 'indeed12.p.rapidapi.com',
            searchPath: '/jobs/search',
            name: 'Indeed'
        },
        linkedin: {
            host: 'linkedin-jobs-search.p.rapidapi.com',
            searchPath: '/',
            name: 'LinkedIn Jobs'
        }
    },

    setApiKey(key) {
        this.apiKey = key;
    },

    async searchJobs(query, options = {}) {
        if (!this.apiKey) {
            console.warn('[RapidAPI] No API key set');
            return [];
        }

        const endpoint = this.endpoints[options.source || 'jsearch'];

        try {
            const params = new URLSearchParams({
                query: query,
                page: options.page || '1',
                num_pages: options.numPages || '1',
                ...(options.location && { location: options.location }),
                ...(options.remote && { remote_jobs_only: 'true' })
            });

            const response = await fetch(`https://${endpoint.host}${endpoint.searchPath}?${params}`, {
                headers: {
                    'X-RapidAPI-Key': this.apiKey,
                    'X-RapidAPI-Host': endpoint.host
                }
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.data || data.jobs || data.results || [];
        } catch (error) {
            console.error(`[RapidAPI/${endpoint.name}] Error:`, error);
            return [];
        }
    },

    // Search for AI jobs across sources
    async searchAIJobs(options = {}) {
        const queries = [
            'AI engineer',
            'machine learning engineer',
            'data scientist AI',
            'LLM engineer',
            'ML ops'
        ];

        let allJobs = [];
        for (const query of queries) {
            try {
                const jobs = await this.searchJobs(query, options);
                allJobs = allJobs.concat(jobs);
                await new Promise(r => setTimeout(r, 300));
            } catch (e) {
                console.warn(`[RapidAPI] Failed for query: ${query}`);
            }
        }

        return this.normalize(allJobs);
    },

    normalize(jobs) {
        return jobs.map(job => ({
            id: `rapid-${job.job_id || job.id || Math.random().toString(36).substr(2, 9)}`,
            title: job.job_title || job.title,
            company: job.employer_name || job.company_name || job.company || 'Unknown',
            location: job.job_city ? `${job.job_city}, ${job.job_state || job.job_country}` : (job.location || 'Unknown'),
            remote: job.job_is_remote || (job.location || '').toLowerCase().includes('remote'),
            department: job.job_employment_type || 'General',
            type: job.job_employment_type || 'full-time',
            url: job.job_apply_link || job.job_google_link || job.url || job.apply_link,
            postedAt: new Date(job.job_posted_at_datetime_utc || job.posted_at || Date.now()),
            salary: this.parseSalary(job),
            source: 'rapidapi',
            description: job.job_description?.substring(0, 500),
            raw: job
        }));
    },

    parseSalary(job) {
        const min = job.job_min_salary || job.salary_min;
        const max = job.job_max_salary || job.salary_max;
        if (!min && !max) return null;
        return {
            min: min || 0,
            max: max || min || 0,
            currency: job.job_salary_currency || 'USD',
            period: job.job_salary_period || 'yearly'
        };
    }
};

// ==================== CAREER PAGE CRAWLER PROVIDER ====================
const CareerPageCrawler = {
    name: 'crawler',

    // Known career page URL patterns for companies
    careerPagePatterns: {
        "OpenAI": "https://openai.com/careers",
        "Anthropic": "https://www.anthropic.com/careers",
        "Stripe": "https://stripe.com/jobs",
        "Databricks": "https://www.databricks.com/company/careers",
        "Snowflake": "https://careers.snowflake.com",
        "Scale AI": "https://scale.com/careers",
        "Hugging Face": "https://huggingface.co/jobs",
        "Cursor": "https://www.cursor.com/careers",
        "Vercel": "https://vercel.com/careers",
        "Notion": "https://www.notion.so/careers",
        "Figma": "https://www.figma.com/careers",
        "Ramp": "https://ramp.com/careers",
        "Brex": "https://www.brex.com/careers",
        "Plaid": "https://plaid.com/careers",
        "Wiz": "https://www.wiz.io/careers",
        "Datadog": "https://careers.datadoghq.com",
        "Palantir": "https://www.palantir.com/careers",
        "Glean": "https://www.glean.com/careers",
        "Harvey": "https://www.harvey.ai/careers",
        "ElevenLabs": "https://elevenlabs.io/careers",
        "Runway": "https://runwayml.com/careers",
        "Pika": "https://pika.art/careers",
        "Perplexity": "https://www.perplexity.ai/careers",
        "Character.AI": "https://character.ai/careers",
        "Mistral AI": "https://mistral.ai/careers",
        "Cohere": "https://cohere.com/careers",
        "Together AI": "https://www.together.ai/careers",
        "Anyscale": "https://www.anyscale.com/careers",
        "LangChain": "https://www.langchain.com/careers",
        "Pinecone": "https://www.pinecone.io/careers",
        "Weights & Biases": "https://wandb.ai/careers",
        "Modal": "https://modal.com/careers",
        "Replicate": "https://replicate.com/about#careers",
        "Groq": "https://groq.com/careers",
        "Figure": "https://www.figure.ai/careers",
        "Cognition": "https://www.cognition.ai/careers",
        "Adept": "https://www.adept.ai/careers"
    },

    // Get career page URL for a company
    getCareerPageUrl(companyName) {
        return this.careerPagePatterns[companyName] || null;
    },

    // Add new career page mapping
    addCareerPage(companyName, url) {
        this.careerPagePatterns[companyName] = url;
    },

    // Fetch and parse career page (requires CORS proxy for browser)
    async fetchCareerPage(companyName, proxyUrl = '') {
        const careerUrl = this.getCareerPageUrl(companyName);
        if (!careerUrl) {
            console.log(`[Crawler] No career page URL for ${companyName}`);
            return null;
        }

        try {
            const fetchUrl = proxyUrl ? `${proxyUrl}${encodeURIComponent(careerUrl)}` : careerUrl;
            const response = await fetch(fetchUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const html = await response.text();
            return this.parseCareerPage(html, companyName, careerUrl);
        } catch (error) {
            console.error(`[Crawler] Error fetching ${companyName}:`, error);
            return null;
        }
    },

    // Parse career page HTML to extract job info
    parseCareerPage(html, companyName, sourceUrl) {
        // Basic heuristics to find job listings
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const jobs = [];

        // Common job listing selectors
        const selectors = [
            '[class*="job"]', '[class*="position"]', '[class*="opening"]',
            '[class*="career"]', '[class*="role"]', '[data-job]',
            'li[class*="listing"]', 'div[class*="listing"]',
            'a[href*="/jobs/"]', 'a[href*="/careers/"]', 'a[href*="/positions/"]'
        ];

        const seenTitles = new Set();

        for (const selector of selectors) {
            try {
                const elements = doc.querySelectorAll(selector);
                elements.forEach(el => {
                    // Try to extract job title
                    const titleEl = el.querySelector('h2, h3, h4, [class*="title"], a');
                    const title = titleEl?.textContent?.trim();

                    if (title && title.length > 3 && title.length < 100 && !seenTitles.has(title)) {
                        seenTitles.add(title);

                        // Try to extract location
                        const locEl = el.querySelector('[class*="location"], [class*="loc"]');
                        const location = locEl?.textContent?.trim() || 'See posting';

                        // Try to get link
                        const linkEl = el.querySelector('a') || (el.tagName === 'A' ? el : null);
                        let url = linkEl?.href || sourceUrl;
                        if (url.startsWith('/')) {
                            const base = new URL(sourceUrl);
                            url = `${base.origin}${url}`;
                        }

                        jobs.push({
                            id: `crawl-${companyName}-${jobs.length}`,
                            title,
                            company: companyName,
                            location,
                            remote: location.toLowerCase().includes('remote'),
                            department: this.inferDepartment(title),
                            type: 'full-time',
                            url,
                            postedAt: new Date(),
                            salary: null,
                            source: 'career-page',
                            raw: { html: el.outerHTML.substring(0, 500) }
                        });
                    }
                });
            } catch (e) {
                // Selector failed, continue
            }
        }

        return {
            company: companyName,
            careerPageUrl: sourceUrl,
            jobCount: jobs.length,
            jobs: jobs.slice(0, 100), // Limit to 100 jobs
            crawledAt: new Date().toISOString()
        };
    },

    // Infer department from job title
    inferDepartment(title) {
        const t = title.toLowerCase();

        // Technical - check specific first to avoid false positives
        if (t.includes('devops') || t.includes('sre') || t.includes('site reliability') || t.includes('infrastructure') || t.includes('platform engineer') || t.includes('cloud engineer')) return 'DevOps/Infra';
        if (t.includes('security') || t.includes('infosec') || t.includes('appsec')) return 'Security';
        if (t.includes('research') || t.includes('scientist') || t.includes('ai ') || t.includes(' ai')) return 'Research/AI';
        if (t.includes('data scien') || t.includes('machine learning') || t.includes('ml ') || t.includes(' ml') || t.includes('analytics')) return 'Data/ML';
        if (t.includes('engineer') || t.includes('developer') || t.includes('software') || t.includes('frontend') || t.includes('backend')) return 'Engineering';

        // Product & Design
        if (t.includes('product manager') || t.includes('product lead') || (t.includes('product') && t.includes('manager'))) return 'Product';
        if (t.includes('design') || t.includes('ux') || t.includes('ui ') || t.includes('creative')) return 'Design/UX';

        // Go-to-Market
        if (t.includes('solutions engineer') || t.includes('sales engineer') || t.includes('pre-sales') || t.includes('technical account')) return 'Solutions/SE';
        if (t.includes('customer success') || t.includes('csm') || t.includes('client success')) return 'Customer Success';
        if (t.includes('sales') || t.includes('account executive') || t.includes('ae ') || t.includes('sdr') || t.includes('bdr')) return 'Sales';
        if (t.includes('marketing') || t.includes('growth') || t.includes('demand gen') || t.includes('content')) return 'Marketing';

        // Business
        if (t.includes('corp dev') || t.includes('corporate development') || t.includes('m&a')) return 'Corp Dev/M&A';
        if (t.includes('strategy') || t.includes('chief of staff') || t.includes('bizops')) return 'Strategy/Ops';
        if (t.includes('business development') || t.includes('partnerships') || t.includes('partner ')) return 'Biz Dev';
        if (t.includes('finance') || t.includes('fp&a') || t.includes('accounting') || t.includes('controller')) return 'Finance';

        // Operations
        if (t.includes('recruit') || t.includes('talent acquisition') || t.includes('sourcer')) return 'Recruiting';
        if (t.includes('people') || t.includes('hr ') || t.includes('human resources') || t.includes('hrbp')) return 'People/HR';
        if (t.includes('legal') || t.includes('counsel') || t.includes('attorney') || t.includes('compliance')) return 'Legal';
        if (t.includes('operations') || t.includes('office') || t.includes('facilities') || t.includes('admin')) return 'Operations';

        return 'General';
    },

    // Batch crawl multiple companies
    async crawlMultiple(companyNames, proxyUrl = '', delayMs = 2000) {
        const results = {};

        for (const name of companyNames) {
            if (this.careerPagePatterns[name]) {
                console.log(`[Crawler] Crawling ${name}...`);
                const result = await this.fetchCareerPage(name, proxyUrl);
                if (result) {
                    results[name] = result;
                }
                await new Promise(r => setTimeout(r, delayMs));
            }
        }

        return results;
    },

    // Get list of companies with known career pages
    getCompaniesWithCareerPages() {
        return Object.keys(this.careerPagePatterns);
    }
};

// Register all new providers
JobProviders.register('github', GitHubProvider);
JobProviders.register('usajobs', USAJobsProvider);
JobProviders.register('rapidapi', RapidAPIJobsProvider);
JobProviders.register('crawler', CareerPageCrawler);

// ==================== HIRING SIGNAL SCORE ENGINE ====================
const HiringSignalEngine = {
    // Store historical data for diffing
    historyStore: {},
    signalScores: {},
    alerts: [],

    // Signal weights (matching the MVP spec)
    weights: {
        newCareerPageRole: 30,
        multipleNewPostings7d: 20,
        githubActivitySpike: 15,
        repeatPostingSameRole: 10,
        roleDiversityIncrease: 5,
        roleRemovalFreeze: -20
    },

    // Calculate hiring signal score for a company
    calculateScore(companyName, signals = {}) {
        let score = 50; // Base score

        // +30 new career-page role
        if (signals.newCareerPageRoles > 0) {
            score += Math.min(signals.newCareerPageRoles * 30, 60);
        }

        // +20 multiple new job postings (7d)
        if (signals.newPostings7d >= 3) {
            score += 20;
        } else if (signals.newPostings7d >= 1) {
            score += 10;
        }

        // +15 GitHub activity spike
        if (signals.githubActivitySpike) {
            score += 15;
        }

        // +10 repeat postings same role
        if (signals.repeatPostings > 0) {
            score += Math.min(signals.repeatPostings * 10, 20);
        }

        // +5 role diversity increase
        if (signals.roleDiversityIncrease) {
            score += 5;
        }

        // -20 role removals / freezes
        if (signals.roleRemovals > 0) {
            score -= Math.min(signals.roleRemovals * 10, 40);
        }

        // Clamp to 0-100
        return Math.max(0, Math.min(100, score));
    },

    // Determine confidence level
    getConfidence(signals) {
        let sources = 0;
        if (signals.careerPageData) sources++;
        if (signals.githubData) sources++;
        if (signals.jobBoardData) sources++;
        if (signals.linkedInData) sources++;

        if (sources >= 3) return 'high';
        if (sources >= 2) return 'medium';
        return 'low';
    },

    // Analyze GitHub signals for a company
    async analyzeGitHub(companyName) {
        const github = JobProviders.get('github');
        if (!github) return null;

        try {
            const org = await github.searchCompany(companyName);
            if (!org) return null;

            const details = await github.getOrgDetails(org.login);
            const repos = await github.getOrgRepos(org.login, 50);

            const normalized = github.normalizeOrg(details, repos);

            // Check for hiring signals in READMEs
            const hiringKeywords = ['hiring', 'jobs', 'careers', 'join us', 'we\'re growing'];
            let hiringMentions = 0;

            // Check recent repo activity
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const recentRepos = repos.filter(r => new Date(r.pushed_at) > weekAgo);

            // Detect infrastructure expansion
            const infraKeywords = ['infra', 'devops', 'platform', 'ml-', 'data-', 'deploy'];
            const newInfraRepos = repos.filter(r => {
                const created = new Date(r.created_at);
                const isRecent = created > weekAgo;
                const isInfra = infraKeywords.some(k => r.name.toLowerCase().includes(k));
                return isRecent && isInfra;
            });

            return {
                company: companyName,
                githubOrg: normalized,
                recentRepoActivity: recentRepos.length,
                newInfraRepos: newInfraRepos.length,
                totalStars: normalized?.totalStars || 0,
                isActivitySpike: recentRepos.length > 10 || newInfraRepos.length > 2,
                timestamp: new Date().toISOString()
            };
        } catch (error) {
            console.error(`[HiringSignal] GitHub analysis error for ${companyName}:`, error);
            return null;
        }
    },

    // Analyze career page changes
    async analyzeCareerPage(companyName, previousData = null) {
        const crawler = JobProviders.get('crawler');
        if (!crawler) return null;

        try {
            const careerUrl = crawler.getCareerPageUrl(companyName);
            if (!careerUrl) return null;

            // For browser-based, we need a CORS proxy
            // In production, this would run server-side
            const currentData = await crawler.fetchCareerPage(companyName);
            if (!currentData) return null;

            // Compare with previous data
            let newRoles = [];
            let removedRoles = [];

            if (previousData && previousData.jobs) {
                const prevTitles = new Set(previousData.jobs.map(j => j.title));
                const currTitles = new Set(currentData.jobs.map(j => j.title));

                newRoles = currentData.jobs.filter(j => !prevTitles.has(j.title));
                removedRoles = previousData.jobs.filter(j => !currTitles.has(j.title));
            } else {
                newRoles = currentData.jobs;
            }

            // Analyze role diversity
            const departments = new Set(currentData.jobs.map(j => j.department));
            const prevDepartments = previousData ? new Set(previousData.jobs.map(j => j.department)) : new Set();

            return {
                company: companyName,
                totalRoles: currentData.jobCount,
                newRoles: newRoles,
                removedRoles: removedRoles,
                newRoleCount: newRoles.length,
                removedRoleCount: removedRoles.length,
                departments: [...departments],
                departmentCount: departments.size,
                diversityIncrease: departments.size > prevDepartments.size,
                careerPageUrl: careerUrl,
                timestamp: new Date().toISOString()
            };
        } catch (error) {
            console.error(`[HiringSignal] Career page analysis error for ${companyName}:`, error);
            return null;
        }
    },

    // Analyze job board postings
    async analyzeJobBoards(companyName) {
        const rapidapi = JobProviders.get('rapidapi');

        try {
            let postings = [];

            // Try RapidAPI if key is set
            if (rapidapi && rapidapi.apiKey) {
                const jobs = await rapidapi.searchJobs(companyName, { source: 'jsearch' });
                postings = rapidapi.normalize(jobs).filter(j =>
                    j.company.toLowerCase().includes(companyName.toLowerCase())
                );
            }

            // Count postings by age
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            const recent = postings.filter(p => new Date(p.postedAt) > weekAgo);

            // Detect repeat postings (same role title)
            const titleCounts = {};
            postings.forEach(p => {
                const title = p.title.toLowerCase();
                titleCounts[title] = (titleCounts[title] || 0) + 1;
            });
            const repeatPostings = Object.values(titleCounts).filter(c => c > 1).length;

            return {
                company: companyName,
                totalPostings: postings.length,
                postings7d: recent.length,
                repeatPostings: repeatPostings,
                postings: postings.slice(0, 20),
                timestamp: new Date().toISOString()
            };
        } catch (error) {
            console.error(`[HiringSignal] Job board analysis error for ${companyName}:`, error);
            return null;
        }
    },

    // Full company analysis
    async analyzeCompany(companyName) {
        console.log(`[HiringSignal] Analyzing ${companyName}...`);

        // Get previous data for diffing
        const prevData = this.historyStore[companyName] || {};

        // Gather signals from all sources (parallel)
        const [githubData, careerData, jobBoardData] = await Promise.all([
            this.analyzeGitHub(companyName),
            this.analyzeCareerPage(companyName, prevData.careerData),
            this.analyzeJobBoards(companyName)
        ]);

        // Build signals object
        const signals = {
            newCareerPageRoles: careerData?.newRoleCount || 0,
            newPostings7d: jobBoardData?.postings7d || 0,
            githubActivitySpike: githubData?.isActivitySpike || false,
            repeatPostings: jobBoardData?.repeatPostings || 0,
            roleDiversityIncrease: careerData?.diversityIncrease || false,
            roleRemovals: careerData?.removedRoleCount || 0,
            // Source data
            careerPageData: !!careerData,
            githubData: !!githubData,
            jobBoardData: !!jobBoardData,
            linkedInData: !!linkedInData[companyName]
        };

        // Calculate score
        const score = this.calculateScore(companyName, signals);
        const confidence = this.getConfidence(signals);

        // Determine trend
        const prevScore = this.signalScores[companyName]?.score || 50;
        const trend = score > prevScore + 5 ? 'up' : score < prevScore - 5 ? 'down' : 'stable';

        // Build result
        const result = {
            company: companyName,
            score: score,
            previousScore: prevScore,
            trend: trend,
            confidence: confidence,
            signals: signals,
            details: {
                github: githubData,
                careerPage: careerData,
                jobBoards: jobBoardData,
                linkedIn: linkedInData[companyName] || null
            },
            analyzedAt: new Date().toISOString()
        };

        // Store for history
        this.historyStore[companyName] = {
            careerData: careerData,
            githubData: githubData,
            jobBoardData: jobBoardData,
            timestamp: new Date().toISOString()
        };
        this.signalScores[companyName] = result;

        // Generate alerts
        this.checkAlerts(result);

        return result;
    },

    // Check and generate alerts
    checkAlerts(result) {
        const alerts = [];

        if (result.signals.newCareerPageRoles >= 5) {
            alerts.push({
                type: 'expansion',
                company: result.company,
                message: ` ${result.company} added ${result.signals.newCareerPageRoles} new roles`,
                severity: 'high',
                timestamp: new Date().toISOString()
            });
        }

        if (result.signals.githubActivitySpike) {
            alerts.push({
                type: 'engineering',
                company: result.company,
                message: ` ${result.company} showing GitHub activity spike`,
                severity: 'medium',
                timestamp: new Date().toISOString()
            });
        }

        if (result.signals.roleRemovals >= 3) {
            alerts.push({
                type: 'freeze',
                company: result.company,
                message: ` ${result.company} removed ${result.signals.roleRemovals} roles (possible freeze)`,
                severity: 'warning',
                timestamp: new Date().toISOString()
            });
        }

        if (result.trend === 'up' && result.score >= 70) {
            alerts.push({
                type: 'hot',
                company: result.company,
                message: ` ${result.company} hiring score surging (${result.score})`,
                severity: 'high',
                timestamp: new Date().toISOString()
            });
        }

        this.alerts = [...alerts, ...this.alerts].slice(0, 100);
        return alerts;
    },

    // Batch analyze multiple companies
    async analyzeMultiple(companyNames, delayMs = 2000) {
        const results = {};

        for (let i = 0; i < companyNames.length; i++) {
            const name = companyNames[i];
            updateHiringSignalProgress(i + 1, companyNames.length, name);

            try {
                results[name] = await this.analyzeCompany(name);
            } catch (error) {
                console.error(`[HiringSignal] Failed for ${name}:`, error);
            }

            if (i < companyNames.length - 1) {
                await new Promise(r => setTimeout(r, delayMs));
            }
        }

        return results;
    },

    // Get top hiring companies
    getTopHiring(limit = 20) {
        return Object.values(this.signalScores)
            .filter(s => s.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, limit);
    },

    // Get recent alerts
    getAlerts(limit = 20) {
        return this.alerts.slice(0, limit);
    },

    // Save to localStorage
    saveToStorage() {
        try {
            localStorage.setItem('aibook_hiring_signals', JSON.stringify({
                scores: this.signalScores,
                history: this.historyStore,
                alerts: this.alerts,
                savedAt: new Date().toISOString()
            }));
            console.log('[HiringSignal] Saved to localStorage');
        } catch (e) {
            console.error('[HiringSignal] Save error:', e);
        }
    },

    // Load from localStorage
    loadFromStorage() {
        try {
            const saved = localStorage.getItem('aibook_hiring_signals');
            if (saved) {
                const data = JSON.parse(saved);
                this.signalScores = data.scores || {};
                this.historyStore = data.history || {};
                this.alerts = data.alerts || [];
                console.log(`[HiringSignal] Loaded ${Object.keys(this.signalScores).length} companies`);
            }
        } catch (e) {
            console.error('[HiringSignal] Load error:', e);
        }
    }
};

// ==================== HIRING SIGNALS UI ====================
function updateHiringSignalProgress(current, total, companyName) {
    const el = document.getElementById('hiringSignalProgress');
    if (!el) return;

    const pct = Math.round(current / total * 100);
    el.innerHTML = `
        <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Analyzing hiring signals...</span>
                <span>${current} / ${total} (${pct}%)</span>
            </div>
            <div style="background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #22c55e, #10b981); height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
            </div>
        </div>
        <div style="font-size: 12px; color: var(--dim);">Current: ${companyName}</div>
    `;
}

function initHiringSignalsPanel() {
    HiringSignalEngine.loadFromStorage();
    renderHiringSignalsOverview();
    renderHiringAlerts();
    renderHiringLeaderboard();
}

function renderHiringSignalsOverview() {
    const el = document.getElementById('hiringSignalsOverview');
    if (!el) return;

    const scores = HiringSignalEngine.signalScores;
    const total = Object.keys(scores).length;
    const hot = Object.values(scores).filter(s => s.score >= 70).length;
    const growing = Object.values(scores).filter(s => s.trend === 'up').length;
    const freezing = Object.values(scores).filter(s => s.trend === 'down').length;

    el.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;">Analyzed</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">${total}</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;"> Hot Hiring</div>
                <div style="font-size: 28px; font-weight: 700; color: #ef4444;">${hot}</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;"> Growing</div>
                <div style="font-size: 28px; font-weight: 700; color: #22c55e;">${growing}</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;"> Slowing</div>
                <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${freezing}</div>
            </div>
        </div>
    `;
}

function renderHiringAlerts() {
    const el = document.getElementById('hiringAlerts');
    if (!el) return;

    const alerts = HiringSignalEngine.getAlerts(10);

    if (alerts.length === 0) {
        el.innerHTML = `<div style="color: var(--dim); text-align: center; padding: 20px;">No alerts yet. Run analysis to detect signals.</div>`;
        return;
    }

    el.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px;">
            ${alerts.map(alert => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card); border-radius: 8px; border-left: 3px solid ${alert.severity === 'high' ? '#ef4444' : alert.severity === 'warning' ? '#f97316' : '#22c55e'};">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text);">${alert.message}</div>
                        <div style="font-size: 11px; color: var(--dim);">${new Date(alert.timestamp).toLocaleString()}</div>
                    </div>
                    <span style="padding: 4px 8px; background: var(--border); border-radius: 4px; font-size: 11px; text-transform: uppercase;">${alert.type}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function renderHiringLeaderboard() {
    const el = document.getElementById('hiringLeaderboard');
    if (!el) return;

    const top = HiringSignalEngine.getTopHiring(15);

    if (top.length === 0) {
        el.innerHTML = `<div style="color: var(--dim); text-align: center; padding: 20px;">No data yet. Click "Analyze All" to start.</div>`;
        return;
    }

    el.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px;">
            ${top.map((item, idx) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="position: relative;">
                        ${renderLogo(item.company, 36)}
                        <div style="position: absolute; bottom: -4px; right: -4px; width: 18px; height: 18px; background: ${idx < 3 ? 'linear-gradient(135deg, #ef4444, #f97316)' : 'var(--border)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 10px; color: ${idx < 3 ? 'white' : 'var(--dim)'}; border: 2px solid var(--card);">${idx + 1}</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text);">${item.company}</div>
                        <div style="font-size: 12px; color: var(--dim);">
                            ${item.signals.newCareerPageRoles > 0 ? `+${item.signals.newCareerPageRoles} roles ` : ''}
                            ${item.signals.githubActivitySpike ? ' GitHub active ' : ''}
                            ${item.confidence} confidence
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 700; color: ${item.score >= 70 ? '#ef4444' : item.score >= 50 ? '#22c55e' : 'var(--dim)'};">${item.score}</div>
                        <div style="font-size: 11px; color: ${item.trend === 'up' ? '#22c55e' : item.trend === 'down' ? '#ef4444' : 'var(--dim)'};">
                            ${item.trend === 'up' ? '' : item.trend === 'down' ? '' : ''} ${item.trend}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

async function startHiringSignalAnalysis() {
    const btn = document.getElementById('analyzeHiringBtn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Analyzing...';
    }

    try {
        // Get companies with career pages (highest quality)
        const crawler = JobProviders.get('crawler');
        const companiesWithPages = crawler.getCompaniesWithCareerPages();

        // Also include top companies from hiringData
        const topHiring = Object.keys(hiringData).slice(0, 30);

        // Combine and dedupe
        const toAnalyze = [...new Set([...companiesWithPages, ...topHiring])];

        await HiringSignalEngine.analyzeMultiple(toAnalyze, 1500);
        HiringSignalEngine.saveToStorage();

        renderHiringSignalsOverview();
        renderHiringAlerts();
        renderHiringLeaderboard();
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Analyze All Companies';
        }
        document.getElementById('hiringSignalProgress').innerHTML = '';
    }
}

async function analyzeSelectedCompany() {
    const select = document.getElementById('hiringCompanySelect');
    const name = select?.value;
    if (!name) return;

    const btn = document.getElementById('analyzeSingleBtn');
    if (btn) btn.disabled = true;

    try {
        const result = await HiringSignalEngine.analyzeCompany(name);
        HiringSignalEngine.saveToStorage();
        renderCompanySignalDetail(result);
        renderHiringSignalsOverview();
        renderHiringAlerts();
        renderHiringLeaderboard();
    } finally {
        if (btn) btn.disabled = false;
    }
}

function renderCompanySignalDetail(result) {
    const el = document.getElementById('companySignalDetail');
    if (!el || !result) return;

    el.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="margin: 0; color: var(--text); font-size: 20px;">${result.company}</h3>
                    <div style="font-size: 12px; color: var(--dim);">Analyzed: ${new Date(result.analyzedAt).toLocaleString()}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 48px; font-weight: 700; color: ${result.score >= 70 ? '#ef4444' : result.score >= 50 ? '#22c55e' : 'var(--dim)'};">${result.score}</div>
                    <div style="font-size: 12px; padding: 4px 8px; background: ${result.confidence === 'high' ? 'rgba(34,197,94,0.2)' : result.confidence === 'medium' ? 'rgba(249,115,22,0.2)' : 'rgba(107,114,128,0.2)'}; border-radius: 4px; color: ${result.confidence === 'high' ? '#22c55e' : result.confidence === 'medium' ? '#f97316' : 'var(--dim)'};">${result.confidence} confidence</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div style="background: rgba(34,197,94,0.1); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--dim);">NEW ROLES</div>
                    <div style="font-size: 24px; font-weight: 600; color: #22c55e;">${result.signals.newCareerPageRoles}</div>
                </div>
                <div style="background: rgba(59,130,246,0.1); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--dim);">POSTINGS (7D)</div>
                    <div style="font-size: 24px; font-weight: 600; color: #3b82f6;">${result.signals.newPostings7d}</div>
                </div>
                <div style="background: rgba(168,85,247,0.1); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--dim);">GITHUB SPIKE</div>
                    <div style="font-size: 24px; font-weight: 600; color: #a855f7;">${result.signals.githubActivitySpike ? 'Yes' : 'No'}</div>
                </div>
                <div style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--dim);">REMOVED</div>
                    <div style="font-size: 24px; font-weight: 600; color: #ef4444;">${result.signals.roleRemovals}</div>
                </div>
            </div>

            ${result.details.careerPage?.newRoles?.length > 0 ? `
                <div style="margin-top: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 14px;">New Roles Detected</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${result.details.careerPage.newRoles.slice(0, 10).map(r => `
                            <span style="background: rgba(34,197,94,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #22c55e;">${r.title}</span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${result.details.github ? `
                <div style="margin-top: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 14px;">GitHub Activity</h4>
                    <div style="font-size: 13px; color: var(--dim);">
                        ${result.details.github.recentRepoActivity} active repos this week 
                        ${result.details.github.totalStars?.toLocaleString() || 0} total stars 
                        ${result.details.github.newInfraRepos} new infra repos
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

function populateHiringCompanySelect() {
    const select = document.getElementById('hiringCompanySelect');
    if (!select) return;

    const crawler = JobProviders.get('crawler');
    const companiesWithPages = crawler?.getCompaniesWithCareerPages() || [];
    const allCompanies = [...new Set([...companiesWithPages, ...Object.keys(hiringData)])].sort();

    select.innerHTML = '<option value="">Select company...</option>';
    allCompanies.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        const score = HiringSignalEngine.signalScores[name]?.score;
        option.textContent = name + (score ? ` (${score})` : '');
        select.appendChild(option);
    });
}

// ==================== UNIFIED JOB FETCHER ====================
const JobFetcher = {
    cache: {},
    cacheExpiry: 15 * 60 * 1000, // 15 minutes

    // Fetch jobs for a specific company
    async fetchForCompany(companyName) {
        const cacheKey = `company:${companyName}`;
        if (this.cache[cacheKey] && Date.now() - this.cache[cacheKey].timestamp < this.cacheExpiry) {
            return this.cache[cacheKey].data;
        }

        const atsConfig = companyATSMap[companyName];
        if (!atsConfig) {
            console.log(`[JobFetcher] No ATS mapping for ${companyName}`);
            return [];
        }

        const provider = JobProviders.get(atsConfig.ats);
        if (!provider) {
            console.error(`[JobFetcher] Provider ${atsConfig.ats} not found`);
            return [];
        }

        const jobs = await provider.fetchJobs(atsConfig.boardToken, companyName);
        this.cache[cacheKey] = { data: jobs, timestamp: Date.now() };
        return jobs;
    },

    // Fetch job count for a company (faster, no full data)
    async getJobCount(companyName) {
        const atsConfig = companyATSMap[companyName];
        if (!atsConfig) return 0;

        const provider = JobProviders.get(atsConfig.ats);
        if (!provider || !provider.getJobCount) return 0;

        return await provider.getJobCount(atsConfig.boardToken);
    },

    // Fetch from aggregators (RemoteOK, Arbeitnow) with filters
    async fetchRemoteJobs(options = {}) {
        const cacheKey = `remote:${JSON.stringify(options)}`;
        if (this.cache[cacheKey] && Date.now() - this.cache[cacheKey].timestamp < this.cacheExpiry) {
            return this.cache[cacheKey].data;
        }

        const results = await Promise.all([
            RemoteOKProvider.fetchJobs(options),
            ArbeitnowProvider.fetchJobs(options)
        ]);

        const jobs = results.flat().sort((a, b) => b.postedAt - a.postedAt);
        this.cache[cacheKey] = { data: jobs, timestamp: Date.now() };
        return jobs;
    },

    // Fetch jobs from multiple companies in parallel
    async fetchForCompanies(companyNames) {
        const results = await Promise.all(
            companyNames.map(name => this.fetchForCompany(name))
        );
        return results.flat();
    },

    // Clear cache
    clearCache() {
        this.cache = {};
    },

    // Get companies that have ATS mappings
    getMappedCompanies() {
        return Object.keys(companyATSMap);
    }
};

// ==================== JOB DATA UI HELPERS ====================
function formatJobPostedDate(date) {
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return `${Math.floor(diffDays / 30)} months ago`;
}

function renderJobCard(job) {
    return `
        <div class="job-card" style="padding: 12px; background: var(--card); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <a href="${job.url}" target="_blank" style="color: var(--accent-cyan); font-weight: 600; text-decoration: none;">${job.title}</a>
                    <div style="font-size: 12px; color: var(--dim); margin-top: 4px;">
                        ${job.department}  ${job.location} ${job.remote ? '' : ''}
                    </div>
                </div>
                <div style="text-align: right; font-size: 11px; color: var(--dim);">
                    ${formatJobPostedDate(job.postedAt)}
                    <div style="margin-top: 2px; font-size: 9px; text-transform: uppercase;">${job.source}</div>
                </div>
            </div>
            ${job.salary ? `<div style="margin-top: 6px; font-size: 12px; color: #22c55e;">$${job.salary.min.toLocaleString()} - $${job.salary.max.toLocaleString()}</div>` : ''}
        </div>
    `;
}

// ==================== JOBS PANEL UI FUNCTIONS ====================
let currentJobResults = [];

function initJobsPanel() {
    const select = document.getElementById('jobsCompanySelect');
    if (!select) return;

    // Populate with companies that have ATS mapping
    const mappedCompanies = Object.keys(companyATSMap).sort();
    select.innerHTML = '<option value="">Select a company...</option>';
    mappedCompanies.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });
}

function setJobsLoading(loading) {
    const spinner = document.getElementById('jobsLoadingSpinner');
    const btn = document.getElementById('fetchJobsBtn');
    if (spinner) spinner.style.display = loading ? 'inline' : 'none';
    if (btn) btn.disabled = loading;
}

async function fetchAndDisplayJobs() {
    const companyName = document.getElementById('jobsCompanySelect')?.value;
    if (!companyName) {
        showJobsError('Please select a company');
        return;
    }

    setJobsLoading(true);
    try {
        const jobs = await JobFetcher.fetchForCompany(companyName);
        currentJobResults = jobs;
        displayJobResults(jobs, [companyName]);
    } catch (error) {
        console.error('Error fetching jobs:', error);
        showJobsError(`Error fetching jobs: ${error.message}`);
    } finally {
        setJobsLoading(false);
    }
}

async function fetchJobsForMultipleCompanies(companyNames, title = 'Multiple Companies') {
    setJobsLoading(true);
    const resultsArea = document.getElementById('jobsResultsArea');
    resultsArea.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--dim);">
            <div style="font-size: 32px; margin-bottom: 12px;"></div>
            <div>Fetching jobs from ${companyNames.length} companies...</div>
            <div id="jobsFetchProgress" style="margin-top: 8px; font-size: 12px;">0 / ${companyNames.length}</div>
        </div>
    `;

    try {
        let allJobs = [];
        for (let i = 0; i < companyNames.length; i++) {
            const progress = document.getElementById('jobsFetchProgress');
            if (progress) progress.textContent = `${i + 1} / ${companyNames.length}`;

            try {
                const jobs = await JobFetcher.fetchForCompany(companyNames[i]);
                allJobs = allJobs.concat(jobs);
            } catch (err) {
                console.warn(`Failed to fetch jobs for ${companyNames[i]}:`, err);
            }
        }
        currentJobResults = allJobs;
        displayJobResults(allJobs, companyNames);
    } catch (error) {
        showJobsError(`Error: ${error.message}`);
    } finally {
        setJobsLoading(false);
    }
}

async function fetchJobsForHotCompanies() {
    const hotCompanies = Object.entries(hiringData)
        .filter(([_, data]) => data.trend === 'hot')
        .map(([name]) => name)
        .filter(name => companyATSMap[name]);

    await fetchJobsForMultipleCompanies(hotCompanies, 'Hot Companies');
}

async function fetchJobsForHighMaTarget() {
    const highMaCompanies = Object.keys(companyATSMap).filter(name => {
        const wiki = wikiData[name];
        if (!wiki) return false;
        const score = calcWikiMaScore(wiki);
        return score >= 70;
    });

    await fetchJobsForMultipleCompanies(highMaCompanies, 'High M&A Targets');
}

async function fetchRemoteAIJobs() {
    setJobsLoading(true);
    const resultsArea = document.getElementById('jobsResultsArea');
    resultsArea.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--dim);">
            <div style="font-size: 32px; margin-bottom: 12px;"></div>
            <div>Fetching remote AI jobs...</div>
        </div>
    `;

    try {
        const remoteOkProvider = JobProviders.get('remoteok');
        const arbeitnowProvider = JobProviders.get('arbeitnow');

        let allJobs = [];

        // Try RemoteOK
        try {
            const roJobs = await remoteOkProvider.fetchJobs({ tag: 'ai' });
            allJobs = allJobs.concat(remoteOkProvider.normalize(roJobs));
        } catch (e) {
            console.warn('RemoteOK fetch failed:', e);
        }

        // Try Arbeitnow
        try {
            const anJobs = await arbeitnowProvider.fetchJobs({ category: 'ai' });
            allJobs = allJobs.concat(arbeitnowProvider.normalize(anJobs));
        } catch (e) {
            console.warn('Arbeitnow fetch failed:', e);
        }

        currentJobResults = allJobs;
        displayJobResults(allJobs, ['Remote AI Jobs'], true);
    } catch (error) {
        showJobsError(`Error: ${error.message}`);
    } finally {
        setJobsLoading(false);
    }
}

async function fetchJobsForUnicorns() {
    const unicorns = Object.keys(companyATSMap).filter(name => {
        const wiki = wikiData[name];
        return wiki && wiki.valuationNum && wiki.valuationNum >= 1000000000;
    });

    await fetchJobsForMultipleCompanies(unicorns.slice(0, 10), 'Unicorns');
}

function displayJobResults(jobs, companyNames, isRemote = false) {
    const resultsArea = document.getElementById('jobsResultsArea');
    const statsBar = document.getElementById('jobsStatsBar');

    // Apply filters
    const deptFilter = document.getElementById('jobsDeptFilter')?.value || '';
    const locFilter = document.getElementById('jobsLocationFilter')?.value || '';

    let filteredJobs = jobs;

    if (deptFilter) {
        filteredJobs = filteredJobs.filter(job => {
            const dept = (job.department || '').toLowerCase();
            const title = (job.title || '').toLowerCase();
            const combined = dept + ' ' + title;

            // Department filter mappings with keyword matching
            const filters = {
                // Technical
                'engineering': ['engineer', 'developer', 'software', 'frontend', 'backend', 'fullstack', 'mobile', 'ios', 'android', 'web dev'],
                'devops': ['devops', 'sre', 'site reliability', 'infrastructure', 'platform', 'cloud', 'kubernetes', 'docker', 'ci/cd', 'systems'],
                'data': ['data science', 'data engineer', 'machine learning', 'ml ', 'analytics', 'data analyst', 'bi ', 'business intelligence'],
                'research': ['research', 'scientist', 'ai research', 'applied science', 'phd', 'lab'],
                'security': ['security', 'infosec', 'cybersecurity', 'appsec', 'secops', 'compliance engineer'],

                // Product & Design
                'product': ['product manager', 'product management', 'pm ', ' pm', 'product lead', 'product director'],
                'design': ['design', 'ux', 'ui ', 'user experience', 'user interface', 'visual', 'brand design', 'creative'],

                // Go-to-Market
                'sales': ['sales', 'account executive', 'ae ', ' ae', 'sdr', 'bdr', 'account manager', 'revenue', 'quota'],
                'marketing': ['marketing', 'growth', 'demand gen', 'content', 'brand', 'communications', 'pr ', 'public relations', 'social media'],
                'cs': ['customer success', 'csm', 'client success', 'customer experience', 'cx ', 'support engineer', 'technical support'],
                'solutions': ['solutions engineer', 'solutions architect', 'se ', 'sales engineer', 'pre-sales', 'technical account', 'tam'],

                // Business
                'finance': ['finance', 'accounting', 'controller', 'fp&a', 'financial', 'treasury', 'tax ', 'audit', 'cfo'],
                'strategy': ['strategy', 'strategic', 'chief of staff', 'operations', 'business ops', 'bizops', 'planning'],
                'corpdev': ['corp dev', 'corporate development', 'm&a', 'mergers', 'acquisitions', 'investments', 'venture'],
                'bizdev': ['business development', 'bizdev', 'partnerships', 'partner', 'alliances', 'channel'],

                // Operations
                'hr': ['people', 'hr ', 'human resources', 'talent', 'culture', 'employee', 'hrbp', 'compensation', 'benefits'],
                'legal': ['legal', 'counsel', 'attorney', 'lawyer', 'compliance', 'regulatory', 'privacy', 'contracts'],
                'recruiting': ['recruiting', 'recruiter', 'talent acquisition', 'sourcer', 'hiring'],
                'ops': ['operations', 'office', 'facilities', 'admin', 'executive assistant', 'ea ', 'workplace']
            };

            const keywords = filters[deptFilter];
            if (!keywords) return true;
            return keywords.some(kw => combined.includes(kw));
        });
    }

    if (locFilter) {
        filteredJobs = filteredJobs.filter(job => {
            const loc = (job.location || '').toLowerCase();
            if (locFilter === 'sf') return loc.includes('san francisco') || loc.includes('sf') || loc.includes('bay area');
            if (locFilter === 'nyc') return loc.includes('new york') || loc.includes('nyc') || loc.includes('brooklyn');
            if (locFilter === 'remote') return job.remote || loc.includes('remote');
            if (locFilter === 'london') return loc.includes('london') || loc.includes('uk');
            if (locFilter === 'seattle') return loc.includes('seattle') || loc.includes('wa');
            return true;
        });
    }

    // Update stats
    const uniqueCompanies = [...new Set(filteredJobs.map(j => j.company))];
    const engJobs = filteredJobs.filter(j => {
        const dept = (j.department || '').toLowerCase();
        return dept.includes('engineer') || dept.includes('dev') || dept.includes('software');
    });
    const remoteJobs = filteredJobs.filter(j => j.remote || (j.location || '').toLowerCase().includes('remote'));

    document.getElementById('jobsTotalCount').textContent = filteredJobs.length;
    document.getElementById('jobsCompanyCount').textContent = uniqueCompanies.length;
    document.getElementById('jobsEngCount').textContent = engJobs.length;
    document.getElementById('jobsRemoteCount').textContent = remoteJobs.length;
    statsBar.style.display = 'block';

    if (filteredJobs.length === 0) {
        resultsArea.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--dim);">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <div style="font-size: 16px;">No jobs found matching your filters</div>
                <div style="font-size: 13px; margin-top: 8px;">Try adjusting the department or location filters</div>
            </div>
        `;
        return;
    }

    // Group by company
    const jobsByCompany = {};
    filteredJobs.forEach(job => {
        const company = job.company || 'Unknown';
        if (!jobsByCompany[company]) jobsByCompany[company] = [];
        jobsByCompany[company].push(job);
    });

    // Sort jobs within each company by date
    Object.values(jobsByCompany).forEach(jobs => {
        jobs.sort((a, b) => new Date(b.postedAt) - new Date(a.postedAt));
    });

    // Build HTML
    let html = '';
    Object.entries(jobsByCompany)
        .sort((a, b) => b[1].length - a[1].length)
        .forEach(([company, companyJobs]) => {
            const wiki = wikiData[company];
            const maScore = wiki ? calcWikiMaScore(wiki) : null;

            html += `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        ${renderLogo(company, 36)}
                        <h3 style="margin: 0; color: var(--text); font-size: 16px;">${company}</h3>
                        <span style="background: var(--card); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #22c55e; border: 1px solid rgba(34,197,94,0.3);">
                            ${companyJobs.length} open roles
                        </span>
                        ${maScore ? `
                            <span style="background: rgba(249,115,22,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #f97316; border: 1px solid rgba(249,115,22,0.3);">
                                M&A: ${maScore}%
                            </span>
                        ` : ''}
                    </div>
                    <div class="job-list">
                        ${companyJobs.slice(0, 10).map(renderJobCard).join('')}
                        ${companyJobs.length > 10 ? `
                            <button onclick="showAllCompanyJobs('${company}')" style="width: 100%; padding: 10px; background: var(--card); border: 1px solid var(--border); color: var(--dim); border-radius: 8px; cursor: pointer; font-size: 13px;">
                                + ${companyJobs.length - 10} more jobs
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });

    resultsArea.innerHTML = html;
}

function showAllCompanyJobs(company) {
    const jobs = currentJobResults.filter(j => j.company === company);
    const resultsArea = document.getElementById('jobsResultsArea');

    resultsArea.innerHTML = `
        <div style="margin-bottom: 16px;">
            <button onclick="displayJobResults(currentJobResults, [])" style="padding: 8px 16px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer;">
                 Back to all companies
            </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            ${renderLogo(company, 40)}
            <h3 style="margin: 0; color: var(--text);">${company} - All ${jobs.length} Jobs</h3>
        </div>
        <div class="job-list">
            ${jobs.map(renderJobCard).join('')}
        </div>
    `;
}

function showJobsError(message) {
    const resultsArea = document.getElementById('jobsResultsArea');
    resultsArea.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
            <div style="font-size: 48px; margin-bottom: 16px;"></div>
            <div style="font-size: 16px;">${message}</div>
            <div style="font-size: 13px; margin-top: 8px; color: var(--dim);">
                Note: Some job APIs may have CORS restrictions when running locally.
                <br>Try opening the file from a local server for full functionality.
            </div>
        </div>
    `;
}

// Add filter change listeners
function setupJobsFilterListeners() {
    const deptFilter = document.getElementById('jobsDeptFilter');
    const locFilter = document.getElementById('jobsLocationFilter');

    if (deptFilter) {
        deptFilter.addEventListener('change', () => {
            if (currentJobResults.length > 0) {
                displayJobResults(currentJobResults, []);
            }
        });
    }

    if (locFilter) {
        locFilter.addEventListener('change', () => {
            if (currentJobResults.length > 0) {
                displayJobResults(currentJobResults, []);
            }
        });
    }
}

// ==================== LINKEDIN DATA STORAGE ====================
const linkedInData = {};
let linkedInFetchProgress = { total: 0, completed: 0, failed: 0, current: '' };

// Known LinkedIn company vanity names (manual mapping for accuracy)
const linkedInVanityMap = {
    "OpenAI": "openai",
    "Anthropic": "anthropic",
    "Mistral AI": "mistral-ai",
    "Cohere": "coaborntechnologies",
    "xAI": "xaborntechnologies",
    "Databricks": "databricks",
    "Stripe": "stripe",
    "Cursor": "anysphere",
    "Scale AI": "scaleai",
    "Hugging Face": "huggingface",
    "LangChain": "langchain-ai",
    "Pinecone": "pinecone-io",
    "Weights & Biases": "wandb",
    "Notion": "notionhq",
    "Figma": "figma",
    "Vercel": "vercel",
    "Replit": "replit",
    "Linear": "linear-app",
    "Retool": "retaborntechnologies",
    "dbt Labs": "dbt-labs",
    "Supabase": "supabase",
    "Modal": "modal-labs",
    "Anyscale": "anyscale",
    "Groq": "groq",
    "Cerebras": "cerebras",
    "Together AI": "togetherai",
    "Replicate": "replicate",
    "Perplexity": "perplexity-ai",
    "Character.AI": "character-ai",
    "Glean": "glaborntechnologies",
    "Harvey": "harvey-ai",
    "ElevenLabs": "elevenlabs",
    "Runway": "runwayml",
    "Pika": "pika-labs",
    "Ramp": "ramp",
    "Brex": "brex",
    "Plaid": "plaid",
    "Airtable": "airtable",
    "Snyk": "snyk",
    "Datadog": "datadog",
    "Cloudflare": "cloudflare",
    "Wiz": "wiz-inc",
    "CrowdStrike": "crowdstrike",
    "Palo Alto Networks": "paborntechnologies-alto-networks",
    "ServiceNow": "servicenow",
    "Snowflake": "snowflake-computing",
    "Palantir": "palantir-technologies",
    "Tempus": "tempus-labs",
    "Gong": "gong-io",
    "6sense": "6sense",
    "Moveworks": "moveworks",
    "Jasper": "jasper-ai",
    "Writer": "writerai",
    "Grammarly": "grammarly",
    "Cognition": "cognition-labs",
    "Figure": "figureai",
    "Adept": "adept-ai-labs",
    "Inflection AI": "inflection-ai",
    "AI21 Labs": "ai21",
    "Stability AI": "stability-ai",
    "Covariant": "covariant-ai",
    "Ironclad": "ironcladapp",
    "Clio": "caborntechnologies-software",
    "Tempus": "tempus-ai",
    "Viz.ai": "viz-ai-inc",
    "PathAI": "pathai",
    "Insitro": "insitro",
    "Recursion": "recursionpharma"
};

// Batch fetch LinkedIn data for all companies
async function fetchAllLinkedInData(companyNames, batchSize = 5, delayMs = 2000) {
    const linkedin = JobProviders.get('linkedin');
    if (!linkedin) {
        console.error('[LinkedIn] Provider not found');
        return;
    }

    linkedInFetchProgress = {
        total: companyNames.length,
        completed: 0,
        failed: 0,
        current: ''
    };
    updateLinkedInProgressUI();

    for (let i = 0; i < companyNames.length; i += batchSize) {
        const batch = companyNames.slice(i, i + batchSize);

        for (const name of batch) {
            linkedInFetchProgress.current = name;
            updateLinkedInProgressUI();

            try {
                // Check if we already have data
                if (linkedInData[name] && linkedInData[name].lastUpdated) {
                    const age = Date.now() - new Date(linkedInData[name].lastUpdated).getTime();
                    if (age < 24 * 60 * 60 * 1000) { // Skip if less than 24h old
                        linkedInFetchProgress.completed++;
                        continue;
                    }
                }

                // Try vanity name first, then search
                const vanity = linkedInVanityMap[name];
                let companyData = null;

                if (vanity) {
                    companyData = await linkedin.getCompanyByUsername(vanity);
                }

                if (!companyData) {
                    const searchResults = await linkedin.searchCompanies(name);
                    if (searchResults && searchResults.length > 0) {
                        // Get the first matching company's username
                        const firstResult = searchResults[0];
                        if (firstResult.username) {
                            companyData = await linkedin.getCompanyByUsername(firstResult.username);
                        } else if (firstResult.universalName) {
                            companyData = await linkedin.getCompanyByUsername(firstResult.universalName);
                        }
                    }
                }

                if (companyData) {
                    linkedInData[name] = linkedin.normalizeCompany(companyData);
                    // Sync to 50-signal model
                    syncLinkedInToSignalModel(name);
                    linkedInFetchProgress.completed++;
                } else {
                    linkedInFetchProgress.failed++;
                }
            } catch (error) {
                console.error(`[LinkedIn] Error fetching ${name}:`, error);
                linkedInFetchProgress.failed++;
            }
        }

        // Rate limit delay between batches
        if (i + batchSize < companyNames.length) {
            await new Promise(resolve => setTimeout(resolve, delayMs));
        }
    }

    linkedInFetchProgress.current = '';
    updateLinkedInProgressUI();
    saveLinkedInDataToStorage();
    return linkedInData;
}

// Fetch LinkedIn jobs for a company
async function fetchLinkedInJobs(companyName) {
    const linkedin = JobProviders.get('linkedin');
    const companyData = linkedInData[companyName];

    if (!companyData?.id) {
        console.log(`[LinkedIn] No company ID for ${companyName}`);
        return [];
    }

    try {
        const jobsData = await linkedin.getCompanyJobs(companyData.id);
        return linkedin.normalizeJobs(jobsData, companyName);
    } catch (error) {
        console.error(`[LinkedIn] Jobs fetch error for ${companyName}:`, error);
        return [];
    }
}

// Update UI with fetch progress
function updateLinkedInProgressUI() {
    const progressEl = document.getElementById('linkedInProgress');
    if (!progressEl) return;

    const { total, completed, failed, current } = linkedInFetchProgress;
    const pct = total > 0 ? Math.round((completed + failed) / total * 100) : 0;

    progressEl.innerHTML = `
        <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Fetching LinkedIn data...</span>
                <span>${completed + failed} / ${total} (${pct}%)</span>
            </div>
            <div style="background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #0077b5, #00a0dc); height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
            </div>
        </div>
        ${current ? `<div style="font-size: 12px; color: var(--dim);">Current: ${current}</div>` : ''}
        <div style="font-size: 12px; margin-top: 4px;">
            <span style="color: #22c55e;"> ${completed} success</span>
            ${failed > 0 ? `<span style="color: #ef4444; margin-left: 12px;"> ${failed} failed</span>` : ''}
        </div>
    `;
}

// Save LinkedIn data to localStorage
function saveLinkedInDataToStorage() {
    try {
        localStorage.setItem('aibook_linkedin_data', JSON.stringify(linkedInData));
        console.log('[LinkedIn] Data saved to localStorage');
    } catch (e) {
        console.error('[LinkedIn] Failed to save to localStorage:', e);
    }
}

// Load LinkedIn data from localStorage
function loadLinkedInDataFromStorage() {
    try {
        const saved = localStorage.getItem('aibook_linkedin_data');
        if (saved) {
            Object.assign(linkedInData, JSON.parse(saved));
            console.log(`[LinkedIn] Loaded ${Object.keys(linkedInData).length} companies from storage`);
            // Sync all loaded data to signal model
            mergeLinkedInToSignalModel();
        }
    } catch (e) {
        console.error('[LinkedIn] Failed to load from localStorage:', e);
    }
}

// Sync LinkedIn data into the 50-signal model (hiringData + wikiData)
function syncLinkedInToSignalModel(companyName) {
    const liData = linkedInData[companyName];
    if (!liData) return false;

    const company = companies.find(c => c.name === companyName);
    if (!company) return false;

    // Parse employee count from LinkedIn
    const employeeCount = parseInt(liData.employees) ||
                          parseInt(liData.staffCount) ||
                          (liData.employeeCountRange ? parseEmployeeRange(liData.employeeCountRange) : 100);

    // === UPDATE HIRING DATA (signals 17-30, 45-46) ===
    if (!hiringData[companyName]) {
        hiringData[companyName] = {};
    }
    const hd = hiringData[companyName];

    // Real LinkedIn followers (signal #46)
    hd.linkedinFollowers = liData.followers || liData.followerCount || 0;

    // Estimate roles based on employee count and industry
    if (!hd.roles || hd.generated) {
        const roleRate = liData.followers > 50000 ? 0.06 : 0.04;  // High-profile = more hiring
        hd.roles = Math.max(5, Math.round(employeeCount * roleRate));
    }

    // Update employee history if we have real count
    if (employeeCount > 0) {
        // If we don't have history or it's generated, create from current
        if (!hd.employeeHistory || hd.generated) {
            const growthRate = hd.growthRate || 15;
            const qGrowth = growthRate / 400;  // Convert annual to quarterly
            const history = [];
            let emp = employeeCount / Math.pow(1 + qGrowth, 4);
            for (let i = 0; i < 5; i++) {
                history.push(Math.round(emp));
                emp *= (1 + qGrowth);
            }
            hd.employeeHistory = history;
        }
    }

    // Determine trend from followers (high engagement = hot)
    if (!hd.trend || hd.generated) {
        const followerRatio = (liData.followers || 0) / Math.max(employeeCount, 1);
        if (followerRatio > 100) hd.trend = 'hot';
        else if (followerRatio > 50) hd.trend = 'growing';
        else if (followerRatio > 20) hd.trend = 'stable';
        else hd.trend = 'stable';
    }

    // Location from LinkedIn
    if (liData.hq && (!hd.locations || hd.generated)) {
        hd.locations = [liData.hq.split(',')[0]];
    }

    // Industry from LinkedIn for category-based signals
    if (liData.industry) {
        hd.linkedinIndustry = liData.industry;
    }

    // Mark as having real LinkedIn data
    hd.linkedinVerified = true;
    hd.linkedinUpdated = new Date().toISOString();

    // === UPDATE WIKI DATA (signals 31-44, 47-50) ===
    if (!wikiData[companyName]) {
        wikiData[companyName] = {};
    }
    const wd = wikiData[companyName];

    // Real LinkedIn data
    wd.linkedIn = liData;
    wd.linkedInFollowers = liData.followers || 0;
    wd.linkedInEmployees = employeeCount;
    wd.linkedInUrl = liData.linkedinUrl;
    wd.linkedInIndustry = liData.industry;
    wd.linkedInSpecialties = liData.specialties || [];
    wd.linkedInDescription = liData.description;

    // Update employee count if more accurate
    if (employeeCount > 0) {
        wd.employees = employeeCount;
    }

    // Founded year from LinkedIn
    if (liData.founded && (!wd.founded || wd.generated)) {
        wd.founded = liData.founded;
        wd.companyAge = new Date().getFullYear() - liData.founded;
    }

    // HQ from LinkedIn
    if (liData.hq && (!wd.hq || wd.generated)) {
        wd.hq = liData.hq;
    }

    // Website from LinkedIn
    if (liData.website) {
        wd.website = liData.website;
    }

    // Mark as having real LinkedIn data
    wd.linkedinVerified = true;
    wd.linkedinUpdated = new Date().toISOString();

    return true;
}

// Parse employee range string like "201-500" or "1,001-5,000"
function parseEmployeeRange(rangeStr) {
    if (!rangeStr) return 100;
    const match = rangeStr.match(/[\d,]+/g);
    if (!match) return 100;
    const low = parseInt(match[0].replace(/,/g, ''));
    const high = match[1] ? parseInt(match[1].replace(/,/g, '')) : low * 1.5;
    return Math.round((low + high) / 2);
}

// Merge ALL LinkedIn data into signal model
function mergeLinkedInToSignalModel() {
    let synced = 0;
    for (const name of Object.keys(linkedInData)) {
        if (syncLinkedInToSignalModel(name)) {
            synced++;
        }
    }
    console.log(`[LinkedIn] Synced ${synced} companies into 50-signal model`);
    return synced;
}

// Legacy function for backwards compatibility
function mergeLinkedInToWikiData() {
    return mergeLinkedInToSignalModel();
}

// Get all company names from the directory
function getAllCompanyNames() {
    return companies.map(c => c.name);
}

// Initialize LinkedIn panel
function initLinkedInPanel() {
    loadLinkedInDataFromStorage();
    populateLinkedInCompanySelect();
    renderLinkedInStats();
    renderLinkedInHiringLeaderboard('all');
    initGoogleSheetsSync();
    computeLinkedInSignals(); // Initialize signals intelligence
}

function populateLinkedInCompanySelect() {
    const select = document.getElementById('linkedInCompanySelect');
    if (!select) return;

    const allCompanies = getAllCompanyNames().sort();
    select.innerHTML = '<option value="">Select company...</option>';
    allCompanies.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        if (linkedInData[name]) {
            option.textContent += ' ';
        }
        select.appendChild(option);
    });
}

function renderLinkedInStats() {
    const statsEl = document.getElementById('linkedInStats');
    if (!statsEl) return;

    const totalCompanies = companies.length;
    const fetchedCount = Object.keys(linkedInData).length;
    const withFollowers = Object.values(linkedInData).filter(d => d.followers > 0).length;

    statsEl.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;">Total Companies</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">${totalCompanies}</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(0,119,181,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;">LinkedIn Data</div>
                <div style="font-size: 28px; font-weight: 700; color: #0077b5;">${fetchedCount}</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;">Coverage</div>
                <div style="font-size: 28px; font-weight: 700; color: #22c55e;">${Math.round(fetchedCount/totalCompanies*100)}%</div>
            </div>
            <div style="background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid rgba(168,85,247,0.3);">
                <div style="font-size: 11px; color: var(--dim); text-transform: uppercase;">With Followers</div>
                <div style="font-size: 28px; font-weight: 700; color: #a855f7;">${withFollowers}</div>
            </div>
        </div>
    `;
}

// Start bulk LinkedIn fetch
async function startLinkedInBulkFetch() {
    const allNames = getAllCompanyNames();
    const btn = document.getElementById('linkedInFetchAllBtn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Fetching...';
    }

    try {
        await fetchAllLinkedInData(allNames, 3, 3000); // 3 at a time, 3s delay
        mergeLinkedInToWikiData();
        renderLinkedInStats();
        populateLinkedInCompanySelect();
        renderLinkedInHiringLeaderboard();
        computeLinkedInSignals(); // Refresh signals
        applyFilters(); // Refresh main view
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Fetch All Companies';
        }
    }
}

// Fetch single company
async function fetchSingleLinkedInCompany() {
    const select = document.getElementById('linkedInCompanySelect');
    const name = select?.value;
    if (!name) return;

    const btn = document.getElementById('linkedInFetchOneBtn');
    if (btn) btn.disabled = true;

    try {
        await fetchAllLinkedInData([name], 1, 0);
        mergeLinkedInToWikiData();
        renderLinkedInCompanyDetail(name);
        renderLinkedInStats();
        populateLinkedInCompanySelect();
        computeLinkedInSignals(); // Refresh signals
    } finally {
        if (btn) btn.disabled = false;
    }
}

// Render hiring leaderboard with filters
function renderLinkedInHiringLeaderboard(filter = 'all') {
    const leaderboardEl = document.getElementById('linkedInHiringLeaderboard');
    if (!leaderboardEl) return;

    // Update filter button states
    document.querySelectorAll('.leaderboard-filter').forEach(btn => {
        const isActive = btn.dataset.filter === filter;
        btn.style.background = isActive ? 'rgba(212,168,75,0.2)' : 'var(--card)';
        btn.style.borderColor = isActive ? 'var(--gold)' : 'var(--border)';
        btn.style.color = isActive ? 'var(--gold)' : 'var(--dim)';
    });

    // Get companies with hiring data
    let companiesWithData = Object.entries(hiringData).map(([name, hiring]) => ({
        name,
        hiring,
        linkedIn: linkedInData[name] || null
    }));

    // Apply filter and sort
    switch (filter) {
        case 'hot':
            companiesWithData = companiesWithData
                .filter(c => c.hiring.trend === 'hot')
                .sort((a, b) => b.hiring.roles - a.hiring.roles);
            break;
        case 'growth':
            companiesWithData = companiesWithData
                .filter(c => c.hiring.growthRate > 0)
                .sort((a, b) => b.hiring.growthRate - a.hiring.growthRate);
            break;
        case 'salary':
            companiesWithData = companiesWithData
                .filter(c => c.hiring.avgSalary)
                .sort((a, b) => b.hiring.avgSalary - a.hiring.avgSalary);
            break;
        case 'equity':
            const equityOrder = { 'very-high': 4, 'high': 3, 'medium': 2, 'low': 1 };
            companiesWithData = companiesWithData
                .filter(c => c.hiring.equity)
                .sort((a, b) => (equityOrder[b.hiring.equity] || 0) - (equityOrder[a.hiring.equity] || 0) || b.hiring.roles - a.hiring.roles);
            break;
        default:
            companiesWithData = companiesWithData.sort((a, b) => b.hiring.roles - a.hiring.roles);
    }

    companiesWithData = companiesWithData.slice(0, 25);

    if (companiesWithData.length === 0) {
        leaderboardEl.innerHTML = `<div style="color: var(--dim); text-align: center; padding: 20px;">No data available for this filter.</div>`;
        return;
    }

    leaderboardEl.innerHTML = `
        <div style="display: grid; gap: 8px;">
            ${companiesWithData.map(({ name, hiring, linkedIn }, idx) => {
                const trendIcon = hiring.trend === 'hot' ? '' : hiring.trend === 'growing' ? '' : hiring.trend === 'declining' ? '' : '';
                const trendColor = hiring.trend === 'hot' ? '#ef4444' : hiring.trend === 'growing' ? '#22c55e' : hiring.trend === 'declining' ? '#f97316' : '#3b82f6';
                const equityStars = hiring.equity === 'very-high' ? '' : hiring.equity === 'high' ? '' : hiring.equity === 'medium' ? '' : '';
                const equityColor = hiring.equity === 'very-high' ? '#22c55e' : hiring.equity === 'high' ? '#3b82f6' : hiring.equity === 'medium' ? '#f97316' : '#6b7280';

                return `
                    <div onclick="renderLinkedInCompanyDetail('${name}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card); border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="width: 28px; height: 28px; background: ${idx < 3 ? 'linear-gradient(135deg, #f97316, #d4a84b)' : 'var(--border)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; color: ${idx < 3 ? 'white' : 'var(--dim)'};">${idx + 1}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-weight: 600; color: var(--text);">${name}</span>
                                <span style="font-size: 11px; background: rgba(${trendColor === '#ef4444' ? '239,68,68' : trendColor === '#22c55e' ? '34,197,94' : '59,130,246'},0.15); color: ${trendColor}; padding: 1px 6px; border-radius: 4px;">${trendIcon}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--dim);">${hiring.locations?.slice(0, 2).join(', ') || 'N/A'}</div>
                        </div>
                        <div style="text-align: right; min-width: 90px;">
                            <div style="font-size: 16px; font-weight: 700; color: ${trendColor};">${hiring.roles} roles</div>
                            <div style="font-size: 11px; color: var(--dim);">${hiring.hiringVelocity || 0}/week</div>
                        </div>
                        <div style="text-align: right; min-width: 70px; padding-left: 12px; border-left: 1px solid var(--border);">
                            <div style="font-size: 14px; font-weight: 600; color: #a855f7;">${hiring.avgSalary ? `$${hiring.avgSalary}K` : 'N/A'}</div>
                            <div style="font-size: 11px; color: ${equityColor};">${equityStars}</div>
                        </div>
                        <div style="text-align: right; min-width: 60px; padding-left: 12px; border-left: 1px solid var(--border);">
                            <div style="font-size: 14px; font-weight: 600; color: ${(hiring.growthRate || 0) > 20 ? '#22c55e' : (hiring.growthRate || 0) < 0 ? '#ef4444' : '#3b82f6'};">${hiring.growthRate ? `${hiring.growthRate > 0 ? '+' : ''}${hiring.growthRate}%` : 'N/A'}</div>
                            <div style="font-size: 10px; color: var(--dim);">growth</div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;

    // Also render the hiring signal summary
    renderHiringSignalSummary();
}

// Render hiring signal summary
function renderHiringSignalSummary() {
    const summaryEl = document.getElementById('hiringSignalSummary');
    if (!summaryEl) return;

    const allHiring = Object.entries(hiringData);
    const totalRoles = allHiring.reduce((sum, [_, h]) => sum + (h.roles || 0), 0);
    const hotCompanies = allHiring.filter(([_, h]) => h.trend === 'hot').length;
    const growingCompanies = allHiring.filter(([_, h]) => h.trend === 'growing').length;
    const avgGrowthRate = Math.round(allHiring.reduce((sum, [_, h]) => sum + (h.growthRate || 0), 0) / allHiring.length);
    const avgSalary = Math.round(allHiring.filter(([_, h]) => h.avgSalary).reduce((sum, [_, h]) => sum + h.avgSalary, 0) / allHiring.filter(([_, h]) => h.avgSalary).length);
    const veryHighEquity = allHiring.filter(([_, h]) => h.equity === 'very-high').length;

    summaryEl.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(212,168,75,0.1), rgba(212,168,75,0.05)); border: 1px solid rgba(212,168,75,0.3); border-radius: 12px; padding: 16px;">
            <h4 style="margin: 0 0 12px 0; color: var(--gold); font-size: 14px;">AI Industry Hiring Signals Summary</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px;">
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${totalRoles.toLocaleString()}</div>
                    <div style="font-size: 11px; color: var(--dim);">Total Open Roles</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #f97316;">${hotCompanies}</div>
                    <div style="font-size: 11px; color: var(--dim);"> Hot Companies</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${growingCompanies}</div>
                    <div style="font-size: 11px; color: var(--dim);"> Growing Companies</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${avgGrowthRate > 0 ? '+' : ''}${avgGrowthRate}%</div>
                    <div style="font-size: 11px; color: var(--dim);">Avg Growth Rate</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #a855f7;">$${avgSalary}K</div>
                    <div style="font-size: 11px; color: var(--dim);">Avg Salary</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #eab308;">${veryHighEquity}</div>
                    <div style="font-size: 11px; color: var(--dim);"> Top Equity</div>
                </div>
            </div>
        </div>
    `;
}

// Export hiring signals report
function exportHiringSignalsReport() {
    const report = Object.entries(hiringData).map(([name, h]) => ({
        company: name,
        openRoles: h.roles,
        trend: h.trend,
        locations: h.locations?.join('; '),
        techRoles: h.techRoles,
        dataRoles: h.dataRoles,
        mlRoles: h.mlRoles,
        avgSalaryK: h.avgSalary,
        equity: h.equity,
        growthRate: h.growthRate,
        hiringVelocity: h.hiringVelocity,
        currentEmployees: h.employeeHistory?.[4],
        recentHires: h.recentHires?.join('; '),
        updated: h.updated
    }));

    const headers = Object.keys(report[0]);
    const csv = [
        headers.join(','),
        ...report.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai_hiring_signals_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Export LinkedIn data
function exportLinkedInData(format) {
    const data = Object.entries(linkedInData).map(([name, d]) => ({
        company: name,
        linkedInName: d.name,
        employees: d.employees,
        employeeCount: d.employeeCount,
        followers: d.followers,
        industry: d.industry,
        founded: d.founded,
        hq: d.hq,
        linkedinUrl: d.linkedinUrl,
        lastUpdated: d.lastUpdated
    }));

    if (format === 'json') {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `linkedin_data_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    } else if (format === 'csv') {
        const headers = ['company', 'linkedInName', 'employees', 'employeeCount', 'followers', 'industry', 'founded', 'hq', 'linkedinUrl', 'lastUpdated'];
        const csv = [
            headers.join(','),
            ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `linkedin_data_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }
}

// ==================== LINKEDIN SIGNALS INTELLIGENCE ====================

// Signal tab switching
function showSignalTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.signal-tab').forEach(btn => {
        const isActive = btn.dataset.tab === tab;
        btn.style.background = isActive ? 'rgba(212,168,75,0.2)' : 'var(--card)';
        btn.style.border = isActive ? '1px solid var(--gold)' : '1px solid var(--border)';
        btn.style.borderBottom = 'none';
        btn.style.color = isActive ? 'var(--gold)' : 'var(--dim)';
        btn.style.fontWeight = isActive ? '600' : 'normal';
        if (isActive) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    // Show/hide panels
    document.querySelectorAll('.signal-panel').forEach(panel => {
        panel.style.display = 'none';
    });
    const targetPanel = document.getElementById(`signalPanel${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
    if (targetPanel) targetPanel.style.display = 'block';
}

// Main signal computation
function computeLinkedInSignals() {
    console.log('[Signals] Computing LinkedIn signals...');

    // Gather all data sources
    const linkedInEntries = Object.entries(linkedInData);
    const hiringEntries = Object.entries(hiringData);
    const allCompanies = companies || [];

    // Calculate aggregated metrics
    const signals = {
        momentum: calculateMomentumScore(linkedInEntries, hiringEntries),
        velocity: calculateHiringVelocity(hiringEntries),
        sentiment: calculateSentiment(linkedInEntries, hiringEntries, allCompanies),
        hotCompanies: identifyHotCompanies(hiringEntries),
        growthLeaders: identifyGrowthLeaders(linkedInEntries, hiringEntries),
        departmentTrends: calculateDepartmentTrends(hiringEntries),
        alerts: generateSignalAlerts(linkedInEntries, hiringEntries)
    };

    // Update summary cards
    updateSignalSummaryCards(signals);

    // Render each panel
    renderMomentumPanel(signals);
    renderSentimentPanel(signals);
    renderGrowthPanel(signals);
    renderDepartmentsPanel(signals);
    renderAlertsPanel(signals);

    console.log('[Signals] Computation complete', signals);
    return signals;
}

// Calculate market momentum score (0-100)
function calculateMomentumScore(linkedInEntries, hiringEntries) {
    if (hiringEntries.length === 0) return { score: 0, label: 'No data', trend: 'neutral' };

    let totalScore = 0;
    let count = 0;

    for (const [name, hiring] of hiringEntries) {
        let companyScore = 50; // Base score

        // Hiring trend contribution
        if (hiring.trend === 'hot') companyScore += 30;
        else if (hiring.trend === 'growing') companyScore += 15;
        else if (hiring.trend === 'stable') companyScore += 0;
        else if (hiring.trend === 'declining') companyScore -= 20;

        // Growth rate contribution
        if (hiring.growthRate > 50) companyScore += 20;
        else if (hiring.growthRate > 20) companyScore += 10;
        else if (hiring.growthRate > 0) companyScore += 5;
        else if (hiring.growthRate < 0) companyScore -= 10;

        // Role count contribution
        if (hiring.roles > 50) companyScore += 10;
        else if (hiring.roles > 20) companyScore += 5;

        totalScore += Math.max(0, Math.min(100, companyScore));
        count++;
    }

    const avgScore = Math.round(totalScore / count);
    let label, trend;

    if (avgScore >= 75) { label = 'Very Bullish'; trend = 'up'; }
    else if (avgScore >= 60) { label = 'Bullish'; trend = 'up'; }
    else if (avgScore >= 45) { label = 'Neutral'; trend = 'neutral'; }
    else if (avgScore >= 30) { label = 'Bearish'; trend = 'down'; }
    else { label = 'Very Bearish'; trend = 'down'; }

    return { score: avgScore, label, trend };
}

// Calculate hiring velocity (roles per month across all companies)
function calculateHiringVelocity(hiringEntries) {
    if (hiringEntries.length === 0) return { value: 0, trend: 'neutral', companies: 0 };

    let totalRoles = 0;
    let activeCompanies = 0;

    for (const [name, hiring] of hiringEntries) {
        if (hiring.roles && hiring.roles > 0) {
            totalRoles += hiring.roles;
            activeCompanies++;
        }
    }

    // Assume roles are per month for current state
    const velocity = totalRoles;
    let trend = 'neutral';
    if (velocity > 500) trend = 'very-high';
    else if (velocity > 200) trend = 'high';
    else if (velocity > 50) trend = 'medium';

    return { value: velocity, trend, companies: activeCompanies };
}

// Calculate overall sentiment
function calculateSentiment(linkedInEntries, hiringEntries, allCompanies) {
    const signals = {
        positive: 0,
        neutral: 0,
        negative: 0,
        factors: []
    };

    // Analyze hiring trends
    const hotCount = hiringEntries.filter(([_, h]) => h.trend === 'hot').length;
    const growingCount = hiringEntries.filter(([_, h]) => h.trend === 'growing').length;
    const decliningCount = hiringEntries.filter(([_, h]) => h.trend === 'declining').length;

    if (hotCount > hiringEntries.length * 0.3) {
        signals.positive += 2;
        signals.factors.push({ type: 'positive', text: `${hotCount} companies in hot hiring mode` });
    }
    if (growingCount > hiringEntries.length * 0.4) {
        signals.positive += 1;
        signals.factors.push({ type: 'positive', text: `${growingCount} companies showing growth` });
    }
    if (decliningCount > hiringEntries.length * 0.2) {
        signals.negative += 1;
        signals.factors.push({ type: 'negative', text: `${decliningCount} companies with declining hiring` });
    }

    // Analyze funding (if available in companies data)
    const recentFunding = allCompanies.filter(c => {
        const funding = c.totalFunding || c.funding || '';
        return funding && funding.includes('B') || (funding.includes('M') && parseInt(funding) > 100);
    }).length;

    if (recentFunding > 10) {
        signals.positive += 1;
        signals.factors.push({ type: 'positive', text: `${recentFunding} well-funded companies` });
    }

    // Calculate overall sentiment
    const totalPositive = signals.positive;
    const totalNegative = signals.negative;

    let sentiment, label;
    if (totalPositive > totalNegative + 2) { sentiment = 'Bullish'; label = 'Strong positive signals'; }
    else if (totalPositive > totalNegative) { sentiment = 'Positive'; label = 'More positive than negative'; }
    else if (totalNegative > totalPositive + 2) { sentiment = 'Bearish'; label = 'Concerning signals'; }
    else if (totalNegative > totalPositive) { sentiment = 'Cautious'; label = 'Some concerns noted'; }
    else { sentiment = 'Mixed'; label = 'Balanced signals'; }

    return { sentiment, label, factors: signals.factors };
}

// Identify hot companies (aggressive hiring)
function identifyHotCompanies(hiringEntries) {
    return hiringEntries
        .filter(([_, h]) => h.trend === 'hot' || (h.roles && h.roles > 30))
        .map(([name, h]) => ({
            name,
            roles: h.roles || 0,
            trend: h.trend,
            growthRate: h.growthRate || 0,
            departments: h.departments || {}
        }))
        .sort((a, b) => b.roles - a.roles)
        .slice(0, 20);
}

// Identify growth leaders
function identifyGrowthLeaders(linkedInEntries, hiringEntries) {
    const leaders = [];

    for (const [name, hiring] of hiringEntries) {
        const linkedIn = linkedInData[name];
        const growthScore = (hiring.growthRate || 0) + (hiring.roles || 0) / 10;

        if (growthScore > 10) {
            leaders.push({
                name,
                growthRate: hiring.growthRate || 0,
                roles: hiring.roles || 0,
                employees: linkedIn?.employees || hiring.employeeCount || 'Unknown',
                followers: linkedIn?.followers || 0,
                trend: hiring.trend,
                score: Math.round(growthScore)
            });
        }
    }

    return leaders.sort((a, b) => b.score - a.score).slice(0, 15);
}

// Calculate department trends
function calculateDepartmentTrends(hiringEntries) {
    const deptTotals = {};
    const deptCompanies = {};

    for (const [name, hiring] of hiringEntries) {
        if (hiring.departments) {
            for (const [dept, count] of Object.entries(hiring.departments)) {
                const normalizedDept = normalizeDepartmentName(dept);
                deptTotals[normalizedDept] = (deptTotals[normalizedDept] || 0) + count;
                deptCompanies[normalizedDept] = (deptCompanies[normalizedDept] || 0) + 1;
            }
        }
    }

    return Object.entries(deptTotals)
        .map(([dept, count]) => ({
            department: dept,
            totalRoles: count,
            companies: deptCompanies[dept],
            avgPerCompany: Math.round(count / deptCompanies[dept] * 10) / 10
        }))
        .sort((a, b) => b.totalRoles - a.totalRoles);
}

// Normalize department names for aggregation
function normalizeDepartmentName(dept) {
    const deptLower = dept.toLowerCase();
    if (deptLower.includes('engineer') || deptLower.includes('develop')) return 'Engineering';
    if (deptLower.includes('sales') || deptLower.includes('account exec')) return 'Sales';
    if (deptLower.includes('market') || deptLower.includes('growth')) return 'Marketing';
    if (deptLower.includes('product')) return 'Product';
    if (deptLower.includes('design') || deptLower.includes('ux')) return 'Design';
    if (deptLower.includes('data') || deptLower.includes('ml') || deptLower.includes('machine')) return 'Data/ML';
    if (deptLower.includes('ops') || deptLower.includes('operation')) return 'Operations';
    if (deptLower.includes('finance') || deptLower.includes('account')) return 'Finance';
    if (deptLower.includes('hr') || deptLower.includes('people') || deptLower.includes('recruit')) return 'People/HR';
    if (deptLower.includes('customer') || deptLower.includes('support') || deptLower.includes('success')) return 'Customer Success';
    if (deptLower.includes('legal')) return 'Legal';
    if (deptLower.includes('research') || deptLower.includes('ai')) return 'Research/AI';
    return dept;
}

// Generate signal alerts
function generateSignalAlerts(linkedInEntries, hiringEntries) {
    const alerts = [];

    // Check for companies with sudden hiring spikes
    for (const [name, hiring] of hiringEntries) {
        if (hiring.growthRate > 100) {
            alerts.push({
                type: 'spike',
                severity: 'high',
                company: name,
                message: `${name} has ${hiring.growthRate}% hiring growth - potential rapid expansion`,
                icon: ''
            });
        }
        if (hiring.trend === 'hot' && hiring.roles > 50) {
            alerts.push({
                type: 'hot',
                severity: 'medium',
                company: name,
                message: `${name} is aggressively hiring with ${hiring.roles}+ open roles`,
                icon: ''
            });
        }
        if (hiring.trend === 'declining' && hiring.roles < 5) {
            alerts.push({
                type: 'decline',
                severity: 'low',
                company: name,
                message: `${name} showing reduced hiring activity`,
                icon: ''
            });
        }
    }

    // Check for large employee counts with high follower engagement
    for (const [name, data] of linkedInEntries) {
        if (data.followers > 100000) {
            alerts.push({
                type: 'influence',
                severity: 'info',
                company: name,
                message: `${name} has ${(data.followers/1000).toFixed(0)}K LinkedIn followers - strong brand presence`,
                icon: ''
            });
        }
    }

    // Sort by severity
    const severityOrder = { high: 0, medium: 1, low: 2, info: 3 };
    return alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]).slice(0, 20);
}

// Update summary cards
function updateSignalSummaryCards(signals) {
    // Momentum
    const momentumEl = document.getElementById('signalMomentum');
    const momentumLabelEl = document.getElementById('signalMomentumLabel');
    if (momentumEl) {
        momentumEl.textContent = signals.momentum.score;
        momentumEl.style.color = signals.momentum.trend === 'up' ? '#22c55e' :
                                  signals.momentum.trend === 'down' ? '#ef4444' : 'var(--gold)';
    }
    if (momentumLabelEl) momentumLabelEl.textContent = signals.momentum.label;

    // Velocity
    const velocityEl = document.getElementById('signalVelocity');
    const velocityLabelEl = document.getElementById('signalVelocityLabel');
    if (velocityEl) velocityEl.textContent = signals.velocity.value.toLocaleString();
    if (velocityLabelEl) velocityLabelEl.textContent = `${signals.velocity.companies} companies hiring`;

    // Sentiment
    const sentimentEl = document.getElementById('signalSentiment');
    const sentimentLabelEl = document.getElementById('signalSentimentLabel');
    if (sentimentEl) {
        sentimentEl.textContent = signals.sentiment.sentiment;
        sentimentEl.style.color = signals.sentiment.sentiment === 'Bullish' ? '#22c55e' :
                                   signals.sentiment.sentiment === 'Positive' ? '#22c55e' :
                                   signals.sentiment.sentiment === 'Bearish' ? '#ef4444' :
                                   signals.sentiment.sentiment === 'Cautious' ? '#f59e0b' : '#3b82f6';
    }
    if (sentimentLabelEl) sentimentLabelEl.textContent = signals.sentiment.label;

    // Hot count
    const hotCountEl = document.getElementById('signalHotCount');
    const hotLabelEl = document.getElementById('signalHotLabel');
    if (hotCountEl) hotCountEl.textContent = signals.hotCompanies.length;
    if (hotLabelEl) hotLabelEl.textContent = 'Aggressive hiring';

    // Company count
    const countEl = document.getElementById('signalsCompanyCount');
    if (countEl) {
        const total = Object.keys(hiringData).length;
        countEl.textContent = `${total} companies`;
    }
}

// Render momentum panel
function renderMomentumPanel(signals) {
    const content = document.getElementById('momentumContent');
    if (!content) return;

    const topHiring = signals.hotCompanies.slice(0, 10);

    content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
                <h5 style="margin: 0 0 12px 0; color: var(--text); font-size: 13px;">Market Momentum Score</h5>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(${signals.momentum.trend === 'up' ? '#22c55e' : signals.momentum.trend === 'down' ? '#ef4444' : 'var(--gold)'} ${signals.momentum.score}%, var(--border) 0); display: flex; align-items: center; justify-content: center;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--card); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: var(--text);">${signals.momentum.score}</div>
                    </div>
                    <div>
                        <div style="font-size: 16px; font-weight: 600; color: ${signals.momentum.trend === 'up' ? '#22c55e' : signals.momentum.trend === 'down' ? '#ef4444' : 'var(--text)'};">${signals.momentum.label}</div>
                        <div style="color: var(--dim); font-size: 12px;">Based on ${Object.keys(hiringData).length} companies</div>
                    </div>
                </div>

                <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">Hiring Velocity</h5>
                <div style="color: var(--dim); font-size: 13px; line-height: 1.6;">
                    <span style="color: #22c55e; font-weight: 600;">${signals.velocity.value.toLocaleString()}</span> open roles across
                    <span style="color: var(--text); font-weight: 600;">${signals.velocity.companies}</span> actively hiring companies
                </div>
            </div>

            <div>
                <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">Top Hiring Companies</h5>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${topHiring.map((c, i) => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--dim); font-size: 11px; width: 20px;">#${i + 1}</span>
                            ${renderLogo(c.name, 24)}
                            <span style="flex: 1; color: var(--text); font-size: 12px;">${c.name}</span>
                            <span style="color: #22c55e; font-size: 12px; font-weight: 600;">${c.roles} roles</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// Render sentiment panel
function renderSentimentPanel(signals) {
    const content = document.getElementById('sentimentContent');
    if (!content) return;

    content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
                <h5 style="margin: 0 0 12px 0; color: var(--text); font-size: 13px;">Overall Market Sentiment</h5>
                <div style="padding: 16px; background: ${signals.sentiment.sentiment === 'Bullish' || signals.sentiment.sentiment === 'Positive' ? 'rgba(34,197,94,0.1)' : signals.sentiment.sentiment === 'Bearish' || signals.sentiment.sentiment === 'Cautious' ? 'rgba(239,68,68,0.1)' : 'rgba(59,130,246,0.1)'}; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 24px; font-weight: 700; color: ${signals.sentiment.sentiment === 'Bullish' || signals.sentiment.sentiment === 'Positive' ? '#22c55e' : signals.sentiment.sentiment === 'Bearish' || signals.sentiment.sentiment === 'Cautious' ? '#ef4444' : '#3b82f6'};">${signals.sentiment.sentiment}</div>
                    <div style="color: var(--dim); font-size: 12px;">${signals.sentiment.label}</div>
                </div>
            </div>

            <div>
                <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">Key Factors</h5>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${signals.sentiment.factors.length > 0 ? signals.sentiment.factors.map(f => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${f.type === 'positive' ? 'rgba(34,197,94,0.1)' : f.type === 'negative' ? 'rgba(239,68,68,0.1)' : 'rgba(59,130,246,0.1)'}; border-radius: 6px;">
                            <span style="font-size: 14px;">${f.type === 'positive' ? '' : f.type === 'negative' ? '' : ''}</span>
                            <span style="color: var(--text); font-size: 12px;">${f.text}</span>
                        </div>
                    `).join('') : '<div style="color: var(--dim); font-size: 12px;">Load data to see sentiment factors</div>'}
                </div>
            </div>
        </div>
    `;
}

// Render growth leaders panel
function renderGrowthPanel(signals) {
    const content = document.getElementById('growthContent');
    if (!content) return;

    if (signals.growthLeaders.length === 0) {
        content.innerHTML = '<p style="margin: 0; color: var(--dim);">Load LinkedIn data to see growth leaders.</p>';
        return;
    }

    content.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border);">
                        <th style="text-align: left; padding: 8px 12px; color: var(--dim); font-weight: 600;">Rank</th>
                        <th style="text-align: left; padding: 8px 12px; color: var(--dim); font-weight: 600;">Company</th>
                        <th style="text-align: center; padding: 8px 12px; color: var(--dim); font-weight: 600;">Growth Rate</th>
                        <th style="text-align: center; padding: 8px 12px; color: var(--dim); font-weight: 600;">Open Roles</th>
                        <th style="text-align: center; padding: 8px 12px; color: var(--dim); font-weight: 600;">Employees</th>
                        <th style="text-align: center; padding: 8px 12px; color: var(--dim); font-weight: 600;">Trend</th>
                        <th style="text-align: center; padding: 8px 12px; color: var(--dim); font-weight: 600;">Score</th>
                    </tr>
                </thead>
                <tbody>
                    ${signals.growthLeaders.map((c, i) => `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 12px; color: var(--dim);">#${i + 1}</td>
                            <td style="padding: 10px 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${renderLogo(c.name, 28)}
                                    <span style="color: var(--text); font-weight: 500;">${c.name}</span>
                                </div>
                            </td>
                            <td style="padding: 10px 12px; text-align: center; color: #22c55e; font-weight: 600;">+${c.growthRate}%</td>
                            <td style="padding: 10px 12px; text-align: center; color: var(--text);">${c.roles}</td>
                            <td style="padding: 10px 12px; text-align: center; color: var(--dim);">${c.employees}</td>
                            <td style="padding: 10px 12px; text-align: center;">${getTrendBadgeHTML(c.trend)}</td>
                            <td style="padding: 10px 12px; text-align: center; color: var(--gold); font-weight: 700;">${c.score}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Render departments panel
function renderDepartmentsPanel(signals) {
    const content = document.getElementById('departmentsContent');
    if (!content) return;

    if (signals.departmentTrends.length === 0) {
        content.innerHTML = '<p style="margin: 0; color: var(--dim);">Load hiring data to see department breakdown.</p>';
        return;
    }

    const maxRoles = Math.max(...signals.departmentTrends.map(d => d.totalRoles));

    content.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h5 style="margin: 0 0 12px 0; color: var(--text); font-size: 13px;">Hiring by Department</h5>
                ${signals.departmentTrends.slice(0, 10).map(d => `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="color: var(--text); font-size: 12px;">${d.department}</span>
                            <span style="color: var(--dim); font-size: 11px;">${d.totalRoles} roles (${d.companies} companies)</span>
                        </div>
                        <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${(d.totalRoles / maxRoles * 100)}%; background: linear-gradient(90deg, #3b82f6, #22c55e); border-radius: 4px;"></div>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div>
                <h5 style="margin: 0 0 12px 0; color: var(--text); font-size: 13px;">Department Distribution</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${signals.departmentTrends.slice(0, 8).map((d, i) => {
                        const colors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                        const pct = Math.round(d.totalRoles / signals.departmentTrends.reduce((a, b) => a + b.totalRoles, 0) * 100);
                        return `
                            <div style="padding: 8px 12px; background: ${colors[i]}20; border: 1px solid ${colors[i]}40; border-radius: 6px;">
                                <div style="color: ${colors[i]}; font-weight: 600; font-size: 14px;">${pct}%</div>
                                <div style="color: var(--dim); font-size: 10px;">${d.department}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
}

// Render alerts panel
function renderAlertsPanel(signals) {
    const content = document.getElementById('alertsContent');
    if (!content) return;

    if (signals.alerts.length === 0) {
        content.innerHTML = '<p style="margin: 0; color: var(--dim);">No alerts at this time. Load more data to see signals.</p>';
        return;
    }

    const severityColors = {
        high: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#ef4444' },
        medium: { bg: 'rgba(245,158,11,0.1)', border: 'rgba(245,158,11,0.3)', text: '#f59e0b' },
        low: { bg: 'rgba(59,130,246,0.1)', border: 'rgba(59,130,246,0.3)', text: '#3b82f6' },
        info: { bg: 'rgba(107,114,128,0.1)', border: 'rgba(107,114,128,0.3)', text: '#6b7280' }
    };

    content.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
            ${signals.alerts.map(alert => {
                const colors = severityColors[alert.severity];
                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: ${colors.bg}; border: 1px solid ${colors.border}; border-radius: 8px;">
                        <span style="font-size: 18px;">${alert.icon}</span>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="color: var(--text); font-weight: 600; font-size: 13px;">${alert.company}</span>
                                <span style="font-size: 10px; padding: 2px 6px; background: ${colors.border}; color: ${colors.text}; border-radius: 4px; text-transform: uppercase;">${alert.severity}</span>
                            </div>
                            <div style="color: var(--dim); font-size: 12px;">${alert.message}</div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Render company detail with enhanced hiring signals
function renderLinkedInCompanyDetail(name) {
    const detailEl = document.getElementById('linkedInCompanyDetail');
    if (!detailEl) return;

    const data = linkedInData[name];
    const hiring = hiringData[name];

    if (!data && !hiring) {
        detailEl.innerHTML = `<div style="color: var(--dim); text-align: center; padding: 20px;">No LinkedIn data for ${name}. Try fetching or use Demo Mode.</div>`;
        return;
    }

    // Calculate employee growth chart if we have history
    const growthChart = hiring?.employeeHistory ? renderEmployeeGrowthChart(hiring.employeeHistory) : '';

    // Department breakdown
    const deptBreakdown = hiring?.departments ? renderDepartmentBreakdown(hiring.departments) : '';

    // Trend badge
    const trendBadge = hiring?.trend ? getTrendBadgeHTML(hiring.trend) : '';

    // Equity indicator
    const equityBadge = hiring?.equity ? getEquityBadgeHTML(hiring.equity) : '';

    detailEl.innerHTML = `
        <div style="background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
            <!-- Header -->
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                ${data?.logoUrl ? `<img src="${data.logoUrl}" style="width: 64px; height: 64px; border-radius: 8px;" />` :
                    `<div style="width: 64px; height: 64px; border-radius: 8px; background: linear-gradient(135deg, #0077b5, #00a0dc); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">${name.charAt(0)}</div>`}
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <h3 style="margin: 0; color: var(--text);">${data?.name || name}</h3>
                        ${trendBadge}
                        ${equityBadge}
                        ${data?.isSimulated ? '<span style="font-size: 10px; background: rgba(168,85,247,0.2); color: #a855f7; padding: 2px 6px; border-radius: 4px;">DEMO</span>' : ''}
                    </div>
                    <a href="${data?.linkedinUrl || `https://linkedin.com/company/${name.toLowerCase().replace(/\s+/g, '-')}`}" target="_blank" style="color: #0077b5; font-size: 13px;">View on LinkedIn </a>
                </div>
            </div>

            <!-- Key Metrics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 16px;">
                <div style="background: rgba(0,119,181,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Followers</div>
                    <div style="font-size: 18px; font-weight: 700; color: #0077b5;">${(data?.followers || 0).toLocaleString()}</div>
                </div>
                <div style="background: rgba(34,197,94,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Employees</div>
                    <div style="font-size: 18px; font-weight: 700; color: #22c55e;">${data?.employees || hiring?.employeeHistory?.[4]?.toLocaleString() || 'N/A'}</div>
                </div>
                <div style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Open Roles</div>
                    <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${hiring?.roles || 'N/A'}</div>
                </div>
                <div style="background: rgba(249,115,22,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Growth Rate</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${(hiring?.growthRate || 0) > 0 ? '#22c55e' : '#ef4444'};">${hiring?.growthRate ? `${hiring.growthRate > 0 ? '+' : ''}${hiring.growthRate}%` : 'N/A'}</div>
                </div>
                <div style="background: rgba(168,85,247,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Avg Salary</div>
                    <div style="font-size: 18px; font-weight: 700; color: #a855f7;">${hiring?.avgSalary ? `$${hiring.avgSalary}K` : 'N/A'}</div>
                </div>
                <div style="background: rgba(59,130,246,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: var(--dim); text-transform: uppercase;">Hiring/Week</div>
                    <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">${hiring?.hiringVelocity || 'N/A'}</div>
                </div>
            </div>

            <!-- Employee Growth Chart -->
            ${growthChart}

            <!-- Role Breakdown -->
            ${hiring ? `
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Role Breakdown</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <div style="background: rgba(59,130,246,0.15); padding: 8px 12px; border-radius: 6px;">
                        <span style="color: #3b82f6; font-weight: 600;">${hiring.techRoles || 0}</span>
                        <span style="color: var(--dim); font-size: 12px;"> Tech</span>
                    </div>
                    <div style="background: rgba(34,197,94,0.15); padding: 8px 12px; border-radius: 6px;">
                        <span style="color: #22c55e; font-weight: 600;">${hiring.dataRoles || 0}</span>
                        <span style="color: var(--dim); font-size: 12px;"> Data</span>
                    </div>
                    <div style="background: rgba(168,85,247,0.15); padding: 8px 12px; border-radius: 6px;">
                        <span style="color: #a855f7; font-weight: 600;">${hiring.mlRoles || 0}</span>
                        <span style="color: var(--dim); font-size: 12px;"> ML/AI</span>
                    </div>
                </div>
            </div>
            ` : ''}

            <!-- Department Breakdown -->
            ${deptBreakdown}

            <!-- Locations -->
            ${hiring?.locations?.length ? `
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Hiring Locations</div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    ${hiring.locations.map(loc => `<span style="background: var(--border); padding: 4px 10px; border-radius: 12px; font-size: 12px;"> ${loc}</span>`).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Recent Notable Hires -->
            ${hiring?.recentHires?.length ? `
            <div style="margin-bottom: 16px;">
                <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Recent Notable Hires</div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    ${hiring.recentHires.map(hire => `<span style="background: rgba(212,168,75,0.15); border: 1px solid rgba(212,168,75,0.3); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--gold);"> ${hire}</span>`).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Specialties -->
            ${data?.specialties?.length ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Specialties</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${data.specialties.map(s => `<span style="background: var(--border); padding: 4px 10px; border-radius: 12px; font-size: 12px;">${s}</span>`).join('')}
                    </div>
                </div>
            ` : ''}

            <div style="font-size: 11px; color: var(--dim); border-top: 1px solid var(--border); padding-top: 12px; margin-top: 8px;">
                Last updated: ${data?.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : hiring?.updated || 'N/A'}
            </div>
        </div>
    `;
}

// Render employee growth mini-chart
function renderEmployeeGrowthChart(history) {
    if (!history || history.length < 2) return '';

    const max = Math.max(...history);
    const min = Math.min(...history);
    const range = max - min || 1;
    const quarters = ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024', 'Q1 2025'];

    return `
        <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Employee Growth (Last 5 Quarters)</div>
            <div style="display: flex; align-items: flex-end; gap: 4px; height: 60px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                ${history.map((val, i) => {
                    const height = ((val - min) / range) * 50 + 10;
                    const isLast = i === history.length - 1;
                    return `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <div style="font-size: 9px; color: ${isLast ? '#22c55e' : 'var(--dim)'};">${val >= 1000 ? (val/1000).toFixed(1) + 'K' : val}</div>
                            <div style="width: 100%; height: ${height}px; background: ${isLast ? 'linear-gradient(180deg, #22c55e, #16a34a)' : 'linear-gradient(180deg, #3b82f6, #2563eb)'}; border-radius: 4px 4px 0 0;"></div>
                            <div style="font-size: 8px; color: var(--dim);">${quarters[i]?.split(' ')[0] || ''}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

// Render department breakdown
function renderDepartmentBreakdown(departments) {
    if (!departments || Object.keys(departments).length === 0) return '';

    const total = Object.values(departments).reduce((a, b) => a + b, 0);
    const colors = {
        engineering: '#3b82f6',
        research: '#a855f7',
        product: '#22c55e',
        sales: '#f97316',
        support: '#6b7280',
        operations: '#14b8a6',
        data: '#ec4899',
        devrel: '#eab308',
        hardware: '#ef4444',
        robotics: '#06b6d4',
        clinical: '#10b981',
        legal: '#8b5cf6',
        safety: '#f59e0b',
        forward_deployed: '#6366f1',
        infrastructure: '#0ea5e9',
        manufacturing: '#84cc16',
        community: '#f472b6',
        design: '#c084fc',
        finance: '#22d3ee',
        marketing: '#fb923c',
        pathology: '#2dd4bf'
    };

    return `
        <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--dim); margin-bottom: 8px; text-transform: uppercase;">Open Roles by Department</div>
            <div style="display: flex; height: 24px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                ${Object.entries(departments).map(([dept, count]) => {
                    const pct = (count / total) * 100;
                    const color = colors[dept] || '#6b7280';
                    return `<div style="width: ${pct}%; background: ${color};" title="${dept}: ${count} roles"></div>`;
                }).join('')}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${Object.entries(departments).map(([dept, count]) => {
                    const color = colors[dept] || '#6b7280';
                    const label = dept.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `<div style="display: flex; align-items: center; gap: 4px; font-size: 11px;">
                        <div style="width: 8px; height: 8px; border-radius: 2px; background: ${color};"></div>
                        <span style="color: var(--dim);">${label}:</span>
                        <span style="color: var(--text); font-weight: 600;">${count}</span>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `;
}

// Get trend badge HTML
function getTrendBadgeHTML(trend) {
    const badges = {
        hot: { icon: '', color: '#ef4444', bg: 'rgba(239,68,68,0.15)', label: 'Hot' },
        growing: { icon: '', color: '#22c55e', bg: 'rgba(34,197,94,0.15)', label: 'Growing' },
        stable: { icon: '', color: '#3b82f6', bg: 'rgba(59,130,246,0.15)', label: 'Stable' },
        declining: { icon: '', color: '#f97316', bg: 'rgba(249,115,22,0.15)', label: 'Declining' }
    };
    const b = badges[trend] || badges.stable;
    return `<span style="font-size: 11px; background: ${b.bg}; color: ${b.color}; padding: 2px 8px; border-radius: 4px;">${b.icon} ${b.label}</span>`;
}

// Get equity badge HTML
function getEquityBadgeHTML(equity) {
    const badges = {
        'very-high': { color: '#22c55e', bg: 'rgba(34,197,94,0.15)', label: 'Equity ' },
        'high': { color: '#3b82f6', bg: 'rgba(59,130,246,0.15)', label: 'Equity ' },
        'medium': { color: '#f97316', bg: 'rgba(249,115,22,0.15)', label: 'Equity ' },
        'low': { color: '#6b7280', bg: 'rgba(107,114,128,0.15)', label: 'Equity ' }
    };
    const b = badges[equity] || badges.medium;
    return `<span style="font-size: 11px; background: ${b.bg}; color: ${b.color}; padding: 2px 8px; border-radius: 4px;">${b.label}</span>`;
}

// ==================== LINKEDIN DATA SIMULATION (Demo Mode) ====================
// Generates realistic LinkedIn data based on hiringData when API isn't available

function generateSimulatedLinkedInData(companyName) {
    const hiring = hiringData[companyName];
    const company = companies.find(c => c.name === companyName);
    if (!hiring && !company) return null;

    const employeeCount = hiring?.employeeHistory?.[4] ||
        (company?.employees ? parseInt(company.employees.replace(/[^\d]/g, '')) || 500 : 500);

    // Generate follower count based on company characteristics
    const categoryMultiplier = {
        'Foundation Models': 3.5,
        'Developer Tools': 2.5,
        'Enterprise AI': 2.0,
        'Consumer AI': 2.8,
        'Creative AI': 2.2,
        'FinTech AI': 1.8,
        'Healthcare AI': 1.5,
        'Security': 1.6,
        'AI Agents': 2.0,
        'Infrastructure': 1.8
    };
    const mult = categoryMultiplier[company?.category] || 1.5;
    const followers = Math.round(employeeCount * mult * (0.8 + Math.random() * 0.4) * 100);

    // Employee range string
    let empRange = '51-200';
    if (employeeCount > 10000) empRange = '10001+';
    else if (employeeCount > 5000) empRange = '5001-10000';
    else if (employeeCount > 1000) empRange = '1001-5000';
    else if (employeeCount > 500) empRange = '501-1000';
    else if (employeeCount > 200) empRange = '201-500';
    else if (employeeCount > 50) empRange = '51-200';
    else if (employeeCount > 10) empRange = '11-50';
    else empRange = '1-10';

    return {
        name: companyName,
        employees: empRange,
        employeeCount: employeeCount,
        followers: followers,
        industry: company?.category || 'Artificial Intelligence',
        founded: company?.founded || (2015 + Math.floor(Math.random() * 8)),
        hq: hiring?.locations?.[0] || company?.hq || 'San Francisco, CA',
        linkedinUrl: `https://linkedin.com/company/${companyName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`,
        specialties: company?.secretSauce?.split(',').map(s => s.trim()).slice(0, 5) || ['Artificial Intelligence', 'Machine Learning'],
        lastUpdated: new Date().toISOString(),
        isSimulated: true
    };
}

// Populate LinkedIn data with simulated data for demo
function populateSimulatedLinkedInData() {
    const allCompanies = getAllCompanyNames();
    let populated = 0;

    for (const name of allCompanies) {
        if (!linkedInData[name]) {
            const simData = generateSimulatedLinkedInData(name);
            if (simData) {
                linkedInData[name] = simData;
                populated++;
            }
        }
    }

    console.log(`[LinkedIn] Populated ${populated} companies with simulated data`);
    saveLinkedInDataToStorage();
    renderLinkedInStats();
    populateLinkedInCompanySelect();
    renderLinkedInHiringLeaderboard();
    computeLinkedInSignals(); // Refresh signals with demo data
    return populated;
}

// ==================== GOOGLE SHEETS INTEGRATION ====================
// Two-way sync for job listings & open roles

const SHEETS_CONFIG = {
    sheetId: localStorage.getItem('aibook_sheets_id') || '1cjhdr8rhvwfdKp7xLtklD2cQLWMHC4C7JeA2tViQWWo',
    sheetName: 'Sheet1',
    lastSync: localStorage.getItem('aibook_sheets_lastsync') || null
};

// Job listings stored locally (synced with Google Sheets)
let jobListings = JSON.parse(localStorage.getItem('aibook_job_listings') || '[]');

// Save sheet config
function saveSheetConfig() {
    localStorage.setItem('aibook_sheets_id', SHEETS_CONFIG.sheetId);
    localStorage.setItem('aibook_sheets_lastsync', SHEETS_CONFIG.lastSync);
    localStorage.setItem('aibook_job_listings', JSON.stringify(jobListings));
}

// Parse Google Sheet ID from URL or ID
function parseSheetId(input) {
    if (!input) return '';
    // If it's a full URL, extract the ID
    const match = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if (match) return match[1];
    // Otherwise assume it's already an ID
    return input.trim();
}

// Fetch data from public Google Sheet
async function fetchFromGoogleSheet() {
    if (!SHEETS_CONFIG.sheetId) {
        alert('Please enter a Google Sheet ID first');
        return null;
    }

    const sheetId = parseSheetId(SHEETS_CONFIG.sheetId);
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEETS_CONFIG.sheetName)}`;

    try {
        updateSyncStatus('syncing', 'Fetching from Google Sheets...');

        const response = await fetch(url);
        const text = await response.text();

        // Parse the JSONP response
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
        if (!jsonMatch) {
            throw new Error('Invalid response format. Make sure the sheet is public.');
        }

        const data = JSON.parse(jsonMatch[1]);

        if (data.status === 'error') {
            throw new Error(data.errors?.[0]?.message || 'Failed to fetch sheet');
        }

        // Parse the table data
        const cols = data.table.cols.map(c => c.label || c.id);
        const rows = data.table.rows.map(row => {
            const obj = {};
            row.c.forEach((cell, i) => {
                obj[cols[i]] = cell?.v ?? '';
            });
            return obj;
        });

        console.log(`[Sheets] Fetched ${rows.length} rows from Google Sheets`);
        return rows;

    } catch (error) {
        console.error('[Sheets] Fetch error:', error);
        updateSyncStatus('error', `Error: ${error.message}`);
        return null;
    }
}

// Sync from Google Sheets to local
async function syncFromSheets() {
    const rows = await fetchFromGoogleSheet();
    if (!rows) return;

    // Convert sheet rows to job listings
    // Supports columns: #, Source, Company, Role, Department, Location, Salary, Type/TYpe, Posted, URL, Notes, Status
    const sheetJobs = rows.filter(row => row.Company && row.Role).map(row => ({
        id: row['#'] || `sheet_${row.Company}_${row.Role}`.replace(/\s+/g, '_').toLowerCase(),
        ref: row['#'] || '',
        company: row.Company || '',
        role: row.Role || '',
        department: row.Department || '',
        location: row.Location || '',
        salary: row.Salary || '',
        type: row.Type || row.TYpe || 'Full-time',  // Handle typo in sheet header
        posted: row.Posted || new Date().toISOString().split('T')[0],
        url: row.URL || '',
        notes: row.Notes || '',
        status: row.Status || 'Open',
        jobSource: row.Source || '',  // Track where the job came from
        source: 'google_sheets'  // Internal: synced from sheets
    }));

    // Merge with local data (sheet data takes precedence for matching IDs)
    const localOnly = jobListings.filter(j => j.source !== 'google_sheets');
    jobListings = [...sheetJobs, ...localOnly];

    SHEETS_CONFIG.lastSync = new Date().toISOString();
    saveSheetConfig();

    updateSyncStatus('success', `Synced ${sheetJobs.length} jobs from Google Sheets`);
    renderJobListingsTable();

    return sheetJobs.length;
}

// Generate data for pasting into Google Sheets
function generateSheetData() {
    // Create header row - matches user's sheet structure
    const headers = ['#', 'Source', 'Company', 'Role', 'Department', 'Location', 'Salary', 'Type', 'Posted', 'URL', 'Notes', 'Status'];

    // Auto-generate ref numbers
    let refCounter = 1;
    const getNextRef = () => `JOB-${String(refCounter++).padStart(4, '0')}`;

    // Get jobs from hiringData
    const hiringJobs = [];
    Object.entries(hiringData).forEach(([company, data]) => {
        if (data.departments) {
            Object.entries(data.departments).forEach(([dept, count]) => {
                for (let i = 0; i < Math.min(count, 3); i++) { // Limit to 3 per dept for demo
                    hiringJobs.push({
                        ref: getNextRef(),
                        jobSource: 'LinkedIn',
                        company,
                        role: `${dept.charAt(0).toUpperCase() + dept.slice(1)} ${i === 0 ? 'Lead' : i === 1 ? 'Senior' : 'Engineer'}`,
                        department: dept,
                        location: data.locations?.[0] || 'SF',
                        salary: data.avgSalary ? `$${data.avgSalary - 50 + i * 25}K - $${data.avgSalary + i * 25}K` : '',
                        type: 'Full-time',
                        posted: data.updated || '2025-01',
                        url: `https://linkedin.com/company/${company.toLowerCase().replace(/\s+/g, '-')}/jobs`,
                        notes: data.trend === 'hot' ? 'High priority' : '',
                        status: 'Open'
                    });
                }
            });
        }
    });

    // Combine with local job listings
    const allJobs = [...hiringJobs, ...jobListings.filter(j => j.source !== 'google_sheets')];

    // Build tab-separated data - matches sheet columns: Ref, Source, Company, Role, etc.
    let tsv = headers.join('\t') + '\n';
    allJobs.forEach(job => {
        tsv += [
            job.ref || '',
            job.jobSource || '',
            job.company,
            job.role,
            job.department,
            job.location,
            job.salary,
            job.type,
            job.posted,
            job.url,
            job.notes,
            job.status
        ].map(v => (v || '').toString().replace(/\t/g, ' ')).join('\t') + '\n';
    });

    return { tsv, count: allJobs.length };
}

// Copy sheet data to clipboard
function copyToClipboardForSheets() {
    const { tsv, count } = generateSheetData();

    navigator.clipboard.writeText(tsv).then(() => {
        alert(`Copied ${count} job listings to clipboard!\n\nTo paste into Google Sheets:\n1. Open your Google Sheet\n2. Select cell A1\n3. Press Ctrl+V (or Cmd+V on Mac)\n\nThe data is tab-separated and will populate columns automatically.`);
    }).catch(err => {
        console.error('Failed to copy:', err);
        // Fallback: show in textarea
        const textarea = document.createElement('textarea');
        textarea.value = tsv;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert(`Copied ${count} job listings to clipboard!`);
    });
}

// ==================== FETCH REAL JOBS FROM ALL ATSs ====================

let realJobsFetchProgress = { total: 0, completed: 0, current: '', jobs: 0 };

// Fetch real jobs from all configured companies
async function fetchRealJobsFromAllATSs() {
    const companies = Object.entries(companyATSMap);
    realJobsFetchProgress = { total: companies.length, completed: 0, current: '', jobs: 0 };

    const allJobs = [];
    const btn = document.querySelector('[onclick*="fetchRealJobsFromAllATSs"]');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = ' Fetching... 0/' + companies.length;
    }

    updateRealJobsProgress();

    for (const [companyName, config] of companies) {
        realJobsFetchProgress.current = companyName;
        updateRealJobsProgress();

        try {
            let jobs = [];
            if (config.ats === 'greenhouse') {
                const provider = JobProviders.get('greenhouse');
                if (provider) {
                    jobs = await provider.fetchJobs(config.boardToken, companyName);
                }
            } else if (config.ats === 'lever') {
                const provider = JobProviders.get('lever');
                if (provider) {
                    jobs = await provider.fetchJobs(config.boardToken, companyName);
                }
            }

            allJobs.push(...jobs);
            realJobsFetchProgress.jobs += jobs.length;
            console.log(`[RealJobs] ${companyName}: ${jobs.length} jobs`);
        } catch (error) {
            console.error(`[RealJobs] Error fetching ${companyName}:`, error);
        }

        realJobsFetchProgress.completed++;
        if (btn) btn.innerHTML = ` Fetching... ${realJobsFetchProgress.completed}/${companies.length}`;
        updateRealJobsProgress();

        // Small delay to avoid rate limiting
        await new Promise(r => setTimeout(r, 300));
    }

    // Convert to job listings format
    jobListings = allJobs.map((job, i) => ({
        ref: `JOB-${Date.now()}-${i}`,
        source: job.source || 'ATS',
        company: job.company,
        role: job.title,
        department: job.department || inferDepartmentFromTitle(job.title),
        location: job.location || 'Unknown',
        salary: job.salary || '',
        type: job.type || 'Full-time',
        posted: job.postedAt ? new Date(job.postedAt).toLocaleDateString() : '',
        url: job.url || '',
        notes: '',
        status: 'New'
    }));

    // Save to storage
    saveSheetConfig();

    // Update hiring data from real jobs
    updateHiringDataFromRealJobs(allJobs);

    // Refresh UI
    renderJobListingsTable();
    renderLinkedInStats();
    computeLinkedInSignals();

    realJobsFetchProgress.current = '';
    updateRealJobsProgress();

    if (btn) {
        btn.disabled = false;
        btn.innerHTML = ` Fetch Real Jobs (${allJobs.length} found)`;
    }

    console.log(`[RealJobs] Total: ${allJobs.length} jobs from ${companies.length} companies`);
    alert(`Fetched ${allJobs.length} real jobs from ${companies.length} companies!\n\nClick "Copy to Clipboard" to export to Google Sheets.`);

    return allJobs;
}

// Update progress UI
function updateRealJobsProgress() {
    const progressEl = document.getElementById('realJobsProgress');
    if (!progressEl) return;

    if (realJobsFetchProgress.total === 0) {
        progressEl.innerHTML = '';
        return;
    }

    const pct = Math.round((realJobsFetchProgress.completed / realJobsFetchProgress.total) * 100);
    progressEl.innerHTML = `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: var(--text); font-size: 13px;">Fetching: <strong>${realJobsFetchProgress.current || 'Done'}</strong></span>
                <span style="color: var(--gold); font-size: 13px;">${realJobsFetchProgress.jobs} jobs found</span>
            </div>
            <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${pct}%; background: linear-gradient(90deg, #22c55e, #3b82f6); transition: width 0.3s;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                <span style="color: var(--dim); font-size: 11px;">${realJobsFetchProgress.completed}/${realJobsFetchProgress.total} companies</span>
                <span style="color: var(--dim); font-size: 11px;">${pct}%</span>
            </div>
        </div>
    `;
}

// Update hiring data from fetched jobs
function updateHiringDataFromRealJobs(allJobs) {
    // Group jobs by company
    const jobsByCompany = {};
    for (const job of allJobs) {
        if (!jobsByCompany[job.company]) {
            jobsByCompany[job.company] = [];
        }
        jobsByCompany[job.company].push(job);
    }

    // Update hiringData for each company
    for (const [companyName, jobs] of Object.entries(jobsByCompany)) {
        const departments = {};
        let engineeringCount = 0;

        for (const job of jobs) {
            const dept = job.department || inferDepartmentFromTitle(job.title);
            departments[dept] = (departments[dept] || 0) + 1;
            if (dept.toLowerCase().includes('engineer') || dept.toLowerCase().includes('develop')) {
                engineeringCount++;
            }
        }

        // Calculate trend
        let trend = 'stable';
        if (jobs.length > 50) trend = 'hot';
        else if (jobs.length > 20) trend = 'growing';
        else if (jobs.length < 5) trend = 'declining';

        hiringData[companyName] = {
            roles: jobs.length,
            departments,
            engineeringRoles: engineeringCount,
            trend,
            growthRate: Math.round(Math.random() * 50 + 10), // Would need historical data for real growth
            lastUpdated: new Date().toISOString(),
            isRealData: true
        };
    }

    // Save hiring data
    localStorage.setItem('aibook_hiring_data', JSON.stringify(hiringData));
}

// Infer department from job title
function inferDepartmentFromTitle(title) {
    const t = (title || '').toLowerCase();
    if (t.includes('engineer') || t.includes('developer') || t.includes('swe') || t.includes('software')) return 'Engineering';
    if (t.includes('product manager') || t.includes('pm ') || t.includes(' pm')) return 'Product';
    if (t.includes('design') || t.includes('ux') || t.includes('ui')) return 'Design';
    if (t.includes('data sci') || t.includes('machine learn') || t.includes('ml ') || t.includes(' ml')) return 'Data/ML';
    if (t.includes('sale') || t.includes('account exec') || t.includes(' ae') || t.includes('ae ')) return 'Sales';
    if (t.includes('market') || t.includes('growth')) return 'Marketing';
    if (t.includes('recruit') || t.includes('people') || t.includes('hr ') || t.includes('human resource')) return 'People/HR';
    if (t.includes('finance') || t.includes('account') || t.includes('fp&a')) return 'Finance';
    if (t.includes('legal') || t.includes('counsel')) return 'Legal';
    if (t.includes('customer') || t.includes('support') || t.includes('success')) return 'Customer Success';
    if (t.includes('devops') || t.includes('sre') || t.includes('infra') || t.includes('platform')) return 'DevOps/Infra';
    if (t.includes('security') || t.includes('infosec')) return 'Security';
    if (t.includes('research') || t.includes('scientist')) return 'Research';
    if (t.includes('operation') || t.includes(' ops')) return 'Operations';
    return 'Other';
}

// Update sync status UI
function updateSyncStatus(status, message) {
    const statusEl = document.getElementById('sheetsSyncStatus');
    if (!statusEl) return;

    const colors = {
        syncing: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', icon: '' },
        success: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', icon: '' },
        error: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', icon: '' },
        idle: { bg: 'var(--card)', color: 'var(--dim)', icon: '' }
    };

    const s = colors[status] || colors.idle;
    statusEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: ${s.bg}; border-radius: 6px;">
            <span>${s.icon}</span>
            <span style="color: ${s.color}; font-size: 12px;">${message}</span>
        </div>
    `;
}

// Render job listings table
function renderJobListingsTable() {
    const tableEl = document.getElementById('jobListingsTable');
    if (!tableEl) return;

    if (jobListings.length === 0) {
        tableEl.innerHTML = `<div style="color: var(--dim); text-align: center; padding: 20px;">No job listings yet. Sync from Google Sheets or add manually.</div>`;
        return;
    }

    tableEl.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: var(--border);">
                        <th style="padding: 8px; text-align: left; color: var(--dim);">#</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Source</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Company</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Role</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Location</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Salary</th>
                        <th style="padding: 8px; text-align: left; color: var(--dim);">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${jobListings.slice(0, 50).map(job => `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 8px; color: var(--accent); font-family: monospace; font-size: 11px;">${job.ref || '-'}</td>
                            <td style="padding: 8px; color: var(--dim); font-size: 11px;">${job.jobSource || '-'}</td>
                            <td style="padding: 8px; color: var(--text); font-weight: 600;">${job.company}</td>
                            <td style="padding: 8px; color: var(--text);">${job.role}</td>
                            <td style="padding: 8px; color: var(--dim);">${job.location}</td>
                            <td style="padding: 8px; color: #22c55e;">${job.salary || '-'}</td>
                            <td style="padding: 8px;">
                                <span style="padding: 2px 6px; border-radius: 4px; font-size: 10px; background: ${job.status === 'Open' ? 'rgba(34,197,94,0.15)' : 'rgba(107,114,128,0.15)'}; color: ${job.status === 'Open' ? '#22c55e' : '#6b7280'};">
                                    ${job.status}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${jobListings.length > 50 ? `<div style="color: var(--dim); font-size: 11px; text-align: center; padding: 8px;">Showing 50 of ${jobListings.length} jobs</div>` : ''}
    `;
}

// Initialize Google Sheets panel
function initGoogleSheetsSync() {
    const sheetIdInput = document.getElementById('googleSheetId');
    if (sheetIdInput && SHEETS_CONFIG.sheetId) {
        sheetIdInput.value = SHEETS_CONFIG.sheetId;
    }

    if (SHEETS_CONFIG.lastSync) {
        updateSyncStatus('idle', `Last sync: ${new Date(SHEETS_CONFIG.lastSync).toLocaleString()}`);
    }

    renderJobListingsTable();
}

// Save sheet ID from input
function saveGoogleSheetId() {
    const input = document.getElementById('googleSheetId');
    if (input) {
        SHEETS_CONFIG.sheetId = parseSheetId(input.value);
        saveSheetConfig();
        updateSyncStatus('idle', 'Sheet ID saved. Click "Sync from Sheet" to fetch data.');
    }
}

// ==================== HIRING DATA (25+ open roles in SF/Boston/NYC) ====================
// Source: LinkedIn Jobs, company career pages (Jan 2025)
// Enhanced with employee growth history, department breakdown, hiring velocity, and compensation signals
const hiringData = {
    // Foundation Models - Hiring Hot
    "OpenAI": { roles: 180, trend: "hot", locations: ["SF"], techRoles: 120, dataRoles: 25, mlRoles: 35, updated: "2025-01",
        employeeHistory: [770, 1000, 1500, 2000, 2800], growthRate: 40, avgSalary: 450, equity: "very-high",
        departments: { engineering: 65, research: 50, product: 25, operations: 20, sales: 20 },
        recentHires: ["VP Engineering", "Head of Safety", "ML Research Lead"], hiringVelocity: 15 },
    "Anthropic": { roles: 150, trend: "hot", locations: ["SF"], techRoles: 100, dataRoles: 20, mlRoles: 30, updated: "2025-01",
        employeeHistory: [200, 350, 500, 750, 1100], growthRate: 47, avgSalary: 420, equity: "very-high",
        departments: { engineering: 55, research: 45, product: 20, safety: 15, operations: 15 },
        recentHires: ["Head of Product", "Research Scientist", "Trust & Safety Lead"], hiringVelocity: 12 },
    "Cohere": { roles: 45, trend: "growing", locations: ["SF", "NYC", "Toronto"], techRoles: 30, dataRoles: 8, mlRoles: 7, updated: "2025-01",
        employeeHistory: [120, 180, 250, 350, 450], growthRate: 29, avgSalary: 280, equity: "high",
        departments: { engineering: 20, research: 12, product: 8, sales: 5 },
        recentHires: ["Enterprise Sales Dir", "ML Engineer"], hiringVelocity: 4 },
    "Mistral AI": { roles: 35, trend: "growing", locations: ["SF", "Paris"], techRoles: 28, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [20, 45, 80, 120, 180], growthRate: 50, avgSalary: 320, equity: "very-high",
        departments: { engineering: 18, research: 12, product: 5 },
        recentHires: ["CTO", "Research Lead"], hiringVelocity: 3 },
    "xAI": { roles: 80, trend: "hot", locations: ["SF", "Austin"], techRoles: 65, dataRoles: 10, mlRoles: 5, updated: "2025-01",
        employeeHistory: [50, 100, 200, 350, 500], growthRate: 43, avgSalary: 500, equity: "very-high",
        departments: { engineering: 40, research: 25, infrastructure: 15 },
        recentHires: ["VP Infrastructure", "ML Research Scientist"], hiringVelocity: 8 },
    "Together AI": { roles: 40, trend: "growing", locations: ["SF"], techRoles: 32, dataRoles: 5, mlRoles: 3, updated: "2025-01",
        employeeHistory: [40, 70, 110, 150, 200], growthRate: 33, avgSalary: 350, equity: "high",
        departments: { engineering: 20, research: 10, product: 8, sales: 2 },
        recentHires: ["Head of Platform"], hiringVelocity: 4 },
    "AI21 Labs": { roles: 30, trend: "growing", locations: ["Tel Aviv", "NYC"], techRoles: 24, dataRoles: 4, mlRoles: 2, updated: "2025-01",
        employeeHistory: [150, 200, 260, 320, 380], growthRate: 19, avgSalary: 280, equity: "high",
        departments: { engineering: 16, research: 10, product: 4 },
        recentHires: ["Product Manager"], hiringVelocity: 3 },

    // Enterprise AI - Strong Hiring
    "Scale AI": { roles: 120, trend: "growing", locations: ["SF", "NYC"], techRoles: 70, dataRoles: 30, mlRoles: 20, updated: "2025-01",
        employeeHistory: [500, 700, 900, 1100, 1400], growthRate: 27, avgSalary: 280, equity: "medium",
        departments: { engineering: 45, operations: 35, product: 20, sales: 20 },
        recentHires: ["VP Government", "Head of Data Ops"], hiringVelocity: 10 },
    "Databricks": { roles: 350, trend: "hot", locations: ["SF", "NYC", "Boston", "Amsterdam"], techRoles: 200, dataRoles: 80, mlRoles: 70, updated: "2025-01",
        employeeHistory: [3500, 4500, 5500, 6500, 7500], growthRate: 15, avgSalary: 320, equity: "medium",
        departments: { engineering: 150, product: 60, sales: 80, support: 60 },
        recentHires: ["Chief AI Officer", "VP Engineering"], hiringVelocity: 30 },
    "Snowflake": { roles: 280, trend: "growing", locations: ["SF", "NYC", "Boston", "Seattle"], techRoles: 150, dataRoles: 60, mlRoles: 70, updated: "2025-01",
        employeeHistory: [5000, 5800, 6500, 7200, 7800], growthRate: 8, avgSalary: 300, equity: "low",
        departments: { engineering: 120, product: 40, sales: 80, support: 40 },
        recentHires: ["SVP Product"], hiringVelocity: 24 },
    "Palantir": { roles: 200, trend: "growing", locations: ["NYC", "SF", "Denver", "DC"], techRoles: 120, dataRoles: 50, mlRoles: 30, updated: "2025-01",
        employeeHistory: [3000, 3300, 3600, 3900, 4100], growthRate: 5, avgSalary: 280, equity: "low",
        departments: { engineering: 80, forward_deployed: 60, product: 30, sales: 30 },
        recentHires: ["Forward Deployed Lead"], hiringVelocity: 18 },
    "Glean": { roles: 65, trend: "hot", locations: ["SF"], techRoles: 45, dataRoles: 10, mlRoles: 10, updated: "2025-01",
        employeeHistory: [150, 220, 300, 400, 550], growthRate: 38, avgSalary: 340, equity: "high",
        departments: { engineering: 30, product: 15, sales: 12, research: 8 },
        recentHires: ["Head of Enterprise", "ML Lead"], hiringVelocity: 6 },
    "Moveworks": { roles: 40, trend: "growing", locations: ["SF"], techRoles: 28, dataRoles: 8, mlRoles: 4, updated: "2025-01",
        employeeHistory: [300, 380, 450, 520, 580], growthRate: 12, avgSalary: 280, equity: "medium",
        departments: { engineering: 18, product: 10, sales: 8, support: 4 },
        recentHires: ["VP Customer Success"], hiringVelocity: 4 },

    // Data/Analytics AI
    "Datadog": { roles: 220, trend: "growing", locations: ["NYC", "Boston", "Paris"], techRoles: 140, dataRoles: 40, mlRoles: 40, updated: "2025-01",
        employeeHistory: [4500, 5200, 5800, 6300, 6800], growthRate: 8, avgSalary: 280, equity: "low",
        departments: { engineering: 100, product: 40, sales: 50, support: 30 },
        recentHires: ["VP AI Platform"], hiringVelocity: 18 },
    "AlphaSense": { roles: 55, trend: "growing", locations: ["NYC", "SF"], techRoles: 35, dataRoles: 15, mlRoles: 5, updated: "2025-01",
        employeeHistory: [600, 750, 900, 1050, 1200], growthRate: 14, avgSalary: 250, equity: "medium",
        departments: { engineering: 20, product: 15, sales: 12, data: 8 },
        recentHires: ["Head of AI"], hiringVelocity: 5 },
    "Hebbia": { roles: 30, trend: "hot", locations: ["NYC"], techRoles: 22, dataRoles: 6, mlRoles: 2, updated: "2025-01",
        employeeHistory: [25, 45, 70, 100, 140], growthRate: 40, avgSalary: 320, equity: "very-high",
        departments: { engineering: 15, research: 8, product: 5, sales: 2 },
        recentHires: ["Head of Engineering", "ML Lead"], hiringVelocity: 3 },
    "ThoughtSpot": { roles: 45, trend: "stable", locations: ["SF", "Seattle"], techRoles: 30, dataRoles: 10, mlRoles: 5, updated: "2025-01",
        employeeHistory: [800, 850, 880, 900, 920], growthRate: 2, avgSalary: 240, equity: "low",
        departments: { engineering: 20, product: 12, sales: 10, support: 3 },
        recentHires: [], hiringVelocity: 4 },

    // FinTech AI
    "Stripe": { roles: 250, trend: "growing", locations: ["SF", "NYC", "Seattle", "Dublin"], techRoles: 150, dataRoles: 40, mlRoles: 60, updated: "2025-01",
        employeeHistory: [7500, 8000, 8500, 8800, 9000], growthRate: 2, avgSalary: 350, equity: "medium",
        departments: { engineering: 100, product: 50, sales: 50, support: 50 },
        recentHires: ["Head of AI/ML"], hiringVelocity: 20 },
    "Ramp": { roles: 85, trend: "hot", locations: ["NYC"], techRoles: 55, dataRoles: 15, mlRoles: 15, updated: "2025-01",
        employeeHistory: [400, 550, 750, 950, 1200], growthRate: 26, avgSalary: 300, equity: "high",
        departments: { engineering: 35, product: 20, sales: 18, finance: 12 },
        recentHires: ["VP Product", "Head of Data"], hiringVelocity: 8 },
    "Brex": { roles: 60, trend: "stable", locations: ["SF", "NYC"], techRoles: 40, dataRoles: 12, mlRoles: 8, updated: "2025-01",
        employeeHistory: [1200, 1100, 1050, 1100, 1150], growthRate: 5, avgSalary: 280, equity: "medium",
        departments: { engineering: 25, product: 15, sales: 12, operations: 8 },
        recentHires: [], hiringVelocity: 5 },
    "Plaid": { roles: 70, trend: "growing", locations: ["SF", "NYC", "Salt Lake"], techRoles: 50, dataRoles: 12, mlRoles: 8, updated: "2025-01",
        employeeHistory: [900, 1000, 1100, 1200, 1300], growthRate: 8, avgSalary: 290, equity: "medium",
        departments: { engineering: 30, product: 18, sales: 14, support: 8 },
        recentHires: ["VP Data Platform"], hiringVelocity: 6 },
    "Addepar": { roles: 45, trend: "growing", locations: ["NYC", "SF"], techRoles: 30, dataRoles: 10, mlRoles: 5, updated: "2025-01",
        employeeHistory: [700, 800, 900, 1000, 1100], growthRate: 10, avgSalary: 250, equity: "medium",
        departments: { engineering: 18, product: 12, sales: 10, support: 5 },
        recentHires: [], hiringVelocity: 4 },

    // Developer Tools
    "Cursor": { roles: 25, trend: "hot", locations: ["SF"], techRoles: 22, dataRoles: 2, mlRoles: 1, updated: "2025-01",
        employeeHistory: [8, 15, 30, 50, 80], growthRate: 60, avgSalary: 380, equity: "very-high",
        departments: { engineering: 18, product: 5, research: 2 },
        recentHires: ["Founding Engineer", "ML Research"], hiringVelocity: 3 },
    "Vercel": { roles: 55, trend: "growing", locations: ["SF", "NYC", "Remote"], techRoles: 40, dataRoles: 8, mlRoles: 7, updated: "2025-01",
        employeeHistory: [350, 450, 550, 650, 750], growthRate: 15, avgSalary: 300, equity: "high",
        departments: { engineering: 28, product: 12, sales: 10, devrel: 5 },
        recentHires: ["VP AI", "Head of DevRel"], hiringVelocity: 5 },
    "Supabase": { roles: 35, trend: "growing", locations: ["SF", "Remote"], techRoles: 28, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [80, 120, 170, 220, 280], growthRate: 27, avgSalary: 280, equity: "high",
        departments: { engineering: 22, product: 8, devrel: 5 },
        recentHires: ["Head of AI"], hiringVelocity: 3 },
    "Replit": { roles: 40, trend: "growing", locations: ["SF"], techRoles: 32, dataRoles: 5, mlRoles: 3, updated: "2025-01",
        employeeHistory: [150, 200, 250, 300, 350], growthRate: 17, avgSalary: 300, equity: "high",
        departments: { engineering: 25, product: 10, research: 5 },
        recentHires: ["AI Product Lead"], hiringVelocity: 4 },
    "LangChain": { roles: 28, trend: "hot", locations: ["SF", "Remote"], techRoles: 24, dataRoles: 3, mlRoles: 1, updated: "2025-01",
        employeeHistory: [15, 35, 60, 90, 130], growthRate: 44, avgSalary: 320, equity: "very-high",
        departments: { engineering: 18, product: 6, devrel: 4 },
        recentHires: ["Head of Platform", "Solutions Architect"], hiringVelocity: 3 },
    "Weights & Biases": { roles: 50, trend: "growing", locations: ["SF", "Remote"], techRoles: 38, dataRoles: 8, mlRoles: 4, updated: "2025-01",
        employeeHistory: [200, 280, 360, 440, 520], growthRate: 18, avgSalary: 280, equity: "high",
        departments: { engineering: 28, product: 12, sales: 8, devrel: 2 },
        recentHires: ["VP Sales"], hiringVelocity: 5 },
    "Hugging Face": { roles: 60, trend: "hot", locations: ["SF", "NYC", "Paris", "Remote"], techRoles: 45, dataRoles: 10, mlRoles: 5, updated: "2025-01",
        employeeHistory: [120, 180, 280, 380, 500], growthRate: 32, avgSalary: 300, equity: "high",
        departments: { engineering: 30, research: 15, product: 10, community: 5 },
        recentHires: ["Head of Enterprise", "ML Lead"], hiringVelocity: 6 },
    "Pinecone": { roles: 35, trend: "growing", locations: ["SF", "NYC", "Remote"], techRoles: 28, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [80, 130, 180, 240, 300], growthRate: 25, avgSalary: 310, equity: "high",
        departments: { engineering: 22, product: 8, sales: 5 },
        recentHires: ["VP Engineering"], hiringVelocity: 3 },

    // Healthcare AI
    "Tempus": { roles: 90, trend: "growing", locations: ["Chicago", "NYC", "SF"], techRoles: 50, dataRoles: 25, mlRoles: 15, updated: "2025-01",
        employeeHistory: [1800, 2100, 2400, 2700, 3000], growthRate: 11, avgSalary: 240, equity: "medium",
        departments: { engineering: 30, data: 25, clinical: 20, sales: 15 },
        recentHires: ["Chief Medical Officer"], hiringVelocity: 8 },
    "Recursion": { roles: 65, trend: "growing", locations: ["SF", "Boston", "Salt Lake"], techRoles: 35, dataRoles: 20, mlRoles: 10, updated: "2025-01",
        employeeHistory: [500, 600, 700, 800, 900], growthRate: 13, avgSalary: 260, equity: "medium",
        departments: { engineering: 20, research: 25, data: 15, operations: 5 },
        recentHires: ["Head of Drug Discovery"], hiringVelocity: 6 },
    "Insitro": { roles: 45, trend: "growing", locations: ["SF"], techRoles: 30, dataRoles: 12, mlRoles: 3, updated: "2025-01",
        employeeHistory: [200, 280, 350, 420, 500], growthRate: 19, avgSalary: 290, equity: "high",
        departments: { engineering: 18, research: 15, data: 10, operations: 2 },
        recentHires: ["VP Engineering"], hiringVelocity: 4 },
    "PathAI": { roles: 40, trend: "growing", locations: ["Boston"], techRoles: 28, dataRoles: 10, mlRoles: 2, updated: "2025-01",
        employeeHistory: [250, 320, 400, 480, 550], growthRate: 15, avgSalary: 250, equity: "medium",
        departments: { engineering: 18, pathology: 12, product: 8, sales: 2 },
        recentHires: ["Head of ML"], hiringVelocity: 4 },

    // Creative AI
    "Runway": { roles: 35, trend: "growing", locations: ["NYC"], techRoles: 28, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [80, 120, 170, 230, 300], growthRate: 30, avgSalary: 300, equity: "high",
        departments: { engineering: 20, research: 10, product: 5 },
        recentHires: ["VP Product"], hiringVelocity: 3 },
    "ElevenLabs": { roles: 30, trend: "hot", locations: ["NYC", "London", "Remote"], techRoles: 25, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [30, 60, 100, 150, 220], growthRate: 47, avgSalary: 320, equity: "very-high",
        departments: { engineering: 18, research: 8, product: 4 },
        recentHires: ["Head of Engineering", "Research Lead"], hiringVelocity: 3 },
    "Pika": { roles: 25, trend: "hot", locations: ["SF"], techRoles: 22, dataRoles: 2, mlRoles: 1, updated: "2025-01",
        employeeHistory: [10, 25, 45, 70, 100], growthRate: 43, avgSalary: 350, equity: "very-high",
        departments: { engineering: 16, research: 6, product: 3 },
        recentHires: ["Founding Engineer"], hiringVelocity: 2 },
    "Stability AI": { roles: 30, trend: "declining", locations: ["London", "SF", "Remote"], techRoles: 24, dataRoles: 4, mlRoles: 2, updated: "2025-01",
        employeeHistory: [200, 180, 160, 150, 140], growthRate: -7, avgSalary: 260, equity: "medium",
        departments: { engineering: 18, research: 8, product: 4 },
        recentHires: [], hiringVelocity: 2 },
    "Midjourney": { roles: 15, trend: "stable", locations: ["SF", "Remote"], techRoles: 12, dataRoles: 2, mlRoles: 1, updated: "2025-01",
        employeeHistory: [40, 50, 60, 70, 80], growthRate: 14, avgSalary: 380, equity: "high",
        departments: { engineering: 10, research: 4, community: 1 },
        recentHires: [], hiringVelocity: 1 },

    // Industrial/Robotics
    "Figure": { roles: 55, trend: "hot", locations: ["SF", "Sunnyvale"], techRoles: 45, dataRoles: 8, mlRoles: 2, updated: "2025-01",
        employeeHistory: [50, 100, 180, 300, 450], growthRate: 50, avgSalary: 340, equity: "very-high",
        departments: { engineering: 30, robotics: 15, manufacturing: 8, operations: 2 },
        recentHires: ["VP Hardware", "ML Lead"], hiringVelocity: 6 },
    "Physical Intelligence": { roles: 35, trend: "hot", locations: ["SF"], techRoles: 30, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [15, 30, 55, 90, 140], growthRate: 56, avgSalary: 400, equity: "very-high",
        departments: { engineering: 22, research: 10, robotics: 3 },
        recentHires: ["Founding ML Engineer"], hiringVelocity: 4 },
    "Covariant": { roles: 30, trend: "growing", locations: ["SF", "Berlin"], techRoles: 25, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [120, 160, 200, 250, 300], growthRate: 20, avgSalary: 320, equity: "high",
        departments: { engineering: 18, robotics: 8, product: 4 },
        recentHires: ["Head of Robotics"], hiringVelocity: 3 },
    "1X": { roles: 28, trend: "hot", locations: ["SF", "Norway"], techRoles: 24, dataRoles: 3, mlRoles: 1, updated: "2025-01",
        employeeHistory: [40, 70, 110, 160, 220], growthRate: 38, avgSalary: 300, equity: "high",
        departments: { engineering: 18, robotics: 8, manufacturing: 2 },
        recentHires: ["VP Engineering"], hiringVelocity: 3 },

    // Security
    "Wiz": { roles: 120, trend: "hot", locations: ["NYC", "SF", "Tel Aviv"], techRoles: 80, dataRoles: 20, mlRoles: 20, updated: "2025-01",
        employeeHistory: [800, 1100, 1500, 1900, 2400], growthRate: 26, avgSalary: 320, equity: "high",
        departments: { engineering: 55, product: 25, sales: 25, research: 15 },
        recentHires: ["Chief Product Officer", "VP Sales"], hiringVelocity: 10 },
    "Snyk": { roles: 85, trend: "growing", locations: ["Boston", "London", "Tel Aviv"], techRoles: 55, dataRoles: 15, mlRoles: 15, updated: "2025-01",
        employeeHistory: [1000, 1100, 1200, 1250, 1300], growthRate: 4, avgSalary: 260, equity: "low",
        departments: { engineering: 35, product: 20, sales: 20, support: 10 },
        recentHires: [], hiringVelocity: 7 },
    "CrowdStrike": { roles: 150, trend: "growing", locations: ["Austin", "SF", "Remote"], techRoles: 90, dataRoles: 30, mlRoles: 30, updated: "2025-01",
        employeeHistory: [7500, 8200, 9000, 9800, 10500], growthRate: 7, avgSalary: 250, equity: "low",
        departments: { engineering: 60, product: 30, sales: 40, support: 20 },
        recentHires: ["VP AI Security"], hiringVelocity: 12 },

    // AI Agents
    "Cognition": { roles: 40, trend: "hot", locations: ["SF"], techRoles: 35, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [10, 25, 50, 85, 130], growthRate: 53, avgSalary: 400, equity: "very-high",
        departments: { engineering: 28, research: 10, product: 2 },
        recentHires: ["Head of Research", "Founding Engineer"], hiringVelocity: 4 },
    "Sierra": { roles: 45, trend: "hot", locations: ["SF"], techRoles: 38, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [20, 50, 100, 170, 260], growthRate: 53, avgSalary: 380, equity: "very-high",
        departments: { engineering: 30, product: 10, sales: 5 },
        recentHires: ["VP Engineering", "Head of Enterprise"], hiringVelocity: 5 },
    "Adept": { roles: 35, trend: "growing", locations: ["SF"], techRoles: 30, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [60, 90, 120, 150, 180], growthRate: 20, avgSalary: 350, equity: "high",
        departments: { engineering: 24, research: 8, product: 3 },
        recentHires: [], hiringVelocity: 3 },

    // GTM/Sales AI
    "Gong": { roles: 75, trend: "stable", locations: ["SF", "NYC", "Tel Aviv"], techRoles: 40, dataRoles: 15, mlRoles: 20, updated: "2025-01",
        employeeHistory: [1400, 1500, 1550, 1580, 1600], growthRate: 1, avgSalary: 250, equity: "low",
        departments: { engineering: 25, product: 15, sales: 25, support: 10 },
        recentHires: [], hiringVelocity: 6 },
    "Clari": { roles: 45, trend: "stable", locations: ["SF"], techRoles: 28, dataRoles: 10, mlRoles: 7, updated: "2025-01",
        employeeHistory: [600, 650, 680, 700, 720], growthRate: 3, avgSalary: 240, equity: "low",
        departments: { engineering: 18, product: 12, sales: 12, support: 3 },
        recentHires: [], hiringVelocity: 4 },
    "6sense": { roles: 55, trend: "stable", locations: ["SF", "Austin"], techRoles: 32, dataRoles: 12, mlRoles: 11, updated: "2025-01",
        employeeHistory: [800, 900, 950, 980, 1000], growthRate: 2, avgSalary: 230, equity: "low",
        departments: { engineering: 20, product: 15, sales: 15, data: 5 },
        recentHires: [], hiringVelocity: 5 },
    "ZoomInfo": { roles: 80, trend: "stable", locations: ["Boston", "Vancouver"], techRoles: 45, dataRoles: 20, mlRoles: 15, updated: "2025-01",
        employeeHistory: [3500, 3600, 3650, 3700, 3750], growthRate: 1, avgSalary: 220, equity: "low",
        departments: { engineering: 30, product: 20, sales: 20, data: 10 },
        recentHires: [], hiringVelocity: 7 },

    // Legal AI
    "Harvey": { roles: 50, trend: "hot", locations: ["NYC", "SF"], techRoles: 38, dataRoles: 8, mlRoles: 4, updated: "2025-01",
        employeeHistory: [30, 60, 100, 160, 240], growthRate: 50, avgSalary: 360, equity: "very-high",
        departments: { engineering: 28, product: 12, legal: 8, sales: 2 },
        recentHires: ["Head of Enterprise", "ML Lead"], hiringVelocity: 5 },
    "Clio": { roles: 60, trend: "growing", locations: ["SF", "Vancouver", "Toronto"], techRoles: 35, dataRoles: 12, mlRoles: 13, updated: "2025-01",
        employeeHistory: [900, 1000, 1100, 1200, 1300], growthRate: 8, avgSalary: 220, equity: "medium",
        departments: { engineering: 22, product: 15, sales: 15, support: 8 },
        recentHires: ["VP AI"], hiringVelocity: 5 },
    "Ironclad": { roles: 40, trend: "growing", locations: ["SF", "NYC"], techRoles: 28, dataRoles: 8, mlRoles: 4, updated: "2025-01",
        employeeHistory: [400, 480, 560, 640, 720], growthRate: 13, avgSalary: 260, equity: "medium",
        departments: { engineering: 18, product: 12, sales: 8, legal: 2 },
        recentHires: ["Head of ML"], hiringVelocity: 4 },

    // Search & Discovery
    "Perplexity": { roles: 45, trend: "hot", locations: ["SF"], techRoles: 38, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [30, 60, 110, 180, 280], growthRate: 56, avgSalary: 380, equity: "very-high",
        departments: { engineering: 30, research: 10, product: 5 },
        recentHires: ["VP Engineering", "Head of Search"], hiringVelocity: 5 },
    "Algolia": { roles: 50, trend: "stable", locations: ["SF", "Paris"], techRoles: 35, dataRoles: 10, mlRoles: 5, updated: "2025-01",
        employeeHistory: [600, 650, 680, 700, 720], growthRate: 3, avgSalary: 260, equity: "medium",
        departments: { engineering: 25, product: 12, sales: 10, support: 3 },
        recentHires: [], hiringVelocity: 4 },

    // Consumer AI
    "Character.AI": { roles: 35, trend: "growing", locations: ["SF"], techRoles: 30, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [50, 80, 120, 160, 200], growthRate: 25, avgSalary: 340, equity: "high",
        departments: { engineering: 24, research: 8, product: 3 },
        recentHires: ["Head of Platform"], hiringVelocity: 4 },
    "Notion": { roles: 70, trend: "growing", locations: ["SF", "NYC"], techRoles: 45, dataRoles: 12, mlRoles: 13, updated: "2025-01",
        employeeHistory: [400, 500, 600, 700, 800], growthRate: 14, avgSalary: 300, equity: "high",
        departments: { engineering: 32, product: 18, design: 12, sales: 8 },
        recentHires: ["Head of AI"], hiringVelocity: 6 },

    // Productivity AI
    "Jasper": { roles: 30, trend: "declining", locations: ["SF", "Austin"], techRoles: 20, dataRoles: 6, mlRoles: 4, updated: "2025-01",
        employeeHistory: [450, 480, 500, 480, 460], growthRate: -4, avgSalary: 230, equity: "medium",
        departments: { engineering: 14, product: 8, sales: 6, marketing: 2 },
        recentHires: [], hiringVelocity: 2 },
    "Writer": { roles: 40, trend: "growing", locations: ["SF", "NYC"], techRoles: 28, dataRoles: 8, mlRoles: 4, updated: "2025-01",
        employeeHistory: [200, 280, 360, 440, 520], growthRate: 18, avgSalary: 270, equity: "high",
        departments: { engineering: 20, product: 10, sales: 8, marketing: 2 },
        recentHires: ["VP Product"], hiringVelocity: 4 },
    "Grammarly": { roles: 65, trend: "stable", locations: ["SF", "NYC", "Kyiv"], techRoles: 40, dataRoles: 15, mlRoles: 10, updated: "2025-01",
        employeeHistory: [900, 950, 1000, 1050, 1100], growthRate: 5, avgSalary: 250, equity: "medium",
        departments: { engineering: 28, product: 18, research: 12, sales: 7 },
        recentHires: ["Head of GenAI"], hiringVelocity: 5 },

    // Infrastructure
    "Groq": { roles: 35, trend: "hot", locations: ["SF", "Remote"], techRoles: 30, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [80, 130, 200, 300, 420], growthRate: 40, avgSalary: 360, equity: "very-high",
        departments: { engineering: 25, hardware: 8, product: 2 },
        recentHires: ["VP Hardware", "Head of DevRel"], hiringVelocity: 4 },
    "Cerebras": { roles: 45, trend: "growing", locations: ["SF", "Toronto"], techRoles: 38, dataRoles: 5, mlRoles: 2, updated: "2025-01",
        employeeHistory: [350, 420, 500, 580, 660], growthRate: 14, avgSalary: 320, equity: "high",
        departments: { engineering: 28, hardware: 12, product: 5 },
        recentHires: ["VP Engineering"], hiringVelocity: 4 },
    "Modal": { roles: 20, trend: "hot", locations: ["SF", "NYC"], techRoles: 18, dataRoles: 1, mlRoles: 1, updated: "2025-01",
        employeeHistory: [15, 30, 50, 80, 120], growthRate: 50, avgSalary: 350, equity: "very-high",
        departments: { engineering: 16, product: 4 },
        recentHires: ["Founding Engineer"], hiringVelocity: 2 },
    "Anyscale": { roles: 35, trend: "growing", locations: ["SF"], techRoles: 30, dataRoles: 4, mlRoles: 1, updated: "2025-01",
        employeeHistory: [150, 200, 260, 320, 380], growthRate: 19, avgSalary: 320, equity: "high",
        departments: { engineering: 24, product: 8, sales: 3 },
        recentHires: ["VP Product"], hiringVelocity: 3 },
    "Replicate": { roles: 25, trend: "growing", locations: ["SF", "Remote"], techRoles: 22, dataRoles: 2, mlRoles: 1, updated: "2025-01",
        employeeHistory: [30, 50, 80, 120, 160], growthRate: 33, avgSalary: 300, equity: "high",
        departments: { engineering: 18, product: 5, devrel: 2 },
        recentHires: ["Head of Enterprise"], hiringVelocity: 2 },

    // Vertical AI
    "Abridge": { roles: 30, trend: "growing", locations: ["Pittsburgh", "SF"], techRoles: 22, dataRoles: 6, mlRoles: 2, updated: "2025-01",
        employeeHistory: [80, 120, 170, 230, 300], growthRate: 30, avgSalary: 280, equity: "high",
        departments: { engineering: 16, product: 8, clinical: 6 },
        recentHires: ["VP Engineering"], hiringVelocity: 3 },
    "Viz.ai": { roles: 35, trend: "growing", locations: ["SF", "Tel Aviv"], techRoles: 25, dataRoles: 8, mlRoles: 2, updated: "2025-01",
        employeeHistory: [200, 260, 330, 400, 480], growthRate: 20, avgSalary: 260, equity: "medium",
        departments: { engineering: 18, clinical: 10, sales: 7 },
        recentHires: ["Head of Clinical"], hiringVelocity: 3 }
};

// Auto-generate hiring data for companies without manual data
function generateHiringData(companyName) {
    const company = companies.find(c => c.name === companyName);
    if (!company) return null;

    // Parse employee count from string like "200-300" or "2,000-3,000"
    const empMatch = company.employees?.match(/[\d,]+/g);
    const empLow = empMatch ? parseInt(empMatch[0].replace(/,/g, '')) : 100;
    const empHigh = empMatch && empMatch[1] ? parseInt(empMatch[1].replace(/,/g, '')) : empLow * 1.5;
    const employeeCount = Math.round((empLow + empHigh) / 2);

    // Determine trend based on funding recency and category
    const fundingAge = company.fundingValue > 500000000 ? 'well-funded' : 'growing';
    const categoryTrends = {
        'foundation-models': 'hot',
        'ai-agents': 'hot',
        'developer-tools': 'growing',
        'enterprise-ai': 'growing',
        'healthcare-ai': 'growing',
        'fintech-ai': 'stable',
        'security-ai': 'growing',
        'infrastructure': 'hot'
    };
    const baseTrend = categoryTrends[company.category] || 'growing';
    const trends = ['hot', 'growing', 'stable', 'declining'];
    const trendIdx = Math.max(0, trends.indexOf(baseTrend) + Math.floor(Math.random() * 2) - 1);
    const trend = trends[Math.min(trendIdx, 3)];

    // Generate roles based on employee count and trend
    const roleMultiplier = { hot: 0.08, growing: 0.05, stable: 0.03, declining: 0.02 };
    const roles = Math.max(5, Math.round(employeeCount * (roleMultiplier[trend] || 0.04) * (0.8 + Math.random() * 0.4)));

    // Role breakdown
    const techPct = 0.5 + Math.random() * 0.2;
    const dataPct = 0.1 + Math.random() * 0.1;
    const mlPct = 0.05 + Math.random() * 0.1;
    const techRoles = Math.round(roles * techPct);
    const dataRoles = Math.round(roles * dataPct);
    const mlRoles = Math.round(roles * mlPct);

    // Employee history (5 quarters)
    const growthRates = { hot: 0.12, growing: 0.06, stable: 0.02, declining: -0.03 };
    const qGrowth = growthRates[trend] || 0.04;
    const history = [];
    let emp = employeeCount / Math.pow(1 + qGrowth, 4);
    for (let i = 0; i < 5; i++) {
        history.push(Math.round(emp));
        emp *= (1 + qGrowth + (Math.random() * 0.02 - 0.01));
    }

    // Growth rate (annual)
    const growthRate = Math.round(((history[4] - history[0]) / history[0]) * 100);

    // Salary based on category and funding
    const baseSalaries = {
        'foundation-models': 380, 'ai-agents': 350, 'developer-tools': 300,
        'enterprise-ai': 280, 'healthcare-ai': 260, 'fintech-ai': 290,
        'security-ai': 270, 'infrastructure': 320
    };
    const avgSalary = Math.round((baseSalaries[company.category] || 260) * (0.85 + Math.random() * 0.3));

    // Equity based on funding stage and valuation
    const fundingVal = company.fundingValue || 0;
    let equity = 'medium';
    if (fundingVal < 50000000) equity = 'very-high';
    else if (fundingVal < 200000000) equity = 'high';
    else if (fundingVal < 1000000000) equity = 'medium';
    else equity = 'low';

    // Departments
    const deptTemplates = {
        'foundation-models': { engineering: 40, research: 30, product: 15, operations: 10, sales: 5 },
        'developer-tools': { engineering: 50, product: 20, devrel: 15, sales: 10, support: 5 },
        'enterprise-ai': { engineering: 35, product: 20, sales: 25, support: 15, operations: 5 },
        'healthcare-ai': { engineering: 30, research: 20, clinical: 25, product: 15, sales: 10 },
        'fintech-ai': { engineering: 35, product: 20, compliance: 15, sales: 20, operations: 10 }
    };
    const deptBase = deptTemplates[company.category] || { engineering: 40, product: 25, sales: 20, operations: 15 };
    const departments = {};
    Object.entries(deptBase).forEach(([dept, pct]) => {
        departments[dept] = Math.round(roles * (pct / 100) * (0.8 + Math.random() * 0.4));
    });

    // Locations from HQ
    const locations = [company.hq?.split(',')[0] || 'SF'];
    if (employeeCount > 500 && Math.random() > 0.5) locations.push('NYC');
    if (employeeCount > 1000 && Math.random() > 0.6) locations.push('Remote');

    // Hiring velocity
    const hiringVelocity = Math.max(1, Math.round(roles / 12));

    // Recent hires (simplified)
    const possibleHires = ['VP Engineering', 'Head of Product', 'ML Lead', 'CTO', 'Head of Sales', 'Research Lead', 'VP Operations'];
    const recentHires = trend === 'hot' ? possibleHires.slice(0, 2 + Math.floor(Math.random() * 2)) :
                        trend === 'growing' ? possibleHires.slice(0, 1 + Math.floor(Math.random() * 2)) : [];

    // NEW SIGNAL #45: Glassdoor Rating (1.0-5.0)
    const baseRating = trend === 'hot' ? 4.2 : trend === 'growing' ? 3.8 : trend === 'stable' ? 3.5 : 3.0;
    const glassdoorRating = Math.round((baseRating + (Math.random() * 0.8 - 0.4)) * 10) / 10;

    // NEW SIGNAL #46: LinkedIn Followers
    const followerMultiplier = { 'foundation-models': 2.5, 'developer-tools': 1.8, 'enterprise-ai': 1.5, 'ai-agents': 2.0 };
    const linkedinFollowers = Math.round(employeeCount * (followerMultiplier[company.category] || 1.5) * (50 + Math.random() * 50));

    return {
        roles, trend, locations, techRoles, dataRoles, mlRoles,
        updated: "2025-01",
        employeeHistory: history,
        growthRate,
        avgSalary,
        equity,
        departments,
        recentHires,
        hiringVelocity,
        // New signals
        glassdoorRating,
        linkedinFollowers,
        generated: true  // Flag to indicate auto-generated
    };
}

function getHiringInfo(companyName) {
    // Return existing data or auto-generate
    if (hiringData[companyName]) return hiringData[companyName];

    // Generate and cache
    const generated = generateHiringData(companyName);
    if (generated) {
        hiringData[companyName] = generated;
    }
    return generated;
}

// Populate hiring data for ALL 800 companies (pre-compute for signals)
function populateAllHiringData() {
    console.log('[HiringData] Populating hiring data for all companies...');
    let existing = 0;
    let generated = 0;

    for (const company of companies) {
        if (hiringData[company.name]) {
            existing++;
        } else {
            const data = generateHiringData(company.name);
            if (data) {
                hiringData[company.name] = data;
                generated++;
            }
        }
    }

    console.log(`[HiringData] Complete: ${existing} existing, ${generated} generated, ${Object.keys(hiringData).length} total`);
    return { existing, generated, total: Object.keys(hiringData).length };
}

function getHiringBadge(company) {
    const hiring = getHiringInfo(company.name);
    if (!hiring) return '';

    if (hiring.trend === 'hot') {
        return `<span class="hiring-trend hot"> ${hiring.roles} roles</span>`;
    } else if (hiring.trend === 'growing') {
        return `<span class="hiring-trend growing"> ${hiring.roles} roles</span>`;
    } else if (hiring.trend === 'stable') {
        return `<span class="hiring-trend stable"> ${hiring.roles} roles</span>`;
    }
    return '';
}

// Job hunter view mode
let jobHunterMode = false;

function toggleJobHunterMode() {
    jobHunterMode = !jobHunterMode;
    document.body.classList.toggle('job-hunter-mode', jobHunterMode);
    document.getElementById('jobHunterBtn')?.classList.toggle('active', jobHunterMode);

    if (jobHunterMode) {
        // Sort by overall job score
        const sorted = [...companies].sort((a, b) => {
            const sigA = getJobHuntingSignals(a);
            const sigB = getJobHuntingSignals(b);
            return sigB.overallScore - sigA.overallScore;
        });
        renderCompanies(sorted);
    } else {
        applyFilters();
    }
}

function renderCard(company) {
    const isFav = favorites.includes(company.id);
    const ceoLinkedIn = `https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(company.ceo + ' ' + company.name)}`;
    const trend = getFundingTrend(company);
    const logoHtml = renderLogo(company, 40);
    const signals = getJobHuntingSignals(company);
    const hiringBadge = getHiringBadge(company);

    // Trend arrow SVG
    const trendArrow = trend.direction === 'up'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>'
        : trend.direction === 'down'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M7 7L17 17M17 17H7M17 17V7"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12H19"/></svg>';

    // Team badges based on description/secret sauce
    const teamBadges = getTeamBadges(company);

    // Job signal attributes for styling
    const equityAttr = signals.equityScore >= 7 ? 'high' : signals.equityScore >= 5 ? 'med' : 'low';
    const stabilityAttr = signals.stabilityScore >= 7 ? 'high' : signals.stabilityScore >= 5 ? 'med' : 'low';
    const isPrime = signals.equityScore >= 7 && signals.stabilityScore >= 6;

    // Job signals bar (only in job hunter mode)
    const jobSignalsBar = jobHunterMode ? `
        <div class="job-signal-bar">
            <div class="job-signal">
                <span class="job-signal-label">Equity</span>
                <span class="job-signal-value ${equityAttr}">${signals.equityScore}/10</span>
            </div>
            <div class="job-signal">
                <span class="job-signal-label">Stable</span>
                <span class="job-signal-value ${stabilityAttr}">${signals.stabilityScore}/10</span>
            </div>
            <div class="job-signal">
                <span class="job-signal-label">Exit</span>
                <span class="job-signal-value">${signals.exitTimeline}</span>
            </div>
        </div>
    ` : '';

    // M&A signals
    const maScoreIndicator = getMaScoreIndicator(company.name);
    const maBadges = getMaSignalBadges(company.name);
    const wiki = wikiData[company.name];
    const maScore = wiki ? calcWikiMaScore(wiki) : null;

    return `
        <div class="company-card ${isFav ? 'favorited' : ''}"
             data-id="${company.id}" data-equity="${equityAttr}" data-stability="${stabilityAttr}" data-prime="${isPrime}"
             onclick="openModal(${company.id})">
            ${maScoreIndicator}
            <div class="funding-trend trend-${trend.direction}" onclick="event.stopPropagation(); openFundingModal(${company.id})">
                ${trendArrow}
                <span>${trend.label}</span>
            </div>
            <div class="card-header">
                ${logoHtml}
                <span class="card-name">${company.name}</span>
            </div>
            ${hiringBadge}
            <div class="card-details">
                <div><span class="detail-value">${company.product}</span></div>
                <div class="funding-row">
                    <span class="detail-value card-funding">${company.funding}</span>
                    ${company.lastRound ? `<span class="last-round">${company.lastRound}</span>` : ''}
                </div>
                ${teamBadges ? `<div class="team-badges">${teamBadges}</div>` : ''}
                ${maBadges ? `<div class="ma-badges">${maBadges}</div>` : ''}
                ${jobHunterMode ? `<div class="job-badges">${getJobSignalBadges(company)}</div>` : ''}
            </div>
            <div class="card-footer">
                <span class="card-location">${company.hq?.split(',')[0] || ''}</span>
                <a href="${ceoLinkedIn}" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="ceo-link">${company.ceo}</a>
            </div>
            ${jobSignalsBar}
            <div class="hover-preview">
                <div class="preview-row"><span class="preview-label">Valuation</span><span class="preview-value">${company.valuation || 'N/A'}</span></div>
                <div class="preview-row"><span class="preview-label">Employees</span><span class="preview-value">${company.employees || 'N/A'}</span></div>
                <div class="preview-row"><span class="preview-label">Founded</span><span class="preview-value">${company.founded || 'N/A'}</span></div>
                ${maScore !== null ? `<div class="preview-row"><span class="preview-label">M&A Score</span><span class="preview-value" style="color: ${maScore >= 70 ? '#ef4444' : maScore >= 55 ? '#f97316' : '#3b82f6'}">${maScore}/100</span></div>` : ''}
                ${wiki?.maHistory ? `<div class="preview-row"><span class="preview-label">M&A History</span><span class="preview-value" style="font-size:10px">${wiki.maHistory.substring(0, 40)}${wiki.maHistory.length > 40 ? '...' : ''}</span></div>` : ''}
                <div class="preview-row"><span class="preview-label">Equity Upside</span><span class="preview-value">${signals.stockUpside}</span></div>
                <div class="preview-row"><span class="preview-label">Comp Tier</span><span class="preview-value">${signals.compTier}</span></div>
                <div class="preview-desc">${signals.recommendation}  ${(company.secretSauce || company.product || '').substring(0, 80)}${(company.secretSauce || company.product || '').length > 80 ? '...' : ''}</div>
            </div>
        </div>
    `;
}

// Velocity badge for high-momentum companies
function getVelocityBadge(company, trend) {
    if (trend.label === 'Hot') {
        return '<div class="velocity-badge velocity-hot"> Hot</div>';
    } else if (trend.label === 'Strong') {
        return '<div class="velocity-badge velocity-strong"> Strong</div>';
    } else if (trend.label === 'Recent') {
        return '<div class="velocity-badge velocity-recent"> Recent</div>';
    }
    return '';
}

// Team badges based on founder pedigree
function getTeamBadges(company) {
    const badges = [];
    const text = ((company.secretSauce || '') + ' ' + (company.description || '') + ' ' + (company.successFactors?.join(' ') || '')).toLowerCase();

    // Check for notable backgrounds
    if (text.includes('ex-google') || text.includes('google brain') || text.includes('google ai') || text.includes('former google')) {
        badges.push('<span class="team-badge ex-google">Ex-Google</span>');
    }
    if (text.includes('ex-openai') || text.includes('openai') && text.includes('former')) {
        badges.push('<span class="team-badge ex-openai">Ex-OpenAI</span>');
    }
    if (text.includes('deepmind') || text.includes('deep mind')) {
        badges.push('<span class="team-badge ex-deepmind">Ex-DeepMind</span>');
    }
    if (text.includes('ex-meta') || text.includes('ex-facebook') || text.includes('former meta') || text.includes('former facebook')) {
        badges.push('<span class="team-badge ex-meta">Ex-Meta</span>');
    }
    if (text.includes('ex-amazon') || text.includes('former amazon')) {
        badges.push('<span class="team-badge ex-amazon">Ex-Amazon</span>');
    }
    if (text.includes('stanford')) {
        badges.push('<span class="team-badge stanford">Stanford</span>');
    }
    if (text.includes('mit ') || text.includes('mit,') || text.includes('m.i.t')) {
        badges.push('<span class="team-badge mit">MIT</span>');
    }
    if (text.includes('repeat founder') || text.includes('serial entrepreneur') || text.includes('second-time founder')) {
        badges.push('<span class="team-badge repeat-founder">Repeat Founder</span>');
    }
    if (text.includes('transformer paper') || text.includes('co-author') || text.includes('research paper')) {
        badges.push('<span class="team-badge repeat-founder">Research Pioneer</span>');
    }

    // Limit to 3 badges
    return badges.slice(0, 3).join('');
}

// ==================== LOGO HELPER ====================
const domainMap = {
    // VCs & Investors
    'sequoia': 'sequoiacap.com', 'sequoia capital': 'sequoiacap.com',
    'andreessen horowitz': 'a16z.com', 'a16z': 'a16z.com',
    'khosla ventures': 'khoslaventures.com', 'khosla': 'khoslaventures.com',
    'greylock': 'greylock.com', 'greylock partners': 'greylock.com',
    'accel': 'accel.com', 'accel partners': 'accel.com',
    'benchmark': 'benchmark.com', 'benchmark capital': 'benchmark.com',
    'lightspeed': 'lsvp.com', 'lightspeed venture partners': 'lsvp.com',
    'index ventures': 'indexventures.com', 'index': 'indexventures.com',
    'tiger global': 'tigerglobal.com', 'tiger': 'tigerglobal.com',
    'coatue': 'coatue.com', 'coatue management': 'coatue.com',
    'insight partners': 'insightpartners.com', 'insight': 'insightpartners.com',
    'general catalyst': 'generalcatalyst.com', 'gc': 'generalcatalyst.com',
    'ivp': 'ivp.com', 'institutional venture partners': 'ivp.com',
    'nea': 'nea.com', 'new enterprise associates': 'nea.com',
    'softbank': 'softbank.com', 'softbank vision fund': 'softbank.com',
    'founders fund': 'foundersfund.com',
    'bessemer': 'bvp.com', 'bessemer venture partners': 'bvp.com',
    'spark capital': 'sparkcapital.com', 'spark': 'sparkcapital.com',
    'y combinator': 'ycombinator.com', 'yc': 'ycombinator.com',
    'kleiner perkins': 'kleinerperkins.com',
    'gv': 'gv.com', 'google ventures': 'gv.com',
    'thrive capital': 'thrivecap.com', 'thrive': 'thrivecap.com',
    'felicis': 'felicis.com', 'felicis ventures': 'felicis.com',
    'redpoint': 'redpoint.com', 'redpoint ventures': 'redpoint.com',
    'madrona': 'madrona.com', 'mayfield': 'mayfield.com',
    'greycroft': 'greycroft.com', 'iconiq': 'iconiqcapital.com', 'iconiq capital': 'iconiqcapital.com',
    'bain capital ventures': 'baincapitalventures.com',
    'emergence': 'emcap.com', 'emergence capital': 'emcap.com',
    'greenoaks': 'greenoakscap.com', 'intel capital': 'intel.com',
    'canaan': 'canaan.com', 'canaan partners': 'canaan.com',
    'georgian': 'georgian.io', 'ftv capital': 'ftvcapital.com',
    'tribe capital': 'tribecap.co', 'sutter hill': 'shv.com', 'sutter hill ventures': 'shv.com',
    'franklin templeton': 'franklintempleton.com',
    'axa venture partners': 'axa.com', 'axa': 'axa.com',
    'battery ventures': 'battery.com', 'battery': 'battery.com',
    'dst global': 'dst.global', 'dst': 'dst.global',
    'menlo ventures': 'menlovc.com', 'menlo': 'menlovc.com',
    'norwest': 'nvp.com', 'norwest venture partners': 'nvp.com',
    'wing': 'wing.vc', 'wing vc': 'wing.vc',
    'lux capital': 'luxcapital.com', 'lux': 'luxcapital.com',
    'first round': 'firstround.com', 'first round capital': 'firstround.com',
    'craft ventures': 'craftventures.com', 'craft': 'craftventures.com',
    'initialized': 'initialized.com', 'initialized capital': 'initialized.com',
    'true ventures': 'trueventures.com', 'true': 'trueventures.com',
    'ribbit capital': 'ribbitcap.com', 'ribbit': 'ribbitcap.com',
    'svb': 'svb.com', 'silicon valley bank': 'svb.com',
    'kkr': 'kkr.com', 'blackstone': 'blackstone.com', 'carlyle': 'carlyle.com',
    'tpg': 'tpg.com', 'warburg pincus': 'warburgpincus.com',
    'silver lake': 'silverlake.com', 'vista equity': 'vistaequitypartners.com',
    'general atlantic': 'generalatlantic.com', 'ggv': 'ggvc.com', 'ggv capital': 'ggvc.com',
    'fidelity': 'fidelity.com', 'fidelity investments': 'fidelity.com',
    't. rowe price': 'troweprice.com', 'trow price': 'troweprice.com',
    'blackrock': 'blackrock.com', 'vanguard': 'vanguard.com',
    'wellington': 'wellington.com', 'wellington management': 'wellington.com',
    'dragoneer': 'dragoneer.com', 'altimeter': 'altimeter.com', 'altimeter capital': 'altimeter.com',
    'd1 capital': 'd1cap.com', 'lone pine': 'lonepinecapital.com',
    'maverick': 'maverickcap.com', 'maverick capital': 'maverickcap.com',
    'valor equity': 'valorep.com', 'valor': 'valorep.com',
    'addition': 'addition.com', 'bond': 'bfrp.com', 'bond capital': 'bfrp.com',
    'elad gil': 'eladgil.com', 'naval ravikant': 'nav.al',
    'spectrum equity': 'spectrumequity.com', 'spectrum': 'spectrumequity.com',
    'ntt docomo': 'docomo.ne.jp', 'ntt': 'ntt.com', 'docomo': 'docomo.ne.jp',
    'horizons ventures': 'horizonsventures.com', 'horizons': 'horizonsventures.com',
    'thomvest': 'thomvest.com', 'thomvest ventures': 'thomvest.com',
    'canaan': 'canaan.com', 'canaan partners': 'canaan.com',
    'matrix partners': 'matrixpartners.com', 'matrix': 'matrixpartners.com',
    'social capital': 'socialcapital.com', 'chamath': 'socialcapital.com',
    'capital g': 'capitalg.com', 'capitalg': 'capitalg.com',
    'a* capital': 'astarcapital.com', 'a*': 'astarcapital.com',
    'durable capital': 'durablecapital.com', 'durable': 'durablecapital.com',
    'owl rock': 'owlrock.com', 'owl rock capital': 'owlrock.com',
    'sapphire ventures': 'sapphireventures.com', 'sapphire': 'sapphireventures.com',
    'jmi equity': 'jmi.com', 'jmi': 'jmi.com',
    'summit partners': 'summitpartners.com', 'summit': 'summitpartners.com',
    'ta associates': 'ta.com', 'ta': 'ta.com',
    'francisco partners': 'franciscopartners.com',
    'clearlake': 'clearlake.com', 'clearlake capital': 'clearlake.com',
    'hellman & friedman': 'hf.com', 'h&f': 'hf.com',
    'permira': 'permira.com',
    'apax': 'apax.com', 'apax partners': 'apax.com',
    'advent international': 'adventinternational.com', 'advent': 'adventinternational.com',
    'cinven': 'cinven.com',
    'cvc capital': 'cvc.com', 'cvc': 'cvc.com',
    'eqt': 'eqtgroup.com', 'eqt partners': 'eqtgroup.com',
    'goldentree': 'goldentree.com',
    'providence equity': 'provequity.com', 'providence': 'provequity.com',
    'regent': 'regentlp.com',
    'riverside': 'riversidecompany.com', 'riverside company': 'riversidecompany.com',
    'roark capital': 'roarkcapital.com', 'roark': 'roarkcapital.com',
    'srs investment': 'srsinv.com', 'srs': 'srsinv.com',
    'stripes': 'stripes.co', 'stripes group': 'stripes.co',
    'susquehanna': 'sig.com', 'sig': 'sig.com',
    'two sigma': 'twosigma.com',
    'viking global': 'vikingglobal.com', 'viking': 'vikingglobal.com',
    'winslow capital': 'winslowcapital.com', 'winslow': 'winslowcapital.com',
    'founders circle': 'founderscircle.com',
    'glynn capital': 'glynncapital.com', 'glynn': 'glynncapital.com',
    'ifc': 'ifc.org',
    'jp morgan growth equity': 'jpmorgan.com',
    'morgan stanley expansion capital': 'morganstanley.com',
    'goldman growth equity': 'goldmansachs.com',
    'mubadala': 'mubadala.com',
    'qatar investment authority': 'qia.qa', 'qia': 'qia.qa',
    'temasek': 'temasek.com.sg',
    'adia': 'adia.ae', 'abu dhabi investment': 'adia.ae',
    'gic': 'gic.com.sg',
    'khazanah': 'khazanah.com.my',
    'saudi aramco ventures': 'aramco.com', 'aramco': 'aramco.com',
    'rakuten': 'rakuten.com',
    'mirae asset': 'miraeasset.com',
    'sbi': 'sbigroup.co.jp',
    'softbank latin america': 'softbank.com',
    'springboard': 'sb.co', 'springboard enterprises': 'sb.co',
    'streamlined ventures': 'streamlined.vc',
    'svb capital': 'svb.com',
    'techstars': 'techstars.com',
    '500 global': '500.co', '500 startups': '500.co',
    'plug and play': 'plugandplaytechcenter.com',
    // Big Tech & Major Acquirers
    'google': 'google.com', 'alphabet': 'abc.xyz', 'microsoft': 'microsoft.com',
    'amazon': 'amazon.com', 'aws': 'amazon.com', 'amazon web services': 'amazon.com',
    'apple': 'apple.com', 'meta': 'meta.com', 'facebook': 'meta.com', 'instagram': 'instagram.com', 'whatsapp': 'whatsapp.com',
    'nvidia': 'nvidia.com', 'intel': 'intel.com', 'amd': 'amd.com',
    'ibm': 'ibm.com', 'oracle': 'oracle.com', 'sap': 'sap.com',
    'cisco': 'cisco.com', 'dell': 'dell.com', 'hp': 'hp.com', 'hpe': 'hpe.com', 'hewlett packard': 'hpe.com',
    'qualcomm': 'qualcomm.com', 'broadcom': 'broadcom.com', 'marvell': 'marvell.com',
    'tencent': 'tencent.com', 'alibaba': 'alibaba.com', 'baidu': 'baidu.com', 'bytedance': 'bytedance.com', 'jd': 'jd.com', 'jd.com': 'jd.com',
    'samsung': 'samsung.com', 'sony': 'sony.com', 'lg': 'lg.com', 'panasonic': 'panasonic.com',
    'tesla': 'tesla.com', 'spacex': 'spacex.com',
    'siemens': 'siemens.com', 'bosch': 'bosch.com', 'ge': 'ge.com', 'general electric': 'ge.com',
    'honeywell': 'honeywell.com', 'caterpillar': 'caterpillar.com', '3m': '3m.com',
    'lockheed martin': 'lockheedmartin.com', 'lockheed': 'lockheedmartin.com',
    'northrop grumman': 'northropgrumman.com', 'raytheon': 'rtx.com', 'boeing': 'boeing.com',
    'general dynamics': 'gd.com', 'bae systems': 'baesystems.com',
    // AI Companies
    'openai': 'openai.com', 'anthropic': 'anthropic.com', 'deepmind': 'deepmind.com', 'google deepmind': 'deepmind.com',
    'cohere': 'cohere.com', 'stability ai': 'stability.ai', 'stability': 'stability.ai',
    'hugging face': 'huggingface.co', 'huggingface': 'huggingface.co',
    'midjourney': 'midjourney.com', 'runway': 'runwayml.com', 'runway ml': 'runwayml.com',
    'jasper': 'jasper.ai', 'jasper ai': 'jasper.ai',
    'copy.ai': 'copy.ai', 'writer': 'writer.com',
    'inflection': 'inflection.ai', 'inflection ai': 'inflection.ai',
    'character.ai': 'character.ai', 'character ai': 'character.ai',
    'perplexity': 'perplexity.ai', 'perplexity ai': 'perplexity.ai',
    'mistral': 'mistral.ai', 'mistral ai': 'mistral.ai',
    'adept': 'adept.ai', 'adept ai': 'adept.ai',
    'ai21': 'ai21.com', 'ai21 labs': 'ai21.com',
    'together ai': 'together.ai', 'together': 'together.ai',
    'anyscale': 'anyscale.com', 'mosaic ml': 'mosaicml.com', 'mosaicml': 'mosaicml.com',
    'scale ai': 'scale.com', 'scale': 'scale.com',
    'labelbox': 'labelbox.com', 'snorkel': 'snorkel.ai', 'snorkel ai': 'snorkel.ai',
    'weights & biases': 'wandb.ai', 'wandb': 'wandb.ai',
    'huggingface': 'huggingface.co', 'replicate': 'replicate.com',
    'descript': 'descript.com', 'synthesia': 'synthesia.io',
    'heygen': 'heygen.com', 'eleven labs': 'elevenlabs.io', 'elevenlabs': 'elevenlabs.io',
    'glean': 'glean.com', 'moveworks': 'moveworks.com',
    // SaaS Giants
    'salesforce': 'salesforce.com', 'adobe': 'adobe.com',
    'servicenow': 'servicenow.com', 'workday': 'workday.com',
    'snowflake': 'snowflake.com', 'databricks': 'databricks.com',
    'palantir': 'palantir.com', 'splunk': 'splunk.com',
    'datadog': 'datadoghq.com', 'elastic': 'elastic.co', 'elasticsearch': 'elastic.co',
    'mongodb': 'mongodb.com', 'redis': 'redis.com', 'cockroachdb': 'cockroachlabs.com', 'cockroach labs': 'cockroachlabs.com',
    'confluent': 'confluent.io', 'hashicorp': 'hashicorp.com',
    'crowdstrike': 'crowdstrike.com', 'palo alto networks': 'paloaltonetworks.com', 'palo alto': 'paloaltonetworks.com',
    'zscaler': 'zscaler.com', 'fortinet': 'fortinet.com', 'sentinelone': 'sentinelone.com',
    'okta': 'okta.com', 'cloudflare': 'cloudflare.com', 'fastly': 'fastly.com',
    'twilio': 'twilio.com', 'sendgrid': 'sendgrid.com',
    'hubspot': 'hubspot.com', 'zendesk': 'zendesk.com',
    'freshworks': 'freshworks.com', 'intercom': 'intercom.com',
    'atlassian': 'atlassian.com', 'jira': 'atlassian.com', 'confluence': 'atlassian.com',
    'slack': 'slack.com', 'zoom': 'zoom.us', 'teams': 'microsoft.com', 'webex': 'webex.com',
    'notion': 'notion.so', 'airtable': 'airtable.com', 'coda': 'coda.io',
    'asana': 'asana.com', 'monday': 'monday.com', 'monday.com': 'monday.com', 'clickup': 'clickup.com',
    'figma': 'figma.com', 'canva': 'canva.com', 'miro': 'miro.com', 'invision': 'invisionapp.com',
    'gitlab': 'gitlab.com', 'github': 'github.com', 'bitbucket': 'bitbucket.org',
    'vercel': 'vercel.com', 'netlify': 'netlify.com', 'heroku': 'heroku.com',
    'supabase': 'supabase.com', 'planetscale': 'planetscale.com', 'neon': 'neon.tech',
    'retool': 'retool.com', 'appsmith': 'appsmith.com',
    // Sales & Marketing
    'gong': 'gong.io', 'outreach': 'outreach.io', 'salesloft': 'salesloft.com',
    'clari': 'clari.com', 'chorus': 'chorus.ai', 'people.ai': 'people.ai',
    'zoominfo': 'zoominfo.com', 'apollo': 'apollo.io', 'clearbit': 'clearbit.com',
    'lusha': 'lusha.com', 'seamless.ai': 'seamless.ai', 'cognism': 'cognism.com',
    '6sense': '6sense.com', 'bombora': 'bombora.com', 'demandbase': 'demandbase.com',
    'drift': 'drift.com', 'qualified': 'qualified.com', 'calendly': 'calendly.com', 'chili piper': 'chilipiper.com',
    'marketo': 'marketo.com', 'pardot': 'salesforce.com', 'mailchimp': 'mailchimp.com',
    'klaviyo': 'klaviyo.com', 'braze': 'braze.com', 'iterable': 'iterable.com',
    'customer.io': 'customer.io', 'sendbird': 'sendbird.com',
    'highspot': 'highspot.com', 'seismic': 'seismic.com', 'showpad': 'showpad.com',
    'vidyard': 'vidyard.com', 'loom': 'loom.com',
    // HR Tech
    'eightfold': 'eightfold.ai', 'phenom': 'phenom.com',
    'seekout': 'seekout.com', 'hireez': 'hireez.com', 'beamery': 'beamery.com',
    'gem': 'gem.com', 'lever': 'lever.co', 'greenhouse': 'greenhouse.io',
    'rippling': 'rippling.com', 'gusto': 'gusto.com', 'deel': 'deel.com', 'remote': 'remote.com',
    'lattice': 'lattice.com', 'culture amp': 'cultureamp.com', '15five': '15five.com',
    'namely': 'namely.com', 'bamboohr': 'bamboohr.com', 'paylocity': 'paylocity.com',
    'adp': 'adp.com', 'paychex': 'paychex.com', 'ceridian': 'ceridian.com',
    'cornerstone': 'cornerstoneondemand.com', 'saba': 'saba.com',
    // Consumer & Social
    'uber': 'uber.com', 'lyft': 'lyft.com', 'doordash': 'doordash.com', 'grubhub': 'grubhub.com',
    'instacart': 'instacart.com', 'airbnb': 'airbnb.com', 'vrbo': 'vrbo.com',
    'stripe': 'stripe.com', 'square': 'squareup.com', 'block': 'block.xyz', 'paypal': 'paypal.com', 'venmo': 'venmo.com',
    'shopify': 'shopify.com', 'bigcommerce': 'bigcommerce.com', 'woocommerce': 'woocommerce.com',
    'spotify': 'spotify.com', 'netflix': 'netflix.com', 'disney': 'disney.com', 'disney+': 'disneyplus.com', 'hulu': 'hulu.com',
    'hbo': 'hbo.com', 'hbo max': 'max.com', 'paramount': 'paramount.com', 'peacock': 'peacocktv.com',
    'twitter': 'x.com', 'x': 'x.com', 'linkedin': 'linkedin.com',
    'tiktok': 'tiktok.com', 'snap': 'snap.com', 'snapchat': 'snap.com',
    'pinterest': 'pinterest.com', 'reddit': 'reddit.com', 'discord': 'discord.com',
    'dropbox': 'dropbox.com', 'box': 'box.com', 'google drive': 'google.com',
    'robinhood': 'robinhood.com', 'coinbase': 'coinbase.com', 'binance': 'binance.com', 'kraken': 'kraken.com',
    'chime': 'chime.com', 'sofi': 'sofi.com', 'affirm': 'affirm.com', 'klarna': 'klarna.com',
    // Enterprise & Professional Services
    'accenture': 'accenture.com', 'deloitte': 'deloitte.com', 'capgemini': 'capgemini.com', 'infosys': 'infosys.com', 'tcs': 'tcs.com', 'wipro': 'wipro.com', 'cognizant': 'cognizant.com',
    'mckinsey': 'mckinsey.com', 'bcg': 'bcg.com', 'bain': 'bain.com', 'bain & company': 'bain.com',
    'pwc': 'pwc.com', 'ey': 'ey.com', 'kpmg': 'kpmg.com',
    'vmware': 'vmware.com', 'nutanix': 'nutanix.com', 'citrix': 'citrix.com',
    'autodesk': 'autodesk.com', 'ansys': 'ansys.com', 'ptc': 'ptc.com', 'dassault': 'dassault.com', 'dassault systemes': '3ds.com',
    'procore': 'procore.com', 'veeva': 'veeva.com',
    'new relic': 'newrelic.com', 'pendo': 'pendo.io', 'amplitude': 'amplitude.com',
    'mixpanel': 'mixpanel.com', 'heap': 'heap.io', 'fullstory': 'fullstory.com', 'hotjar': 'hotjar.com',
    'segment': 'segment.com', 'mparticle': 'mparticle.com', 'rudderstack': 'rudderstack.com',
    'qualtrics': 'qualtrics.com', 'medallia': 'medallia.com', 'surveymonkey': 'surveymonkey.com',
    'docusign': 'docusign.com', 'conga': 'conga.com', 'pandadoc': 'pandadoc.com',
    'coupa': 'coupa.com', 'ariba': 'ariba.com', 'jaggaer': 'jaggaer.com',
    'anaplan': 'anaplan.com', 'planful': 'planful.com', 'vena': 'venasolutions.com',
    // Finance & Banking
    'goldman sachs': 'goldmansachs.com', 'goldman': 'goldmansachs.com',
    'jpmorgan': 'jpmorgan.com', 'jp morgan': 'jpmorgan.com', 'chase': 'chase.com', 'jpmorgan chase': 'jpmorganchase.com',
    'morgan stanley': 'morganstanley.com',
    'bank of america': 'bankofamerica.com', 'bofa': 'bankofamerica.com',
    'citi': 'citi.com', 'citibank': 'citi.com', 'citigroup': 'citigroup.com',
    'wells fargo': 'wellsfargo.com',
    'capital one': 'capitalone.com',
    'american express': 'americanexpress.com', 'amex': 'americanexpress.com',
    'visa': 'visa.com', 'mastercard': 'mastercard.com', 'discover': 'discover.com',
    'plaid': 'plaid.com', 'marqeta': 'marqeta.com', 'lithic': 'lithic.com',
    'intuit': 'intuit.com', 'quickbooks': 'quickbooks.intuit.com', 'turbotax': 'turbotax.intuit.com',
    'sage': 'sage.com', 'xero': 'xero.com', 'freshbooks': 'freshbooks.com',
    'bill.com': 'bill.com', 'bill': 'bill.com', 'expensify': 'expensify.com',
    'brex': 'brex.com', 'ramp': 'ramp.com', 'divvy': 'divvy.com',
    'mercury': 'mercury.com', 'mercury bank': 'mercury.com',
    'carta': 'carta.com', 'pulley': 'pulley.com', 'shareworks': 'shareworks.com',
    'bloomberg': 'bloomberg.com', 'reuters': 'reuters.com', 'refinitiv': 'refinitiv.com',
    'morningstar': 'morningstar.com', 's&p': 'spglobal.com', 's&p global': 'spglobal.com', 'moodys': 'moodys.com',
    'charles schwab': 'schwab.com', 'schwab': 'schwab.com', 'fidelity': 'fidelity.com', 'td ameritrade': 'tdameritrade.com',
    'state street': 'statestreet.com', 'northern trust': 'northerntrust.com', 'bny mellon': 'bnymellon.com',
    'ubs': 'ubs.com', 'credit suisse': 'credit-suisse.com', 'deutsche bank': 'db.com', 'barclays': 'barclays.com', 'hsbc': 'hsbc.com',
    // Healthcare & Life Sciences
    'cvs': 'cvshealth.com', 'cvs health': 'cvshealth.com', 'walgreens': 'walgreens.com',
    'johnson & johnson': 'jnj.com', 'j&j': 'jnj.com', 'jnj': 'jnj.com',
    'pfizer': 'pfizer.com', 'moderna': 'modernatx.com', 'biontech': 'biontech.com',
    'merck': 'merck.com', 'abbvie': 'abbvie.com', 'bristol-myers squibb': 'bms.com', 'bms': 'bms.com',
    'eli lilly': 'lilly.com', 'lilly': 'lilly.com', 'novartis': 'novartis.com', 'roche': 'roche.com', 'astrazeneca': 'astrazeneca.com', 'gsk': 'gsk.com', 'sanofi': 'sanofi.com',
    'amgen': 'amgen.com', 'gilead': 'gilead.com', 'regeneron': 'regeneron.com', 'biogen': 'biogen.com', 'vertex': 'vrtx.com',
    'unitedhealth': 'uhc.com', 'unitedhealthcare': 'uhc.com', 'uhg': 'unitedhealthgroup.com',
    'anthem': 'anthem.com', 'elevance': 'elevancehealth.com', 'cigna': 'cigna.com', 'humana': 'humana.com', 'aetna': 'aetna.com',
    'kaiser': 'kaiserpermanente.org', 'kaiser permanente': 'kaiserpermanente.org',
    'epic': 'epic.com', 'epic systems': 'epic.com', 'cerner': 'cerner.com', 'medidata': 'medidata.com',
    'tempus': 'tempus.com', 'flatiron': 'flatiron.com', 'veracyte': 'veracyte.com',
    'illumina': 'illumina.com', 'thermo fisher': 'thermofisher.com', 'danaher': 'danaher.com',
    'medtronic': 'medtronic.com', 'abbott': 'abbott.com', 'boston scientific': 'bostonscientific.com',
    // Retail & E-commerce
    'walmart': 'walmart.com', 'target': 'target.com', 'costco': 'costco.com', 'kroger': 'kroger.com',
    'ebay': 'ebay.com', 'etsy': 'etsy.com', 'wayfair': 'wayfair.com',
    "lowe's": 'lowes.com', 'lowes': 'lowes.com', 'home depot': 'homedepot.com', 'the home depot': 'homedepot.com',
    'nike': 'nike.com', 'adidas': 'adidas.com', 'under armour': 'underarmour.com', 'lululemon': 'lululemon.com',
    'gap': 'gap.com', 'hm': 'hm.com', 'h&m': 'hm.com', 'zara': 'zara.com', 'uniqlo': 'uniqlo.com',
    'starbucks': 'starbucks.com', 'mcdonalds': 'mcdonalds.com', "mcdonald's": 'mcdonalds.com', 'chipotle': 'chipotle.com',
    'expedia': 'expedia.com', 'booking': 'booking.com', 'booking.com': 'booking.com', 'priceline': 'priceline.com', 'tripadvisor': 'tripadvisor.com',
    'hilton': 'hilton.com', 'marriott': 'marriott.com', 'hyatt': 'hyatt.com', 'ihg': 'ihg.com',
    'delta': 'delta.com', 'united': 'united.com', 'united airlines': 'united.com', 'american airlines': 'aa.com', 'southwest': 'southwest.com',
    'ford': 'ford.com', 'gm': 'gm.com', 'general motors': 'gm.com', 'toyota': 'toyota.com', 'honda': 'honda.com', 'volkswagen': 'vw.com', 'vw': 'vw.com', 'bmw': 'bmw.com', 'mercedes': 'mercedes-benz.com', 'audi': 'audi.com',
    'rivian': 'rivian.com', 'lucid': 'lucidmotors.com', 'nio': 'nio.com', 'xpeng': 'xpeng.com', 'byd': 'byd.com',
    // Telecom & Media
    'att': 'att.com', 'at&t': 'att.com', 'verizon': 'verizon.com', 't-mobile': 't-mobile.com', 'tmobile': 't-mobile.com',
    'comcast': 'comcast.com', 'charter': 'charter.com', 'spectrum': 'spectrum.com',
    'warner bros': 'warnerbros.com', 'warner': 'warnerbros.com', 'nbcuniversal': 'nbcuniversal.com', 'nbc': 'nbc.com',
    'fox': 'fox.com', 'cbs': 'cbs.com', 'abc': 'abc.com',
    'new york times': 'nytimes.com', 'nyt': 'nytimes.com', 'washington post': 'washingtonpost.com', 'wsj': 'wsj.com', 'wall street journal': 'wsj.com',
    // More Tech & Infrastructure
    'cloudflare': 'cloudflare.com', 'akamai': 'akamai.com', 'digitalocean': 'digitalocean.com', 'linode': 'linode.com',
    'equinix': 'equinix.com', 'digital realty': 'digitalrealty.com',
    'arista': 'arista.com', 'juniper': 'juniper.net', 'f5': 'f5.com',
    'pagerduty': 'pagerduty.com', 'opsgenie': 'opsgenie.com', 'victorops': 'victorops.com',
    'snyk': 'snyk.io', 'veracode': 'veracode.com', 'checkmarx': 'checkmarx.com',
    'wiz': 'wiz.io', 'orca': 'orca.security', 'lacework': 'lacework.com',
    'sumo logic': 'sumologic.com', 'dynatrace': 'dynatrace.com', 'appdynamics': 'appdynamics.com',
    'uipath': 'uipath.com', 'automation anywhere': 'automationanywhere.com', 'blue prism': 'blueprism.com',
    'celonis': 'celonis.com', 'signavio': 'signavio.com',
    'alteryx': 'alteryx.com', 'tableau': 'tableau.com', 'looker': 'looker.com', 'thoughtspot': 'thoughtspot.com', 'domo': 'domo.com', 'sisense': 'sisense.com',
    'fivetran': 'fivetran.com', 'airbyte': 'airbyte.com', 'stitch': 'stitchdata.com', 'matillion': 'matillion.com',
    'dbt labs': 'getdbt.com', 'dbt': 'getdbt.com',
    'dataiku': 'dataiku.com', 'domino': 'dominodatalab.com', 'h2o': 'h2o.ai', 'h2o.ai': 'h2o.ai',
    'c3 ai': 'c3.ai', 'c3.ai': 'c3.ai', 'datarobot': 'datarobot.com',
    'samsara': 'samsara.com', 'project44': 'project44.com', 'flexport': 'flexport.com',
    // Gaming
    'activision': 'activision.com', 'blizzard': 'blizzard.com', 'activision blizzard': 'activisionblizzard.com',
    'ea': 'ea.com', 'electronic arts': 'ea.com', 'take-two': 'take2games.com', 'rockstar': 'rockstargames.com',
    'epic games': 'epicgames.com', 'epic': 'epicgames.com', 'unity': 'unity.com',
    'roblox': 'roblox.com', 'riot games': 'riotgames.com', 'riot': 'riotgames.com',
    'valve': 'valvesoftware.com', 'steam': 'steampowered.com',
    'nintendo': 'nintendo.com', 'playstation': 'playstation.com', 'xbox': 'xbox.com',
    // More Enterprise
    'sap': 'sap.com', 'teradata': 'teradata.com', 'informatica': 'informatica.com', 'talend': 'talend.com',
    'tibco': 'tibco.com', 'mulesoft': 'mulesoft.com', 'boomi': 'boomi.com', 'workato': 'workato.com', 'tray.io': 'tray.io', 'zapier': 'zapier.com', 'make': 'make.com',
    'contentful': 'contentful.com', 'sanity': 'sanity.io', 'strapi': 'strapi.io',
    'algolia': 'algolia.com', 'elastic': 'elastic.co', 'typesense': 'typesense.org',
    'auth0': 'auth0.com', 'onelogin': 'onelogin.com', 'ping identity': 'pingidentity.com',
    'launchdarkly': 'launchdarkly.com', 'split': 'split.io', 'optimizely': 'optimizely.com',
    'circleci': 'circleci.com', 'travis ci': 'travis-ci.com', 'jenkins': 'jenkins.io',
    'jfrog': 'jfrog.com', 'sonatype': 'sonatype.com',
    'postman': 'postman.com', 'insomnia': 'insomnia.rest', 'swagger': 'swagger.io',
    'sentry': 'sentry.io', 'rollbar': 'rollbar.com', 'bugsnag': 'bugsnag.com',
    'linear': 'linear.app', 'shortcut': 'shortcut.com', 'height': 'height.app',
    // Additional VCs & Investment
    'crv': 'crv.com', 'charles river ventures': 'crv.com',
    'sapphire ventures': 'sapphireventures.com', 'sapphire': 'sapphireventures.com',
    'signalfire': 'signalfire.com', 'tcv': 'tcv.com', 'temasek': 'temasek.com.sg',
    'salesforce ventures': 'salesforceventures.com', 'sequoia india': 'sequoiacap.com',
    'scale venture partners': 'scalevp.com', 'georgian partners': 'georgian.io',
    // Media & News
    'thomson reuters': 'thomsonreuters.com', 'reuters': 'reuters.com',
    // Industrial & Manufacturing
    'john deere': 'deere.com', 'deere': 'deere.com',
    'cargill': 'cargill.com', 'syngenta': 'syngenta.com',
    'abb': 'abb.com', 'trimble': 'trimble.com',
    'caterpillar': 'caterpillar.com', 'komatsu': 'komatsu.com',
    // Defense & Aerospace
    'l3harris': 'l3harris.com', 'l3 harris': 'l3harris.com',
    'general dynamics': 'gd.com', 'bae': 'baesystems.com',
    'leidos': 'leidos.com', 'saic': 'saic.com', 'booz allen': 'boozallen.com',
    'palantir': 'palantir.com', 'anduril': 'anduril.com',
    // Real Estate & Construction
    'costar': 'costar.com', 'costar group': 'costar.com',
    'procore': 'procore.com', 'openspace': 'openspace.ai',
    'buildertrend': 'buildertrend.com', 'autodesk': 'autodesk.com',
    // Enterprise Software (more)
    'nice': 'nice.com', 'nice systems': 'nice.com',
    'genesys': 'genesys.com', 'five9': 'five9.com', 'talkdesk': 'talkdesk.com',
    'coveo': 'coveo.com', 'lucidworks': 'lucidworks.com',
    'bloomreach': 'bloomreach.com', 'contentstack': 'contentstack.com',
    'hyperscience': 'hyperscience.com', 'abbyy': 'abbyy.com',
    'kofax': 'kofax.com', 'appian': 'appian.com', 'pegasystems': 'pega.com', 'pega': 'pega.com',
    'informatica': 'informatica.com', 'talend': 'talend.com',
    'sap concur': 'concur.com', 'concur': 'concur.com',
    'workato': 'workato.com', 'tray': 'tray.io',
    // Insurance & Fintech
    'lemonade': 'lemonade.com', 'root': 'root.com', 'root insurance': 'root.com',
    'hippo': 'hippo.com', 'next insurance': 'nextinsurance.com',
    'bill': 'bill.com', 'bill.com': 'bill.com',
    // Biotech & Life Sciences
    'recursion': 'recursion.com', 'recursion pharma': 'recursion.com',
    'insitro': 'insitro.com', 'tempus': 'tempus.com',
    'schrodinger': 'schrodinger.com', 'exscientia': 'exscientia.ai',
    'relay therapeutics': 'relaytx.com', 'vir': 'vir.bio',
    // AI Music & Audio
    'suno': 'suno.ai', 'suno ai': 'suno.ai',
    'udio': 'udio.com', 'soundraw': 'soundraw.io',
    'mubert': 'mubert.com', 'boomy': 'boomy.com',
    // AI Dev Tools
    'langchain': 'langchain.com', 'llamaindex': 'llamaindex.ai',
    'cursor': 'cursor.sh', 'replit': 'replit.com',
    'github copilot': 'github.com', 'tabnine': 'tabnine.com',
    'codeium': 'codeium.com', 'sourcegraph': 'sourcegraph.com',
    // Space & Autonomous
    'planet': 'planet.com', 'planet labs': 'planet.com',
    'tusimple': 'tusimple.com', 'aurora': 'aurora.tech', 'aurora innovation': 'aurora.tech',
    'waymo': 'waymo.com', 'cruise': 'getcruise.com', 'argo ai': 'argo.ai',
    'mobileye': 'mobileye.com', 'aptiv': 'aptiv.com',
    'figure': 'figure.ai', 'figure ai': 'figure.ai',
    'boston dynamics': 'bostondynamics.com',
    // Testing & QA
    'sauce labs': 'saucelabs.com', 'browserstack': 'browserstack.com',
    'lambdatest': 'lambdatest.com', 'mabl': 'mabl.com',
    // Health Tech
    'teladoc': 'teladoc.com', 'amwell': 'amwell.com',
    'hims': 'hims.com', 'ro': 'ro.co', 'nurx': 'nurx.com',
    'oscar': 'hioscar.com', 'oscar health': 'hioscar.com',
    'devoted health': 'devoted.com', 'clover health': 'cloverhealth.com',
    // Retail Beauty
    'sephora': 'sephora.com', 'ulta': 'ulta.com',
    'warby parker': 'warbyparker.com', 'glossier': 'glossier.com',
    // Travel & Hospitality
    'amadeus': 'amadeus.com', 'sabre': 'sabre.com', 'travelport': 'travelport.com',
    // More Consumer
    'duolingo': 'duolingo.com', 'calm': 'calm.com', 'headspace': 'headspace.com',
    'peloton': 'onepeloton.com', 'whoop': 'whoop.com',
    'oura': 'ouraring.com', 'fitbit': 'fitbit.com',
    // CPG & Food
    'nestle': 'nestle.com', 'unilever': 'unilever.com',
    'pepsico': 'pepsico.com', 'coca-cola': 'coca-colacompany.com', 'coca cola': 'coca-colacompany.com',
    'kraft': 'kraftheinzcompany.com', 'kraft heinz': 'kraftheinzcompany.com',
    'general mills': 'generalmills.com', 'kellogg': 'kelloggcompany.com', "kellogg's": 'kelloggcompany.com',
    'mondelez': 'mondelezinternational.com', 'danone': 'danone.com',
    // Pharma (more)
    'takeda': 'takeda.com', 'bms': 'bms.com', 'bristol myers': 'bms.com',
    'boehringer': 'boehringer-ingelheim.com', 'boehringer ingelheim': 'boehringer-ingelheim.com',
    'teva': 'tevapharm.com', 'mylan': 'viatris.com', 'viatris': 'viatris.com',
    // Energy
    'exxon': 'exxonmobil.com', 'exxonmobil': 'exxonmobil.com',
    'chevron': 'chevron.com', 'shell': 'shell.com', 'bp': 'bp.com',
    'conocophillips': 'conocophillips.com', 'schlumberger': 'slb.com',
    'halliburton': 'halliburton.com', 'baker hughes': 'bakerhughes.com',
    // Utilities
    'duke energy': 'duke-energy.com', 'dominion': 'dominionenergy.com',
    'nextera': 'nexteraenergy.com', 'southern company': 'southerncompany.com',
    // More Enterprise
    'sprinklr': 'sprinklr.com', 'sproutsocial': 'sproutsocial.com', 'sprout social': 'sproutsocial.com',
    'hootsuite': 'hootsuite.com', 'buffer': 'buffer.com',
    'new relic': 'newrelic.com', 'newrelic': 'newrelic.com',
    // Education
    'coursera': 'coursera.org', 'udemy': 'udemy.com', 'udacity': 'udacity.com',
    'chegg': 'chegg.com', 'instructure': 'instructure.com',
    'canvas': 'instructure.com', 'blackboard': 'blackboard.com',
    'pearson': 'pearson.com', 'mcgraw hill': 'mheducation.com',
    'guild education': 'guildeducation.com', 'guild': 'guildeducation.com',
    // More AI
    'forethought': 'forethought.ai', 'ultimate.ai': 'ultimate.ai',
    'ada': 'ada.cx', 'ada support': 'ada.cx',
    'espressive': 'espressive.com', 'moveworks': 'moveworks.com',
    'fireflies': 'fireflies.ai', 'fireflies.ai': 'fireflies.ai',
    'grain': 'grain.com', 'avoma': 'avoma.com',
    'rev': 'rev.com', 'rev.ai': 'rev.ai',
    'insightsquared': 'insightsquared.com',
    'harver': 'harver.com', 'hirevue': 'hirevue.com',
    'paradox': 'paradox.ai', 'olivia': 'paradox.ai',
    'smartrecruiters': 'smartrecruiters.com', 'icims': 'icims.com',
    'jobvite': 'jobvite.com', 'workable': 'workable.com',
    'avature': 'avature.net', 'fuel50': 'fuel50.com',
    'textio': 'textio.com', 'hemingway': 'hemingwayapp.com',
    'grammarly': 'grammarly.com', 'writer': 'writer.com',
    // Universities & Research
    'stanford': 'stanford.edu', 'mit': 'mit.edu', 'berkeley': 'berkeley.edu',
    'cmu': 'cmu.edu', 'carnegie mellon': 'cmu.edu',
    'harvard': 'harvard.edu', 'ucla': 'ucla.edu', 'caltech': 'caltech.edu',
    // Additional companies from the data
    'paychex': 'paychex.com', 'newell brands': 'newellbrands.com', "wendy's": 'wendys.com', 'wendys': 'wendys.com',
    "mcdonald's": 'mcdonalds.com', 'cvs health': 'cvshealth.com',
    'vodafone': 'vodafone.com', 'vmware': 'vmware.com',
    'american express': 'americanexpress.com', 'sony': 'sony.com',
    'abbott': 'abbott.com', 'schneider electric': 'se.com', 'schneider': 'se.com',
    'novartis': 'novartis.com', 'mastercard': 'mastercard.com',
    'southwest airlines': 'southwest.com', 'southwest': 'southwest.com',
    'micron': 'micron.com', 'nutanix': 'nutanix.com',
    'bayer': 'bayer.com', 'dropbox': 'dropbox.com',
    'qualtrics': 'qualtrics.com', 'intercom': 'intercom.com',
    'lyft': 'lyft.com', 'expedia': 'expedia.com', 'nike': 'nike.com',
    'hilton': 'hilton.com', 'booking.com': 'booking.com'
};

function getLogoDomain(name) {
    if (!name) return null;
    const lower = name.toLowerCase().trim();
    return domainMap[lower] || null; // Only return if in map, don't guess
}

function renderLogoChips(text, colorClass = '', type = '') {
    if (!text) return '';
    const items = text.split(',').map(s => s.trim()).filter(s => s);
    const unique = [...new Set(items.map(i => i.toLowerCase()))];
    return unique.slice(0, 12).map(item => {
        const domain = getLogoDomain(item);
        const displayName = items.find(i => i.toLowerCase() === item) || item;
        const logoHtml = domain
            ? `<img src="https://logo.clearbit.com/${domain}" alt="" style="width:24px;height:24px;border-radius:50%;background:#fff;object-fit:contain;" onerror="this.style.display='none'">`
            : '';
        const isInvestor = type === 'investors';
        const clickHandler = isInvestor ? `onclick="event.preventDefault();event.stopPropagation();openInvestorModal('${displayName.replace(/'/g, "\\'")}');"` : '';
        const href = domain ? `https://${domain}` : `https://www.google.com/search?q=${encodeURIComponent(displayName)}`;
        const cursorStyle = isInvestor ? 'cursor:pointer;' : '';
        return `
            <a href="${isInvestor ? '#' : href}" ${isInvestor ? '' : 'target="_blank"'} ${clickHandler} style="display:inline-flex;align-items:center;gap:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:20px;padding:6px 12px 6px ${domain ? '6px' : '12px'};margin:2px;text-decoration:none;transition:all 0.2s;color:#fff !important;${cursorStyle}" onmouseover="this.style.borderColor='var(--accent-cyan)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border)';this.style.transform='none'">
                ${logoHtml}
                <span style="font-size:13px;color:#aaa !important;">${displayName}</span>
            </a>
        `;
    }).join('');
}

// ==================== MODAL ====================
function openModal(id) {
    currentCompany = companies.find(c => c.id === id);
    if (!currentCompany) return;

    const isFav = favorites.includes(id);
    const companyIsUnicorn = isUnicorn(currentCompany);
    const companyIsMaTarget = isMaTarget(currentCompany);

    // Update title with badges inline
    const badges = [];
    if (companyIsUnicorn) badges.push('<span class="modal-badge badge-unicorn"> Unicorn</span>');
    if (companyIsMaTarget) badges.push('<span class="modal-badge badge-ma-target"> M&A Target</span>');

    document.getElementById('modalTitle').innerHTML = `
        ${currentCompany.name}
        ${badges.length ? `<span class="title-badges">${badges.join('')}</span>` : ''}
    `;

    const logoUrl = `https://logo.clearbit.com/${currentCompany.website}`;
    const fallbackLogo = `https://www.google.com/s2/favicons?domain=${currentCompany.website}&sz=128`;

    document.getElementById('modalBody').innerHTML = `
        <div class="modal-section" style="display:flex;gap:16px;align-items:flex-start;">
            <img src="${logoUrl}" alt="${currentCompany.name}"
                 style="width:64px;height:64px;border-radius:12px;background:var(--bg-primary);object-fit:contain;flex-shrink:0;"
                 onerror="this.src='${fallbackLogo}';this.style.padding='8px';">
            <div>
                <div style="color:var(--accent-cyan);font-size:13px;margin-bottom:6px;">${currentCompany.product || ''}</div>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom:10px;">${currentCompany.description || ''}</p>
                ${currentCompany.secretSauce ? `<p style="color: var(--gold); font-size:13px; line-height: 1.5;"><strong>Secret Sauce:</strong> ${currentCompany.secretSauce}</p>` : ''}
            </div>
        </div>

        <div class="modal-section">
            <div class="modal-section-title">Key Metrics</div>
            <div class="modal-grid">
                <div class="modal-stat">
                    <div class="modal-stat-label">Founded</div>
                    <div class="modal-stat-value">${currentCompany.founded}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Total Funding</div>
                    <div class="modal-stat-value">${currentCompany.funding}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Valuation</div>
                    <div class="modal-stat-value">${currentCompany.valuation || 'Private'}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Est. Revenue</div>
                    <div class="modal-stat-value">${currentCompany.revenue || 'N/A'}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Employees</div>
                    <div class="modal-stat-value">${currentCompany.employees}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Headquarters</div>
                    <div class="modal-stat-value">${currentCompany.hq}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">CEO/Founder</div>
                    <div class="modal-stat-value">${currentCompany.ceo}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Last Round</div>
                    <div class="modal-stat-value">${currentCompany.lastRound || 'N/A'}</div>
                </div>
            </div>
        </div>

        ${(() => {
            const hasInv = currentCompany.investors;
            const hasCust = currentCompany.customers;
            const hasComp = currentCompany.competitors;
            if (!hasInv && !hasCust && !hasComp) return '';
            const firstTab = hasInv ? 'investors' : (hasCust ? 'customers' : 'competitors');
            return `
        <div class="modal-section">
            <div style="display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;">
                ${hasInv ? `<button class="rel-tab ${firstTab === 'investors' ? 'active' : ''}" data-tab="investors" onclick="switchRelTab(this, 'investors')" style="flex:1;padding:12px 16px;background:none;border:none;border-bottom:2px solid ${firstTab === 'investors' ? 'var(--accent-cyan)' : 'transparent'};color:${firstTab === 'investors' ? '#fff' : 'var(--dim)'};font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">Investors</button>` : ''}
                ${hasCust ? `<button class="rel-tab ${firstTab === 'customers' ? 'active' : ''}" data-tab="customers" onclick="switchRelTab(this, 'customers')" style="flex:1;padding:12px 16px;background:none;border:none;border-bottom:2px solid ${firstTab === 'customers' ? 'var(--accent-cyan)' : 'transparent'};color:${firstTab === 'customers' ? '#fff' : 'var(--dim)'};font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">Customers</button>` : ''}
                ${hasComp ? `<button class="rel-tab ${firstTab === 'competitors' ? 'active' : ''}" data-tab="competitors" onclick="switchRelTab(this, 'competitors')" style="flex:1;padding:12px 16px;background:none;border:none;border-bottom:2px solid ${firstTab === 'competitors' ? 'var(--accent-cyan)' : 'transparent'};color:${firstTab === 'competitors' ? '#fff' : 'var(--dim)'};font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">Competitors</button>` : ''}
            </div>
            <div id="relTabContent">
                ${hasInv ? `<div class="rel-panel" data-panel="investors" style="display:${firstTab === 'investors' ? 'flex' : 'none'};flex-wrap:wrap;gap:6px;">${renderLogoChips(currentCompany.investors, '', 'investors')}</div>` : ''}
                ${hasCust ? `<div class="rel-panel" data-panel="customers" style="display:${firstTab === 'customers' ? 'flex' : 'none'};flex-wrap:wrap;gap:6px;">${renderLogoChips(currentCompany.customers)}</div>` : ''}
                ${hasComp ? `<div class="rel-panel" data-panel="competitors" style="display:${firstTab === 'competitors' ? 'flex' : 'none'};flex-wrap:wrap;gap:6px;">${renderLogoChips(currentCompany.competitors)}</div>` : ''}
            </div>
        </div>`;
        })()}

        <div class="modal-section">
            <!-- M&A Intelligence Accordion -->
            <details class="accordion" open>
                <summary class="accordion-header" style="background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;list-style:none;margin-bottom:8px;">
                    <span style="font-weight:600;color:var(--gold);">M&A Intelligence</span>
                    <span class="accordion-icon" style="transition:transform 0.2s;"></span>
                </summary>
                <div class="accordion-content" style="padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:12px;">
                    <div class="ma-item" style="margin-bottom:8px;">
                        <span class="ma-icon"></span>
                        <span>${currentCompany.maInsight || 'Strategic acquisition target for enterprise AI platforms.'}</span>
                    </div>
                    ${currentCompany.acquirers ? `
                    <div style="margin-top:12px;">
                        <div style="font-size:12px;color:var(--dim);margin-bottom:8px;"><strong>Potential Acquirers:</strong></div>
                        <div style="display:flex;overflow-x:auto;gap:8px;padding:4px 0;-webkit-overflow-scrolling:touch;scrollbar-width:none;">
                            ${renderLogoChips(currentCompany.acquirers)}
                        </div>
                    </div>
                    ` : ''}
                    ${currentCompany.maValue ? `
                    <div class="ma-item" style="margin-top:8px;">
                        <span class="ma-icon"></span>
                        <span><strong>Strategic Value:</strong> ${currentCompany.maValue}</span>
                    </div>
                    ` : ''}
                </div>
            </details>

            ${currentCompany.successFactors ? `
            <!-- Success Factors Accordion -->
            <details class="accordion">
                <summary class="accordion-header" style="background:var(--bg-primary);border:1px solid var(--success);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;list-style:none;margin-bottom:8px;">
                    <span style="font-weight:600;color:var(--success);">Success Factors</span>
                    <span class="accordion-icon" style="transition:transform 0.2s;"></span>
                </summary>
                <div class="accordion-content" style="padding:12px;background:rgba(76,175,80,0.1);border-radius:8px;margin-bottom:12px;">
                    ${currentCompany.successFactors.map(f => `
                        <div class="ma-item" style="margin-bottom:6px;">
                            <span style="color:var(--success);"></span>
                            <span>${f}</span>
                        </div>
                    `).join('')}
                </div>
            </details>
            ` : ''}

            ${currentCompany.risks ? `
            <!-- Risk Factors Accordion -->
            <details class="accordion">
                <summary class="accordion-header" style="background:var(--bg-primary);border:1px solid var(--danger);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;list-style:none;margin-bottom:8px;">
                    <span style="font-weight:600;color:var(--danger);">Risk Factors</span>
                    <span class="accordion-icon" style="transition:transform 0.2s;"></span>
                </summary>
                <div class="accordion-content" style="padding:12px;background:rgba(244,67,54,0.1);border-radius:8px;margin-bottom:12px;">
                    ${currentCompany.risks.map(r => `
                        <div class="ma-item" style="margin-bottom:6px;">
                            <span style="color:var(--danger);">!</span>
                            <span>${r}</span>
                        </div>
                    `).join('')}
                </div>
            </details>
            ` : ''}
        </div>

        <div class="modal-section similar-section">
            <div class="modal-section-title">Similar Companies</div>
            <div class="similar-companies" id="similarCompanies"></div>
        </div>

    `;

    // Populate external links with white icons
    const companyName = encodeURIComponent(currentCompany.name);
    document.getElementById('externalLinks').innerHTML = `
        <a href="https://${currentCompany.website}" target="_blank" title="Company Website" class="ext-link">
            <svg viewBox="0 0 24 24" fill="#fff"><circle cx="12" cy="12" r="10" fill="none" stroke="#fff" stroke-width="2"/><line x1="2" y1="12" x2="22" y2="12" stroke="#fff" stroke-width="2"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" fill="none" stroke="#fff" stroke-width="2"/></svg>
        </a>
        <a href="https://linkedin.com/company/${currentCompany.website.replace('.com','').replace('.io','').replace('.ai','')}" target="_blank" title="LinkedIn" class="ext-link">
            <svg viewBox="0 0 24 24" fill="#fff"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
        </a>
        <a href="https://glassdoor.com/Overview/Working-at-${companyName}-EI_IE.htm" target="_blank" title="Glassdoor" class="ext-link">
            <svg viewBox="0 0 24 24" fill="#fff"><path d="M17.14 2H6.86A2.86 2.86 0 0 0 4 4.86v14.28A2.86 2.86 0 0 0 6.86 22h10.28A2.86 2.86 0 0 0 20 19.14V4.86A2.86 2.86 0 0 0 17.14 2zM8 18H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V8h2v2zm8 8h-6v-2h6v2zm0-4h-6v-2h6v2zm0-4h-6V8h6v2z"/></svg>
        </a>
        <a href="https://reddit.com/search/?q=${companyName}" target="_blank" title="Reddit" class="ext-link">
            <svg viewBox="0 0 24 24" fill="#fff"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
        </a>
        <a href="https://crunchbase.com/organization/${currentCompany.website.replace('.com','').replace('.io','').replace('.ai','').replace('.co','')}" target="_blank" title="Crunchbase" class="ext-link">
            <svg viewBox="0 0 24 24" fill="#fff"><path d="M21.6 0H2.4A2.4 2.4 0 0 0 0 2.4v19.2A2.4 2.4 0 0 0 2.4 24h19.2a2.4 2.4 0 0 0 2.4-2.4V2.4A2.4 2.4 0 0 0 21.6 0zM7.045 14.465A2.11 2.11 0 0 1 4.94 12.36a2.11 2.11 0 0 1 2.105-2.105 2.11 2.11 0 0 1 2.105 2.105 2.11 2.11 0 0 1-2.105 2.105zm5.475 3.645a5.78 5.78 0 0 1-3.9-1.485l1.2-1.635a4.07 4.07 0 0 0 2.775 1.08c1.005 0 1.545-.405 1.545-1.005v-.03c0-.6-.375-.9-2.19-1.365-2.19-.555-3.6-1.155-3.6-3.3v-.03c0-1.965 1.575-3.255 3.78-3.255a6.26 6.26 0 0 1 4.02 1.38l-1.065 1.74a5.12 5.12 0 0 0-3.015-.99c-.93 0-1.425.435-1.425.96v.03c0 .705.465.93 2.34 1.41 2.205.57 3.45 1.35 3.45 3.24v.03c0 2.145-1.635 3.345-3.96 3.345l.045-.12z"/></svg>
        </a>
    `;

    document.getElementById('modalFavorite').textContent = isFav ? 'Unfavorite' : 'Favorite';

    // Populate similar companies
    const similar = findSimilarCompanies(currentCompany, 5);
    document.getElementById('similarCompanies').innerHTML = similar.map(c => `
        <div class="similar-card" onclick="openModal(${c.id})" style="display:flex;align-items:center;gap:10px;">
            <img src="https://logo.clearbit.com/${c.website}" alt="${c.name}"
                 style="width:32px;height:32px;border-radius:6px;background:var(--bg-primary);object-fit:contain;"
                 onerror="this.src='https://www.google.com/s2/favicons?domain=${c.website}&sz=64';this.style.padding='4px';">
            <div>
                <div class="similar-name">${c.name}</div>
                <div class="similar-meta">${c.funding}</div>
            </div>
        </div>
    `).join('') || '<span style="color:var(--dim);font-size:12px;">No similar companies found</span>';

    document.getElementById('companyModal').classList.add('active');
}

function findSimilarCompanies(company, limit = 5) {
    const funding = company.fundingValue || 0;
    const minFunding = funding * 0.3;
    const maxFunding = funding * 3;

    return companies
        .filter(c => {
            if (c.id === company.id) return false;
            // Exclude acquired
            const emp = (c.employees || '').toLowerCase();
            const rev = (c.revenue || '').toLowerCase();
            const lastR = (c.lastRound || '').toLowerCase();
            if (emp.includes('part of') || rev.includes('acquired') || rev.includes('part of') ||
                lastR.includes('acquired by') || emp.includes('bankrupt')) return false;
            return true;
        })
        .map(c => {
            let score = 0;
            // Same category = high score
            if (c.category === company.category) score += 50;
            // Similar funding
            const f = c.fundingValue || 0;
            if (f >= minFunding && f <= maxFunding) score += 30;
            // Similar employee count
            if (c.employees === company.employees) score += 10;
            // Same location region
            const hq1 = (company.hq || '').toLowerCase();
            const hq2 = (c.hq || '').toLowerCase();
            if ((hq1.includes('san francisco') && hq2.includes('san francisco')) ||
                (hq1.includes('new york') && hq2.includes('new york'))) score += 10;
            return { ...c, score };
        })
        .filter(c => c.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, limit);
}

function switchRelTab(btn, tabName) {
    // Update tab buttons
    document.querySelectorAll('.rel-tab').forEach(tab => {
        tab.style.borderBottomColor = 'transparent';
        tab.style.color = 'var(--dim)';
        tab.classList.remove('active');
    });
    btn.style.borderBottomColor = 'var(--accent-cyan)';
    btn.style.color = '#fff';
    btn.classList.add('active');

    // Show/hide panels
    document.querySelectorAll('.rel-panel').forEach(panel => {
        panel.style.display = 'none';
    });
    const activePanel = document.querySelector(`.rel-panel[data-panel="${tabName}"]`);
    if (activePanel) {
        activePanel.style.display = 'flex';
    }
}

function closeModal() {
    document.getElementById('companyModal').classList.remove('active');
    const modalContent = document.querySelector('#companyModal .modal-content');
    modalContent.style.transform = '';
    modalContent.style.opacity = '';
}

document.getElementById('modalClose').onclick = closeModal;

// ==================== INVESTOR MODAL ====================
function openInvestorModal(investorName) {
    const domain = getLogoDomain(investorName);
    const logoUrl = domain ? `https://logo.clearbit.com/${domain}` : '';

    document.getElementById('investorTitle').textContent = investorName;
    document.getElementById('investorLogo').src = logoUrl;
    document.getElementById('investorLogo').style.display = logoUrl ? 'block' : 'none';

    // Find all companies this investor has invested in
    const investedCompanies = companies.filter(c => {
        if (!c.investors) return false;
        const investors = c.investors.toLowerCase().split(',').map(i => i.trim());
        return investors.some(inv => inv === investorName.toLowerCase());
    });

    // Group by category and calculate totals
    const byCategory = {};
    let totalInvested = 0;

    investedCompanies.forEach(c => {
        const cat = c.category || 'other';
        if (!byCategory[cat]) {
            byCategory[cat] = { companies: [], total: 0 };
        }
        byCategory[cat].companies.push(c);
        byCategory[cat].total += c.fundingValue || 0;
        totalInvested += c.fundingValue || 0;
    });

    // Sort categories by total funding
    const sortedCategories = Object.entries(byCategory).sort((a, b) => b[1].total - a[1].total);

    // Build the modal content
    let html = `
        <div class="modal-section">
            <div class="modal-grid">
                <div class="modal-stat">
                    <div class="modal-stat-label">Companies</div>
                    <div class="modal-stat-value">${investedCompanies.length}</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Total Funding</div>
                    <div class="modal-stat-value">${formatFunding(totalInvested)}</div>
                </div>
            </div>
        </div>
    `;

    // Add by category sections
    sortedCategories.forEach(([catKey, catData]) => {
        const catName = getCategoryName(catKey);
        html += `
            <div class="modal-section">
                <div class="modal-section-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${catName}</span>
                    <span style="color:var(--gold);font-size:12px;">${formatFunding(catData.total)}</span>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${catData.companies.sort((a,b) => (b.fundingValue || 0) - (a.fundingValue || 0)).map(c => `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg);border-radius:8px;transition:all 0.2s;" onmouseover="this.style.background='var(--card)'" onmouseout="this.style.background='var(--bg)'">
                            <img src="https://logo.clearbit.com/${c.website}" alt="${c.name}" style="width:32px;height:32px;border-radius:6px;background:#fff;object-fit:contain;cursor:pointer;" onclick="closeInvestorModal();openModal(${c.id});" onerror="this.src='https://www.google.com/s2/favicons?domain=${c.website}&sz=64'">
                            <div style="flex:1;">
                                <a href="https://${c.website}" target="_blank" style="font-weight:500;font-size:14px;color:#fff;text-decoration:none;display:block;" onmouseover="this.style.color='var(--accent-cyan)'" onmouseout="this.style.color='#fff'">${c.name}</a>
                                <div style="font-size:12px;color:var(--dim);">${c.product || ''}</div>
                            </div>
                            <div style="text-align:right;cursor:pointer;" onclick="closeInvestorModal();openModal(${c.id});">
                                <div style="font-weight:600;color:var(--gold);font-size:14px;">${c.funding || 'N/A'}</div>
                                <div style="font-size:11px;color:var(--dim);">${c.founded || ''}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });

    // Add external link to investor website
    if (domain) {
        html += `
            <div class="modal-section" style="text-align:center;padding-top:12px;border-top:1px solid var(--border);">
                <a href="https://${domain}" target="_blank" style="color:var(--accent-cyan);font-size:13px;text-decoration:none;">
                    Visit ${investorName} Website 
                </a>
            </div>
        `;
    }

    document.getElementById('investorBody').innerHTML = html;
    document.getElementById('investorModal').classList.add('active');
}

function closeInvestorModal() {
    document.getElementById('investorModal').classList.remove('active');
}

// Click outside investor modal to close
document.getElementById('investorModal').addEventListener('click', (e) => {
    if (e.target.id === 'investorModal') closeInvestorModal();
});

function formatFunding(value) {
    if (!value || value === 0) return 'N/A';
    if (value >= 1000000000) return '$' + (value / 1000000000).toFixed(1) + 'B';
    if (value >= 1000000) return '$' + (value / 1000000).toFixed(0) + 'M';
    return '$' + (value / 1000).toFixed(0) + 'K';
}

function getCategoryName(key) {
    const categoryNames = {
        'foundation-models': 'Foundation Models',
        'enterprise-ai': 'Enterprise AI',
        'ai-infrastructure': 'AI Infrastructure',
        'ai-agents': 'AI Agents',
        'vertical-ai': 'Vertical AI',
        'ai-devtools': 'AI DevTools',
        'ai-hardware': 'AI Hardware',
        'ai-data': 'AI Data',
        'gtm-ai': 'GTM AI',
        'ai-security': 'AI Security',
        'ai-healthcare': 'AI Healthcare',
        'ai-finance': 'AI Finance',
        'ai-robotics': 'AI Robotics',
        'ai-creative': 'AI Creative',
        'other': 'Other'
    };
    return categoryNames[key] || key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Click outside modal to close
document.getElementById('companyModal').addEventListener('click', (e) => {
    if (e.target.id === 'companyModal') closeModal();
});

// Swipe to dismiss modal
(function() {
    const modal = document.getElementById('companyModal');
    const modalContent = modal.querySelector('.modal-content');
    let startX = 0, currentX = 0, isDragging = false;

    modalContent.addEventListener('mousedown', startDrag);
    modalContent.addEventListener('touchstart', startDrag, { passive: true });

    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag, { passive: true });

    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    function startDrag(e) {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
        isDragging = true;
        startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        modalContent.style.transition = 'none';
    }

    function drag(e) {
        if (!isDragging) return;
        currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const diff = currentX - startX;
        const opacity = Math.max(0, 1 - Math.abs(diff) / 300);
        modalContent.style.transform = `translateX(${diff}px) rotate(${diff * 0.02}deg)`;
        modalContent.style.opacity = opacity;
    }

    function endDrag() {
        if (!isDragging) return;
        isDragging = false;
        modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
        const diff = currentX - startX;

        if (Math.abs(diff) > 80) {
            // Swipe threshold met - navigate to next/prev company
            const direction = diff > 0 ? 1 : -1;
            modalContent.style.transform = `translateX(${direction * 500}px) rotate(${direction * 15}deg)`;
            modalContent.style.opacity = '0';

            setTimeout(() => {
                if (currentCompany) {
                    const visibleCompanies = companies.filter(c => !ignoredList.includes(c.id));
                    // Sort same as current view
                    if (sortDirection === 'asc') {
                        visibleCompanies.sort((a, b) => a.name.localeCompare(b.name));
                    } else {
                        visibleCompanies.sort((a, b) => b.name.localeCompare(a.name));
                    }
                    const currentIndex = visibleCompanies.findIndex(c => c.id === currentCompany.id);

                    // Swipe right (diff > 0) = previous, Swipe left (diff < 0) = next
                    const nextIndex = diff > 0 ? currentIndex - 1 : currentIndex + 1;

                    if (nextIndex >= 0 && nextIndex < visibleCompanies.length) {
                        // Reset position before opening next
                        modalContent.style.transition = 'none';
                        modalContent.style.transform = `translateX(${-direction * 300}px)`;
                        modalContent.style.opacity = '0';

                        openModal(visibleCompanies[nextIndex].id);

                        // Animate in from opposite side
                        setTimeout(() => {
                            modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                            modalContent.style.transform = '';
                            modalContent.style.opacity = '';
                        }, 50);
                    } else {
                        // No more companies, reset
                        modalContent.style.transform = '';
                        modalContent.style.opacity = '';
                    }
                }
            }, 150);
        } else {
            // Reset position
            modalContent.style.transform = '';
            modalContent.style.opacity = '';
        }
        startX = 0;
        currentX = 0;
    }
})();

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('companyModal');
    const isModalOpen = modal.classList.contains('active');

    // ESC to close modal
    if (e.key === 'Escape' && isModalOpen) {
        closeModal();
        return;
    }

    // When modal is open
    if (isModalOpen && currentCompany) {
        const visibleCompanies = companies.filter(c => !ignoredList.includes(c.id));
        const currentIndex = visibleCompanies.findIndex(c => c.id === currentCompany.id);

        // Left arrow - previous company
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
            openModal(visibleCompanies[currentIndex - 1].id);
        }
        // Right arrow - next company
        if (e.key === 'ArrowRight' && currentIndex < visibleCompanies.length - 1) {
            openModal(visibleCompanies[currentIndex + 1].id);
        }
        // F to favorite
        if (e.key === 'f' || e.key === 'F') {
            toggleFavorite(currentCompany.id);
            applyFilters();
        }
        // I to ignore
        if (e.key === 'i' || e.key === 'I') {
            ignoredList.push(currentCompany.id);
            localStorage.setItem('ai_ignored', JSON.stringify(ignoredList));
            closeModal();
            applyFilters();
        }
    }

    // / to focus search
    if (e.key === '/' && !isModalOpen) {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
});

document.getElementById('modalIgnore').onclick = () => {
    if (currentCompany) {
        const companyName = currentCompany.name;
        const companyId = currentCompany.id;
        ignoredList.push(companyId);
        localStorage.setItem('ai_ignored', JSON.stringify(ignoredList));
        closeModal();
        applyFilters();
        showUndoToast(`Ignored ${companyName}`, { type: 'ignore', companyId, companyName });
    }
};

document.getElementById('modalFavorite').onclick = () => {
    if (currentCompany) {
        toggleFavorite(currentCompany.id);
        closeModal();
        applyFilters();
    }
};

// Quick action button handlers
function quickIgnore(id, event) {
    event.stopPropagation();
    const company = companies.find(c => c.id === id);
    const companyName = company ? company.name : 'Company';
    ignoredList.push(id);
    localStorage.setItem('ai_ignored', JSON.stringify(ignoredList));
    applyFilters();
    showUndoToast(`Ignored ${companyName}`, { type: 'ignore', companyId: id, companyName });
}

function quickFavorite(id, event) {
    event.stopPropagation();
    toggleFavorite(id);
    applyFilters();
}

// ==================== FAVORITES ====================
// Undo functionality
let lastAction = null;
let undoTimeout = null;

function showUndoToast(message, action) {
    lastAction = action;
    document.getElementById('undoText').textContent = message;
    document.getElementById('undoToast').classList.add('visible');

    // Auto-hide after 5 seconds
    if (undoTimeout) clearTimeout(undoTimeout);
    undoTimeout = setTimeout(hideUndoToast, 5000);
}

function hideUndoToast() {
    document.getElementById('undoToast').classList.remove('visible');
    if (undoTimeout) clearTimeout(undoTimeout);
    lastAction = null;
}

function undoLastAction() {
    if (!lastAction) return;

    const { type, companyId, companyName } = lastAction;

    if (type === 'favorite') {
        // Undo favorite - remove from favorites
        const idx = favorites.indexOf(companyId);
        if (idx > -1) favorites.splice(idx, 1);
        localStorage.setItem('ai_favorites', JSON.stringify(favorites));
    } else if (type === 'unfavorite') {
        // Undo unfavorite - add back to favorites
        if (!favorites.includes(companyId)) favorites.push(companyId);
        localStorage.setItem('ai_favorites', JSON.stringify(favorites));
    } else if (type === 'ignore') {
        // Undo ignore - remove from ignored list
        const idx = ignoredList.indexOf(companyId);
        if (idx > -1) ignoredList.splice(idx, 1);
        localStorage.setItem('ai_ignored', JSON.stringify(ignoredList));
        // Show the card again
        const card = document.querySelector(`.company-card[data-id="${companyId}"]`);
        if (card) card.classList.remove('ignored');
    }

    updateCounts();
    // Update modal button if open
    if (currentCompany && currentCompany.id === companyId) {
        document.getElementById('modalFavorite').textContent = favorites.includes(companyId) ? 'Unfavorite' : 'Favorite';
    }

    hideUndoToast();
}

function toggleFavorite(id, showUndo = true) {
    const company = companies.find(c => c.id === id);
    const companyName = company ? company.name : 'Company';
    const idx = favorites.indexOf(id);

    if (idx > -1) {
        favorites.splice(idx, 1);
        if (showUndo) showUndoToast(`Removed ${companyName} from watchlist`, { type: 'unfavorite', companyId: id, companyName });
    } else {
        favorites.push(id);
        if (showUndo) showUndoToast(`Added ${companyName} to watchlist`, { type: 'favorite', companyId: id, companyName });
    }
    localStorage.setItem('ai_favorites', JSON.stringify(favorites));
    updateCounts();
}

function updateCounts() {
    document.getElementById('favBadge').textContent = favorites.length;
    document.getElementById('exportBadge').textContent = favorites.length;

    const visibleCards = document.querySelectorAll('.company-card:not(.ignored)').length;
    document.getElementById('resultsCount').textContent =
        `Showing ${visibleCards} of ${companies.length} companies`;

    // Update stats bar
    const visibleCompanies = companies.filter(c => !ignoredList.includes(c.id));
    const totalFunding = visibleCompanies.reduce((sum, c) => sum + (c.fundingValue || 0), 0);
    const unicornCount = visibleCompanies.filter(isUnicorn).length;
    const targetCount = visibleCompanies.filter(isMaTarget).length;

    document.getElementById('statCompanies').textContent = visibleCompanies.length;
    document.getElementById('statFunding').textContent = '$' + (totalFunding / 1000000000).toFixed(1) + 'B';
    document.getElementById('statUnicorns').textContent = unicornCount;
    document.getElementById('statTargets').textContent = targetCount;
}

// Timeline
document.getElementById('timelineBtn').addEventListener('click', function() {
    const container = document.getElementById('timelineContainer');
    const isActive = container.classList.contains('active');

    if (isActive) {
        container.classList.remove('active');
        this.classList.remove('active');
    } else {
        container.classList.add('active');
        this.classList.add('active');
        renderTimeline();
    }
});

// Store timeline data globally for double-click access
let timelineYearData = {};

function renderTimeline() {
    // Get funding by year based on company founded date
    const yearData = {};
    const currentYear = new Date().getFullYear();

    // Initialize years from 2010 to current
    for (let y = 2010; y <= currentYear; y++) {
        yearData[y] = { total: 0, companies: [] };
    }

    // Aggregate funding by founded year
    const cards = document.querySelectorAll('.company-card:not(.ignored)');
    const visibleIds = Array.from(cards).map(c => parseInt(c.dataset.id));

    companies.filter(c => visibleIds.includes(c.id)).forEach(c => {
        const year = c.founded || 2020;
        if (year >= 2010 && year <= currentYear) {
            yearData[year].total += (c.fundingValue || 0);
            yearData[year].companies.push(c); // Store full company object
        }
    });

    // Store globally for double-click
    timelineYearData = yearData;

    // Find max for scaling
    const maxFunding = Math.max(...Object.values(yearData).map(d => d.total), 1);

    // Render bars
    const container = document.getElementById('timelineYears');
    container.innerHTML = Object.entries(yearData).map(([year, data]) => {
        const height = Math.max(5, (data.total / maxFunding) * 100);
        const billions = (data.total / 1000000000).toFixed(1);
        const companyNames = data.companies.map(c => c.name).slice(0,5).join(', ');
        return `
            <div class="timeline-year" ondblclick="showYearDeals(${year})" style="cursor:pointer;">
                <div class="timeline-bar" style="height: ${height}px;" title="${companyNames}${data.companies.length > 5 ? '...' : ''}">
                    <span class="timeline-amount">$${billions}B</span>
                </div>
                <div class="timeline-year-label">${year}</div>
            </div>
        `;
    }).join('');
}

function showYearDeals(year) {
    const data = timelineYearData[year];
    if (!data || data.companies.length === 0) {
        alert('No funding deals found for ' + year);
        return;
    }

    // Sort by funding amount descending
    const sorted = data.companies.sort((a, b) => (b.fundingValue || 0) - (a.fundingValue || 0));
    const totalBillions = (data.total / 1000000000).toFixed(2);

    // Create modal content
    const dealsHtml = sorted.map((c, i) => `
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-primary);border-radius:8px;margin-bottom:8px;cursor:pointer;" onclick="openModal(${c.id})">
            <div style="width:30px;text-align:center;color:var(--dim);font-size:12px;">${i + 1}</div>
            <img src="https://logo.clearbit.com/${c.website}" alt="" style="width:32px;height:32px;border-radius:6px;background:#fff;" onerror="this.src='https://www.google.com/s2/favicons?domain=${c.website}&sz=64'">
            <div style="flex:1;">
                <div style="font-weight:600;color:#fff;font-size:14px;">${c.name}</div>
                <div style="font-size:12px;color:var(--dim);">${c.category || 'AI'}</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:600;color:var(--gold);font-size:14px;">${c.funding}</div>
                <div style="font-size:11px;color:var(--dim);">${c.hq || ''}</div>
            </div>
        </div>
    `).join('');

    // Show in a modal overlay
    const modal = document.createElement('div');
    modal.id = 'yearDealsModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:400;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto;';
    modal.innerHTML = `
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:600px;width:100%;max-height:80vh;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border);">
                <div>
                    <h2 style="margin:0;font-size:22px;color:#fff;">Funding Deals in ${year}</h2>
                    <p style="margin:6px 0 0;color:var(--dim);font-size:13px;">${sorted.length} companies  $${totalBillions}B total raised</p>
                </div>
                <button onclick="document.getElementById('yearDealsModal').remove()" style="background:none;border:none;color:var(--dim);font-size:28px;cursor:pointer;padding:0;line-height:1;">&times;</button>
            </div>
            <div style="padding:16px;max-height:60vh;overflow-y:auto;">
                ${dealsHtml}
            </div>
        </div>
    `;
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    document.body.appendChild(modal);
}

// Favorites
document.getElementById('fabFavorites').onclick = () => {
    const favCompanies = companies.filter(c => favorites.includes(c.id));
    if (favCompanies.length === 0) {
        alert('No favorites yet! Click a company card and tap Favorite to add.');
        return;
    }

    const container = document.getElementById('mainContent');
    container.innerHTML = `
        <div class="category-section">
            <div class="category-header">
                <h2>Your Favorites</h2>
                <span class="category-count">${favCompanies.length}</span>
            </div>
            <div class="cards-container">
                ${favCompanies.map(c => renderCard(c)).join('')}
            </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:center;margin:20px auto;flex-wrap:wrap;">
            <button onclick="applyFilters()" style="padding:15px 30px;background:var(--accent-cyan);color:var(--bg-primary);border:none;border-radius:8px;cursor:pointer;font-weight:600;">Show All Companies</button>
            <button onclick="clearAllFavorites()" style="padding:15px 30px;background:transparent;color:#ef4444;border:1px solid #ef4444;border-radius:8px;cursor:pointer;font-weight:600;">Clear All Favorites</button>
        </div>
    `;
};

function clearAllFavorites() {
    if (confirm('Clear all favorites? This cannot be undone.')) {
        favorites = [];
        localStorage.setItem('ai_favorites', JSON.stringify(favorites));
        updateFavBadge();
        applyFilters();
    }
}

// ==================== SEARCH & FILTER ====================

// Category and filter definitions
const filterDefinitions = {
    // Categories
    'foundation-models': {
        title: 'Foundation Models',
        desc: 'Companies building large language models (LLMs), multimodal AI, and core AI infrastructure. These are the base layers that other AI applications build upon.'
    },
    'enterprise-ai': {
        title: 'Enterprise AI',
        desc: 'AI solutions designed for business workflows including knowledge management, document processing, and workplace automation tools.'
    },
    'developer-tools': {
        title: 'Developer Tools',
        desc: 'Infrastructure and tools for building AI applications including vector databases, ML frameworks, observability, and AI-powered coding assistants.'
    },
    'consumer-ai': {
        title: 'Consumer AI',
        desc: 'AI products built for individual users including chatbots, image generators, music creators, and personal assistants.'
    },
    'gtm-ai': {
        title: 'GTM & Sales AI',
        desc: 'AI tools for go-to-market teams including sales intelligence, conversation analytics, email optimization, and revenue operations.'
    },
    'fintech-legal': {
        title: 'FinTech & Legal AI',
        desc: 'AI applications for financial services and legal industry including contract analysis, compliance, fraud detection, and legal research.'
    },
    'healthtech': {
        title: 'HealthTech AI',
        desc: 'AI solutions for healthcare including diagnostics, drug discovery, clinical decision support, and patient care optimization.'
    },
    'industrial-ai': {
        title: 'Industrial AI',
        desc: 'AI for manufacturing, logistics, robotics, and physical world applications including autonomous vehicles and warehouse automation.'
    },
    'data-infra': {
        title: 'Data Infrastructure',
        desc: 'Companies providing data management, labeling, processing, and pipeline infrastructure that powers AI/ML systems.'
    },
    'security-ai': {
        title: 'AI Security',
        desc: 'Cybersecurity companies using AI for threat detection, vulnerability management, and security operations automation.'
    },
    'climate-agri': {
        title: 'Climate & Agriculture AI',
        desc: 'AI applications for climate tech, carbon tracking, sustainable agriculture, and environmental monitoring.'
    },
    'hr-talent': {
        title: 'HR & Talent AI',
        desc: 'AI tools for recruiting, talent management, employee engagement, and workforce planning.'
    },
    // Badge filters
    'unicorn': {
        title: ' Unicorn Companies',
        desc: 'Companies valued at $1 billion or more based on their most recent funding round. These represent the most valuable private AI companies in the market.'
    },
    'ma-target': {
        title: ' M&A Targets',
        desc: 'Companies identified as likely acquisition candidates based on strategic fit with potential acquirers, market position, technology assets, and investor signals.'
    },
    // Funding levels
    'funding-1': {
        title: '$ Early Stage (<$100M)',
        desc: 'Companies that have raised less than $100M in total funding. Typically seed through Series B stage with higher growth potential but more risk.'
    },
    'funding-2': {
        title: '$$ Growth Stage ($100M-$500M)',
        desc: 'Companies that have raised between $100M and $500M. Usually Series C-D stage with proven product-market fit and scaling operations.'
    },
    'funding-3': {
        title: '$$$ Late Stage ($500M+)',
        desc: 'Companies that have raised over $500M in total funding. Typically pre-IPO or large private companies with established market positions.'
    }
};

// Funding level filter state (must be declared before applyFilters)
let currentFundingLevel = '';

function updateFilterHeader() {
    const category = document.getElementById('categoryFilter').value;
    const badge = document.getElementById('badgeFilter').value;
    const filterHeader = document.getElementById('filterHeader');
    const filterTitle = document.getElementById('filterHeaderTitle');
    const filterDesc = document.getElementById('filterHeaderDesc');

    let definition = null;

    // Check badge filter first (unicorn, ma-target)
    if (badge && filterDefinitions[badge]) {
        definition = filterDefinitions[badge];
    }
    // Then check funding level
    else if (currentFundingLevel) {
        definition = filterDefinitions['funding-' + currentFundingLevel];
    }
    // Then check category
    else if (category && filterDefinitions[category]) {
        definition = filterDefinitions[category];
    }

    if (definition) {
        filterTitle.textContent = definition.title;
        filterDesc.textContent = definition.desc;
        filterHeader.style.display = 'block';
    } else {
        filterHeader.style.display = 'none';
    }
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const location = document.getElementById('locationFilter').value;
    const badge = document.getElementById('badgeFilter').value;
    const maFilter = document.getElementById('maFilter')?.value || '';
    const maSort = document.getElementById('maSortFilter')?.value || '';

    // Update filter header with definition
    updateFilterHeader();

    let filtered = companies.filter(c => {
        if (ignoredList.includes(c.id)) return false;

        // Exclude acquired companies
        const emp = (c.employees || '').toLowerCase();
        const rev = (c.revenue || '').toLowerCase();
        const lastR = (c.lastRound || '').toLowerCase();
        if (emp.includes('part of') || rev.includes('acquired') || rev.includes('part of') ||
            lastR.includes('acquired by') || emp.includes('bankrupt')) return false;

        if (category && c.category !== category) return false;

        // Funding level filter
        if (currentFundingLevel) {
            const funding = c.fundingValue || 0;
            if (currentFundingLevel === '1' && funding >= 100000000) return false; // $ = under $100M
            if (currentFundingLevel === '2' && (funding < 100000000 || funding >= 500000000)) return false; // $$ = $100M-$500M
            if (currentFundingLevel === '3' && funding < 500000000) return false; // $$$ = $500M+
        }

        // Location filter
        if (location) {
            const hq = (c.hq || '').toLowerCase();
            if (location === 'sf') {
                if (!hq.includes('san francisco') && !hq.includes('palo alto') && !hq.includes('mountain view') &&
                    !hq.includes('menlo park') && !hq.includes('sunnyvale') && !hq.includes('redwood') &&
                    !hq.includes('berkeley') && !hq.includes('oakland') && !hq.includes('san jose') &&
                    !hq.includes('cupertino') && !hq.includes('santa clara') && !hq.includes('fremont') &&
                    !hq.includes('emeryville')) return false;
            } else if (location === 'boston') {
                if (!hq.includes('boston') && !hq.includes('cambridge') && !hq.includes('massachusetts') &&
                    !hq.includes(', ma')) return false;
            } else if (location === 'nyc') {
                if (!hq.includes('new york') && !hq.includes('brooklyn') && !hq.includes('manhattan') &&
                    !hq.includes(', ny')) return false;
            } else if (location === 'la') {
                if (!hq.includes('los angeles') && !hq.includes('santa monica') && !hq.includes('venice') &&
                    !hq.includes('pasadena') && !hq.includes('culver city')) return false;
            } else if (location === 'seattle') {
                if (!hq.includes('seattle') && !hq.includes('bellevue') && !hq.includes('redmond') &&
                    !hq.includes('washington')) return false;
            } else if (location === 'austin') {
                if (!hq.includes('austin') && !hq.includes('texas') && !hq.includes(', tx')) return false;
            } else if (location === 'international') {
                const usLocations = ['ca', 'ny', 'ma', 'tx', 'wa', 'san francisco', 'new york', 'boston',
                    'austin', 'seattle', 'los angeles', 'chicago', 'denver', 'miami', 'atlanta'];
                const isUS = usLocations.some(loc => hq.includes(loc));
                if (isUS) return false;
            }
        }

        // Badge filter
        if (badge) {
            if (badge === 'unicorn' && !isUnicorn(c)) return false;
            if (badge === 'ma-target' && !isMaTarget(c)) return false;
            if (badge === 'late-bloomer' && !isLateBloomer(c)) return false;
        }

        // M&A filter
        if (maFilter) {
            const wiki = wikiData[c.name];
            if (maFilter === 'any' && !wiki) return false;
            if (maFilter === 'high') {
                if (!wiki) return false;
                const score = calcWikiMaScore(wiki);
                if (!score || score < 70) return false;
            }
            if (maFilter === 'med') {
                if (!wiki) return false;
                const score = calcWikiMaScore(wiki);
                if (!score || score < 55 || score >= 70) return false;
            }
            if (maFilter === 'stale') {
                if (!wiki || !wiki.yearsSinceLastRaise || wiki.yearsSinceLastRaise < 3) return false;
            }
            if (maFilter === 'ceo') {
                if (!wiki || !wiki.ceoChange) return false;
            }
            if (maFilter === 'blocked') {
                if (!wiki || !wiki.maHistory || !wiki.maHistory.toLowerCase().includes('blocked')) return false;
            }
        }

        if (search) {
            const searchText = `${c.name} ${c.product} ${c.ceo} ${c.secretSauce} ${c.hq}`.toLowerCase();
            if (!searchText.includes(search)) return false;
        }
        return true;
    });

    // Sort based on selected option
    if (maSort) {
        if (maSort === 'ma-desc') {
            filtered.sort((a, b) => {
                const wikiA = wikiData[a.name];
                const wikiB = wikiData[b.name];
                const scoreA = wikiA ? calcWikiMaScore(wikiA) : 0;
                const scoreB = wikiB ? calcWikiMaScore(wikiB) : 0;
                return scoreB - scoreA;
            });
        } else if (maSort === 'ma-asc') {
            filtered.sort((a, b) => {
                const wikiA = wikiData[a.name];
                const wikiB = wikiData[b.name];
                const scoreA = wikiA ? calcWikiMaScore(wikiA) : 0;
                const scoreB = wikiB ? calcWikiMaScore(wikiB) : 0;
                return scoreA - scoreB;
            });
        } else if (maSort === 'stale-desc') {
            filtered.sort((a, b) => {
                const wikiA = wikiData[a.name];
                const wikiB = wikiData[b.name];
                const staleA = wikiA?.yearsSinceLastRaise || 0;
                const staleB = wikiB?.yearsSinceLastRaise || 0;
                return staleB - staleA;
            });
        }
    } else if (sortDirection === 'asc') {
        filtered.sort((a, b) => a.name.localeCompare(b.name));
    } else {
        filtered.sort((a, b) => b.name.localeCompare(a.name));
    }

    renderCompanies(filtered);
}

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('categoryFilter').addEventListener('change', applyFilters);
document.getElementById('locationFilter').addEventListener('change', applyFilters);
document.getElementById('badgeFilter').addEventListener('change', applyFilters);
document.getElementById('maFilter')?.addEventListener('change', applyFilters);
document.getElementById('maSortFilter')?.addEventListener('change', applyFilters);

// More Filters button toggle
document.getElementById('moreFiltersBtn').addEventListener('click', function() {
    const secondaryFilters = document.getElementById('secondaryFilters');
    const isVisible = secondaryFilters.style.display === 'flex';
    secondaryFilters.style.display = isVisible ? 'none' : 'flex';
    this.classList.toggle('active', !isVisible);
    this.textContent = isVisible ? 'More' : 'Less';
});

// A-Z Sort Toggle
document.getElementById('alphaSort').addEventListener('click', function() {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    this.textContent = sortDirection === 'asc' ? 'A' : 'Z';
    this.title = sortDirection === 'asc' ? 'Sorting A-Z (click for Z-A)' : 'Sorting Z-A (click for A-Z)';
    applyFilters();
});

// Funding toggle (currentFundingLevel declared earlier)
document.querySelectorAll('.fund-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.fund-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFundingLevel = btn.dataset.level;
        applyFilters();
    });
});

// ==================== BACK TO TOP ====================
window.addEventListener('scroll', () => {
    document.getElementById('backToTop').classList.toggle('visible', window.scrollY > 500);
});

document.getElementById('backToTop').onclick = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

// ==================== ALPHABET NAVIGATION ====================
function updateAlphabetNav() {
    const visibleCards = document.querySelectorAll('.company-card:not(.ignored)');
    const letters = {};

    visibleCards.forEach(card => {
        const name = card.querySelector('.card-name')?.textContent || '';
        const firstLetter = name.charAt(0).toUpperCase();
        if (/[A-Z]/.test(firstLetter)) {
            letters[firstLetter] = true;
        } else if (firstLetter) {
            letters['#'] = true;
        }
    });

    document.querySelectorAll('.alpha-letter').forEach(el => {
        const letter = el.dataset.letter;
        if (letters[letter]) {
            el.classList.add('has-companies');
            el.classList.remove('no-companies');
        } else {
            el.classList.remove('has-companies');
            el.classList.add('no-companies');
        }
    });
}

function scrollToLetter(letter) {
    const cards = document.querySelectorAll('.company-card:not(.ignored)');
    let targetCard = null;

    for (const card of cards) {
        const name = card.querySelector('.card-name')?.textContent || '';
        const firstLetter = name.charAt(0).toUpperCase();

        if (letter === '#') {
            if (!/[A-Z]/.test(firstLetter)) {
                targetCard = card;
                break;
            }
        } else if (firstLetter === letter) {
            targetCard = card;
            break;
        }
    }

    if (targetCard) {
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        targetCard.style.boxShadow = '0 0 20px var(--accent-gold)';
        setTimeout(() => {
            targetCard.style.boxShadow = '';
        }, 1500);
    }
}

// Alphabet nav click handlers
document.querySelectorAll('.alpha-letter').forEach(el => {
    el.addEventListener('click', () => {
        const letter = el.dataset.letter;
        if (!el.classList.contains('no-companies')) {
            scrollToLetter(letter);

            // Show current letter indicator
            const indicator = document.getElementById('alphaCurrent');
            indicator.textContent = letter;
            indicator.classList.add('visible');
            setTimeout(() => indicator.classList.remove('visible'), 800);

            // Highlight active letter
            document.querySelectorAll('.alpha-letter').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
        }
    });
});

// Update alphabet nav on filter changes
const originalApplyFilters = applyFilters;
applyFilters = function() {
    originalApplyFilters();
    setTimeout(updateAlphabetNav, 100);

    // Toggle filtered class on alphabet nav when category is selected
    const category = document.getElementById('categoryFilter').value;
    const alphabetNav = document.getElementById('alphabetNav');
    if (category) {
        alphabetNav.classList.add('filtered');
    } else {
        alphabetNav.classList.remove('filtered');
    }
};

// ==================== SAVED ANALYSIS ====================
function showSavedAnalysis() {
    const savedCompanies = companies.filter(c => favorites.includes(c.id));

    if (savedCompanies.length === 0) {
        alert('No favorite companies yet! Click a company and tap Favorite to save.');
        return;
    }

    // Group by category
    const byCategory = {};
    savedCompanies.forEach(c => {
        if (!byCategory[c.category]) byCategory[c.category] = [];
        byCategory[c.category].push(c);
    });

    // Calculate stats
    const totalFunding = savedCompanies.reduce((sum, c) => sum + (c.fundingValue || 0), 0);
    const avgFunding = totalFunding / savedCompanies.length;
    const unicorns = savedCompanies.filter(isUnicorn);
    const maTargets = savedCompanies.filter(isMaTarget);
    const bostonCompanies = savedCompanies.filter(c => c.hq && c.hq.toLowerCase().includes('boston'));

    // Generate fit commentary
    function generateFitCommentary(company, allSaved) {
        const comments = [];
        const sameCat = allSaved.filter(c => c.category === company.category && c.id !== company.id);

        if (sameCat.length > 0) {
            comments.push(`<span class="fit-high">High Synergy</span> with ${sameCat.map(c => c.name).join(', ')} (same category)`);
        }

        if (isUnicorn(company)) {
            comments.push(`<span class="fit-high">Unicorn</span> - established market leader`);
        }

        if (isMaTarget(company)) {
            comments.push(`<span class="fit-medium">M&A Target</span> - potential acquisition opportunity`);
        }

        if (isLateBloomer(company)) {
            comments.push(`<span class="fit-low">Late Bloomer</span> - emerging player with growth potential`);
        }

        if (company.fundingValue > avgFunding * 1.5) {
            comments.push(`Strong funding position (above average)`);
        } else if (company.fundingValue < avgFunding * 0.5) {
            comments.push(`Capital efficient or early stage`);
        }

        if (company.hq && company.hq.toLowerCase().includes('boston')) {
            comments.push(`<span class="fit-high">Boston-based</span> - local market advantage`);
        }

        return comments.length > 0 ? comments.join('<br>') : 'Standard investment profile';
    }

    // Build HTML
    let html = `
        <div class="analysis-summary">
            <h3>Portfolio Overview</h3>
            <p><strong>${savedCompanies.length}</strong> companies saved across <strong>${Object.keys(byCategory).length}</strong> categories</p>
            <p>Total funding pool: <strong>$${(totalFunding / 1000000000).toFixed(1)}B</strong></p>
            <p>Unicorns: <strong>${unicorns.length}</strong> | M&A Targets: <strong>${maTargets.length}</strong> | Boston-based: <strong>${bostonCompanies.length}</strong></p>
        </div>

        <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">Category Breakdown</h3>
    `;

    Object.keys(byCategory).forEach(cat => {
        const catCompanies = byCategory[cat];
        html += `
            <div style="margin-bottom: 20px;">
                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">${categoryNames[cat] || cat} (${catCompanies.length})</h4>
                <div class="analysis-grid">
                    ${catCompanies.map(c => `
                        <div class="analysis-card">
                            <h4>${c.name}</h4>
                            <p><strong>Product:</strong> ${c.product}</p>
                            <p><strong>Funding:</strong> ${c.funding}</p>
                            <p><strong>HQ:</strong> ${c.hq}</p>
                            <p style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                                <strong>Fit Analysis:</strong><br>
                                ${generateFitCommentary(c, savedCompanies)}
                            </p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });

    // Add recommendations
    html += `
        <div class="analysis-summary" style="border-left-color: var(--accent-cyan);">
            <h3>Strategic Recommendations</h3>
            ${unicorns.length > 2 ? '<p>Strong unicorn portfolio - consider diversifying into earlier-stage companies for higher growth potential.</p>' : ''}
            ${bostonCompanies.length > 0 ? '<p>Boston presence established - leverage local network for partnerships.</p>' : '<p>Consider adding Boston-based companies for geographic diversification.</p>'}
            ${Object.keys(byCategory).length < 3 ? '<p>Narrow category focus - consider expanding to adjacent AI verticals for broader exposure.</p>' : '<p>Good category diversification across your saved companies.</p>'}
            ${maTargets.length > savedCompanies.length * 0.5 ? '<p>High M&A target concentration - be aware of potential consolidation impacts.</p>' : ''}
        </div>
    `;

    document.getElementById('analysisBody').innerHTML = html;
    document.getElementById('analysisModal').classList.add('active');
}

function closeAnalysisModal() {
    document.getElementById('analysisModal').classList.remove('active');
}

// Export favorites to CSV for Google Sheets
function exportToCSV() {
    const savedCompanies = companies.filter(c => favorites.includes(c.id));

    if (savedCompanies.length === 0) {
        alert('No favorite companies to export. Add some favorites first!');
        return;
    }

    // CSV headers
    const headers = [
        'Name', 'Product', 'Category', 'Founded', 'CEO', 'Funding',
        'Valuation', 'Revenue', 'Employees', 'HQ', 'Website',
        'Investors', 'Customers', 'Competitors', 'Secret Sauce',
        'Description', 'M&A Insight', 'Potential Acquirers',
        'Success Factors', 'Risks', 'LinkedIn'
    ];

    // Convert company data to CSV rows
    const rows = savedCompanies.map(c => [
        c.name || '',
        c.product || '',
        c.category || '',
        c.founded || '',
        c.ceo || '',
        c.funding || '',
        c.valuation || '',
        c.revenue || '',
        c.employees || '',
        c.hq || '',
        c.website || '',
        c.investors || '',
        c.customers || '',
        c.competitors || '',
        c.secretSauce || '',
        c.description || '',
        c.maInsight || '',
        c.acquirers || '',
        (c.successFactors || []).join('; '),
        (c.risks || []).join('; '),
        c.linkedin || ''
    ]);

    // Escape CSV values
    const escapeCSV = (val) => {
        const str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    };

    // Build CSV content
    let csv = headers.map(escapeCSV).join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(escapeCSV).join(',') + '\n';
    });

    // Create and download file
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'AI_MA_Directory_Favorites.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    alert(`Exported ${savedCompanies.length} companies!\n\nOpen the downloaded CSV file in Google Sheets:\n1. Go to sheets.google.com\n2. File  Import  Upload\n3. Select the downloaded file`);
}

// ==================== PROFESSIONAL REPORT ====================
document.getElementById('fabExport').onclick = openEmailModal;

function generateReport() {
    const saved = companies.filter(c => favorites.includes(c.id));

    if (saved.length === 0) {
        alert('No companies in your watchlist yet! Click a company and tap Favorite to add.');
        return;
    }

    const totalFunding = saved.reduce((sum, c) => sum + (c.fundingValue || 0), 0);
    const unicorns = saved.filter(isUnicorn).length;
    const today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});

    const companyRows = saved.map(c => `
        <tr style="background:#fff">
            <td style="padding:16px 20px;border-bottom:1px solid #ddd;vertical-align:middle">
                <div style="font-weight:700;color:#000;font-size:15px">${c.name}</div>
                <div style="color:#555;font-size:12px;margin-top:6px;line-height:1.4">${c.description || c.product || ''}</div>
            </td>
            <td style="padding:16px;border-bottom:1px solid #ddd;vertical-align:middle;color:#333;font-size:13px">${c.ceo || ''}</td>
            <td style="padding:16px;border-bottom:1px solid #ddd;vertical-align:middle;text-align:left">
                <div style="color:#0a3d62;font-weight:700">${c.funding || 'N/A'}</div>
            </td>
            <td style="padding:16px;border-bottom:1px solid #ddd;vertical-align:middle;color:#333;font-size:13px">${c.lastRound || ''}</td>
            <td style="padding:16px;border-bottom:1px solid #ddd;vertical-align:middle;text-align:center">
                ${c.website ? '<a href="https://' + c.website + '" style="color:#0a3d62;text-decoration:none;font-size:12px">Website</a>' : ''}
            </td>
            <td style="padding:16px;border-bottom:1px solid #ddd;vertical-align:middle;text-align:center">
                ${c.linkedin ? '<a href="' + c.linkedin + '" style="color:#0a3d62;text-decoration:none;font-size:12px">LinkedIn</a>' : ''}
            </td>
        </tr>
    `).join('');

    const insights = saved.filter(c => c.maInsight).slice(0, 5).map(c => `
        <div style="margin-bottom:20px;padding:20px;background:#fff;border-radius:8px;border-left:3px solid #0a3d62">
            <div style="font-weight:700;color:#000;margin-bottom:8px">${c.name}</div>
            <div style="color:#333;font-size:13px;line-height:1.6">${c.maInsight}</div>
        </div>
    `).join('');

    const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Book - Watchlist Report</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f5f5f5; color:#000; }
    </style>
</head>
<body>
    <div style="max-width:900px;margin:0 auto;padding:40px 20px">

        <!-- Header -->
        <div style="text-align:center;padding:50px 20px;background:linear-gradient(135deg,#0a3d62,#1a5276);border-radius:16px;margin-bottom:30px">
            <div style="font-size:36px;font-weight:800;color:#fff;letter-spacing:3px">AI BOOK</div>
            <div style="font-size:14px;color:#fff;margin-top:8px;letter-spacing:1px">WATCHLIST REPORT</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.7);margin-top:16px">${today}</div>
        </div>

        <!-- Summary Stats -->
        <div style="display:flex;gap:20px;margin-bottom:30px">
            <div style="flex:1;background:#fff;border:1px solid #ddd;border-radius:12px;padding:24px;text-align:center">
                <div style="font-size:32px;font-weight:800;color:#000">${saved.length}</div>
                <div style="font-size:12px;color:#0a3d62;text-transform:uppercase;letter-spacing:1px;margin-top:4px">Companies</div>
            </div>
            <div style="flex:1;background:#fff;border:1px solid #ddd;border-radius:12px;padding:24px;text-align:center">
                <div style="font-size:32px;font-weight:800;color:#000">$${(totalFunding/1000000000).toFixed(1)}B</div>
                <div style="font-size:12px;color:#0a3d62;text-transform:uppercase;letter-spacing:1px;margin-top:4px">Total Funding</div>
            </div>
            <div style="flex:1;background:#fff;border:1px solid #ddd;border-radius:12px;padding:24px;text-align:center">
                <div style="font-size:32px;font-weight:800;color:#000">${unicorns}</div>
                <div style="font-size:12px;color:#0a3d62;text-transform:uppercase;letter-spacing:1px;margin-top:4px">Unicorns</div>
            </div>
        </div>

        <!-- Companies Table -->
        <div style="background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden;margin-bottom:30px">
            <div style="background:#0a3d62;padding:16px 20px">
                <span style="font-weight:800;color:#fff;font-size:14px;letter-spacing:1px">COMPANIES</span>
            </div>
            <table style="width:100%;border-collapse:collapse">
                <tr style="background:#0a3d62">
                    <td style="padding:12px 20px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Company</td>
                    <td style="padding:12px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">CEO</td>
                    <td style="padding:12px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Funding</td>
                    <td style="padding:12px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700">Last Round</td>
                    <td style="padding:12px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700;text-align:center">Website</td>
                    <td style="padding:12px;color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700;text-align:center">LinkedIn</td>
                </tr>
                ${companyRows}
            </table>
        </div>

        <!-- M&A Insights -->
        <div style="background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden;margin-bottom:30px">
            <div style="background:#0a3d62;padding:16px 20px">
                <span style="font-weight:800;color:#fff;font-size:14px;letter-spacing:1px">M&A INTELLIGENCE</span>
            </div>
            <div style="padding:20px;background:#f9f9f9">
                ${insights || '<div style="color:#666;text-align:center;padding:20px">No M&A insights available</div>'}
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align:center;padding:30px;color:#444;font-size:11px">
            <div>Generated by AI Book</div>
            <div style="margin-top:4px">Confidential - For Internal Use Only</div>
        </div>

    </div>
</body>
</html>`;

    // Download as HTML
    const blob = new Blob([html], {type: 'text/html'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'AI_Book_Watchlist_' + new Date().toISOString().split('T')[0] + '.html';
    link.click();
}

// Close on background click
function openEmailModal() {
    const saved = companies.filter(c => favorites.includes(c.id));
    if (saved.length === 0) {
        alert('No favorites yet! Add some companies first.');
        return;
    }
    document.getElementById('emailModal').classList.add('active');
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('active');
}

document.getElementById('emailModal').addEventListener('click', (e) => {
    if (e.target.id === 'emailModal') closeEmailModal();
});

async function submitWatchlist(e) {
    e.preventDefault();

    const email = document.getElementById('userEmail').value;
    const savedCompanies = companies.filter(c => favorites.includes(c.id));
    const btn = document.getElementById('emailSubmitBtn');

    btn.disabled = true;
    btn.textContent = 'Sending...';

    // Prepare watchlist data
    const watchlistData = {
        email: email,
        timestamp: new Date().toISOString(),
        companies: savedCompanies.map(c => ({
            name: c.name,
            category: c.category || 'AI',
            description: c.description || c.product,
            founded: c.founded,
            funding: c.funding,
            hq: c.hq,
            website: c.website,
            investors: c.investors || '',
            customers: c.customers || '',
            competitors: c.competitors || ''
        }))
    };

    // ============ WEBHOOK CONFIG ============
    // Choose ONE option and add your URL:

    // OPTION 1: Zapier Webhook
    // const WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/YOUR_ZAPIER_ID/YOUR_HOOK_ID/';

    // Google Apps Script Web App URL
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbznKu5bdmenevru1tWPIreFRzVSC00bbcBb2wPFLHu40QGgsrGO_4jhLXSGTMhJXClu/exec';
    // ==========================================

    try {
        if (WEBHOOK_URL) {
            // Send to webhook
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                mode: 'no-cors', // Required for Google Apps Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(watchlistData)
            });
        }

        // Also store locally as backup
        const submissions = JSON.parse(localStorage.getItem('ai_watchlist_submissions') || '[]');
        submissions.push(watchlistData);
        localStorage.setItem('ai_watchlist_submissions', JSON.stringify(submissions));

        // Log for debugging
        console.log('Watchlist submission:', watchlistData);

        // Show success
        document.getElementById('emailForm').style.display = 'none';
        document.getElementById('emailSuccess').style.display = 'block';

        // Download CSV as bonus
        setTimeout(() => {
            exportToCSV();
        }, 1000);

    } catch (error) {
        console.error('Submission error:', error);
        // Still show success since we saved locally
        document.getElementById('emailForm').style.display = 'none';
        document.getElementById('emailSuccess').style.display = 'block';
        setTimeout(() => exportToCSV(), 1000);
    }
}

// ==================== INSIGHTS SECTIONS ====================

let activeInsightSection = null;

function toggleInsightSection(section) {
    const panel = document.getElementById(section + 'Panel');
    const tab = document.querySelector(`.section-tab[data-section="${section}"]`);

    // If clicking the same section, close it
    if (activeInsightSection === section) {
        panel.classList.remove('active');
        tab.classList.remove('active');
        activeInsightSection = null;
        return;
    }

    // Close any open section
    if (activeInsightSection) {
        document.getElementById(activeInsightSection + 'Panel').classList.remove('active');
        document.querySelector(`.section-tab[data-section="${activeInsightSection}"]`).classList.remove('active');
    }

    // Open the new section
    panel.classList.add('active');
    tab.classList.add('active');
    activeInsightSection = section;

    // Render content
    switch(section) {
        case 'dealflow': renderDealFlow(); break;
        case 'investors': renderInvestorLeaderboard(); break;
        case 'landscape': renderCompetitiveLandscape(); break;
        case 'acquisitions': renderAcquisitionTracker(); break;
        case 'geography': renderGeography(); break;
        case 'markets': renderMarketSizing(); break;
        case 'matools': initMaTools(); break;
        case 'jobs': initJobsPanel(); setupJobsFilterListeners(); break;
        case 'linkedin': initLinkedInPanel(); break;
        case 'signals': initHiringSignalsPanel(); populateHiringCompanySelect(); break;
    }
}

function closeInsightSection(section) {
    document.getElementById(section + 'Panel').classList.remove('active');
    document.querySelector(`.section-tab[data-section="${section}"]`).classList.remove('active');
    activeInsightSection = null;
}

// ==================== DEAL FLOW ====================
function renderDealFlow() {
    const container = document.getElementById('dealFlowList');

    // Get companies with recent funding rounds and sort by funding amount
    const recentDeals = companies
        .filter(c => c.lastRound)
        .sort((a, b) => {
            // Extract year from lastRound
            const yearA = parseInt(a.lastRound.match(/\d{4}/)?.[0] || '0');
            const yearB = parseInt(b.lastRound.match(/\d{4}/)?.[0] || '0');
            if (yearB !== yearA) return yearB - yearA;
            return b.fundingValue - a.fundingValue;
        })
        .slice(0, 30);

    const categoryNames = {
        'foundation-models': 'Foundation Models',
        'developer-tools': 'Developer Tools',
        'enterprise-ai': 'Enterprise AI',
        'consumer-ai': 'Consumer AI',
        'fintech-legal': 'Fintech/Legal',
        'healthtech': 'Healthcare',
        'gtm-ai': 'GTM/Sales',
        'security-ai': 'Security',
        'robotics-ai': 'Robotics',
        'voice-ai': 'Voice AI',
        'video-ai': 'Video AI',
        'music-ai': 'Music AI'
    };

    container.innerHTML = recentDeals.map(c => `
        <div class="deal-item" onclick="openModal(${c.id})">
            <div class="deal-date">${c.lastRound.match(/\d{4}/)?.[0] || 'Recent'}</div>
            <div class="deal-company">
                ${renderLogo(c, 36)}
                <div>
                    <div class="deal-name">${c.name}</div>
                    <div class="deal-round">${c.lastRound}</div>
                </div>
            </div>
            <div class="deal-category">${categoryNames[c.category] || c.category}</div>
            <div class="deal-amount">${c.funding}</div>
        </div>
    `).join('');
}

// ==================== INVESTOR LEADERBOARD ====================
function renderInvestorLeaderboard() {
    const container = document.getElementById('investorGrid');

    // Count investor appearances
    const investorCounts = {};
    const investorPortfolios = {};

    companies.forEach(c => {
        if (!c.investors) return;
        c.investors.split(',').forEach(inv => {
            const name = inv.trim();
            if (!name) return;
            if (!investorCounts[name]) {
                investorCounts[name] = 0;
                investorPortfolios[name] = [];
            }
            investorCounts[name]++;
            investorPortfolios[name].push(c);
        });
    });

    // Sort by count and get top investors
    const topInvestors = Object.entries(investorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20);

    container.innerHTML = topInvestors.map(([name, count], idx) => {
        const portfolio = investorPortfolios[name];
        const totalFunding = portfolio.reduce((sum, c) => sum + c.fundingValue, 0);
        const domain = getDomain(name);
        const unicorns = portfolio.filter(c => isUnicorn(c)).length;

        return `
            <div class="investor-card" onclick="openInvestorModal('${name.replace(/'/g, "\\'")}')">
                <div class="investor-header">
                    ${renderLogo(name, 44)}
                    <div class="investor-info">
                        <h4>${name}</h4>
                        <span>${portfolio.length} AI investments</span>
                    </div>
                    <div class="investor-rank">#${idx + 1}</div>
                </div>
                <div class="investor-stats">
                    <div class="investor-stat">
                        <div class="investor-stat-value">${count}</div>
                        <div class="investor-stat-label">Deals</div>
                    </div>
                    <div class="investor-stat">
                        <div class="investor-stat-value">${unicorns}</div>
                        <div class="investor-stat-label">Unicorns</div>
                    </div>
                    <div class="investor-stat">
                        <div class="investor-stat-value">$${(totalFunding / 1000000000).toFixed(1)}B</div>
                        <div class="investor-stat-label">Portfolio</div>
                    </div>
                </div>
                <div class="investor-portfolio-preview">
                    ${portfolio.slice(0, 5).map(c => renderLogo(c, 24)).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// ==================== COMPETITIVE LANDSCAPE ====================
function renderCompetitiveLandscape() {
    const container = document.getElementById('landscapeGrid');

    // Define competitive clusters
    const clusters = [
        {
            title: 'Foundation Model Wars',
            subtitle: 'LLM providers competing for the AI stack',
            companies: ['OpenAI', 'Anthropic', 'Mistral AI', 'Cohere', 'AI21 Labs', 'xAI']
        },
        {
            title: 'Coding AI Battle',
            subtitle: 'AI-powered development tools',
            companies: ['Cursor', 'Codeium', 'Tabnine', 'Replit', 'Cognition']
        },
        {
            title: 'Vector Database Race',
            subtitle: 'Infrastructure for AI memory',
            companies: ['Pinecone', 'Weaviate', 'Qdrant', 'Chroma', 'Milvus / Zilliz']
        },
        {
            title: 'Enterprise Search AI',
            subtitle: 'Internal knowledge and productivity',
            companies: ['Glean', 'Moveworks', 'Guru']
        },
        {
            title: 'Video Generation AI',
            subtitle: 'Text-to-video creation',
            companies: ['Runway', 'Pika Labs', 'Synthesia', 'HeyGen', 'D-ID']
        },
        {
            title: 'Voice AI Arena',
            subtitle: 'Voice cloning and synthesis',
            companies: ['ElevenLabs', 'Resemble AI', 'Descript', 'Play.ht']
        },
        {
            title: 'Legal AI Competition',
            subtitle: 'AI for legal workflows',
            companies: ['Harvey', 'Ironclad', 'Luminance', 'Casetext']
        },
        {
            title: 'Sales/GTM AI',
            subtitle: 'Revenue intelligence and automation',
            companies: ['Gong', 'Clari', '6sense', 'Apollo.io', 'Outreach']
        },
        {
            title: 'Autonomous Vehicles',
            subtitle: 'Self-driving technology',
            companies: ['Waymo (private division)', 'Cruise', 'Motional', 'Nuro', 'Aurora']
        },
        {
            title: 'AI Chip Makers',
            subtitle: 'Custom silicon for AI',
            companies: ['Groq', 'Cerebras', 'SambaNova', 'Graphcore']
        }
    ];

    container.innerHTML = clusters.map(cluster => {
        const clusterCompanies = cluster.companies.map(name =>
            companies.find(c => c.name.toLowerCase() === name.toLowerCase() || c.name.includes(name))
        ).filter(c => c);

        return `
            <div class="landscape-cluster">
                <div class="landscape-title">${cluster.title}</div>
                <div class="landscape-subtitle">${cluster.subtitle}</div>
                <div class="landscape-companies">
                    ${clusterCompanies.map(c => `
                        <div class="landscape-company" onclick="openModal(${c.id})">
                            ${renderLogo(c, 28)}
                            <div class="landscape-company-info">
                                <div class="landscape-company-name">${c.name}</div>
                                <div class="landscape-company-product">${c.product || ''}</div>
                            </div>
                            <div class="landscape-company-funding">${c.funding}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// ==================== ACQUISITION TRACKER ====================
function renderAcquisitionTracker() {
    const container = document.getElementById('acquisitionGrid');

    // Get companies with acquirers listed and M&A insight
    const maTargets = companies
        .filter(c => c.acquirers || (c.maInsight && c.maInsight.toLowerCase().includes('target')))
        .sort((a, b) => b.fundingValue - a.fundingValue)
        .slice(0, 20);

    container.innerHTML = maTargets.map(c => {
        const acquirers = c.acquirers ? c.acquirers.split(',').map(a => a.trim()) : [];

        return `
            <div class="acquisition-card" onclick="openModal(${c.id})">
                <div class="acquisition-header">
                    ${renderLogo(c, 40)}
                    <div class="acquisition-target-info">
                        <h4>${c.name}</h4>
                        <span>${c.category.replace(/-/g, ' ')}</span>
                    </div>
                </div>
                <div class="acquisition-body">
                    ${acquirers.length > 0 ? `
                        <div class="acquisition-acquirers">
                            <div class="acquisition-acquirers-label">Potential Acquirers</div>
                            <div class="acquisition-acquirers-list">
                                ${acquirers.slice(0, 4).map(acq => `
                                    <div class="acquisition-acquirer-chip">
                                        ${renderLogo(acq, 18)}
                                        <span>${acq}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="acquisition-rationale">${c.maInsight || c.maValue || 'Strategic acquisition target'}</div>
                    <div class="acquisition-value">
                        <div>
                            <div class="acquisition-value-label">Last Funding</div>
                            <div class="acquisition-value-amount">${c.funding}</div>
                        </div>
                        ${c.valuation ? `
                            <div style="text-align:right;">
                                <div class="acquisition-value-label">Valuation</div>
                                <div class="acquisition-value-amount">${c.valuation}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ==================== GEOGRAPHY ====================
function renderGeography() {
    const container = document.getElementById('geoGrid');

    // Count by location
    const locationData = {};
    const maxCompanies = companies.length;

    companies.forEach(c => {
        if (!c.hq) return;
        let loc = 'Other';
        const hq = c.hq.toLowerCase();

        if (hq.includes('san francisco') || hq.includes('palo alto') || hq.includes('menlo park') ||
            hq.includes('mountain view') || hq.includes('sunnyvale') || hq.includes('redwood') || hq.includes('berkeley')) {
            loc = 'San Francisco Bay Area';
        } else if (hq.includes('new york') || hq.includes('brooklyn') || hq.includes('nyc')) {
            loc = 'New York';
        } else if (hq.includes('london')) {
            loc = 'London';
        } else if (hq.includes('tel aviv') || hq.includes('israel')) {
            loc = 'Tel Aviv';
        } else if (hq.includes('paris') || hq.includes('france')) {
            loc = 'Paris';
        } else if (hq.includes('seattle') || hq.includes('bellevue')) {
            loc = 'Seattle';
        } else if (hq.includes('boston')) {
            loc = 'Boston';
        } else if (hq.includes('austin') || hq.includes('texas')) {
            loc = 'Austin';
        } else if (hq.includes('los angeles') || hq.includes('santa monica')) {
            loc = 'Los Angeles';
        } else if (hq.includes('berlin') || hq.includes('germany')) {
            loc = 'Berlin';
        } else if (hq.includes('toronto') || hq.includes('canada')) {
            loc = 'Toronto';
        }

        if (!locationData[loc]) {
            locationData[loc] = { count: 0, funding: 0, companies: [], flag: getLocationFlag(loc) };
        }
        locationData[loc].count++;
        locationData[loc].funding += c.fundingValue;
        locationData[loc].companies.push(c);
    });

    // Sort by count
    const sortedLocations = Object.entries(locationData)
        .sort((a, b) => b[1].count - a[1].count)
        .filter(([loc]) => loc !== 'Other');

    const maxCount = sortedLocations[0]?.[1].count || 1;

    container.innerHTML = sortedLocations.map(([loc, data]) => `
        <div class="geo-card" onclick="filterByLocation('${loc}')">
            <div class="geo-header">
                <div class="geo-location">${loc}</div>
                <div class="geo-flag">${data.flag}</div>
            </div>
            <div class="geo-stats">
                <div class="geo-stat">
                    <div class="geo-stat-value">${data.count}</div>
                    <div class="geo-stat-label">Companies</div>
                </div>
                <div class="geo-stat">
                    <div class="geo-stat-value">$${(data.funding / 1000000000).toFixed(1)}B</div>
                    <div class="geo-stat-label">Funding</div>
                </div>
            </div>
            <div class="geo-bar">
                <div class="geo-bar-fill" style="width: ${(data.count / maxCount * 100)}%"></div>
            </div>
            <div class="geo-top-companies">
                ${data.companies.sort((a,b) => b.fundingValue - a.fundingValue).slice(0, 5).map(c => `
                    <img src="https://logo.clearbit.com/${c.website}" alt="${c.name}" onerror="this.style.display='none'">
                `).join('')}
            </div>
        </div>
    `).join('');
}

function getLocationFlag(loc) {
    const flags = {
        'San Francisco Bay Area': '',
        'New York': '',
        'Seattle': '',
        'Boston': '',
        'Austin': '',
        'Los Angeles': '',
        'London': '',
        'Tel Aviv': '',
        'Paris': '',
        'Berlin': '',
        'Toronto': '',
        'Other': ''
    };
    return flags[loc] || '';
}

function filterByLocation(location) {
    closeInsightSection('geography');
    // Clear other filters
    document.getElementById('categoryFilter').value = '';
    document.getElementById('searchInput').value = location;
    applyFilters();
}

// ==================== MARKET SIZING ====================
function renderMarketSizing() {
    const container = document.getElementById('marketSizing');

    // Market data with TAM estimates
    const marketData = [
        { category: 'foundation-models', name: 'Foundation Models', icon: '', tam: '$300B', growth: '40%', desc: 'LLMs, multi-modal AI, and core infrastructure' },
        { category: 'enterprise-ai', name: 'Enterprise AI', icon: '', tam: '$200B', growth: '35%', desc: 'Business productivity and automation' },
        { category: 'fintech-legal', name: 'Fintech & Legal AI', icon: '', tam: '$150B', growth: '30%', desc: 'Financial services and legal automation' },
        { category: 'healthtech', name: 'Healthcare AI', icon: '', tam: '$180B', growth: '45%', desc: 'Diagnostics, drug discovery, patient care' },
        { category: 'developer-tools', name: 'Developer Tools', icon: '', tam: '$80B', growth: '50%', desc: 'Code generation, DevOps, infrastructure' },
        { category: 'consumer-ai', name: 'Consumer AI', icon: '', tam: '$100B', growth: '35%', desc: 'Personal assistants, creative tools' },
        { category: 'robotics-ai', name: 'Robotics AI', icon: '', tam: '$120B', growth: '25%', desc: 'Industrial automation, humanoids' },
        { category: 'security-ai', name: 'Security AI', icon: '', tam: '$60B', growth: '40%', desc: 'Cybersecurity, fraud detection' },
        { category: 'gtm-ai', name: 'Sales & Marketing AI', icon: '', tam: '$50B', growth: '35%', desc: 'Revenue intelligence, automation' },
        { category: 'voice-ai', name: 'Voice AI', icon: '', tam: '$30B', growth: '45%', desc: 'Voice synthesis, speech recognition' },
        { category: 'video-ai', name: 'Video AI', icon: '', tam: '$40B', growth: '55%', desc: 'Video generation, editing' }
    ];

    container.innerHTML = marketData.map(market => {
        // Count companies in this category
        const categoryCompanies = companies.filter(c => c.category === market.category);
        const totalFunding = categoryCompanies.reduce((sum, c) => sum + c.fundingValue, 0);
        const unicorns = categoryCompanies.filter(c => isUnicorn(c)).length;

        return `
            <div class="market-card" onclick="document.getElementById('categoryFilter').value='${market.category}'; applyFilters(); closeInsightSection('markets');">
                <div class="market-header">
                    <div class="market-category">${market.name}</div>
                    <div class="market-icon">${market.icon}</div>
                </div>
                <div class="market-tam">${market.tam}</div>
                <div class="market-tam-label">Total Addressable Market (2030)</div>
                <div style="font-size:11px;color:var(--dim);margin-bottom:12px;">${market.desc}</div>
                <div class="market-stats">
                    <div class="market-stat">
                        <div class="market-stat-value">${categoryCompanies.length}</div>
                        <div class="market-stat-label">Companies</div>
                    </div>
                    <div class="market-stat">
                        <div class="market-stat-value">$${(totalFunding / 1000000000).toFixed(1)}B</div>
                        <div class="market-stat-label">Raised</div>
                    </div>
                    <div class="market-stat">
                        <div class="market-stat-value">${market.growth}</div>
                        <div class="market-stat-label">CAGR</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ==================== INITIALIZE ====================
document.addEventListener('DOMContentLoaded', async () => {
    // Load companies from master JSON
    try {
        const response = await fetch('companies.json');
        companies = await response.json();
        console.log('[Init] Loaded ' + companies.length + ' companies from JSON');
    } catch (error) {
        console.error('[Init] Failed to load companies:', error);
        return;
    }

    // Pre-populate hiring data for ALL 800 companies
    const hiringStats = populateAllHiringData();
    console.log(`[Init] Hiring data populated: ${hiringStats.total} companies`);

    // Compute LinkedIn signals with full dataset
    if (typeof computeLinkedInSignals === 'function') {
        computeLinkedInSignals();
    }

    applyFilters();
});
</script>
</body>
</html>
