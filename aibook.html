<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Book — The AI Company Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <meta name="theme-color" content="#D4AF37">
    <meta name="description" content="AI Book — swipe through 600+ private AI companies like Tinder. Funding, investors, M&A intelligence, and more.">
    <meta property="og:title" content="AI Book — The AI Company Tracker">
    <meta property="og:description" content="Swipe through 600+ AI companies. Real data: funding, investors, HQ, CEO, ratings, and category.">
    <meta property="og:image" content="https://jjshay.com/ai/preview.png">
    <meta property="og:url" content="https://jjshay.com/ai">
    <meta name="twitter:card" content="summary_large_image">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a1628;
            --bg-card: #0f1d32;
            --bg-glass: rgba(15, 29, 50, 0.95);
            --gold: #D4AF37;
            --gold-light: #F4CF47;
            --cyan: #00CED1;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --border: rgba(212, 175, 55, 0.25);
            --pass: #ef4444;
            --save: #22c55e;
            --navy: #1e3a5f;

            /* Typography Scale */
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --fs-xs: 10px;
            --fs-sm: 12px;
            --fs-base: 14px;
            --fs-md: 16px;
            --fs-lg: 18px;
            --fs-xl: 20px;
            --fs-2xl: 24px;

            /* Spacing Scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            font-size: var(--fs-base);
            line-height: 1.5;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            text-decoration: none;
            position: relative;
            cursor: pointer;
        }
        .logo:hover .logo-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        .logo-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: var(--bg-card);
            border: 1px solid var(--gold);
            color: var(--text);
            font-family: var(--font);
            font-size: 12px;
            font-weight: 500;
            padding: 10px 14px;
            border-radius: 10px;
            white-space: normal;
            width: 220px;
            line-height: 1.5;
            pointer-events: auto;
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .logo-tooltip a {
            color: var(--gold);
            font-weight: 700;
            text-decoration: none;
        }
        .logo-tooltip a:hover {
            text-decoration: underline;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 1.5px;
            color: #fff;
            cursor: pointer;
        }

        .app-info-popup {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 400;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .app-info-popup.active { display: flex; }
        .app-info-card {
            background: var(--bg-card);
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 28px 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
        }
        .app-info-card h2 {
            color: var(--gold);
            font-size: 20px;
            font-weight: 800;
            margin: 0 0 6px;
        }
        .app-info-card .tagline {
            color: var(--text);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .app-info-steps {
            text-align: left;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .app-info-steps li {
            color: var(--text);
            font-size: 14px;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .app-info-steps li .step-num {
            color: var(--gold);
            font-weight: 800;
            font-size: 16px;
            min-width: 24px;
        }
        .app-info-close {
            margin-top: 20px;
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: 10px 32px;
            border-radius: 20px;
            font-family: var(--font);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }

        .header-search {
            flex: 1;
            position: relative;
            max-width: 300px;
        }
        .header-search .search-input {
            font-family: var(--font);
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text);
            font-size: var(--fs-sm);
        }
        .header-search .search-input:focus {
            outline: none;
            border-color: var(--gold);
        }
        .header-search .search-input::placeholder {
            color: var(--text-dim);
        }
        .header-search .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: var(--fs-sm);
            pointer-events: none;
        }

        .saved-btn {
            font-family: var(--font);
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: var(--fs-base);
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            letter-spacing: 0.3px;
        }

        .saved-btn .badge {
            background: var(--bg);
            color: var(--gold);
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
        }

        @keyframes savedPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212,175,55,0.7); }
            50% { transform: scale(1.15); box-shadow: 0 0 12px 4px rgba(212,175,55,0.5); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212,175,55,0); }
        }
        .saved-btn.pulse {
            animation: savedPulse 0.6s ease-in-out 2;
        }

        /* ========== FILTER BAR ========== */
        .filter-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        .filter-left, .filter-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-select {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: var(--gold); }
        .filter-btn {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover {
            border-color: var(--gold);
        }
        .filter-btn.active {
            background: var(--gold);
            border-color: var(--gold);
        }
        .sort-btn {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 10px;
            color: var(--text-dim);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .sort-btn:hover {
            border-color: var(--gold);
            color: var(--text);
        }
        .sort-btn.active {
            background: var(--cyan);
            border-color: var(--cyan);
            color: var(--bg);
        }

        /* ========== VANITY STATS ========== */
        .vanity-stats {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, var(--navy) 0%, #2d4a6f 100%);
            border-bottom: 1px solid var(--border);
        }
        .vanity-stat {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        .vanity-value {
            display: block;
            font-size: var(--fs-xl);
            font-weight: 700;
            color: var(--gold);
            line-height: 1.2;
        }
        .vanity-label {
            font-size: var(--fs-xs);
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========== ACCORDION ========== */
        .card-accordion {
            margin-top: var(--space-md);
            border-top: 1px solid var(--border);
            padding-top: var(--space-sm);
        }
        .accordion-item {
            border: 1px solid var(--border);
            border-radius: var(--space-sm);
            margin-bottom: var(--space-sm);
            overflow: hidden;
            background: rgba(0,0,0,0.2);
        }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) var(--space-md);
            cursor: pointer;
            font-size: var(--fs-sm);
            font-weight: 800;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .accordion-header:hover {
            background: rgba(212,175,55,0.1);
        }
        .accordion-icon {
            font-size: var(--fs-sm);
            transition: transform 0.2s;
        }
        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 var(--space-md);
        }
        .accordion-item.open .accordion-content {
            max-height: 400px;
            padding: 0 var(--space-md) var(--space-md);
        }
        .accordion-content ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .accordion-content li {
            font-size: var(--fs-base);
            color: var(--text-dim);
            padding: var(--space-sm) 0;
            padding-left: var(--space-xl);
            position: relative;
            line-height: 1.5;
        }
        .accordion-content li::before {
            content: '•';
            position: absolute;
            left: var(--space-xs);
            color: var(--gold);
        }
        .accordion-content li.risk::before {
            content: '⚠';
            color: var(--pass);
        }
        .accordion-content li.success::before {
            content: '✓';
            color: var(--save);
        }
        .accordion-content li.intel::before {
            content: '→';
            color: var(--cyan);
        }
        .leadership-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .leadership-row:last-child { border-bottom: none; }
        .leadership-role {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 90px;
        }
        .leadership-name {
            font-size: 14px;
            color: var(--text);
            font-weight: 500;
            text-align: right;
        }
        .leadership-name.empty {
            color: var(--text-dim);
            font-style: italic;
            font-size: 12px;
        }

        /* ========== VIEW MODES ========== */
        .list-view { display: block; }
        .swipe-view { display: none; }
        body.swipe-mode .list-view { display: none; }
        body.swipe-mode .swipe-view { display: flex; flex-direction: column; flex: 1; }
        body.swipe-mode .vanity-stats { display: none; }

        /* ========== A-Z SIDEBAR + LIST ========== */
        .list-container {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
        }
        .az-sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 38px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            overflow: hidden;
            padding: 2px 0;
            -webkit-user-select: none;
            user-select: none;
        }
        .az-sort-btn {
            width: 32px;
            height: 22px;
            border: 1px solid var(--border);
            border-radius: 11px;
            background: transparent;
            color: var(--text-dim);
            font-family: var(--font);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            padding: 0;
            line-height: 20px;
            text-align: center;
            margin: 1px 0;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
        }
        .az-sort-btn.active {
            background: var(--cyan);
            border-color: var(--cyan);
            color: var(--bg);
        }
        .az-sort-divider {
            width: 20px;
            height: 1px;
            background: var(--border);
            margin: 3px 0;
        }
        .az-sidebar a {
            font-family: var(--font);
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dim);
            text-decoration: none;
            padding: 0;
            line-height: 1.15;
            text-align: center;
            display: block;
            transition: color 0.1s;
        }
        .az-sidebar a:hover,
        .az-sidebar a.active {
            color: var(--gold);
            font-size: 16px;
        }

        /* ========== MINI CARDS LIST ========== */
        .mini-cards-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .filter-heading {
            padding: 14px 16px 10px;
            font-size: 18px;
            font-weight: 800;
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
            background: rgba(212,175,55,0.08);
        }
        .filter-heading .filter-count {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dim);
            margin-left: 8px;
        }
        .filter-heading .rotating-stats {
            display: flex;
            gap: 0;
            margin-top: 6px;
            font-size: 13px;
            font-weight: 600;
            overflow: hidden;
            position: relative;
            height: 20px;
        }
        .filter-heading .rotating-stats .stat-item {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            opacity: 0;
            transition: opacity 0.4s ease;
            color: var(--text-dim);
        }
        .filter-heading .rotating-stats .stat-item.active {
            opacity: 1;
        }
        .filter-heading .rotating-stats .stat-item span {
            color: var(--gold);
            font-weight: 800;
        }
        .letter-section {
            position: sticky;
            top: 0;
            background: var(--navy);
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 700;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
            border-bottom: 1px solid var(--border);
        }
        .mini-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.15s;
        }
        .mini-card:hover {
            background: rgba(212,175,55,0.1);
        }
        .mini-card:active {
            background: rgba(212,175,55,0.2);
        }
        .mini-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .mini-logo img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }
        .mini-logo-fallback {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }
        .mini-info {
            flex: 1;
            min-width: 0;
        }
        .mini-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-product {
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-funding {
            font-size: 14px;
            font-weight: 700;
            color: var(--save);
            flex-shrink: 0;
        }
        .mini-card.acquired {
            opacity: 0.6;
        }
        .mini-card.acquired .mini-funding {
            color: var(--text-dim);
        }
        .acquired-badge {
            font-size: 10px;
            font-weight: 600;
            color: #f59e0b;
            background: rgba(245,158,11,0.15);
            padding: 1px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }
        .mini-arrow {
            color: var(--text-dim);
            font-size: 16px;
            flex-shrink: 0;
        }

        /* ========== BACK BUTTON ========== */
        .back-btn {
            font-family: var(--font);
            background: none;
            border: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
        }
        .back-btn:hover {
            color: var(--gold);
        }

        /* ========== 3-WHEEL LETTER SPINNER ========== */
        .letter-wheel-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg);
        }
        .wheel-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .wheel-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .wheel-arrow {
            font-family: var(--font);
            width: 28px;
            height: 20px;
            border: none;
            background: transparent;
            font-size: var(--fs-md);
            font-weight: 300;
            cursor: pointer;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }
        .wheel-arrow:hover {
            color: var(--gold);
        }
        .wheel-display {
            width: 36px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .wheel-display::before,
        .wheel-display::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 12px;
            z-index: 2;
            pointer-events: none;
        }
        .wheel-display::before {
            top: 0;
            background: linear-gradient(to bottom, var(--bg-card), transparent);
        }
        .wheel-display::after {
            bottom: 0;
            background: linear-gradient(to top, var(--bg-card), transparent);
        }
        .wheel-letters {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .wheel-letter {
            font-family: var(--font);
            font-weight: 700;
            width: 36px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: rgba(255,255,255,0.25);
            cursor: pointer;
            transition: all 0.2s;
        }
        .wheel-letter.active {
            color: var(--cyan);
            font-size: 18px;
            font-weight: 800;
            height: 16px;
            text-shadow: 0 0 10px rgba(0,206,209,0.5);
        }
        .wheel-letter.has-items {
            color: rgba(255,255,255,0.5);
        }
        .wheel-letter.has-items.active {
            color: var(--cyan);
        }
        .sort-toggle {
            display: flex;
            gap: var(--space-xs);
            margin-left: var(--space-md);
        }
        .sort-toggle-btn {
            font-family: var(--font);
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--space-sm);
            font-size: var(--fs-xs);
            font-weight: 600;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .sort-toggle-btn.active {
            background: var(--gold);
            color: var(--navy);
            border-color: var(--gold);
        }
        .sort-toggle-btn:hover {
            border-color: var(--gold);
        }

        /* ========== CARD AREA ========== */
        .card-area {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: hidden;
        }

        .swipe-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            padding: 6px 16px 8px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
            position: relative;
        }
        .swipe-actions-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            width: 100%;
        }
        .swipe-action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            padding: 4px 12px;
        }
        .swipe-action-item:active { opacity: 0.6; }
        .swipe-action-icon {
            font-size: 20px;
            line-height: 1;
        }
        .swipe-action-label {
            font-family: var(--font);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .swipe-action-item.pass { color: #ef4444; }
        .swipe-action-item.back { color: #94a3b8; }
        .swipe-action-item.save { color: #22c55e; }
        .swipe-counter {
            font-size: 11px;
            color: var(--text-dim);
            font-weight: 600;
            text-align: right;
            width: 100%;
            padding-right: 4px;
            margin-top: 2px;
        }

        .card {
            position: absolute;
            width: calc(100% - 32px);
            max-width: 380px;
            max-height: calc(100% - 20px);
            background: linear-gradient(145deg, var(--bg-card), #0d1a2d);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            cursor: grab;
            overflow-y: auto;
            will-change: transform;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .card:active { cursor: grabbing; }
        .card.dragging { transition: none; }
        .card.flying { transition: transform 0.4s ease-out, opacity 0.4s; pointer-events: none; }

        .card-overlay {
            position: absolute;
            top: 20px;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 20px;
            letter-spacing: 2px;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .card-overlay.pass { right: 20px; background: var(--pass); transform: rotate(15deg); }
        .card-overlay.save { left: 20px; background: var(--save); transform: rotate(-15deg); }

        /* Card Content */
        .card-logo-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .card-logo {
            width: 72px;
            height: 72px;
            border-radius: 16px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card-logo img {
            width: 58px;
            height: 58px;
            object-fit: contain;
        }

        .card-logo-fallback {
            width: 72px;
            height: 72px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: var(--bg);
        }

        .card-funding-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-funding-label {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .card-funding-value {
            font-size: var(--fs-lg);
            font-weight: 800;
            color: var(--save);
            letter-spacing: -0.5px;
        }

        .card-secret-sauce {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border: 1px solid var(--border);
            border-radius: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
        }

        .sauce-icon {
            font-size: var(--fs-md);
            flex-shrink: 0;
        }

        .sauce-text {
            font-size: var(--fs-sm);
            color: var(--gold-light);
            line-height: 1.4;
            font-weight: 500;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .card-rating { color: var(--gold); font-size: var(--fs-base); letter-spacing: 2px; }

        .card-category {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--space-md);
            font-size: var(--fs-xs);
            color: #fff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Health Badge */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--space-md);
            font-size: var(--fs-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: help;
            position: relative;
        }
        .health-badge .health-icon {
            font-size: var(--fs-sm);
        }
        .health-badge.unicorn {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: #fff;
        }
        .health-badge.hot {
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: #fff;
        }
        .health-badge.warm {
            background: linear-gradient(135deg, #eab308, #f59e0b);
            color: #1a1a1a;
        }
        .health-badge.cold {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
            color: #fff;
        }
        .health-badge.acquired {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
        }
        .health-badge.closed {
            background: linear-gradient(135deg, #4b5563, #374151);
            color: #9ca3af;
        }
        .health-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg);
            color: var(--text);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--space-sm);
            font-size: var(--fs-xs);
            font-weight: 500;
            text-transform: none;
            letter-spacing: 0;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: var(--space-xs);
        }
        .health-badge:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* ========== FUNDING TIMELINE ========== */
        .funding-timeline {
            position: relative;
            padding-left: 24px;
            margin: 8px 0;
        }
        .funding-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 4px;
            bottom: 4px;
            width: 2px;
            background: linear-gradient(to bottom, var(--gold), var(--gold-light));
            border-radius: 1px;
        }
        .timeline-item {
            position: relative;
            padding: 8px 0 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .timeline-item:last-child {
            border-bottom: none;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 14px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gold);
            border: 2px solid var(--bg-card);
            box-shadow: 0 0 6px rgba(212, 175, 55, 0.4);
        }
        .timeline-stage {
            font-size: var(--fs-sm);
            font-weight: 700;
            color: var(--gold-light);
        }
        .timeline-amount {
            font-size: var(--fs-base);
            font-weight: 800;
            color: #fff;
            margin: 2px 0;
        }
        .timeline-meta {
            font-size: var(--fs-xs);
            color: var(--text-dim);
        }

        .card-name {
            font-size: var(--fs-xl);
            font-weight: 800;
            margin-bottom: var(--space-xs);
            line-height: 1.1;
        }

        .card-product {
            color: var(--cyan);
            font-size: var(--fs-sm);
            font-weight: 600;
            margin-bottom: 0;
        }

        .card-desc {
            color: var(--text-dim);
            font-size: var(--fs-sm);
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-md);
        }

        .stat-box {
            background: rgba(0,0,0,0.2);
            border-radius: var(--space-md);
            padding: var(--space-md) var(--space-lg);
        }

        .card-links {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border);
        }

        .link-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #fff;
            transition: all 0.2s;
            cursor: pointer;
        }
        .link-circle svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        .link-circle:hover {
            background: rgba(255,255,255,0.1);
            border-color: #fff;
        }

        .similar-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .similar-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .similar-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .similar-card:hover { background: rgba(212,175,55,0.08); }
        .similar-card:active { transform: scale(0.98); }
        .similar-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        .similar-logo img { width: 28px; height: 28px; }
        .similar-logo-fallback {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }
        .similar-info { flex: 1; min-width: 0; }
        .similar-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .similar-meta {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }
        .similar-funding {
            font-size: 13px;
            font-weight: 700;
            color: var(--save);
            flex-shrink: 0;
        }

        .stat-label {
            font-size: var(--fs-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-xs);
        }

        .stat-value {
            font-size: var(--fs-base);
            font-weight: 700;
        }

        .stat-value.funding { color: var(--save); font-size: var(--fs-lg); }

        .card-info-hint {
            text-align: center;
            margin-top: 8px;
            font-family: var(--font);
            font-size: 13px;
            font-weight: 800;
            color: #fff;
            background: var(--gold);
            border-radius: 10px;
            padding: 8px 0;
            letter-spacing: 0.5px;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border);
        }

        .meta-tag {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: var(--space-xs) var(--space-md);
            border-radius: 20px;
            font-size: var(--fs-xs);
            color: var(--text-dim);
        }

        /* Progress */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--cyan));
            transition: width 0.3s;
        }

        /* ========== ACTIONS ========== */
        .actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 32px;
            padding: var(--space-lg);
            padding-bottom: max(var(--space-lg), env(safe-area-inset-bottom));
            background: var(--bg);
        }

        .action-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
        }

        .action-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid;
            background: var(--bg-card);
            font-size: var(--fs-2xl);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .action-btn:active { transform: scale(0.9); }

        .action-label {
            font-size: var(--fs-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .btn-pass { border-color: var(--pass); color: var(--pass); }
        .btn-pass:hover { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        .action-group:has(.btn-pass) .action-label { color: var(--pass); }

        .btn-undo { border-color: var(--gold); color: var(--gold); }
        .btn-undo:hover { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .action-group:has(.btn-undo) .action-label { color: var(--gold); }

        .btn-save { border-color: var(--save); color: var(--save); }
        .btn-save:hover { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
        .action-group:has(.btn-save) .action-label { color: var(--save); }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
        }

        .empty-state .icon { font-size: 64px; margin-bottom: var(--space-xl); }
        .empty-state h3 { font-size: var(--fs-xl); margin-bottom: var(--space-sm); }
        .empty-state p { color: var(--text-dim); font-size: var(--fs-base); margin-bottom: var(--space-2xl); }

        .reset-btn {
            font-family: var(--font);
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: var(--space-md) var(--space-2xl);
            border-radius: 25px;
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--space-2xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 { font-size: var(--fs-lg); font-weight: 700; }

        .close-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .modal-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border);
        }

        /* Saved List */
        .saved-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--space-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .saved-item:active { cursor: grabbing; }
        .saved-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .saved-item.drag-over {
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .saved-name { font-weight: 700; font-size: var(--fs-md); margin-bottom: var(--space-xs); }
        .saved-info { color: var(--text-dim); font-size: var(--fs-sm); }

        .analytics-box {
            background: linear-gradient(135deg, var(--navy) 0%, #2d4a6f 100%);
            border-radius: var(--space-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            color: #fff;
        }
        .analytics-title {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold);
            margin-bottom: var(--space-md);
        }
        .analytics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            font-size: var(--fs-sm);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .analytics-row:last-child { border-bottom: none; }
        .analytics-value {
            font-weight: 700;
            color: var(--gold);
        }
        .analytics-total {
            font-size: var(--fs-2xl);
            font-weight: 800;
            color: var(--gold);
            text-align: center;
            margin-top: var(--space-md);
        }
        .analytics-label {
            font-size: var(--fs-xs);
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .view-toggle {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        .view-toggle button {
            font-family: var(--font);
            flex: 1;
            padding: var(--space-sm);
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: var(--space-sm);
            font-size: var(--fs-sm);
            cursor: pointer;
            color: var(--text-dim);
        }
        .view-toggle button.active {
            background: var(--navy);
            color: #fff;
            border-color: var(--navy);
        }

        .category-group {
            margin-bottom: var(--space-lg);
        }
        .category-group-header {
            font-size: var(--fs-sm);
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--space-sm);
        }
        .saved-funding { color: var(--save); font-weight: 600; margin-top: var(--space-sm); }

        /* Floating A-Z Index */
        .alpha-index {
            position: fixed;
            right: var(--space-xs);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 1000;
            background: rgba(30,58,95,0.95);
            padding: 4px 2px;
            border-radius: var(--space-md);
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        .alpha-index span {
            font-family: var(--font);
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            padding: 2px 6px;
            cursor: pointer;
            text-align: center;
            border-radius: var(--space-xs);
            transition: background 0.1s;
        }
        .alpha-index span:hover,
        .alpha-index span.active {
            background: var(--gold);
            color: var(--navy);
        }
        .alpha-index span.disabled {
            color: rgba(255,255,255,0.3);
            cursor: default;
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
        }
        .sort-btn {
            font-family: var(--font);
            padding: var(--space-xs) var(--space-md);
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: var(--space-xs);
            font-size: var(--fs-xs);
            cursor: pointer;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .sort-btn.active {
            background: var(--navy);
            color: #fff;
            border-color: var(--navy);
        }
        .sort-btn .arrow {
            font-size: var(--fs-xs);
        }

        .letter-header {
            font-size: var(--fs-lg);
            font-weight: 800;
            color: var(--navy);
            padding: var(--space-md) 0 var(--space-xs);
            border-bottom: 2px solid var(--gold);
            margin-bottom: var(--space-sm);
        }

        .remove-btn {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            background: rgba(220,38,38,0.1);
            border: none;
            color: #dc2626;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            z-index: 10;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
        }
        .remove-btn:hover {
            background: rgba(220,38,38,0.3);
            transform: scale(1.1);
        }

        /* Email Gate */
        .email-gate {
            text-align: center;
            padding: var(--space-xl);
        }

        .email-gate h3 { font-size: var(--fs-xl); margin-bottom: var(--space-sm); }
        .email-gate p { color: var(--text-dim); font-size: var(--fs-sm); margin-bottom: var(--space-xl); }

        .email-input {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--border);
            border-radius: var(--space-md);
            background: var(--bg);
            color: var(--text);
            font-size: var(--fs-base);
            margin-bottom: var(--space-md);
        }

        .email-input:focus { outline: none; border-color: var(--gold); }

        .email-submit {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md);
            background: var(--gold);
            color: var(--bg);
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        .export-btn {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md);
            background: var(--save);
            color: white;
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        .empty-saved {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
            color: var(--text-dim);
        }

        .empty-saved .icon { font-size: 48px; margin-bottom: var(--space-md); }

        /* ========== DETAIL MODAL ========== */
        .detail-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .detail-modal.active { display: block; }

        .detail-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--space-2xl);
            max-width: 500px;
            margin: 0 auto;
            overflow: hidden;
        }

        .detail-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            padding: var(--space-2xl);
            position: relative;
        }

        .detail-close {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: var(--fs-2xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--bg);
            margin-bottom: var(--space-xs);
        }

        .detail-product {
            font-size: var(--fs-md);
            color: var(--bg);
            opacity: 0.8;
        }

        .detail-body { padding: var(--space-2xl); }

        .detail-section {
            margin-bottom: var(--space-xl);
        }

        .detail-section:last-child { margin-bottom: 0; }

        .detail-section-title {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold);
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .detail-section-content {
            color: var(--text);
            font-size: var(--fs-base);
            line-height: 1.6;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .detail-stat {
            background: var(--bg);
            border-radius: var(--space-md);
            padding: var(--space-md);
        }

        .detail-stat-label {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: var(--space-xs);
        }

        .detail-stat-value {
            font-size: var(--fs-md);
            font-weight: 700;
        }

        .detail-stat-value.highlight { color: var(--save); font-size: var(--fs-xl); }

        .detail-link {
            display: inline-block;
            background: var(--gold);
            color: var(--bg);
            padding: var(--space-md) var(--space-2xl);
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: var(--fs-base);
            margin-top: var(--space-sm);
        }

        .detail-rating {
            color: var(--gold);
            font-size: var(--fs-lg);
            letter-spacing: 3px;
        }

        .detail-actions {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-xl) var(--space-2xl);
            border-top: 1px solid var(--border);
        }

        .detail-btn {
            font-family: var(--font);
            flex: 1;
            padding: var(--space-md);
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .detail-btn.pass-btn {
            background: rgba(239, 68, 68, 0.2);
            color: var(--pass);
            border: 1px solid var(--pass);
        }

        .detail-btn.save-btn {
            background: var(--save);
            color: white;
        }

        /* ========== CLICKABLE STAT CARDS ========== */
        .vanity-stat.clickable {
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .vanity-stat.clickable:hover { background: rgba(212,175,55,0.1); }
        .vanity-stat.clickable:active { transform: scale(0.95); }

        /* ========== STAT MODAL ========== */
        .stat-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 250;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .stat-modal.active { display: block; }
        .stat-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--navy) 0%, #1a3a5c 100%);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .stat-modal-header h2 {
            font-family: var(--font);
            font-size: var(--fs-lg);
            font-weight: 700;
            color: var(--gold);
            margin: 0;
        }
        .stat-modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stat-modal-body {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ========== BAR CHART ========== */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px 0;
        }
        .bar-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font);
            font-size: 13px;
            font-weight: 600;
        }
        .bar-label-name { color: var(--text); }
        .bar-label-value { color: var(--gold); font-weight: 700; }
        .bar-label-value.cyan { color: var(--cyan); }
        .bar-track {
            height: 32px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #e8c84a);
            border-radius: 8px;
            transition: width 0.6s cubic-bezier(0.25,0.46,0.45,0.94);
            min-width: 4px;
        }
        .bar-fill.cyan {
            background: linear-gradient(90deg, var(--cyan), #00e5e8);
        }

        /* ========== STAT COMPANY LIST ========== */
        .stat-letter-header {
            position: sticky;
            top: 0;
            background: var(--navy);
            padding: 6px 16px;
            font-family: var(--font);
            font-size: 12px;
            font-weight: 700;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 5;
            border-bottom: 1px solid var(--border);
        }
        .stat-company-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            cursor: pointer;
            transition: background 0.15s;
            gap: 12px;
        }
        .stat-company-item:active { background: rgba(212,175,55,0.1); }
        .stat-company-name {
            flex: 1;
            font-family: var(--font);
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        .stat-company-cat {
            font-family: var(--font);
            font-size: 10px;
            color: var(--text-dim);
        }
        .stat-company-funding {
            font-family: var(--font);
            font-size: 12px;
            font-weight: 700;
            color: var(--gold);
            white-space: nowrap;
        }

        .az-dropdown {
            font-family: var(--font);
            font-size: 13px;
            padding: 6px 10px;
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        /* ========== STAR RATING INTERACTIVE ========== */
        .card-rating.clickable {
            cursor: pointer;
            position: relative;
        }
        .card-rating.clickable:hover::after {
            content: 'Tap for definitions';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg);
            color: var(--text-dim);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            border: 1px solid var(--border);
            margin-bottom: 4px;
            letter-spacing: 0;
            pointer-events: none;
        }
        .rating-def-item {
            display: flex;
            gap: 14px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            align-items: flex-start;
        }
        .rating-def-item:last-child { border-bottom: none; }
        .rating-def-stars {
            color: var(--gold);
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 80px;
            letter-spacing: 1px;
        }
        .rating-def-text { flex: 1; }
        .rating-def-title {
            font-family: var(--font);
            font-weight: 700;
            font-size: 14px;
            color: var(--text);
            margin-bottom: 2px;
        }
        .rating-def-desc {
            font-family: var(--font);
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.4;
        }
        /* ========== SPLASH SCREEN ========== */
        .splash {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: linear-gradient(145deg, #0a1628 0%, #1a3050 50%, #0d1f35 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.5s ease-out;
        }
        .splash.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            animation: splashPulse 1.5s ease-in-out infinite;
        }
        .splash-title {
            font-family: var(--font);
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 3px;
            color: var(--gold);
            text-align: center;
        }
        .splash-by {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font);
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            letter-spacing: 1px;
        }
        .splash-by img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        @keyframes splashPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div class="splash" id="splash">
        <img src="icon-192.png" alt="AI Book" class="splash-logo">
        <div class="splash-title">THE AI BOOK</div>
        <div class="splash-by">by <img src="https://jjshay.com/logo.png" alt="JS"> jjshay</div>
    </div>

    <div class="app">
        <!-- HEADER -->
        <div class="header">
            <div class="logo" onclick="openAppInfo()">
                <img src="icon-192.png" alt="AI Book" class="logo-icon">
                <span class="logo-text">AI BOOK</span>
                <span class="logo-tooltip">Tap for guide. Auto-updated daily. Over 70 reports and counting on AI. See all projects at <a href="https://jjshay.com" target="_blank">jjshay.com</a></span>
            </div>
            <div class="header-search">
                <span class="search-icon">⌕</span>
                <input type="text" class="search-input" id="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
            </div>
            <button class="saved-btn" onclick="openSaved()">
                Saved <span class="badge" id="saved-count">0</span>
            </button>
        </div>

        <!-- APP INFO POPUP -->
        <div class="app-info-popup" id="app-info-popup" onclick="if(event.target===this)closeAppInfo()">
            <div class="app-info-card">
                <h2>AI BOOK</h2>
                <div class="tagline">Your pocket guide to 600+ private AI companies — real data, zero noise.</div>
                <ul class="app-info-steps">
                    <li><span class="step-num">1</span> Filter by category, funding tier, or search by name</li>
                    <li><span class="step-num">2</span> Tap a company to enter swipe mode</li>
                    <li><span class="step-num">3</span> Swipe right to save, left to pass</li>
                    <li><span class="step-num">4</span> Open your Saved list and email yourself the results</li>
                </ul>
                <button class="app-info-close" onclick="closeAppInfo()">Got it</button>
            </div>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
            <div class="filter-left">
                <select class="filter-select" id="filter" onchange="filterChanged()"></select>
                <button class="filter-btn" id="filter-unicorn" onclick="toggleFilter('unicorn')" title="Unicorns: $1B+ valuation">🦄 $1B+</button>
                <button class="filter-btn" id="filter-hot" onclick="toggleFilter('hot')" title="Hot: $100M+ funding">🔥 HOT</button>
                <button class="filter-btn" id="filter-new" onclick="toggleFilter('new')" title="New additions">🆕 NEW</button>
                <button class="filter-btn" id="filter-acquired" onclick="toggleFilter('acquired')" title="Acquired / Sold">💰 SOLD</button>
            </div>
            <div class="filter-right">
                <button class="sort-btn" id="sort-az" onclick="sortDeck('alpha')" title="Sort alphabetically A-Z">A-Z</button>
                <button class="sort-btn" id="sort-funding" onclick="sortDeck('funding')" title="Sort by funding amount">$$$</button>
                <button class="sort-btn" onclick="exportCSV()" title="Export filtered list as CSV">CSV</button>
            </div>
        </div>

        <!-- VANITY STATS -->
        <div class="vanity-stats" id="vanity-stats">
            <div class="vanity-stat clickable" onclick="openStatModal('companies')">
                <span class="vanity-value" id="stat-companies">800</span>
                <span class="vanity-label">Companies</span>
            </div>
            <div class="vanity-stat clickable" onclick="openStatModal('funding')">
                <span class="vanity-value" id="stat-funding">$150B+</span>
                <span class="vanity-label">Total Raised</span>
            </div>
            <div class="vanity-stat">
                <span class="vanity-value" id="stat-updated" style="color:var(--cyan)">--</span>
                <span class="vanity-label">Last Updated</span>
            </div>
        </div>

        <!-- LIST VIEW (Landing Page) -->
        <div class="list-view list-container">
            <div class="az-sidebar" id="az-sidebar"></div>
            <div class="mini-cards-container" id="mini-cards"></div>
        </div>

        <!-- SWIPE VIEW (After clicking a company) -->
        <div class="swipe-view">
            <div style="padding:8px 16px;background:var(--bg-card);border-bottom:1px solid var(--border)">
                <button class="back-btn" onclick="exitSwipeMode()">← Back to List</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress" style="width: 0%"></div>
            </div>
            <div class="card-area" id="card-area"></div>
            <div class="swipe-actions" id="swipe-actions">
                <div class="swipe-actions-row">
                    <div class="swipe-action-item pass" onclick="doSwipe('left')">
                        <span class="swipe-action-icon">←</span>
                        <span class="swipe-action-label">Pass</span>
                    </div>
                    <div class="swipe-action-item back" onclick="exitSwipeMode()">
                        <span class="swipe-action-icon">↑</span>
                        <span class="swipe-action-label">Back</span>
                    </div>
                    <div class="swipe-action-item save" onclick="doSwipe('right')">
                        <span class="swipe-action-icon">→</span>
                        <span class="swipe-action-label">Save</span>
                    </div>
                </div>
                <span class="swipe-counter" id="swipe-counter"></span>
            </div>
        </div>

    </div>

    <!-- DETAIL MODAL -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-content" id="detail-content"></div>
    </div>

    <!-- RATING DEFINITIONS MODAL -->
    <div class="modal" id="rating-modal" style="z-index:350">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h2>Rating Guide</h2>
                <button class="close-btn" onclick="document.getElementById('rating-modal').classList.remove('active')">×</button>
            </div>
            <div class="modal-body" style="padding:16px">
                <div style="display:flex;flex-direction:column;gap:14px">
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <span style="color:var(--gold);font-size:16px;white-space:nowrap">★★★★★</span>
                        <div><strong style="color:#fff">Category Leader</strong><br><span style="color:var(--text-dim);font-size:13px">Dominant market position, $1B+ scale, proven moat</span></div>
                    </div>
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <span style="color:var(--gold);font-size:16px;white-space:nowrap">★★★★☆</span>
                        <div><strong style="color:#fff">Strong Contender</strong><br><span style="color:var(--text-dim);font-size:13px">$200M+ raised, strong traction, clear differentiation</span></div>
                    </div>
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <span style="color:var(--gold);font-size:16px;white-space:nowrap">★★★☆☆</span>
                        <div><strong style="color:#fff">Promising</strong><br><span style="color:var(--text-dim);font-size:13px">Growing company with product-market fit, real revenue</span></div>
                    </div>
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <span style="color:var(--gold);font-size:16px;white-space:nowrap">★★☆☆☆</span>
                        <div><strong style="color:#fff">Early Stage</strong><br><span style="color:var(--text-dim);font-size:13px">Pre-revenue or early revenue, still finding fit</span></div>
                    </div>
                    <div style="display:flex;align-items:flex-start;gap:12px">
                        <span style="color:var(--gold);font-size:16px;white-space:nowrap">★☆☆☆☆</span>
                        <div><strong style="color:#fff">Nascent</strong><br><span style="color:var(--text-dim);font-size:13px">Very early, pre-product or research stage</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVED MODAL -->
    <div class="modal" id="saved-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Companies</h2>
                <button class="close-btn" onclick="closeSaved()">×</button>
            </div>
            <div class="modal-body" id="saved-list"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <!-- STAT MODAL -->
    <div class="stat-modal" id="stat-modal">
        <div class="stat-modal-header">
            <h2 id="stat-modal-title">Companies</h2>
            <button class="stat-modal-close" onclick="closeStatModal()">&times;</button>
        </div>
        <div class="stat-modal-body" id="stat-modal-body"></div>
    </div>


<script>
// ========== COMPANY DATA ==========
let companies = [];

// ========== STATE ==========
let currentFilter = 'all';
let activeHealthFilter = null; // 'unicorn', 'hot', 'rising', or null

function toggleFilter(type) {
    const btn = document.getElementById(`filter-${type}`);
    if (activeHealthFilter === type) {
        activeHealthFilter = null;
        btn.classList.remove('active');
    } else {
        // Clear other filter
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        activeHealthFilter = type;
        btn.classList.add('active');
    }
    buildDeck();
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}
let deck = [];
let index = 0;
let saved = JSON.parse(localStorage.getItem('ai_tracker_saved') || '[]');
let history = [];
let userEmail = localStorage.getItem('ai_tracker_email') || '';

// ========== CATEGORY LABELS ==========
const CATEGORY_LABELS = {
    'foundation-infra': { short: 'Foundation', long: 'Foundation & Infra' },
    'enterprise': { short: 'Enterprise', long: 'Enterprise AI' },
    'dev-tools': { short: 'Dev Tools', long: 'Developer Tools' },
    'consumer-creative': { short: 'Consumer', long: 'Consumer & Creative' },
    'healthcare': { short: 'Health', long: 'Healthcare' },
    'security': { short: 'Security', long: 'Security AI' },
    'finance-legal': { short: 'Finance', long: 'Finance & Legal' },
    'industrial': { short: 'Industrial', long: 'Industrial & Climate' }
};
function getCategoryLabel(category, long = false) {
    const entry = CATEGORY_LABELS[category];
    if (entry) return long ? entry.long : entry.short;
    return category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// ========== BUILD FILTER DROPDOWN ==========
function buildFilterDropdown() {
    const select = document.getElementById('filter');
    const counts = {};
    companies.forEach(c => { counts[c.category] = (counts[c.category] || 0) + 1; });

    let html = `<option value="all">All (${companies.length})</option>`;
    Object.keys(CATEGORY_LABELS).forEach(cat => {
        if (!counts[cat]) return;
        html += `<option value="${cat}">${getCategoryLabel(cat, true)} (${counts[cat]})</option>`;
    });
    select.innerHTML = html;
    if (currentFilter !== 'all') select.value = currentFilter;
}

// ========== STAT MODAL ==========
function openStatModal(type) {
    const modal = document.getElementById('stat-modal');
    const title = document.getElementById('stat-modal-title');
    const body = document.getElementById('stat-modal-body');

    if (type === 'companies') {
        const allCompanies = [...companies].filter(c => {
            const funding = (c.funding || '').toLowerCase();
            return !funding.includes('public');
        });
        title.textContent = 'All Companies (' + allCompanies.length + ')';
        body.innerHTML = renderCompanyListForStatModal(allCompanies);
    } else if (type === 'funding') {
        title.textContent = 'Funding by Category';
        body.innerHTML = renderFundingBarChart();
    } else if (type === 'ma') {
        title.textContent = 'M&A Targets by Category';
        body.innerHTML = renderMABarChart();
    }

    modal.classList.add('active');
}

function closeStatModal() {
    document.getElementById('stat-modal').classList.remove('active');
}

function renderCompanyListForStatModal(companyList) {
    const sorted = companyList.sort((a, b) => a.name.localeCompare(b.name));
    const grouped = {};
    sorted.forEach(c => {
        const letter = c.name.charAt(0).toUpperCase();
        if (!grouped[letter]) grouped[letter] = [];
        grouped[letter].push(c);
    });

    const letters = Object.keys(grouped).sort();
    let html = '<div style="margin-bottom:12px;display:flex;align-items:center;gap:8px">';
    html += '<label style="font-size:12px;font-weight:600;color:var(--text-dim)">Jump to:</label>';
    html += '<select class="az-dropdown" onchange="statModalScrollToLetter(this.value)">';
    html += '<option value="">All (' + sorted.length + ')</option>';
    letters.forEach(l => {
        html += '<option value="' + l + '">' + l + ' (' + grouped[l].length + ')</option>';
    });
    html += '</select></div>';

    html += '<div id="stat-company-list">';
    letters.forEach(letter => {
        html += '<div class="stat-letter-header" id="stat-section-' + letter + '">' + letter + '</div>';
        grouped[letter].forEach(c => {
            const catLabel = getCategoryLabel(c.category);
            html += '<div class="stat-company-item" onclick="closeStatModal(); enterSwipeMode(' + c.id + ')">';
            html += '<div style="flex:1;min-width:0"><div class="stat-company-name">' + c.name + '</div>';
            html += '<div class="stat-company-cat">' + catLabel + '</div></div>';
            html += '<div class="stat-company-funding">' + (c.funding || '') + '</div>';
            html += '</div>';
        });
    });
    html += '</div>';
    return html;
}

function statModalScrollToLetter(letter) {
    if (!letter) return;
    const el = document.getElementById('stat-section-' + letter);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderFundingBarChart() {
    const fundingByCat = {};
    companies.forEach(c => {
        const funding = (c.funding || '').toLowerCase();
        if (funding.includes('public')) return;
        const catLabel = getCategoryLabel(c.category, true);
        if (!fundingByCat[catLabel]) fundingByCat[catLabel] = 0;
        fundingByCat[catLabel] += parseFundingAmount(c.funding);
    });

    const sorted = Object.entries(fundingByCat).sort((a, b) => b[1] - a[1]);
    const max = sorted.length > 0 ? sorted[0][1] : 1;

    let html = '<div class="bar-chart">';
    sorted.forEach(([cat, amount]) => {
        const pct = (amount / max) * 100;
        const display = amount >= 1000 ? '$' + (amount / 1000).toFixed(1) + 'B' : '$' + Math.round(amount) + 'M';
        html += '<div class="bar-row">';
        html += '<div class="bar-label"><span class="bar-label-name">' + cat + '</span>';
        html += '<span class="bar-label-value">' + display + '</span></div>';
        html += '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%"></div></div>';
        html += '</div>';
    });
    html += '</div>';
    return html;
}

function renderMABarChart() {
    const maByCat = {};
    let total = 0;
    companies.forEach(c => {
        const funding = (c.funding || '').toLowerCase();
        if (funding.includes('public')) return;
        if (isMATarget(c)) {
            const catLabel = getCategoryLabel(c.category, true);
            if (!maByCat[catLabel]) maByCat[catLabel] = 0;
            maByCat[catLabel]++;
            total++;
        }
    });

    const sorted = Object.entries(maByCat).sort((a, b) => b[1] - a[1]);
    const max = sorted.length > 0 ? sorted[0][1] : 1;

    let html = '<p style="font-size:12px;color:var(--text-dim);margin-bottom:16px">Companies with $100M+ funding or 5-star rating (' + total + ' total)</p>';
    html += '<div class="bar-chart">';
    sorted.forEach(([cat, count]) => {
        const pct = (count / max) * 100;
        html += '<div class="bar-row">';
        html += '<div class="bar-label"><span class="bar-label-name">' + cat + '</span>';
        html += '<span class="bar-label-value cyan">' + count + ' companies</span></div>';
        html += '<div class="bar-track"><div class="bar-fill cyan" style="width:' + pct + '%"></div></div>';
        html += '</div>';
    });
    html += '</div>';
    return html;
}

// ========== STAR RATING DEFINITIONS ==========
function openRatingModal() {
    document.getElementById('rating-modal').classList.add('active');
}

function closeRatingModal() {
    document.getElementById('rating-modal').classList.remove('active');
}

function openAppInfo() {
    document.getElementById('app-info-popup').classList.add('active');
}
function closeAppInfo() {
    document.getElementById('app-info-popup').classList.remove('active');
}

// ========== INIT ==========
function dismissSplash() {
    const splash = document.getElementById('splash');
    if (splash) {
        splash.classList.add('fade-out');
        setTimeout(() => splash.remove(), 500);
    }
}

function init() {
    buildFilterDropdown();
    buildDeck();
    // Restore swipe progress
    try {
        const savedIdx = parseInt(localStorage.getItem('ai-book-swipe-index'));
        if (!isNaN(savedIdx) && savedIdx >= 0 && savedIdx < deck.length) index = savedIdx;
    } catch(e) {}
    renderListView();
    renderAZSidebar();
    updateUI();
    updateVanityStats();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Don't intercept if typing in search
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (e.key === 'Escape') {
            if (document.getElementById('app-info-popup').classList.contains('active')) {
                closeAppInfo();
            } else if (document.getElementById('saved-modal').classList.contains('active')) {
                closeSaved();
            } else if (document.getElementById('stat-modal').classList.contains('active')) {
                closeStatModal();
            } else if (document.getElementById('rating-modal').classList.contains('active')) {
                closeRatingModal();
            } else if (document.getElementById('detail-modal').classList.contains('active')) {
                closeDetail();
            } else if (document.body.classList.contains('swipe-mode')) {
                exitSwipeMode();
            }
        }

        // Swipe mode shortcuts
        if (document.body.classList.contains('swipe-mode') && !document.querySelector('.modal.active, .detail-modal.active')) {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'p') { doSwipe('left'); }
            else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 's') { doSwipe('right'); }
            else if (e.key.toLowerCase() === 'z') { undoSwipe(); }
            else if (e.key === 'ArrowUp' || e.key === 'Enter') {
                const c = deck[index]; if (c) openDetail(c);
            }
        }
    });
}

// ========== LIST VIEW ==========
let currentLetter = 'A';

function getAcquiredStats() {
    let total = 0;
    let count = 0;
    let withValue = 0;
    deck.forEach(c => {
        count++;
        // Try to parse acquisition value from valuation or funding
        const val = c.valuation || c.funding || '';
        const match = val.match(/\$?([\d.]+)\s*(B|M|T)/i);
        if (match) {
            const num = parseFloat(match[1]);
            const mult = match[2].toUpperCase() === 'B' ? 1000 : match[2].toUpperCase() === 'T' ? 1000000 : 1;
            total += num * mult; // in millions
            withValue++;
        }
    });
    const avg = withValue > 0 ? total / withValue : 0;
    const fmtVal = (v) => v >= 1000 ? `$${(v/1000).toFixed(1)}B` : `$${Math.round(v)}M`;
    return {
        count,
        totalStr: total > 0 ? fmtVal(total) : 'N/A',
        avgStr: avg > 0 ? fmtVal(avg) : 'N/A'
    };
}

function renderAcquiredPieChart() {
    const catCounts = {};
    deck.forEach(c => {
        const cat = getCategoryLabel(c.category, true);
        catCounts[cat] = (catCounts[cat] || 0) + 1;
    });
    const sorted = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);
    const total = sorted.reduce((s, e) => s + e[1], 0);
    if (total === 0) return '';

    const colors = ['#d4af37','#00ced1','#ef4444','#22c55e','#a855f7','#f97316','#3b82f6','#ec4899','#14b8a6','#eab308','#6366f1','#f43f5e'];
    const r = 50, cx = 60, cy = 60;
    let startAngle = 0;
    let paths = '';
    sorted.forEach(([cat, count], i) => {
        const slice = (count / total) * Math.PI * 2;
        const endAngle = startAngle + slice;
        const x1 = cx + r * Math.cos(startAngle);
        const y1 = cy + r * Math.sin(startAngle);
        const x2 = cx + r * Math.cos(endAngle);
        const y2 = cy + r * Math.sin(endAngle);
        const large = slice > Math.PI ? 1 : 0;
        const color = colors[i % colors.length];
        paths += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} Z" fill="${color}"/>`;
        startAngle = endAngle;
    });

    let legend = sorted.map(([cat, count], i) => {
        const color = colors[i % colors.length];
        const pct = Math.round((count / total) * 100);
        return `<div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-dim)"><span style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0"></span>${cat} (${count}, ${pct}%)</div>`;
    }).join('');

    return `<div style="display:flex;align-items:center;gap:16px;margin-top:10px;padding:0 8px">
        <svg width="120" height="120" viewBox="0 0 120 120" style="flex-shrink:0">${paths}</svg>
        <div style="display:flex;flex-direction:column;gap:3px">${legend}</div>
    </div>`;
}

let acquiredRotationTimer = null;

function startAcquiredRotation() {
    if (acquiredRotationTimer) clearInterval(acquiredRotationTimer);
    const container = document.getElementById('acquired-rotating');
    if (!container) return;
    let idx = 0;
    const items = container.querySelectorAll('.stat-item');
    if (items.length === 0) return;
    acquiredRotationTimer = setInterval(() => {
        items[idx].classList.remove('active');
        idx = (idx + 1) % items.length;
        items[idx].classList.add('active');
    }, 2500);
}

function getFilterHeading() {
    const labels = {
        unicorn: { icon: '🦄', title: 'Unicorns', desc: '$1B+ valuation' },
        hot: { icon: '🔥', title: 'Hot Companies', desc: '$100M+ funding' },
        new: { icon: '🆕', title: 'New Additions', desc: 'Added in last 7 days' },
        acquired: { icon: '💰', title: 'Sold / Acquired', desc: new Date().getFullYear() + ' YTD' }
    };
    return activeHealthFilter ? labels[activeHealthFilter] || null : null;
}

function renderListView() {
    const container = document.getElementById('mini-cards');
    if (!container) return;

    let html = '';

    // Add filter heading if a filter is active
    const heading = getFilterHeading();
    if (heading) {
        if (activeHealthFilter === 'acquired') {
            const stats = getAcquiredStats();
            html += `<div class="filter-heading">${heading.icon} ${heading.title} <span style="font-size:13px;font-weight:400;color:var(--text-dim)">${heading.desc}</span>` +
                `<div class="rotating-stats" id="acquired-rotating">` +
                `<div class="stat-item active"><span>${stats.count}</span> companies acquired</div>` +
                `<div class="stat-item"><span>${stats.totalStr}</span> total deal value</div>` +
                `<div class="stat-item"><span>${stats.avgStr}</span> avg. acquisition price</div>` +
                `</div>` + renderAcquiredPieChart() + `</div>`;
        } else {
            // Calculate w/w growth for current filter
            const now = new Date();
            const oneWeekAgo = new Date(now); oneWeekAgo.setDate(now.getDate() - 7);
            const twoWeeksAgo = new Date(now); twoWeeksAgo.setDate(now.getDate() - 14);

            let thisWeek = 0, lastWeek = 0;
            const allPrivate = companies.filter(c => !(c.funding || '').toLowerCase().includes('public'));

            allPrivate.forEach(c => {
                // Check if company qualifies for current filter
                let qualifies = true;
                if (activeHealthFilter === 'unicorn') qualifies = parseFundingAmount(c.funding) >= 1000;
                else if (activeHealthFilter === 'hot') qualifies = parseFundingAmount(c.funding) >= 100;
                else if (activeHealthFilter === 'new') {
                    if (!c.dateAdded) return;
                    const added = new Date(c.dateAdded);
                    if (added >= oneWeekAgo) { thisWeek++; }
                    return;
                }
                if (!qualifies) return;
                if (c.dateAdded) {
                    const added = new Date(c.dateAdded);
                    if (added >= oneWeekAgo) thisWeek++;
                    else if (added >= twoWeeksAgo) lastWeek++;
                }
            });

            let growthHtml = '';
            if (activeHealthFilter === 'new') {
                const prevTotal = deck.length > 0 ? allPrivate.length - deck.length : allPrivate.length;
                const pct = prevTotal > 0 ? ((deck.length / prevTotal) * 100).toFixed(1) : '0';
                const color = deck.length > 0 ? 'var(--save)' : 'var(--pass)';
                growthHtml = `<span class="filter-count" style="color:${color};margin-top:2px">+${pct}% w/w growth</span>`;
            } else if (thisWeek > 0 || lastWeek > 0) {
                if (lastWeek === 0 && thisWeek > 0) {
                    // All new — show count instead of meaningless +100%
                    growthHtml = `<span class="filter-count" style="color:var(--save);margin-top:2px">${thisWeek} new this week</span>`;
                } else {
                    const diff = thisWeek - lastWeek;
                    const pct = ((diff / lastWeek) * 100).toFixed(0);
                    const sign = diff >= 0 ? '+' : '';
                    const color = diff >= 0 ? 'var(--save)' : 'var(--pass)';
                    growthHtml = `<span class="filter-count" style="color:${color};margin-top:2px">${sign}${pct}% w/w (${thisWeek} added this week)</span>`;
                }
            }

            html += `<div class="filter-heading">${heading.icon} ${heading.title}<span class="filter-count">${deck.length} companies &middot; ${heading.desc}</span>${growthHtml}</div>`;
        }
    }

    // Use the already-sorted deck (from applyDeckSort)
    if (deckSortMode === 'funding') {
        // Flat list for funding sort
        deck.forEach(c => {
            html += renderMiniCard(c);
        });
    } else {
        // Group by first letter for alpha sort (default)
        const sorted = deckSortMode === 'alpha' ? [...deck] : [...deck].sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return deckSortOrder === 'asc' ? cmp : -cmp;
        });

        const grouped = {};
        sorted.forEach(c => {
            const letter = c.name.charAt(0).toUpperCase();
            if (!grouped[letter]) grouped[letter] = [];
            grouped[letter].push(c);
        });

        const letterKeys = Object.keys(grouped).sort((a, b) => {
            return deckSortOrder === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
        });

        letterKeys.forEach(letter => {
            html += `<div class="letter-section" id="section-${letter}">${letter}</div>`;
            grouped[letter].forEach(c => {
                html += renderMiniCard(c);
            });
        });
    }

    container.innerHTML = html;

    // Start rotation if acquired filter is active
    if (activeHealthFilter === 'acquired') {
        startAcquiredRotation();
    } else if (acquiredRotationTimer) {
        clearInterval(acquiredRotationTimer);
        acquiredRotationTimer = null;
    }
}

function isRecentlyUpdated(c) {
    if (!c.lastAutoUpdate) return false;
    const d = new Date(c.lastAutoUpdate);
    const ago = new Date();
    ago.setDate(ago.getDate() - 7);
    return d >= ago;
}

function highlightMatch(text, query) {
    if (!query || !text) return text || '';
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark style="background:var(--gold);color:#000;border-radius:2px;padding:0 1px">$1</mark>');
}

function renderMiniCard(c) {
    const logoUrl = c.website ? `https://www.google.com/s2/favicons?domain=${c.website}&sz=128` : null;
    const fallback = c.name.charAt(0).toUpperCase();
    const updated = isRecentlyUpdated(c);
    const isAcquired = c.status === 'acquired' || c.status === 'closed';
    const acquiredBadge = isAcquired ? `<span class="acquired-badge">Acquired${c.acquiredBy ? ' → ' + c.acquiredBy : ''}</span>` : '';
    const name = searchQuery ? highlightMatch(c.name, searchQuery) : c.name;
    const product = searchQuery ? highlightMatch(c.product || '', searchQuery) : (c.product || '');
    return `
        <div class="mini-card${isAcquired ? ' acquired' : ''}" onclick="enterSwipeMode(${c.id})">
            <div class="mini-logo">
                ${logoUrl
                    ? `<img src="${logoUrl}" onerror="this.parentElement.innerHTML='<span class=\\'mini-logo-fallback\\'>${fallback}</span>'">`
                    : `<span class="mini-logo-fallback">${fallback}</span>`
                }
            </div>
            <div class="mini-info">
                <div class="mini-name">${name}${updated ? '<span style="display:inline-block;width:6px;height:6px;background:var(--cyan);border-radius:50%;margin-left:6px;vertical-align:middle" title="Recently updated"></span>' : ''}${acquiredBadge}</div>
                <div class="mini-product">${product}</div>
            </div>
            <div class="mini-funding">${c.funding || ''}</div>
            <div class="mini-arrow">›</div>
        </div>
    `;
}

let activeLetterFilter = '';

function renderAZSidebar() {
    const sidebar = document.getElementById('az-sidebar');
    if (!sidebar) return;

    const lCounts = {};
    deck.forEach(c => {
        const letter = c.name.charAt(0).toUpperCase();
        lCounts[letter] = (lCounts[letter] || 0) + 1;
    });

    // Sort buttons at top
    const azActive = deckSortMode === 'alpha' ? ' active' : '';
    const azLabel = deckSortMode === 'alpha' ? (deckSortOrder === 'asc' ? 'A↓' : 'Z↓') : 'AZ';
    const fundActive = deckSortMode === 'funding' ? ' active' : '';
    const fundLabel = deckSortMode === 'funding' ? (deckSortOrder === 'desc' ? '$↓' : '$↑') : '$';

    let html = `<button class="az-sort-btn${azActive}" id="sb-sort-az" onclick="sortDeck('alpha')">${azLabel}</button>`;
    html += `<button class="az-sort-btn${fundActive}" id="sb-sort-funding" onclick="sortDeck('funding')">${fundLabel}</button>`;
    html += `<div class="az-sort-divider"></div>`;

    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    html += letters.map(letter => {
        const has = lCounts[letter];
        const cls = activeLetterFilter === letter ? ' class="active"' : '';
        return has
            ? `<a href="#section-${letter}"${cls} onclick="event.preventDefault();scrollToLetter('${letter}')">${letter}</a>`
            : `<span style="font-size:14px;color:rgba(255,255,255,0.15);padding:0;line-height:1.15">${letter}</span>`;
    }).join('');

    sidebar.innerHTML = html;
}

function scrollToLetter(letter) {
    const section = document.getElementById('section-' + letter);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function filterByLetter(letter) {
    activeLetterFilter = letter;
    buildDeck();
}

function enterSwipeMode(companyId) {
    // Sort deck alphabetically and find the company
    deck.sort((a, b) => a.name.localeCompare(b.name));
    deckSortMode = 'alpha';
    deckSortOrder = 'asc';

    // Find company index
    const companyIndex = deck.findIndex(c => c.id === companyId);
    if (companyIndex !== -1) {
        index = companyIndex;
    }

    // Switch to swipe mode
    document.body.classList.add('swipe-mode');
    renderCards();
    updateUI();
    updateSortButtons();
}

function exitSwipeMode() {
    document.body.classList.remove('swipe-mode');
    renderListView();
    renderAZSidebar();
}

function updateVanityStats() {
    // Use current filtered deck for stats
    let totalFunding = 0;
    let maTargets = 0;

    deck.forEach(c => {
        totalFunding += parseFundingAmount(c.funding);
        if (isMATarget(c)) {
            maTargets++;
        }
    });

    const fundingDisplay = totalFunding >= 1000
        ? `$${Math.round(totalFunding / 1000)}B+`
        : `$${Math.round(totalFunding)}M+`;

    document.getElementById('stat-companies').textContent = deck.length;
    document.getElementById('stat-funding').textContent = fundingDisplay;

    // Show today's date as last updated
    const now = new Date();
    const el = document.getElementById('stat-updated');
    if (el) {
        const mo = now.toLocaleString('default', { month: 'short' });
        const day = now.getDate();
        el.textContent = `${mo} ${day}`;
    }
}

function buildDeck() {
    deck = currentFilter === 'all'
        ? [...companies]
        : companies.filter(c => c.category === currentFilter);

    // Remove public companies
    deck = deck.filter(c => {
        const funding = (c.funding || '').toLowerCase();
        return !funding.includes('public');
    });

    // Acquired companies stay in the list (marked visually in renderMiniCard)

    // Deduplicate by normalized name (keep first occurrence)
    const seen = new Set();
    function normalizeName(name) {
        return name.toLowerCase()
            .replace(/\s*(ai|labs|inc|corp|llc|\.ai|\.io|\.com)\.?\s*$/gi, '') // Remove common suffixes
            .replace(/[^a-z0-9]/g, '') // Remove non-alphanumeric
            .trim();
    }
    deck = deck.filter(c => {
        const normalized = normalizeName(c.name);
        if (seen.has(normalized)) return false;
        seen.add(normalized);
        return true;
    });

    // Apply health filter (unicorn/hot/rising)
    if (activeHealthFilter) {
        deck = deck.filter(c => {
            const funding = parseFundingAmount(c.funding);
            if (activeHealthFilter === 'unicorn') {
                return funding >= 1000; // $1B+
            } else if (activeHealthFilter === 'hot') {
                return funding >= 100; // $100M+
            } else if (activeHealthFilter === 'new') {
                if (!c.dateAdded) return false;
                const added = new Date(c.dateAdded);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - 7);
                return added >= cutoff;
            } else if (activeHealthFilter === 'acquired') {
                if (c.status !== 'acquired' && c.status !== 'closed') return false;
                if (!c.acquiredDate) return false;
                const yr = new Date().getFullYear();
                return new Date(c.acquiredDate) >= new Date(yr, 0, 1);
            }
            return true;
        });
    }

    // Apply search filter (searches name, product, description, ceo, investors, hq, customers, category)
    if (searchQuery) {
        deck = deck.filter(c => c._searchText && c._searchText.includes(searchQuery));
    }

    // Apply A-Z letter filter
    if (activeLetterFilter) {
        deck = deck.filter(c => c.name.charAt(0).toUpperCase() === activeLetterFilter);
    }

    // Shuffle only if no search or sort active
    if (!searchQuery && deckSortMode === 'none' && !activeLetterFilter) {
        deck.sort(() => Math.random() - 0.5);
    }

    // Remove already saved
    const savedIds = new Set(saved.map(c => c.id));
    deck = deck.filter(c => !savedIds.has(c.id));

    // Re-apply sort if active
    if (deckSortMode !== 'none') {
        applyDeckSort();
    } else if (activeLetterFilter) {
        deck.sort((a, b) => a.name.localeCompare(b.name));
    }

    index = 0;
    history = [];
}

function updateUI() {
    const savedBtn = document.querySelector('.saved-btn');
    document.getElementById('saved-count').textContent = saved.length;
    if (savedBtn) savedBtn.style.opacity = saved.length > 0 ? '1' : '0.5';
    const pct = deck.length > 0 ? ((index / deck.length) * 100) : 0;
    document.getElementById('progress').style.width = pct + '%';
    const counter = document.getElementById('swipe-counter');
    if (counter) counter.textContent = deck.length > 0 ? `${index + 1} of ${deck.length}` : '';
    // Persist swipe progress
    try { localStorage.setItem('ai-book-swipe-index', index); } catch(e) {}
}

// ========== FILTER ==========
function filterChanged() {
    currentFilter = document.getElementById('filter').value;
    buildDeck();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}

// ========== SEARCH ==========
let searchQuery = '';

function handleSearch(query) {
    searchQuery = query.toLowerCase().trim();
    buildDeck();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}

// ========== DECK SORTING ==========
let deckSortMode = 'none'; // 'none', 'alpha', 'funding'
let deckSortOrder = 'asc';

function sortDeck(mode) {
    // Toggle order if same mode clicked
    if (mode === deckSortMode) {
        deckSortOrder = deckSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        deckSortMode = mode;
        deckSortOrder = mode === 'funding' ? 'desc' : 'asc';
    }

    applyDeckSort();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateSortButtons();
}

function applyDeckSort() {
    if (deckSortMode === 'alpha') {
        deck.sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return deckSortOrder === 'asc' ? cmp : -cmp;
        });
    } else if (deckSortMode === 'funding') {
        deck.sort((a, b) => {
            const aFund = parseFundingAmount(a.funding);
            const bFund = parseFundingAmount(b.funding);
            return deckSortOrder === 'desc' ? bFund - aFund : aFund - bFund;
        });
    }
    index = 0;
}

function isMATarget(c) {
    return parseFundingAmount(c.funding) >= 100 || (c.rating || 3) >= 5;
}

function parseFundingAmount(funding) {
    if (!funding) return 0;
    const match = funding.match(/\$?([\d.]+)\s*(B|M|K)?/i);
    if (!match) return 0;
    let amount = parseFloat(match[1]);
    const unit = (match[2] || '').toUpperCase();
    if (unit === 'B') amount *= 1000;
    else if (unit === 'K') amount /= 1000;
    return amount;
}

function getCompanyHealth(c) {
    // Acquired companies
    if (c.status === 'acquired') {
        return {
            class: 'acquired',
            icon: '🏷️',
            label: 'Acquired',
            tooltip: c.acquiredBy ? `Acquired by ${c.acquiredBy}` : 'Acquired'
        };
    }

    // Closed/bankrupt companies
    if (c.status === 'closed') {
        return {
            class: 'closed',
            icon: '⛔',
            label: 'Closed',
            tooltip: 'Company closed or bankrupt'
        };
    }

    const funding = parseFundingAmount(c.funding);
    const rating = c.rating || 3;

    // Unicorn: $1B+ funding
    if (funding >= 1000) {
        return {
            class: 'unicorn',
            icon: '🦄',
            label: 'Unicorn',
            tooltip: '$1B+ Elite'
        };
    }

    // Hot: $100M-$1B or high rating with decent funding
    if (funding >= 100 || (rating >= 4 && funding >= 50)) {
        return {
            class: 'hot',
            icon: '🔥',
            label: 'Hot',
            tooltip: 'Strong Momentum'
        };
    }

    // Emerging: $10M-$100M
    if (funding >= 10) {
        return {
            class: 'warm',
            icon: '🌱',
            label: 'Emerging',
            tooltip: 'Emerging ($10M-$100M)'
        };
    }

    // Early: Under $10M
    return {
        class: 'cold',
        icon: '🔬',
        label: 'Early',
        tooltip: 'Early Stage'
    };
}

function updateSortButtons() {
    document.getElementById('sort-az').classList.toggle('active', deckSortMode === 'alpha');
    document.getElementById('sort-funding').classList.toggle('active', deckSortMode === 'funding');

    // Update filter-bar button text
    document.getElementById('sort-az').textContent = deckSortMode === 'alpha'
        ? (deckSortOrder === 'asc' ? 'A→Z' : 'Z→A')
        : 'A-Z';
    document.getElementById('sort-funding').textContent = deckSortMode === 'funding'
        ? (deckSortOrder === 'desc' ? '$$$ ↓' : '$$$ ↑')
        : '$$$';

    // Update sidebar sort buttons
    const sbAz = document.getElementById('sb-sort-az');
    const sbFund = document.getElementById('sb-sort-funding');
    if (sbAz) {
        sbAz.classList.toggle('active', deckSortMode === 'alpha');
        sbAz.textContent = deckSortMode === 'alpha' ? (deckSortOrder === 'asc' ? 'A↓' : 'Z↓') : 'AZ';
    }
    if (sbFund) {
        sbFund.classList.toggle('active', deckSortMode === 'funding');
        sbFund.textContent = deckSortMode === 'funding' ? (deckSortOrder === 'desc' ? '$↓' : '$↑') : '$';
    }
}

// 3-Wheel letter spinner state
const wheelGroups = [
    'ABCDEFGHI'.split(''),  // Wheel 0: A-I
    'JKLMNOPQR'.split(''),  // Wheel 1: J-R
    'STUVWXYZ'.split('')    // Wheel 2: S-Z
];
let wheelIndices = [0, 0, 0]; // Current index for each wheel
let letterCounts = {};

function initLetterWheel() {
    wheelGroups.forEach((letters, wheelIdx) => {
        const slot = document.getElementById(`wheel-slot-${wheelIdx}`);
        slot.innerHTML = `
            <button class="wheel-arrow" onclick="spinWheel(${wheelIdx}, -1)">&#9650;</button>
            <div class="wheel-display">
                <div class="wheel-letters" id="wheel-letters-${wheelIdx}">
                    ${letters.map((letter, i) =>
                        `<span class="wheel-letter" data-wheel="${wheelIdx}" data-index="${i}" onclick="selectWheelLetter(${wheelIdx}, ${i})">${letter}</span>`
                    ).join('')}
                </div>
            </div>
            <button class="wheel-arrow" onclick="spinWheel(${wheelIdx}, 1)">&#9660;</button>
        `;
    });
    updateLetterWheel();
}

function updateLetterCounts() {
    const remaining = deck.slice(index);
    letterCounts = {};
    remaining.forEach(c => {
        const letter = c.name.charAt(0).toUpperCase();
        letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    });
}

function updateLetterWheel() {
    updateLetterCounts();

    wheelGroups.forEach((letters, wheelIdx) => {
        const container = document.getElementById(`wheel-letters-${wheelIdx}`);
        if (!container) return;

        const wheelLetterEls = container.querySelectorAll('.wheel-letter');
        const currentIdx = wheelIndices[wheelIdx];

        wheelLetterEls.forEach((el, i) => {
            const letter = letters[i];
            el.classList.remove('active', 'has-items');
            if (letterCounts[letter] > 0) el.classList.add('has-items');
            if (i === currentIdx) el.classList.add('active');
        });

        // Position wheel - center on current letter
        const letterHeight = 16;
        const offset = -currentIdx * letterHeight + 16; // +16 to center in 48px display
        container.style.transform = `translateY(${offset}px)`;
    });
}

function spinWheel(wheelIdx, direction) {
    const maxIdx = wheelGroups[wheelIdx].length - 1;
    wheelIndices[wheelIdx] = Math.max(0, Math.min(maxIdx, wheelIndices[wheelIdx] + direction));
    updateLetterWheel();
}

function selectWheelLetter(wheelIdx, letterIdx) {
    wheelIndices[wheelIdx] = letterIdx;
    updateLetterWheel();
    const letter = wheelGroups[wheelIdx][letterIdx];
    jumpToLetter(letter);
}

function jumpToLetter(letter) {
    // Sort alphabetically first if not already
    if (deckSortMode !== 'alpha') {
        deckSortMode = 'alpha';
        deckSortOrder = 'asc';
        applyDeckSort();
        updateSortButtons();
    }

    // Find first company starting with this letter
    const targetIndex = deck.findIndex((c, i) => i >= index && c.name.charAt(0).toUpperCase() === letter);
    if (targetIndex !== -1) {
        index = targetIndex;
        renderCards();
        updateUI();
        updateLetterWheel();
    }
}

// ========== RENDER CARDS ==========
function renderCards() {
    const area = document.getElementById('card-area');
    area.innerHTML = '';

    if (index >= deck.length) {
        area.innerHTML = `
            <div class="empty-state">
                <div class="icon">🎉</div>
                <h3>All Done!</h3>
                <p>You've reviewed all companies in this category.</p>
                <button class="reset-btn" onclick="resetDeck()">Start Over</button>
            </div>
        `;
        return;
    }

    // Render next card (behind)
    if (index + 1 < deck.length) {
        const next = deck[index + 1];
        area.appendChild(createCard(next, false));
    }

    // Render current card (front)
    const current = deck[index];
    const card = createCard(current, true);
    setupSwipeGestures(card);
    setupTapHandler(card, current);
    area.appendChild(card);
}

function createCard(c, isCurrent) {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = c.id;

    if (!isCurrent) {
        card.style.transform = 'scale(0.95) translateY(8px)';
        card.style.opacity = '0.6';
        card.style.zIndex = '1';
    } else {
        card.style.zIndex = '2';
    }

    const stars = '★'.repeat(c.rating || 4) + '☆'.repeat(5 - (c.rating || 4));
    const catLabel = getCategoryLabel(c.category);
    const health = getCompanyHealth(c);

    const logoUrl = c.website ? `https://www.google.com/s2/favicons?domain=${c.website}&sz=128` : null;
    const fallbackInitial = c.name.charAt(0);

    card.innerHTML = `
        <div class="card-overlay pass">PASS</div>
        <div class="card-overlay save">SAVE</div>
        <div class="card-logo-row">
            <div class="card-logo" id="logo-${c.id}">
                ${logoUrl ? `<img src="${logoUrl}" alt="${c.name}" onerror="this.parentElement.innerHTML='<div class=\\'card-logo-fallback\\'>${fallbackInitial}</div>'">` : `<div class="card-logo-fallback">${fallbackInitial}</div>`}
            </div>
            <div style="flex:1">
                <div class="card-name">${c.name}</div>
                <div class="card-product">${c.product || ''}</div>
            </div>
            <span class="health-badge ${health.class}" data-tooltip="${health.tooltip}">
                <span class="health-icon">${health.icon}</span>${health.label}
            </span>
        </div>
        <div class="card-funding-banner">
            <span class="card-funding-label">Investment Raised</span>
            <span class="card-funding-value">${c.funding || 'N/A'}</span>
        </div>
        ${c.secretSauce ? `<div class="card-secret-sauce">
            <span class="sauce-icon">🔥</span>
            <span class="sauce-text">${c.secretSauce}</span>
        </div>` : ''}
        <div class="card-header">
            <span class="card-rating clickable" onclick="event.stopPropagation(); openRatingModal()">${stars}</span>
            <span class="card-category">${catLabel}</span>
        </div>
        <div class="card-stats">
            <div class="stat-box">
                <div class="stat-label">Employees</div>
                <div class="stat-value">${c.employees || 'N/A'}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">HQ</div>
                <div class="stat-value">${c.hq || 'N/A'}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Founded</div>
                <div class="stat-value">${c.founded || 'N/A'}</div>
            </div>
            ${c.ceo ? `<div class="stat-box">
                <div class="stat-label">CEO</div>
                <div class="stat-value">${c.ceo}</div>
            </div>` : ''}
        </div>
        <div class="card-info-hint">TAP FOR FULL PROFILE ➤</div>
    `;

    return card;
}

function generateAccordion(c) {
    const funding = parseFundingAmount(c.funding);
    const fundingTier = funding > 1000 ? 'mega' : funding > 100 ? 'growth' : 'early';

    // Generate M&A Intelligence based on company data
    const maIntel = [];
    if (funding > 500) maIntel.push('Prime acquisition target for big tech');
    if (funding > 1000) maIntel.push('IPO candidate within 2-3 years');
    if (c.category === 'foundation-models') maIntel.push('Strategic asset for AI capabilities');
    if (c.category === 'ai-infrastructure') maIntel.push('Infrastructure play attractive to cloud providers');
    if (c.category === 'coding-ai') maIntel.push('Developer tools attract enterprise acquirers');
    if (c.employees && c.employees.includes('1,000')) maIntel.push('Scale attracts PE interest');
    if (maIntel.length === 0) maIntel.push('Early-stage, building strategic value');

    // Generate Success Factors
    const successFactors = [];
    if (c.secretSauce) successFactors.push(c.secretSauce.split('+')[0].trim());
    if (c.ceo) successFactors.push(`Experienced leadership (${c.ceo})`);
    if (funding > 100) successFactors.push('Strong funding runway');
    if (c.rating >= 4) successFactors.push('High market momentum');
    if (c.category === 'enterprise-ai') successFactors.push('Enterprise revenue stability');
    if (successFactors.length < 3) successFactors.push('Growing market opportunity');

    // Generate Risks
    const risks = [];
    if (c.category === 'foundation-models') risks.push('Intense competition from OpenAI/Google');
    if (funding < 50) risks.push('Limited runway for scaling');
    if (c.employees && c.employees.includes('50-')) risks.push('Team scaling challenges');
    if (c.category === 'consumer-ai') risks.push('User acquisition costs');
    if (c.category === 'ai-chips') risks.push('Hardware commoditization risk');
    risks.push('Regulatory uncertainty in AI');
    if (risks.length < 3) risks.push('Market timing dependency');

    return `
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>M&A Intelligence</span>
                <span class="accordion-icon">▼</span>
            </div>
            <div class="accordion-content">
                <ul>${maIntel.slice(0, 3).map(i => `<li class="intel">${i}</li>`).join('')}</ul>
            </div>
        </div>
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>Success Factors</span>
                <span class="accordion-icon">▼</span>
            </div>
            <div class="accordion-content">
                <ul>${successFactors.slice(0, 3).map(i => `<li class="success">${i}</li>`).join('')}</ul>
            </div>
        </div>
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>Risks</span>
                <span class="accordion-icon">▼</span>
            </div>
            <div class="accordion-content">
                <ul>${risks.slice(0, 3).map(i => `<li class="risk">${i}</li>`).join('')}</ul>
            </div>
        </div>
    `;
}

function toggleAccordion(event) {
    event.stopPropagation();
    const item = event.target.closest('.accordion-item');
    if (item) {
        item.classList.toggle('open');
    }
}

// ========== TAP TO VIEW DETAIL ==========
let tapStartTime = 0;
let tapStartX = 0;
let tapStartY = 0;

function setupTapHandler(card, company) {
    card.addEventListener('touchstart', (e) => {
        tapStartTime = Date.now();
        tapStartX = e.touches[0].clientX;
        tapStartY = e.touches[0].clientY;
    }, { passive: true });

    card.addEventListener('touchend', (e) => {
        const elapsed = Date.now() - tapStartTime;
        const touch = e.changedTouches[0];
        const dx = Math.abs(touch.clientX - tapStartX);
        const dy = Math.abs(touch.clientY - tapStartY);

        // Quick tap with minimal movement = open detail
        if (elapsed < 200 && dx < 10 && dy < 10) {
            openDetail(company);
        }
    });

    card.addEventListener('click', (e) => {
        // For mouse clicks (desktop)
        if (e.detail === 1 && !card.classList.contains('dragging')) {
            setTimeout(() => {
                if (!card.classList.contains('flying')) {
                    openDetail(company);
                }
            }, 150);
        }
    });
}

function getSimilarCompanies(company, count = 3) {
    const funding = parseFundingAmount(company.funding);
    return companies
        .filter(c => c.id !== company.id && c.category === company.category)
        .map(c => ({ ...c, diff: Math.abs(parseFundingAmount(c.funding) - funding) }))
        .sort((a, b) => a.diff - b.diff)
        .slice(0, count);
}

function renderSimilarCompanies(company) {
    const similar = getSimilarCompanies(company);
    if (similar.length === 0) return '';
    return `
        <div class="similar-section">
            <div class="similar-title">Similar Companies</div>
            ${similar.map(c => {
                const logoUrl = c.website ? `https://www.google.com/s2/favicons?domain=${c.website}&sz=64` : null;
                const initial = c.name.charAt(0);
                return `<div class="similar-card" onclick="closeDetail();openDetail(companies.find(x=>x.id===${c.id}))">
                    <div class="similar-logo">
                        ${logoUrl ? `<img src="${logoUrl}" alt="${c.name}" onerror="this.parentElement.innerHTML='<span class=\\'similar-logo-fallback\\'>${initial}</span>'">` : `<span class="similar-logo-fallback">${initial}</span>`}
                    </div>
                    <div class="similar-info">
                        <div class="similar-name">${c.name}</div>
                        <div class="similar-meta">${c.product || getCategoryLabel(c.category)}</div>
                    </div>
                    <div class="similar-funding">${c.funding || 'N/A'}</div>
                </div>`;
            }).join('')}
        </div>`;
}

function openDetail(company) {
    const modal = document.getElementById('detail-modal');
    const content = document.getElementById('detail-content');

    const logoUrl = company.website ? `https://www.google.com/s2/favicons?domain=${company.website}&sz=128` : null;
    const fallbackInitial = company.name.charAt(0);
    const stars = '★'.repeat(company.rating || 4) + '☆'.repeat(5 - (company.rating || 4));
    const catLabel = getCategoryLabel(company.category, true);

    content.innerHTML = `
        <div class="detail-header">
            <button class="detail-close" onclick="closeDetail()">×</button>
            <div style="display:flex;align-items:center;gap:16px">
                <div class="card-logo" style="width:70px;height:70px;border-radius:16px">
                    ${logoUrl ? `<img src="${logoUrl}" style="width:56px;height:56px" onerror="this.parentElement.innerHTML='<div class=\\'card-logo-fallback\\' style=\\'width:70px;height:70px;font-size:28px\\'>${fallbackInitial}</div>'" alt="${company.name}">` : `<div class="card-logo-fallback" style="width:70px;height:70px;font-size:28px">${fallbackInitial}</div>`}
                </div>
                <div>
                    <div class="detail-name">${company.name}</div>
                    <div class="detail-product">${company.product || ''}</div>
                </div>
            </div>
        </div>
        <div class="detail-body">
            <div class="detail-section">
                <div class="detail-section-title">Rating</div>
                <div class="detail-rating" style="cursor:pointer" onclick="openRatingModal()">${stars}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">Category</div>
                <div class="detail-section-content">${catLabel}</div>
            </div>
            ${company.secretSauce ? `
            <div class="detail-section">
                <div class="detail-section-title">🔥 Secret Sauce</div>
                <div class="detail-section-content" style="color:var(--gold-light);font-weight:500">${company.secretSauce}</div>
            </div>
            ` : ''}
            <div class="detail-section">
                <div class="detail-section-title">About</div>
                <div class="detail-section-content">${company.description || 'No description available.'}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">Key Metrics</div>
                <div class="detail-grid">
                    <div class="detail-stat">
                        <div class="detail-stat-label">Funding</div>
                        <div class="detail-stat-value highlight">${company.funding || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">Employees</div>
                        <div class="detail-stat-value">${company.employees || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">Founded</div>
                        <div class="detail-stat-value">${company.founded || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">HQ</div>
                        <div class="detail-stat-value">${company.hq || 'N/A'}</div>
                    </div>
                </div>
            </div>
            <div class="card-accordion" style="margin-top:16px;">
                <div class="accordion-item" onclick="toggleAccordion(event)">
                    <div class="accordion-header">
                        <span>Leadership</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="leadership-row">
                            <span class="leadership-role">CEO</span>
                            <span class="leadership-name${company.ceo ? '' : ' empty'}">${company.ceo || '—'}</span>
                        </div>
                    </div>
                </div>
                ${company.fundingRounds && company.fundingRounds.length > 0 ? `
                <div class="accordion-item" onclick="toggleAccordion(event)">
                    <div class="accordion-header">
                        <span>Funding Timeline</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="funding-timeline">
                            ${company.fundingRounds.slice().reverse().map(r => `
                                <div class="timeline-item">
                                    <div class="timeline-stage">${r.stage}</div>
                                    <div class="timeline-amount">${r.amount}</div>
                                    <div class="timeline-meta">${r.date ? r.date : ''}${r.investors ? ' · ' + r.investors : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                ${generateAccordion(company)}
            </div>
            ${renderSimilarCompanies(company)}
            <div class="card-links" style="margin-top:16px;">
                ${company.website ? `<a href="https://${company.website}" target="_blank" class="link-circle" title="${company.website}"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></a>` : ''}
                <a href="https://linkedin.com/company/${company.name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-')}" target="_blank" class="link-circle" title="LinkedIn"><svg viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
                <button class="link-circle" onclick="shareCompany(${company.id})" title="Share"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 0-6 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0 0 6c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65a2.89 2.89 0 0 0 2.89 2.89 2.89 2.89 0 0 0 2.89-2.89A2.89 2.89 0 0 0 18 16.08z"/></svg></button>
            </div>
        </div>
        <div class="detail-actions">
            <button class="detail-btn pass-btn" onclick="closeDetail(); doSwipe('left')">✕ Pass</button>
            <button class="detail-btn save-btn" onclick="closeDetail(); doSwipe('right')">♥ Save</button>
        </div>
    `;

    modal.classList.add('active');
}

function closeDetail() {
    document.getElementById('detail-modal').classList.remove('active');
}

function shareCompany(id) {
    const c = companies.find(x => x.id === id);
    if (!c) return;
    const text = `${c.name} — ${c.product || ''}\nFunding: ${c.funding || 'N/A'}\nHQ: ${c.hq || 'N/A'}\nFounded: ${c.founded || 'N/A'}\n` +
        (c.description ? `${c.description}\n` : '') + (c.website ? `https://${c.website}` : '');
    const url = c.website ? `https://${c.website}` : '';

    // Use Web Share API on mobile if available
    if (navigator.share) {
        navigator.share({ title: c.name, text: text.trim(), url: url }).catch(() => {});
    } else {
        navigator.clipboard.writeText(text.trim()).then(() => {
            const btn = event.target.closest('button');
            if (btn) { btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#4ade80"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'; setTimeout(() => btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#fff"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 0-6 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0 0 6c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65a2.89 2.89 0 0 0 2.89 2.89 2.89 2.89 0 0 0 2.89-2.89A2.89 2.89 0 0 0 18 16.08z"/></svg>', 1500); }
        });
    }
}

// ========== SWIPE GESTURES ==========
function setupSwipeGestures(card) {
    let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;

    const onStart = (e) => {
        isDragging = true;
        startX = e.touches ? e.touches[0].clientX : e.clientX;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        card.classList.add('dragging');
    };

    const onMove = (e) => {
        if (!isDragging) return;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        currentX = x - startX;
        currentY = y - startY;

        const rotate = currentX * 0.04;
            card.style.transform = `translateX(${currentX}px) translateY(${Math.min(0, currentY)}px) rotate(${rotate}deg)`;

            const passOverlay = card.querySelector('.card-overlay.pass');
            const saveOverlay = card.querySelector('.card-overlay.save');

            if (currentY < -40 && Math.abs(currentY) > Math.abs(currentX)) {
                // Swiping up — show LIST overlay
                passOverlay.style.opacity = 0;
                saveOverlay.style.opacity = 0;
            } else if (currentX < -40) {
                passOverlay.style.opacity = Math.min(1, Math.abs(currentX) / 120);
                saveOverlay.style.opacity = 0;
            } else if (currentX > 40) {
                saveOverlay.style.opacity = Math.min(1, currentX / 120);
                passOverlay.style.opacity = 0;
            } else {
                passOverlay.style.opacity = 0;
                saveOverlay.style.opacity = 0;
            }
    };

    const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        if (currentY < -100 && Math.abs(currentY) > Math.abs(currentX)) {
            // Swipe up = back to list
            card.style.transition = 'transform 0.3s, opacity 0.3s';
            card.style.transform = 'translateY(-150vh)';
            card.style.opacity = '0';
            setTimeout(() => exitSwipeMode(), 250);
        } else if (currentX < -100) {
            flyCard('left');
        } else if (currentX > 100) {
            flyCard('right');
        } else {
            card.style.transition = 'transform 0.3s, opacity 0.3s';
            card.style.transform = '';
            card.style.opacity = '';
            card.querySelector('.card-overlay.pass').style.opacity = 0;
            card.querySelector('.card-overlay.save').style.opacity = 0;
            setTimeout(() => card.style.transition = '', 300);
        }

        currentX = 0;
        currentY = 0;
    };

    card.addEventListener('touchstart', onStart, { passive: true });
    card.addEventListener('touchmove', onMove, { passive: true });
    card.addEventListener('touchend', onEnd);
    card.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
}

function flyCard(direction) {
    const card = document.querySelector('.card[style*="z-index: 2"]');
    if (!card) return;

    const company = deck[index];
    history.push({ company, direction });

    if (direction === 'right') {
        saved.push(company);
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
        // Pulse the Saved button on first 2 saves to guide new users
        if (saved.length <= 2) {
            const btn = document.querySelector('.saved-btn');
            if (btn) { btn.classList.remove('pulse'); void btn.offsetWidth; btn.classList.add('pulse'); }
        }
    }

    card.classList.add('flying');
    card.style.transform = `translateX(${direction === 'left' ? -150 : 150}vw) rotate(${direction === 'left' ? -30 : 30}deg)`;
    card.style.opacity = '0';

    setTimeout(() => {
        index++;
        renderCards();
        updateUI();
    }, 350);
}

function doSwipe(direction) {
    const card = document.querySelector('.card[style*="z-index: 2"]');
    if (card) {
        const overlay = card.querySelector(`.card-overlay.${direction === 'left' ? 'pass' : 'save'}`);
        if (overlay) { overlay.style.opacity = '1'; }
    }
    setTimeout(() => flyCard(direction), 150);
}

function undoSwipe() {
    if (history.length === 0) return;

    const last = history.pop();
    index--;

    if (last.direction === 'right') {
        saved = saved.filter(c => c.id !== last.company.id);
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
    }

    renderCards();
    updateUI();
}

function resetDeck() {
    buildDeck();
    renderCards();
    updateUI();
}

// ========== SAVED MODAL ==========
function openSaved() {
    renderSavedList();
    document.getElementById('saved-modal').classList.add('active');
}

function closeSaved() {
    document.getElementById('saved-modal').classList.remove('active');
    // Remove alpha index when closing
    const alphaIndex = document.querySelector('.alpha-index');
    if (alphaIndex) alphaIndex.remove();
}

let savedViewMode = 'list'; // 'list', 'grouped', 'alpha', 'funding'
let savedSortOrder = 'asc'; // 'asc' or 'desc'

function parseFunding(funding) {
    if (!funding) return 0;
    const match = funding.match(/\$?([\d.]+)\s*(B|M|K)?/i);
    if (!match) return 0;
    let amount = parseFloat(match[1]);
    const unit = (match[2] || '').toUpperCase();
    if (unit === 'B') amount *= 1000;
    else if (unit === 'K') amount /= 1000;
    return amount;
}

function renderSavedList() {
    const list = document.getElementById('saved-list');
    const footer = document.getElementById('modal-footer');

    // Remove any existing alpha index
    const existingAlpha = document.querySelector('.alpha-index');
    if (existingAlpha) existingAlpha.remove();

    if (saved.length === 0) {
        list.innerHTML = `
            <div class="empty-saved">
                <div class="icon">💾</div>
                <p>No saved companies yet.<br>Swipe right to save!</p>
            </div>
        `;
        footer.innerHTML = '';
        return;
    }

    // Calculate analytics
    const categoryCount = {};
    let totalFunding = 0;
    saved.forEach(c => {
        const cat = getCategoryLabel(c.category);
        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        totalFunding += parseFunding(c.funding);
    });
    const sortedCategories = Object.entries(categoryCount).sort((a, b) => b[1] - a[1]);
    const fundingDisplay = totalFunding >= 1000 ? `$${(totalFunding / 1000).toFixed(1)}B` : `$${totalFunding.toFixed(0)}M`;

    // Analytics box
    let html = `
        <div class="analytics-box">
            <div class="analytics-title">Watchlist Analytics</div>
            ${sortedCategories.slice(0, 4).map(([cat, count]) => `
                <div class="analytics-row">
                    <span>${cat}</span>
                    <span class="analytics-value">${count}</span>
                </div>
            `).join('')}
            <div class="analytics-total">${fundingDisplay}+</div>
            <div class="analytics-label">Total Funding Raised</div>
        </div>
    `;

    // View toggle and sort controls
    html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="view-toggle">
                <button class="${savedViewMode === 'list' ? 'active' : ''}" onclick="setViewMode('list')">List</button>
                <button class="${savedViewMode === 'grouped' ? 'active' : ''}" onclick="setViewMode('grouped')">Category</button>
            </div>
            <button type="button" id="clear-all-btn" style="background:rgba(220,38,38,0.1);border:1px solid #dc2626;color:#dc2626;font-size:13px;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600">Clear All</button>
        </div>
        <div class="sort-controls">
            <button class="sort-btn ${savedViewMode === 'alpha' ? 'active' : ''}" onclick="setViewMode('alpha')">
                A-Z <span class="arrow">${savedViewMode === 'alpha' ? (savedSortOrder === 'asc' ? '↑' : '↓') : ''}</span>
            </button>
            <button class="sort-btn ${savedViewMode === 'funding' ? 'active' : ''}" onclick="setViewMode('funding')">
                $ Funding <span class="arrow">${savedViewMode === 'funding' ? (savedSortOrder === 'asc' ? '↑' : '↓') : ''}</span>
            </button>
        </div>
    `;

    // Get sorted list based on view mode
    let displayList = [...saved];

    if (savedViewMode === 'alpha') {
        displayList.sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return savedSortOrder === 'asc' ? cmp : -cmp;
        });
    } else if (savedViewMode === 'funding') {
        displayList.sort((a, b) => {
            const cmp = parseFunding(b.funding) - parseFunding(a.funding);
            return savedSortOrder === 'asc' ? -cmp : cmp;
        });
    }

    // Render based on view mode
    if (savedViewMode === 'grouped') {
        const grouped = {};
        saved.forEach(c => {
            const cat = getCategoryLabel(c.category);
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(c);
        });
        Object.entries(grouped).sort((a, b) => b[1].length - a[1].length).forEach(([cat, companies]) => {
            html += `<div class="category-group">
                <div class="category-group-header">${cat} (${companies.length})</div>
                ${companies.map((c, idx) => renderSavedItem(c, idx)).join('')}
            </div>`;
        });
    } else if (savedViewMode === 'alpha') {
        // Group by first letter
        const letters = {};
        displayList.forEach(c => {
            const letter = c.name.charAt(0).toUpperCase();
            if (!letters[letter]) letters[letter] = [];
            letters[letter].push(c);
        });
        const sortedLetters = Object.keys(letters).sort((a, b) =>
            savedSortOrder === 'asc' ? a.localeCompare(b) : b.localeCompare(a)
        );
        sortedLetters.forEach(letter => {
            html += `<div class="letter-header" id="letter-${letter}">${letter}</div>`;
            html += letters[letter].map((c, idx) => renderSavedItem(c, idx)).join('');
        });
        // Add floating A-Z index
        setTimeout(() => addAlphaIndex(sortedLetters), 0);
    } else if (savedViewMode === 'funding') {
        displayList.forEach((c, idx) => {
            html += renderSavedItem(c, idx);
        });
    } else {
        html += saved.map((c, idx) => renderSavedItem(c, idx)).join('');
    }

    list.innerHTML = html;

    // Attach Clear All button listener
    const clearBtn = document.getElementById('clear-all-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (confirm('Clear all saved companies?')) {
                saved = [];
                localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
                updateUI();
                renderSavedList();
            }
        });
    }

    initDragAndDrop();

    // Email gate for sending watchlist
    if (!userEmail) {
        footer.innerHTML = `
            <div class="email-gate">
                <h3>Get Your Watchlist</h3>
                <p>Enter your email to receive your saved companies with all details.</p>
                <input type="email" class="email-input" id="email-input" placeholder="your@email.com">
                <button class="email-submit" onclick="submitEmail()">Send My Watchlist</button>
            </div>
        `;
    } else {
        footer.innerHTML = `
            <p style="color:var(--text-dim);font-size:13px;text-align:center;margin-bottom:12px">Watchlist sent to ${userEmail}</p>
            <button class="export-btn" style="background:var(--gold)" onclick="resendEmail()">Resend Email</button>
        `;
    }
}

function removeSaved(id) {
    saved = saved.filter(c => c.id !== id);
    localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
    updateUI();
    renderSavedList();
}

function clearAllSaved() {
    if (confirm('Clear all saved companies?')) {
        saved = [];
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
        updateUI();
        renderSavedList();
    }
}

function renderSavedItem(c, idx) {
    return `
        <div class="saved-item" draggable="true" data-id="${c.id}" data-idx="${idx}">
            <button class="remove-btn" onclick="event.stopPropagation();removeSaved(${c.id})">×</button>
            <div class="saved-name">${c.name}</div>
            <div class="saved-info">${c.product || ''} • ${c.hq || ''}</div>
            <div class="saved-funding">${c.funding || ''}</div>
        </div>
    `;
}

function setViewMode(mode) {
    // Toggle sort order if clicking same mode
    if (mode === savedViewMode && (mode === 'alpha' || mode === 'funding')) {
        savedSortOrder = savedSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        savedViewMode = mode;
        savedSortOrder = mode === 'funding' ? 'desc' : 'asc'; // Funding defaults to highest first
    }
    renderSavedList();
}

function addAlphaIndex(availableLetters) {
    const modal = document.getElementById('saved-modal');
    if (!modal) return;

    // Remove existing
    const existing = document.querySelector('.alpha-index');
    if (existing) existing.remove();

    const allLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const alphaDiv = document.createElement('div');
    alphaDiv.className = 'alpha-index';

    allLetters.forEach(letter => {
        const span = document.createElement('span');
        span.textContent = letter;
        span.setAttribute('data-letter', letter);
        if (availableLetters.includes(letter)) {
            span.onclick = () => scrollToSavedLetter(letter);
        } else {
            span.className = 'disabled';
        }
        alphaDiv.appendChild(span);
    });

    modal.appendChild(alphaDiv);
}

function scrollToSavedLetter(letter) {
    const el = document.getElementById(`letter-${letter}`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Highlight briefly
        el.style.background = 'var(--gold)';
        el.style.color = 'var(--navy)';
        setTimeout(() => {
            el.style.background = '';
            el.style.color = '';
        }, 500);
    }
}

function initDragAndDrop() {
    const items = document.querySelectorAll('.saved-item[draggable="true"]');
    let draggedItem = null;
    let draggedId = null;

    items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            draggedId = parseInt(item.dataset.id);
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            document.querySelectorAll('.saved-item').forEach(i => i.classList.remove('drag-over'));
            draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (item !== draggedItem) {
                item.classList.add('drag-over');
            }
        });

        item.addEventListener('dragleave', () => {
            item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('drag-over');
            if (item === draggedItem) return;

            const targetId = parseInt(item.dataset.id);
            const fromIdx = saved.findIndex(c => c.id === draggedId);
            const toIdx = saved.findIndex(c => c.id === targetId);

            if (fromIdx !== -1 && toIdx !== -1) {
                const [moved] = saved.splice(fromIdx, 1);
                saved.splice(toIdx, 0, moved);
                localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
                renderSavedList();
            }
        });
    });
}

// Google Apps Script Web App URL
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznKu5bdmenevru1tWPIreFRzVSC00bbcBb2wPFLHu40QGgsrGO_4jhLXSGTMhJXClu/exec';

async function submitEmail() {
    const email = document.getElementById('email-input').value.trim();
    if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
    }

    // Show loading state
    const submitBtn = document.querySelector('.email-submit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Sending...';
    submitBtn.disabled = true;

    try {
        // Send to Google Apps Script
        if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    companies: saved,
                    timestamp: new Date().toISOString()
                })
            });
        }

        userEmail = email;
        localStorage.setItem('ai_tracker_email', email);

        // Show success message
        alert('Your watchlist has been sent to ' + email + '!');
        renderSavedList();

    } catch (error) {
        console.error('Error sending data:', error);
        // Still save locally even if API fails
        userEmail = email;
        localStorage.setItem('ai_tracker_email', email);
        renderSavedList();
    }

    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
}

async function resendEmail() {
    if (!userEmail || saved.length === 0) return;

    try {
        if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    companies: saved,
                    timestamp: new Date().toISOString()
                })
            });
            alert('Watchlist resent to ' + userEmail + '!');
        } else {
            alert('Apps Script URL not configured');
        }
    } catch (error) {
        console.error('Error resending:', error);
        alert('Error sending email. Please try again.');
    }
}

function exportCSV(source) {
    const list = source === 'saved' ? saved : deck;
    if (list.length === 0) return;

    const headers = ['Name', 'Product', 'Category', 'Funding', 'Rating', 'HQ', 'Founded', 'Website', 'Investors', 'Description'];
    const rows = list.map(c => [
        c.name, c.product, getCategoryLabel(c.category), c.funding,
        c.rating || '', c.hq, c.founded, c.website, c.investors, c.description
    ]);

    const csv = [headers, ...rows].map(r => r.map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = source === 'saved' ? 'ai_companies_saved.csv' : `ai_companies_${deck.length}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// Load companies from master JSON, then init
(async function() {
    try {
        const response = await fetch('companies.json?v=' + Date.now());
        companies = await response.json();
        // Pre-compute search text for performance
        companies.forEach(c => {
            c._searchText = [
                c.name, c.product, c.description, c.ceo,
                c.investors, c.hq, c.customers,
                getCategoryLabel(c.category), getCategoryLabel(c.category, true),
                c.status, c.acquiredBy
            ].filter(Boolean).join(' ').toLowerCase();
        });
        console.log('[AI Book] Loaded ' + companies.length + ' companies from JSON');
        init();
        setTimeout(dismissSplash, 1200);
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    } catch (error) {
        console.error('[AI Book] Failed to load companies:', error);
        document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#fff;background:#0a0f1a;min-height:100vh;"><h2>Loading Error</h2><p>Could not load company data. Make sure companies.json is in the same folder.</p></div>';
    }
})();
</script>
</body>
</html>
