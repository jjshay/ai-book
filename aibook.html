<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Company Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a1628;
            --bg-card: #0f1d32;
            --bg-glass: rgba(15, 29, 50, 0.95);
            --gold: #D4AF37;
            --gold-light: #F4CF47;
            --cyan: #00CED1;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --border: rgba(212, 175, 55, 0.25);
            --pass: #ef4444;
            --save: #22c55e;
            --navy: #1e3a5f;

            /* Typography Scale */
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --fs-xs: 10px;
            --fs-sm: 12px;
            --fs-base: 14px;
            --fs-md: 16px;
            --fs-lg: 18px;
            --fs-xl: 20px;
            --fs-2xl: 24px;

            /* Spacing Scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            font-size: var(--fs-base);
            line-height: 1.5;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: contain;
        }

        .logo-text {
            font-size: var(--fs-md);
            font-weight: 800;
            letter-spacing: 1px;
            color: #fff;
        }

        .header-search {
            flex: 1;
            position: relative;
            max-width: 300px;
        }
        .header-search .search-input {
            font-family: var(--font);
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text);
            font-size: var(--fs-sm);
        }
        .header-search .search-input:focus {
            outline: none;
            border-color: var(--gold);
        }
        .header-search .search-input::placeholder {
            color: var(--text-dim);
        }
        .header-search .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: var(--fs-sm);
            pointer-events: none;
        }

        .saved-btn {
            font-family: var(--font);
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: var(--fs-xs);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .saved-btn .badge {
            background: var(--bg);
            color: var(--gold);
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
        }

        /* ========== FILTER BAR ========== */
        .filter-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        .filter-left, .filter-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-select {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: var(--gold); }
        .filter-btn {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover {
            border-color: var(--gold);
        }
        .filter-btn.active {
            background: var(--gold);
            border-color: var(--gold);
        }
        .sort-btn {
            font-family: var(--font);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 10px;
            color: var(--text-dim);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .sort-btn:hover {
            border-color: var(--gold);
            color: var(--text);
        }
        .sort-btn.active {
            background: var(--cyan);
            border-color: var(--cyan);
            color: var(--bg);
        }

        /* ========== VANITY STATS ========== */
        .vanity-stats {
            display: flex;
            justify-content: space-around;
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, var(--navy) 0%, #2d4a6f 100%);
            border-bottom: 1px solid var(--border);
        }
        .vanity-stat {
            text-align: center;
        }
        .vanity-value {
            display: block;
            font-size: var(--fs-xl);
            font-weight: 700;
            color: var(--gold);
            line-height: 1.2;
        }
        .vanity-label {
            font-size: var(--fs-xs);
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========== ACCORDION ========== */
        .card-accordion {
            margin-top: var(--space-md);
            border-top: 1px solid var(--border);
            padding-top: var(--space-sm);
        }
        .accordion-item {
            border: 1px solid var(--border);
            border-radius: var(--space-sm);
            margin-bottom: var(--space-sm);
            overflow: hidden;
            background: rgba(0,0,0,0.2);
        }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            font-size: var(--fs-xs);
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .accordion-header:hover {
            background: rgba(212,175,55,0.1);
        }
        .accordion-icon {
            font-size: var(--fs-sm);
            transition: transform 0.2s;
        }
        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 var(--space-md);
        }
        .accordion-item.open .accordion-content {
            max-height: 200px;
            padding: 0 var(--space-md) var(--space-md);
        }
        .accordion-content ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .accordion-content li {
            font-size: var(--fs-base);
            color: var(--text-dim);
            padding: var(--space-sm) 0;
            padding-left: var(--space-xl);
            position: relative;
            line-height: 1.5;
        }
        .accordion-content li::before {
            content: '‚Ä¢';
            position: absolute;
            left: var(--space-xs);
            color: var(--gold);
        }
        .accordion-content li.risk::before {
            content: '‚ö†';
            color: var(--pass);
        }
        .accordion-content li.success::before {
            content: '‚úì';
            color: var(--save);
        }
        .accordion-content li.intel::before {
            content: '‚Üí';
            color: var(--cyan);
        }

        /* ========== VIEW MODES ========== */
        .list-view { display: block; }
        .swipe-view { display: none; }
        body.swipe-mode .list-view { display: none; }
        body.swipe-mode .swipe-view { display: flex; flex-direction: column; flex: 1; }
        body.swipe-mode .vanity-stats { display: none; }

        /* ========== A-Z SIDEBAR ========== */
        .list-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .az-sidebar {
            width: 32px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            overflow-y: auto;
        }
        .az-letter {
            font-family: var(--font);
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            padding: 3px 0;
            cursor: pointer;
            transition: all 0.15s ease;
            width: 100%;
            text-align: center;
        }
        .az-letter:hover {
            color: var(--cyan);
            font-size: 16px;
            font-weight: 800;
            transform: scale(1.3);
            text-shadow: 0 0 10px rgba(0,206,209,0.6);
        }
        .az-letter.active {
            color: var(--cyan);
            font-size: 16px;
            font-weight: 800;
            transform: scale(1.3);
            text-shadow: 0 0 12px rgba(0,206,209,0.8);
        }
        .az-letter.has-items {
            color: rgba(255,255,255,0.7);
        }
        .az-letter.has-items:hover {
            color: var(--cyan);
        }

        /* ========== MINI CARDS LIST ========== */
        .mini-cards-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .letter-section {
            position: sticky;
            top: 0;
            background: var(--navy);
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 700;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
            border-bottom: 1px solid var(--border);
        }
        .mini-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.15s;
        }
        .mini-card:hover {
            background: rgba(212,175,55,0.1);
        }
        .mini-card:active {
            background: rgba(212,175,55,0.2);
        }
        .mini-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .mini-logo img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }
        .mini-logo-fallback {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }
        .mini-info {
            flex: 1;
            min-width: 0;
        }
        .mini-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-product {
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-funding {
            font-size: 14px;
            font-weight: 700;
            color: var(--save);
            flex-shrink: 0;
        }
        .mini-arrow {
            color: var(--text-dim);
            font-size: 16px;
            flex-shrink: 0;
        }

        /* ========== BACK BUTTON ========== */
        .back-btn {
            font-family: var(--font);
            background: none;
            border: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
        }
        .back-btn:hover {
            color: var(--gold);
        }

        /* ========== 3-WHEEL LETTER SPINNER ========== */
        .letter-wheel-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg);
        }
        .wheel-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .wheel-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .wheel-arrow {
            font-family: var(--font);
            width: 28px;
            height: 20px;
            border: none;
            background: transparent;
            font-size: var(--fs-md);
            font-weight: 300;
            cursor: pointer;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }
        .wheel-arrow:hover {
            color: var(--gold);
        }
        .wheel-display {
            width: 36px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .wheel-display::before,
        .wheel-display::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 12px;
            z-index: 2;
            pointer-events: none;
        }
        .wheel-display::before {
            top: 0;
            background: linear-gradient(to bottom, var(--bg-card), transparent);
        }
        .wheel-display::after {
            bottom: 0;
            background: linear-gradient(to top, var(--bg-card), transparent);
        }
        .wheel-letters {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .wheel-letter {
            font-family: var(--font);
            font-weight: 700;
            width: 36px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: rgba(255,255,255,0.25);
            cursor: pointer;
            transition: all 0.2s;
        }
        .wheel-letter.active {
            color: var(--cyan);
            font-size: 18px;
            font-weight: 800;
            height: 16px;
            text-shadow: 0 0 10px rgba(0,206,209,0.5);
        }
        .wheel-letter.has-items {
            color: rgba(255,255,255,0.5);
        }
        .wheel-letter.has-items.active {
            color: var(--cyan);
        }
        .sort-toggle {
            display: flex;
            gap: var(--space-xs);
            margin-left: var(--space-md);
        }
        .sort-toggle-btn {
            font-family: var(--font);
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--space-sm);
            font-size: var(--fs-xs);
            font-weight: 600;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .sort-toggle-btn.active {
            background: var(--gold);
            color: var(--navy);
            border-color: var(--gold);
        }
        .sort-toggle-btn:hover {
            border-color: var(--gold);
        }

        /* ========== CARD AREA ========== */
        .card-area {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: hidden;
        }

        .card {
            position: absolute;
            width: calc(100% - 32px);
            max-width: 380px;
            max-height: calc(100% - 20px);
            background: linear-gradient(145deg, var(--bg-card), #0d1a2d);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            cursor: grab;
            overflow-y: auto;
            will-change: transform;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .card:active { cursor: grabbing; }
        .card.dragging { transition: none; }
        .card.flying { transition: transform 0.4s ease-out, opacity 0.4s; pointer-events: none; }

        .card-overlay {
            position: absolute;
            top: 20px;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 20px;
            letter-spacing: 2px;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .card-overlay.pass { right: 20px; background: var(--pass); transform: rotate(15deg); }
        .card-overlay.save { left: 20px; background: var(--save); transform: rotate(-15deg); }

        /* Card Content */
        .card-logo-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .card-logo {
            width: 72px;
            height: 72px;
            border-radius: 16px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .card-logo img {
            width: 58px;
            height: 58px;
            object-fit: contain;
        }

        .card-logo-fallback {
            width: 72px;
            height: 72px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: var(--bg);
        }

        .card-funding-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-funding-label {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .card-funding-value {
            font-size: var(--fs-lg);
            font-weight: 800;
            color: var(--save);
            letter-spacing: -0.5px;
        }

        .card-secret-sauce {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border: 1px solid var(--border);
            border-radius: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
        }

        .sauce-icon {
            font-size: var(--fs-md);
            flex-shrink: 0;
        }

        .sauce-text {
            font-size: var(--fs-sm);
            color: var(--gold-light);
            line-height: 1.4;
            font-weight: 500;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .card-rating { color: var(--gold); font-size: var(--fs-base); letter-spacing: 2px; }

        .card-category {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--space-md);
            font-size: var(--fs-xs);
            color: #fff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Health Badge */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--space-md);
            font-size: var(--fs-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: help;
            position: relative;
        }
        .health-badge .health-icon {
            font-size: var(--fs-sm);
        }
        .health-badge.unicorn {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: #fff;
        }
        .health-badge.hot {
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: #fff;
        }
        .health-badge.warm {
            background: linear-gradient(135deg, #eab308, #f59e0b);
            color: #1a1a1a;
        }
        .health-badge.cold {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
            color: #fff;
        }
        .health-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg);
            color: var(--text);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--space-sm);
            font-size: var(--fs-xs);
            font-weight: 500;
            text-transform: none;
            letter-spacing: 0;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: var(--space-xs);
        }
        .health-badge:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .card-name {
            font-size: var(--fs-xl);
            font-weight: 800;
            margin-bottom: var(--space-xs);
            line-height: 1.1;
        }

        .card-product {
            color: var(--cyan);
            font-size: var(--fs-sm);
            font-weight: 600;
            margin-bottom: 0;
        }

        .card-desc {
            color: var(--text-dim);
            font-size: var(--fs-sm);
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-md);
        }

        .stat-box {
            background: rgba(0,0,0,0.2);
            border-radius: var(--space-md);
            padding: var(--space-md) var(--space-lg);
        }

        .card-links {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border);
        }

        .link-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: var(--fs-md);
            color: var(--text);
            transition: all 0.2s;
        }

        .link-circle:hover {
            background: var(--cyan);
            color: var(--bg);
            border-color: var(--cyan);
        }

        .stat-label {
            font-size: var(--fs-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-xs);
        }

        .stat-value {
            font-size: var(--fs-base);
            font-weight: 700;
        }

        .stat-value.funding { color: var(--save); font-size: var(--fs-lg); }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border);
        }

        .meta-tag {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: var(--space-xs) var(--space-md);
            border-radius: 20px;
            font-size: var(--fs-xs);
            color: var(--text-dim);
        }

        /* Progress */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--cyan));
            transition: width 0.3s;
        }

        /* ========== ACTIONS ========== */
        .actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 32px;
            padding: var(--space-lg);
            padding-bottom: max(var(--space-lg), env(safe-area-inset-bottom));
            background: var(--bg);
        }

        .action-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
        }

        .action-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid;
            background: var(--bg-card);
            font-size: var(--fs-2xl);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .action-btn:active { transform: scale(0.9); }

        .action-label {
            font-size: var(--fs-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .btn-pass { border-color: var(--pass); color: var(--pass); }
        .btn-pass:hover { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        .action-group:has(.btn-pass) .action-label { color: var(--pass); }

        .btn-undo { border-color: var(--gold); color: var(--gold); }
        .btn-undo:hover { box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .action-group:has(.btn-undo) .action-label { color: var(--gold); }

        .btn-save { border-color: var(--save); color: var(--save); }
        .btn-save:hover { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
        .action-group:has(.btn-save) .action-label { color: var(--save); }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
        }

        .empty-state .icon { font-size: 64px; margin-bottom: var(--space-xl); }
        .empty-state h3 { font-size: var(--fs-xl); margin-bottom: var(--space-sm); }
        .empty-state p { color: var(--text-dim); font-size: var(--fs-base); margin-bottom: var(--space-2xl); }

        .reset-btn {
            font-family: var(--font);
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: var(--space-md) var(--space-2xl);
            border-radius: 25px;
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--space-2xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 { font-size: var(--fs-lg); font-weight: 700; }

        .close-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .modal-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border);
        }

        /* Saved List */
        .saved-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--space-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .saved-item:active { cursor: grabbing; }
        .saved-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .saved-item.drag-over {
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .saved-name { font-weight: 700; font-size: var(--fs-md); margin-bottom: var(--space-xs); }
        .saved-info { color: var(--text-dim); font-size: var(--fs-sm); }

        .analytics-box {
            background: linear-gradient(135deg, var(--navy) 0%, #2d4a6f 100%);
            border-radius: var(--space-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            color: #fff;
        }
        .analytics-title {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold);
            margin-bottom: var(--space-md);
        }
        .analytics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            font-size: var(--fs-sm);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .analytics-row:last-child { border-bottom: none; }
        .analytics-value {
            font-weight: 700;
            color: var(--gold);
        }
        .analytics-total {
            font-size: var(--fs-2xl);
            font-weight: 800;
            color: var(--gold);
            text-align: center;
            margin-top: var(--space-md);
        }
        .analytics-label {
            font-size: var(--fs-xs);
            text-align: center;
            color: rgba(255,255,255,0.7);
        }

        .view-toggle {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        .view-toggle button {
            font-family: var(--font);
            flex: 1;
            padding: var(--space-sm);
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: var(--space-sm);
            font-size: var(--fs-sm);
            cursor: pointer;
            color: var(--text-dim);
        }
        .view-toggle button.active {
            background: var(--navy);
            color: #fff;
            border-color: var(--navy);
        }

        .category-group {
            margin-bottom: var(--space-lg);
        }
        .category-group-header {
            font-size: var(--fs-sm);
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--space-sm);
        }
        .saved-funding { color: var(--save); font-weight: 600; margin-top: var(--space-sm); }

        /* Floating A-Z Index */
        .alpha-index {
            position: fixed;
            right: var(--space-xs);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1px;
            z-index: 1000;
            background: rgba(30,58,95,0.95);
            padding: var(--space-xs) var(--space-xs);
            border-radius: var(--space-md);
        }
        .alpha-index span {
            font-family: var(--font);
            font-size: var(--fs-xs);
            font-weight: 600;
            color: #fff;
            padding: 2px var(--space-xs);
            cursor: pointer;
            text-align: center;
            border-radius: var(--space-xs);
            transition: background 0.15s;
        }
        .alpha-index span:hover,
        .alpha-index span.active {
            background: var(--gold);
            color: var(--navy);
        }
        .alpha-index span.disabled {
            color: rgba(255,255,255,0.3);
            cursor: default;
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
        }
        .sort-btn {
            font-family: var(--font);
            padding: var(--space-xs) var(--space-md);
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: var(--space-xs);
            font-size: var(--fs-xs);
            cursor: pointer;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .sort-btn.active {
            background: var(--navy);
            color: #fff;
            border-color: var(--navy);
        }
        .sort-btn .arrow {
            font-size: var(--fs-xs);
        }

        .letter-header {
            font-size: var(--fs-lg);
            font-weight: 800;
            color: var(--navy);
            padding: var(--space-md) 0 var(--space-xs);
            border-bottom: 2px solid var(--gold);
            margin-bottom: var(--space-sm);
        }

        .remove-btn {
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            background: rgba(220,38,38,0.1);
            border: none;
            color: #dc2626;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            z-index: 10;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
        }
        .remove-btn:hover {
            background: rgba(220,38,38,0.3);
            transform: scale(1.1);
        }

        /* Email Gate */
        .email-gate {
            text-align: center;
            padding: var(--space-xl);
        }

        .email-gate h3 { font-size: var(--fs-xl); margin-bottom: var(--space-sm); }
        .email-gate p { color: var(--text-dim); font-size: var(--fs-sm); margin-bottom: var(--space-xl); }

        .email-input {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--border);
            border-radius: var(--space-md);
            background: var(--bg);
            color: var(--text);
            font-size: var(--fs-base);
            margin-bottom: var(--space-md);
        }

        .email-input:focus { outline: none; border-color: var(--gold); }

        .email-submit {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md);
            background: var(--gold);
            color: var(--bg);
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        .export-btn {
            font-family: var(--font);
            width: 100%;
            padding: var(--space-md);
            background: var(--save);
            color: white;
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
        }

        .empty-saved {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
            color: var(--text-dim);
        }

        .empty-saved .icon { font-size: 48px; margin-bottom: var(--space-md); }

        /* ========== DETAIL MODAL ========== */
        .detail-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .detail-modal.active { display: block; }

        .detail-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--space-2xl);
            max-width: 500px;
            margin: 0 auto;
            overflow: hidden;
        }

        .detail-header {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            padding: var(--space-2xl);
            position: relative;
        }

        .detail-close {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: var(--fs-2xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--bg);
            margin-bottom: var(--space-xs);
        }

        .detail-product {
            font-size: var(--fs-md);
            color: var(--bg);
            opacity: 0.8;
        }

        .detail-body { padding: var(--space-2xl); }

        .detail-section {
            margin-bottom: var(--space-xl);
        }

        .detail-section:last-child { margin-bottom: 0; }

        .detail-section-title {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gold);
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .detail-section-content {
            color: var(--text);
            font-size: var(--fs-base);
            line-height: 1.6;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        .detail-stat {
            background: var(--bg);
            border-radius: var(--space-md);
            padding: var(--space-md);
        }

        .detail-stat-label {
            font-size: var(--fs-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: var(--space-xs);
        }

        .detail-stat-value {
            font-size: var(--fs-md);
            font-weight: 700;
        }

        .detail-stat-value.highlight { color: var(--save); font-size: var(--fs-xl); }

        .detail-link {
            display: inline-block;
            background: var(--gold);
            color: var(--bg);
            padding: var(--space-md) var(--space-2xl);
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: var(--fs-base);
            margin-top: var(--space-sm);
        }

        .detail-rating {
            color: var(--gold);
            font-size: var(--fs-lg);
            letter-spacing: 3px;
        }

        .detail-actions {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-xl) var(--space-2xl);
            border-top: 1px solid var(--border);
        }

        .detail-btn {
            font-family: var(--font);
            flex: 1;
            padding: var(--space-md);
            border: none;
            border-radius: var(--space-md);
            font-size: var(--fs-base);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .detail-btn.pass-btn {
            background: rgba(239, 68, 68, 0.2);
            color: var(--pass);
            border: 1px solid var(--pass);
        }

        .detail-btn.save-btn {
            background: var(--save);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">
                <img src="https://jjshay.com/logo.png" alt="JS" class="logo-icon" style="width:32px;height:32px;border-radius:6px">
                <span class="logo-text">AI BOOK</span>
            </div>
            <div class="header-search">
                <span class="search-icon">‚åï</span>
                <input type="text" class="search-input" id="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
            </div>
            <button class="saved-btn" onclick="openSaved()">
                Saved <span class="badge" id="saved-count">0</span>
            </button>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
            <div class="filter-left">
                <select class="filter-select" id="filter" onchange="filterChanged()">
                    <option value="all">All</option>
                    <option value="foundation-models">Foundation</option>
                    <option value="enterprise-ai">Enterprise</option>
                    <option value="developer-tools">Dev Tools</option>
                    <option value="consumer-ai">Consumer</option>
                    <option value="gtm-ai">GTM/Sales</option>
                    <option value="healthtech">Healthcare</option>
                    <option value="fintech-legal">Fintech</option>
                    <option value="industrial-ai">Industrial</option>
                    <option value="data-infra">Data Infra</option>
                    <option value="security-ai">Security</option>
                    <option value="robotics-ai">Robotics</option>
                    <option value="video-ai">Video</option>
                    <option value="voice-ai">Voice</option>
                    <option value="creative-ai">Creative</option>
                    <option value="education-ai">Education</option>
                    <option value="gaming-ai">Gaming</option>
                    <option value="music-ai">Music</option>
                </select>
                <button class="filter-btn" id="filter-unicorn" onclick="toggleFilter('unicorn')" title="Unicorns: $1B+ funding elite">ü¶Ñ</button>
                <button class="filter-btn" id="filter-hot" onclick="toggleFilter('hot')" title="Hot: $100M+ strong momentum">üî•</button>
                <button class="filter-btn" id="filter-rising" onclick="toggleFilter('rising')" title="Rising Stars: $10M-$100M growth stage">üìà</button>
                <button class="filter-btn" id="filter-recent" onclick="toggleFilter('recent')" title="Recently updated by AI monitor">üîÑ</button>
                <button class="filter-btn" id="filter-new" onclick="toggleFilter('new')" title="Newly added companies">üÜï</button>
            </div>
            <div class="filter-right">
                <button class="sort-btn" id="sort-az" onclick="sortDeck('alpha')" title="Sort alphabetically A-Z">A-Z</button>
                <button class="sort-btn" id="sort-funding" onclick="sortDeck('funding')" title="Sort by funding amount">$$$</button>
            </div>
        </div>

        <!-- VANITY STATS -->
        <div class="vanity-stats" id="vanity-stats">
            <div class="vanity-stat">
                <span class="vanity-value" id="stat-companies">800</span>
                <span class="vanity-label">Companies</span>
            </div>
            <div class="vanity-stat">
                <span class="vanity-value" id="stat-funding">$150B+</span>
                <span class="vanity-label">Total Raised</span>
            </div>
            <div class="vanity-stat">
                <span class="vanity-value" id="stat-ma">200+</span>
                <span class="vanity-label">M&A Targets</span>
            </div>
            <div class="vanity-stat">
                <span class="vanity-value" id="stat-updated" style="font-size:var(--fs-sm);color:var(--cyan)">--</span>
                <span class="vanity-label">Last Updated</span>
            </div>
        </div>

        <!-- LIST VIEW (Landing Page) -->
        <div class="list-view list-container">
            <div class="az-sidebar" id="az-sidebar"></div>
            <div class="mini-cards-container" id="mini-cards"></div>
        </div>

        <!-- SWIPE VIEW (After clicking a company) -->
        <div class="swipe-view">
            <div style="padding:8px 16px;background:var(--bg-card);border-bottom:1px solid var(--border)">
                <button class="back-btn" onclick="exitSwipeMode()">‚Üê Back to List</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress" style="width: 0%"></div>
            </div>
            <div class="card-area" id="card-area"></div>
        </div>

    </div>

    <!-- DETAIL MODAL -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-content" id="detail-content"></div>
    </div>

    <!-- SAVED MODAL -->
    <div class="modal" id="saved-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Companies</h2>
                <button class="close-btn" onclick="closeSaved()">√ó</button>
            </div>
            <div class="modal-body" id="saved-list"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

<script>
// ========== COMPANY DATA ==========
let companies = [];

// ========== STATE ==========
let currentFilter = 'all';
let activeHealthFilter = null; // 'unicorn', 'hot', 'rising', or null

function toggleFilter(type) {
    const btn = document.getElementById(`filter-${type}`);
    if (activeHealthFilter === type) {
        activeHealthFilter = null;
        btn.classList.remove('active');
    } else {
        // Clear other filter
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        activeHealthFilter = type;
        btn.classList.add('active');
    }
    buildDeck();
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}
let deck = [];
let index = 0;
let saved = JSON.parse(localStorage.getItem('ai_tracker_saved') || '[]');
let history = [];
let userEmail = localStorage.getItem('ai_tracker_email') || '';

// ========== CATEGORY LABELS ==========
function getCategoryLabel(category, long = false) {
    const shortLabels = {
        'foundation-models': 'Foundation',
        'enterprise-ai': 'Enterprise',
        'developer-tools': 'Dev Tools',
        'consumer-ai': 'Consumer',
        'video-ai': 'Video',
        'voice-ai': 'Voice',
        'healthtech': 'Health',
        'healthtech-ai': 'Health',
        'fintech-legal': 'Fintech',
        'fintech-ai': 'Fintech',
        'security-ai': 'Security',
        'robotics-ai': 'Robotics',
        'gtm-ai': 'GTM/Sales',
        'industrial-ai': 'Industrial',
        'data-infra': 'Data',
        'data-infrastructure': 'Data',
        'education-ai': 'Education',
        'hr-talent': 'HR/Talent',
        'supply-chain': 'Supply Chain',
        'legal-compliance': 'Legal',
        'legal-ai': 'Legal',
        'real-estate': 'Real Estate',
        'climate-agri': 'Climate',
        'agriculture-ai': 'Agriculture',
        'photo-ai': 'Photo',
        'text-ai': 'Text',
        'space-ai': 'Space',
        'ocean-ai': 'Ocean',
        'gaming-ai': 'Gaming',
        'music-ai': 'Music',
        'travel-ai': 'Travel',
        'construction-ai': 'Construction',
        'media-ai': 'Media',
        'energy-ai': 'Energy',
        'insurance-ai': 'Insurance',
        'ai-agents': 'Agents',
        'coding-ai': 'Coding',
        'ai-infrastructure': 'AI Infra',
        'ai-chips': 'AI Chips',
        'creative-ai': 'Creative',
        'search-ai': 'Search'
    };
    const longLabels = {
        'foundation-models': 'Foundation Models',
        'enterprise-ai': 'Enterprise AI',
        'developer-tools': 'Developer Tools',
        'consumer-ai': 'Consumer AI',
        'video-ai': 'Video AI',
        'voice-ai': 'Voice AI',
        'healthtech': 'Healthcare',
        'healthtech-ai': 'Healthcare AI',
        'fintech-legal': 'Fintech & Legal',
        'fintech-ai': 'Fintech AI',
        'security-ai': 'Security AI',
        'robotics-ai': 'Robotics AI',
        'gtm-ai': 'GTM / Sales AI',
        'industrial-ai': 'Industrial AI',
        'data-infra': 'Data Infrastructure',
        'data-infrastructure': 'Data Infrastructure',
        'education-ai': 'Education AI',
        'hr-talent': 'HR & Talent',
        'supply-chain': 'Supply Chain',
        'legal-compliance': 'Legal & Compliance',
        'legal-ai': 'Legal AI',
        'real-estate': 'Real Estate',
        'climate-agri': 'Climate & Agriculture',
        'agriculture-ai': 'Agriculture AI',
        'photo-ai': 'Photo AI',
        'text-ai': 'Text AI',
        'space-ai': 'Space AI',
        'ocean-ai': 'Ocean AI',
        'gaming-ai': 'Gaming AI',
        'music-ai': 'Music AI',
        'travel-ai': 'Travel AI',
        'construction-ai': 'Construction AI',
        'media-ai': 'Media AI',
        'energy-ai': 'Energy AI',
        'insurance-ai': 'Insurance AI',
        'ai-agents': 'AI Agents',
        'coding-ai': 'Coding AI',
        'ai-infrastructure': 'AI Infrastructure',
        'ai-chips': 'AI Chips',
        'creative-ai': 'Creative AI',
        'search-ai': 'Search AI'
    };
    const labels = long ? longLabels : shortLabels;
    return labels[category] || category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// ========== INIT ==========
function init() {
    buildDeck();
    renderListView();
    renderAZSidebar();
    updateUI();
    updateVanityStats();

    // Escape key to exit swipe mode back to list
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.body.classList.contains('swipe-mode')) {
            exitSwipeMode();
        }
    });
}

// ========== LIST VIEW ==========
let currentLetter = 'A';

function renderListView() {
    const container = document.getElementById('mini-cards');
    if (!container) return;

    let html = '';

    // Use the already-sorted deck (from applyDeckSort)
    if (deckSortMode === 'funding') {
        // Flat list for funding sort
        deck.forEach(c => {
            html += renderMiniCard(c);
        });
    } else {
        // Group by first letter for alpha sort (default)
        const sorted = deckSortMode === 'alpha' ? [...deck] : [...deck].sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return deckSortOrder === 'asc' ? cmp : -cmp;
        });

        const grouped = {};
        sorted.forEach(c => {
            const letter = c.name.charAt(0).toUpperCase();
            if (!grouped[letter]) grouped[letter] = [];
            grouped[letter].push(c);
        });

        const letterKeys = Object.keys(grouped).sort((a, b) => {
            return deckSortOrder === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
        });

        letterKeys.forEach(letter => {
            html += `<div class="letter-section" id="section-${letter}">${letter}</div>`;
            grouped[letter].forEach(c => {
                html += renderMiniCard(c);
            });
        });
    }

    container.innerHTML = html;
}

function isRecentlyUpdated(c) {
    if (!c.lastAutoUpdate) return false;
    const d = new Date(c.lastAutoUpdate);
    const ago = new Date();
    ago.setDate(ago.getDate() - 7);
    return d >= ago;
}

function renderMiniCard(c) {
    const logoUrl = c.website ? `https://www.google.com/s2/favicons?domain=${c.website}&sz=128` : null;
    const fallback = c.name.charAt(0).toUpperCase();
    const updated = isRecentlyUpdated(c);
    return `
        <div class="mini-card" onclick="enterSwipeMode(${c.id})">
            <div class="mini-logo">
                ${logoUrl
                    ? `<img src="${logoUrl}" onerror="this.parentElement.innerHTML='<span class=\\'mini-logo-fallback\\'>${fallback}</span>'">`
                    : `<span class="mini-logo-fallback">${fallback}</span>`
                }
            </div>
            <div class="mini-info">
                <div class="mini-name">${c.name}${updated ? '<span style="display:inline-block;width:6px;height:6px;background:var(--cyan);border-radius:50%;margin-left:6px;vertical-align:middle" title="Recently updated"></span>' : ''}</div>
                <div class="mini-product">${c.product || ''}</div>
            </div>
            <div class="mini-funding">${c.funding || ''}</div>
            <div class="mini-arrow">‚Ä∫</div>
        </div>
    `;
}

function renderAZSidebar() {
    const sidebar = document.getElementById('az-sidebar');
    if (!sidebar) return;

    // Count companies per letter
    const letterCounts = {};
    deck.forEach(c => {
        const letter = c.name.charAt(0).toUpperCase();
        letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    });

    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    sidebar.innerHTML = letters.map(letter => {
        const hasItems = letterCounts[letter] > 0;
        const isActive = letter === currentLetter;
        return `<div class="az-letter ${hasItems ? 'has-items' : ''} ${isActive ? 'active' : ''}"
                     onclick="scrollToLetter('${letter}')">${letter}</div>`;
    }).join('');
}

function scrollToLetter(letter) {
    currentLetter = letter;
    renderAZSidebar();

    const section = document.getElementById(`section-${letter}`);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function enterSwipeMode(companyId) {
    // Sort deck alphabetically and find the company
    deck.sort((a, b) => a.name.localeCompare(b.name));
    deckSortMode = 'alpha';
    deckSortOrder = 'asc';

    // Find company index
    const companyIndex = deck.findIndex(c => c.id === companyId);
    if (companyIndex !== -1) {
        index = companyIndex;
    }

    // Switch to swipe mode
    document.body.classList.add('swipe-mode');
    renderCards();
    updateUI();
    updateSortButtons();
}

function exitSwipeMode() {
    document.body.classList.remove('swipe-mode');
    renderListView();
    renderAZSidebar();
}

function updateVanityStats() {
    // Use current filtered deck for stats
    let totalFunding = 0;
    let maTargets = 0;

    deck.forEach(c => {
        totalFunding += parseFundingAmount(c.funding);
        // Count M&A targets (companies with >$100M funding or high rating)
        if (parseFundingAmount(c.funding) > 100 || c.rating >= 4) {
            maTargets++;
        }
    });

    const fundingDisplay = totalFunding >= 1000
        ? `$${Math.round(totalFunding / 1000)}B+`
        : `$${Math.round(totalFunding)}M+`;

    document.getElementById('stat-companies').textContent = deck.length;
    document.getElementById('stat-funding').textContent = fundingDisplay;
    document.getElementById('stat-ma').textContent = maTargets;

    // Find most recent auto-update date
    let latestUpdate = null;
    let recentCount = 0;
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    companies.forEach(c => {
        if (c.lastAutoUpdate) {
            const d = new Date(c.lastAutoUpdate);
            if (!latestUpdate || d > latestUpdate) latestUpdate = d;
            if (d >= sevenDaysAgo) recentCount++;
        }
    });
    const el = document.getElementById('stat-updated');
    if (el && latestUpdate) {
        const mo = latestUpdate.toLocaleString('default', { month: 'short' });
        const day = latestUpdate.getDate();
        el.textContent = `${mo} ${day}`;
        if (recentCount > 0) el.title = `${recentCount} companies updated in the last 7 days`;
    }
}

function buildDeck() {
    deck = currentFilter === 'all'
        ? [...companies]
        : companies.filter(c => c.category === currentFilter);

    // Remove public companies
    deck = deck.filter(c => {
        const funding = (c.funding || '').toLowerCase();
        return !funding.includes('public');
    });

    // Deduplicate by normalized name (keep first occurrence)
    const seen = new Set();
    function normalizeName(name) {
        return name.toLowerCase()
            .replace(/\s*(ai|labs|inc|corp|llc|\.ai|\.io|\.com)\.?\s*$/gi, '') // Remove common suffixes
            .replace(/[^a-z0-9]/g, '') // Remove non-alphanumeric
            .trim();
    }
    deck = deck.filter(c => {
        const normalized = normalizeName(c.name);
        if (seen.has(normalized)) return false;
        seen.add(normalized);
        return true;
    });

    // Apply health filter (unicorn/hot/rising)
    if (activeHealthFilter) {
        deck = deck.filter(c => {
            const funding = parseFundingAmount(c.funding);
            if (activeHealthFilter === 'unicorn') {
                return funding >= 1000; // $1B+
            } else if (activeHealthFilter === 'hot') {
                return funding >= 100; // $100M+
            } else if (activeHealthFilter === 'rising') {
                return funding >= 10 && funding < 100; // $10M-$100M
            } else if (activeHealthFilter === 'recent') {
                return isRecentlyUpdated(c);
            } else if (activeHealthFilter === 'new') {
                return !!c.dateAdded;
            }
            return true;
        });
    }

    // Apply search filter
    if (searchQuery) {
        deck = deck.filter(c =>
            c.name.toLowerCase().includes(searchQuery) ||
            (c.product && c.product.toLowerCase().includes(searchQuery)) ||
            (c.description && c.description.toLowerCase().includes(searchQuery)) ||
            (c.ceo && c.ceo.toLowerCase().includes(searchQuery))
        );
    }

    // Shuffle only if no search or sort active
    if (!searchQuery && deckSortMode === 'none') {
        deck.sort(() => Math.random() - 0.5);
    }

    // Remove already saved
    const savedIds = new Set(saved.map(c => c.id));
    deck = deck.filter(c => !savedIds.has(c.id));

    // Re-apply sort if active
    if (deckSortMode !== 'none') {
        applyDeckSort();
    }

    index = 0;
    history = [];
}

function updateUI() {
    document.getElementById('saved-count').textContent = saved.length;
    const pct = deck.length > 0 ? ((index / deck.length) * 100) : 0;
    document.getElementById('progress').style.width = pct + '%';
}

// ========== FILTER ==========
function filterChanged() {
    currentFilter = document.getElementById('filter').value;
    buildDeck();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}

// ========== SEARCH ==========
let searchQuery = '';

function handleSearch(query) {
    searchQuery = query.toLowerCase().trim();
    buildDeck();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateVanityStats();
}

// ========== DECK SORTING ==========
let deckSortMode = 'none'; // 'none', 'alpha', 'funding'
let deckSortOrder = 'asc';

function sortDeck(mode) {
    // Toggle order if same mode clicked
    if (mode === deckSortMode) {
        deckSortOrder = deckSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        deckSortMode = mode;
        deckSortOrder = mode === 'funding' ? 'desc' : 'asc';
    }

    applyDeckSort();

    // Update based on current view mode
    if (document.body.classList.contains('swipe-mode')) {
        renderCards();
    } else {
        renderListView();
        renderAZSidebar();
    }
    updateUI();
    updateSortButtons();
}

function applyDeckSort() {
    if (deckSortMode === 'alpha') {
        deck.sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return deckSortOrder === 'asc' ? cmp : -cmp;
        });
    } else if (deckSortMode === 'funding') {
        deck.sort((a, b) => {
            const aFund = parseFundingAmount(a.funding);
            const bFund = parseFundingAmount(b.funding);
            return deckSortOrder === 'desc' ? bFund - aFund : aFund - bFund;
        });
    }
    index = 0;
}

function parseFundingAmount(funding) {
    if (!funding) return 0;
    const match = funding.match(/\$?([\d.]+)\s*(B|M|K)?/i);
    if (!match) return 0;
    let amount = parseFloat(match[1]);
    const unit = (match[2] || '').toUpperCase();
    if (unit === 'B') amount *= 1000;
    else if (unit === 'K') amount /= 1000;
    return amount;
}

function getCompanyHealth(c) {
    const funding = parseFundingAmount(c.funding);
    const rating = c.rating || 3;

    // Unicorn: $1B+ funding
    if (funding >= 1000) {
        return {
            class: 'unicorn',
            icon: 'ü¶Ñ',
            label: 'Unicorn',
            tooltip: '$1B+ Elite'
        };
    }

    // Hot: $100M-$1B or high rating with decent funding
    if (funding >= 100 || (rating >= 4 && funding >= 50)) {
        return {
            class: 'hot',
            icon: 'üî•',
            label: 'Hot',
            tooltip: 'Strong Momentum'
        };
    }

    // Rising: $10M-$100M or growing
    if (funding >= 10 || rating >= 3) {
        return {
            class: 'warm',
            icon: 'üìà',
            label: 'Rising',
            tooltip: 'Rising Star ($10M-$100M)'
        };
    }

    // Cold: Under $10M or early stage
    return {
        class: 'cold',
        icon: '‚ùÑÔ∏è',
        label: 'Cold',
        tooltip: 'Early Stage'
    };
}

function updateSortButtons() {
    document.getElementById('sort-az').classList.toggle('active', deckSortMode === 'alpha');
    document.getElementById('sort-funding').classList.toggle('active', deckSortMode === 'funding');

    // Update button text with arrow
    document.getElementById('sort-az').textContent = deckSortMode === 'alpha'
        ? (deckSortOrder === 'asc' ? 'A‚ÜíZ' : 'Z‚ÜíA')
        : 'A-Z';
    document.getElementById('sort-funding').textContent = deckSortMode === 'funding'
        ? (deckSortOrder === 'desc' ? '$$$ ‚Üì' : '$$$ ‚Üë')
        : '$$$';
}

// 3-Wheel letter spinner state
const wheelGroups = [
    'ABCDEFGHI'.split(''),  // Wheel 0: A-I
    'JKLMNOPQR'.split(''),  // Wheel 1: J-R
    'STUVWXYZ'.split('')    // Wheel 2: S-Z
];
let wheelIndices = [0, 0, 0]; // Current index for each wheel
let letterCounts = {};

function initLetterWheel() {
    wheelGroups.forEach((letters, wheelIdx) => {
        const slot = document.getElementById(`wheel-slot-${wheelIdx}`);
        slot.innerHTML = `
            <button class="wheel-arrow" onclick="spinWheel(${wheelIdx}, -1)">&#9650;</button>
            <div class="wheel-display">
                <div class="wheel-letters" id="wheel-letters-${wheelIdx}">
                    ${letters.map((letter, i) =>
                        `<span class="wheel-letter" data-wheel="${wheelIdx}" data-index="${i}" onclick="selectWheelLetter(${wheelIdx}, ${i})">${letter}</span>`
                    ).join('')}
                </div>
            </div>
            <button class="wheel-arrow" onclick="spinWheel(${wheelIdx}, 1)">&#9660;</button>
        `;
    });
    updateLetterWheel();
}

function updateLetterCounts() {
    const remaining = deck.slice(index);
    letterCounts = {};
    remaining.forEach(c => {
        const letter = c.name.charAt(0).toUpperCase();
        letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    });
}

function updateLetterWheel() {
    updateLetterCounts();

    wheelGroups.forEach((letters, wheelIdx) => {
        const container = document.getElementById(`wheel-letters-${wheelIdx}`);
        if (!container) return;

        const wheelLetterEls = container.querySelectorAll('.wheel-letter');
        const currentIdx = wheelIndices[wheelIdx];

        wheelLetterEls.forEach((el, i) => {
            const letter = letters[i];
            el.classList.remove('active', 'has-items');
            if (letterCounts[letter] > 0) el.classList.add('has-items');
            if (i === currentIdx) el.classList.add('active');
        });

        // Position wheel - center on current letter
        const letterHeight = 16;
        const offset = -currentIdx * letterHeight + 16; // +16 to center in 48px display
        container.style.transform = `translateY(${offset}px)`;
    });
}

function spinWheel(wheelIdx, direction) {
    const maxIdx = wheelGroups[wheelIdx].length - 1;
    wheelIndices[wheelIdx] = Math.max(0, Math.min(maxIdx, wheelIndices[wheelIdx] + direction));
    updateLetterWheel();
}

function selectWheelLetter(wheelIdx, letterIdx) {
    wheelIndices[wheelIdx] = letterIdx;
    updateLetterWheel();
    const letter = wheelGroups[wheelIdx][letterIdx];
    jumpToLetter(letter);
}

function jumpToLetter(letter) {
    // Sort alphabetically first if not already
    if (deckSortMode !== 'alpha') {
        deckSortMode = 'alpha';
        deckSortOrder = 'asc';
        applyDeckSort();
        updateSortButtons();
    }

    // Find first company starting with this letter
    const targetIndex = deck.findIndex((c, i) => i >= index && c.name.charAt(0).toUpperCase() === letter);
    if (targetIndex !== -1) {
        index = targetIndex;
        renderCards();
        updateUI();
        updateLetterWheel();
    }
}

// ========== RENDER CARDS ==========
function renderCards() {
    const area = document.getElementById('card-area');
    area.innerHTML = '';

    if (index >= deck.length) {
        area.innerHTML = `
            <div class="empty-state">
                <div class="icon">üéâ</div>
                <h3>All Done!</h3>
                <p>You've reviewed all companies in this category.</p>
                <button class="reset-btn" onclick="resetDeck()">Start Over</button>
            </div>
        `;
        return;
    }

    // Render next card (behind)
    if (index + 1 < deck.length) {
        const next = deck[index + 1];
        area.appendChild(createCard(next, false));
    }

    // Render current card (front)
    const current = deck[index];
    const card = createCard(current, true);
    setupSwipeGestures(card);
    setupTapHandler(card, current);
    area.appendChild(card);
}

function createCard(c, isCurrent) {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = c.id;

    if (!isCurrent) {
        card.style.transform = 'scale(0.95) translateY(8px)';
        card.style.opacity = '0.6';
        card.style.zIndex = '1';
    } else {
        card.style.zIndex = '2';
    }

    const stars = '‚òÖ'.repeat(c.rating || 4) + '‚òÜ'.repeat(5 - (c.rating || 4));
    const catLabel = getCategoryLabel(c.category);
    const health = getCompanyHealth(c);

    const logoUrl = c.website ? `https://www.google.com/s2/favicons?domain=${c.website}&sz=128` : null;
    const fallbackInitial = c.name.charAt(0);

    card.innerHTML = `
        <div class="card-overlay pass">PASS</div>
        <div class="card-overlay save">SAVE</div>
        <div class="card-logo-row">
            <div class="card-logo" id="logo-${c.id}">
                ${logoUrl ? `<img src="${logoUrl}" alt="${c.name}">` : `<div class="card-logo-fallback">${fallbackInitial}</div>`}
            </div>
            <div style="flex:1">
                <div class="card-name">${c.name}</div>
                <div class="card-product">${c.product || ''}</div>
            </div>
            <span class="health-badge ${health.class}" data-tooltip="${health.tooltip}">
                <span class="health-icon">${health.icon}</span>${health.label}
            </span>
        </div>
        <div class="card-funding-banner">
            <span class="card-funding-label">Investment Raised</span>
            <span class="card-funding-value">${c.funding || 'N/A'}</span>
        </div>
        ${c.secretSauce ? `<div class="card-secret-sauce">
            <span class="sauce-icon">üî•</span>
            <span class="sauce-text">${c.secretSauce}</span>
        </div>` : ''}
        <div class="card-header">
            <span class="card-rating">${stars}</span>
            <span class="card-category">${catLabel}</span>
        </div>
        <div class="card-stats">
            <div class="stat-box">
                <div class="stat-label">Employees</div>
                <div class="stat-value">${c.employees || 'N/A'}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">HQ</div>
                <div class="stat-value">${c.hq || 'N/A'}</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Founded</div>
                <div class="stat-value">${c.founded || 'N/A'}</div>
            </div>
            ${c.ceo ? `<div class="stat-box">
                <div class="stat-label">CEO</div>
                <div class="stat-value">${c.ceo}</div>
            </div>` : ''}
        </div>
    `;

    return card;
}

function generateAccordion(c) {
    const funding = parseFundingAmount(c.funding);
    const fundingTier = funding > 1000 ? 'mega' : funding > 100 ? 'growth' : 'early';

    // Generate M&A Intelligence based on company data
    const maIntel = [];
    if (funding > 500) maIntel.push('Prime acquisition target for big tech');
    if (funding > 1000) maIntel.push('IPO candidate within 2-3 years');
    if (c.category === 'foundation-models') maIntel.push('Strategic asset for AI capabilities');
    if (c.category === 'ai-infrastructure') maIntel.push('Infrastructure play attractive to cloud providers');
    if (c.category === 'coding-ai') maIntel.push('Developer tools attract enterprise acquirers');
    if (c.employees && c.employees.includes('1,000')) maIntel.push('Scale attracts PE interest');
    if (maIntel.length === 0) maIntel.push('Early-stage, building strategic value');

    // Generate Success Factors
    const successFactors = [];
    if (c.secretSauce) successFactors.push(c.secretSauce.split('+')[0].trim());
    if (c.ceo) successFactors.push(`Experienced leadership (${c.ceo})`);
    if (funding > 100) successFactors.push('Strong funding runway');
    if (c.rating >= 4) successFactors.push('High market momentum');
    if (c.category === 'enterprise-ai') successFactors.push('Enterprise revenue stability');
    if (successFactors.length < 3) successFactors.push('Growing market opportunity');

    // Generate Risks
    const risks = [];
    if (c.category === 'foundation-models') risks.push('Intense competition from OpenAI/Google');
    if (funding < 50) risks.push('Limited runway for scaling');
    if (c.employees && c.employees.includes('50-')) risks.push('Team scaling challenges');
    if (c.category === 'consumer-ai') risks.push('User acquisition costs');
    if (c.category === 'ai-chips') risks.push('Hardware commoditization risk');
    risks.push('Regulatory uncertainty in AI');
    if (risks.length < 3) risks.push('Market timing dependency');

    return `
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>M&A Intelligence</span>
                <span class="accordion-icon">‚ñº</span>
            </div>
            <div class="accordion-content">
                <ul>${maIntel.slice(0, 3).map(i => `<li class="intel">${i}</li>`).join('')}</ul>
            </div>
        </div>
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>Success Factors</span>
                <span class="accordion-icon">‚ñº</span>
            </div>
            <div class="accordion-content">
                <ul>${successFactors.slice(0, 3).map(i => `<li class="success">${i}</li>`).join('')}</ul>
            </div>
        </div>
        <div class="accordion-item" onclick="toggleAccordion(event)">
            <div class="accordion-header">
                <span>Risks</span>
                <span class="accordion-icon">‚ñº</span>
            </div>
            <div class="accordion-content">
                <ul>${risks.slice(0, 3).map(i => `<li class="risk">${i}</li>`).join('')}</ul>
            </div>
        </div>
    `;
}

function toggleAccordion(event) {
    event.stopPropagation();
    const item = event.target.closest('.accordion-item');
    if (item) {
        item.classList.toggle('open');
    }
}

// ========== TAP TO VIEW DETAIL ==========
let tapStartTime = 0;
let tapStartX = 0;
let tapStartY = 0;

function setupTapHandler(card, company) {
    card.addEventListener('touchstart', (e) => {
        tapStartTime = Date.now();
        tapStartX = e.touches[0].clientX;
        tapStartY = e.touches[0].clientY;
    }, { passive: true });

    card.addEventListener('touchend', (e) => {
        const elapsed = Date.now() - tapStartTime;
        const touch = e.changedTouches[0];
        const dx = Math.abs(touch.clientX - tapStartX);
        const dy = Math.abs(touch.clientY - tapStartY);

        // Quick tap with minimal movement = open detail
        if (elapsed < 200 && dx < 10 && dy < 10) {
            openDetail(company);
        }
    });

    card.addEventListener('click', (e) => {
        // For mouse clicks (desktop)
        if (e.detail === 1 && !card.classList.contains('dragging')) {
            setTimeout(() => {
                if (!card.classList.contains('flying')) {
                    openDetail(company);
                }
            }, 150);
        }
    });
}

function openDetail(company) {
    const modal = document.getElementById('detail-modal');
    const content = document.getElementById('detail-content');

    const logoUrl = company.website ? `https://www.google.com/s2/favicons?domain=${company.website}&sz=128` : null;
    const fallbackInitial = company.name.charAt(0);
    const stars = '‚òÖ'.repeat(company.rating || 4) + '‚òÜ'.repeat(5 - (company.rating || 4));
    const catLabel = getCategoryLabel(company.category, true);

    content.innerHTML = `
        <div class="detail-header">
            <button class="detail-close" onclick="closeDetail()">√ó</button>
            <div style="display:flex;align-items:center;gap:16px">
                <div class="card-logo" style="width:70px;height:70px;border-radius:16px">
                    ${logoUrl ? `<img src="${logoUrl}" style="width:56px;height:56px" onerror="this.parentElement.innerHTML='<div class=\\'card-logo-fallback\\' style=\\'width:70px;height:70px;font-size:28px\\'>${fallbackInitial}</div>'" alt="${company.name}">` : `<div class="card-logo-fallback" style="width:70px;height:70px;font-size:28px">${fallbackInitial}</div>`}
                </div>
                <div>
                    <div class="detail-name">${company.name}</div>
                    <div class="detail-product">${company.product || ''}</div>
                </div>
            </div>
        </div>
        <div class="detail-body">
            <div class="detail-section">
                <div class="detail-section-title">Rating</div>
                <div class="detail-rating">${stars}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">Category</div>
                <div class="detail-section-content">${catLabel}</div>
            </div>
            ${company.secretSauce ? `
            <div class="detail-section">
                <div class="detail-section-title">üî• Secret Sauce</div>
                <div class="detail-section-content" style="color:var(--gold-light);font-weight:500">${company.secretSauce}</div>
            </div>
            ` : ''}
            <div class="detail-section">
                <div class="detail-section-title">About</div>
                <div class="detail-section-content">${company.description || 'No description available.'}</div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">Key Metrics</div>
                <div class="detail-grid">
                    <div class="detail-stat">
                        <div class="detail-stat-label">Funding</div>
                        <div class="detail-stat-value highlight">${company.funding || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">Employees</div>
                        <div class="detail-stat-value">${company.employees || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">Founded</div>
                        <div class="detail-stat-value">${company.founded || 'N/A'}</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-label">HQ</div>
                        <div class="detail-stat-value">${company.hq || 'N/A'}</div>
                    </div>
                </div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">Leadership</div>
                <div class="detail-section-content">${company.ceo ? `CEO: ${company.ceo}` : 'Not available'}</div>
            </div>
            <div class="card-accordion" style="margin-top:16px;">
                ${generateAccordion(company)}
            </div>
            <div class="card-links" style="margin-top:16px;">
                ${company.website ? `<a href="https://${company.website}" target="_blank" class="link-circle" title="${company.website}">üåê</a>` : ''}
                <a href="https://linkedin.com/company/${company.name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-')}" target="_blank" class="link-circle" title="LinkedIn">in</a>
            </div>
        </div>
        <div class="detail-actions">
            <button class="detail-btn pass-btn" onclick="closeDetail(); doSwipe('left')">‚úï Pass</button>
            <button class="detail-btn save-btn" onclick="closeDetail(); doSwipe('right')">‚ô• Save</button>
        </div>
    `;

    modal.classList.add('active');
}

function closeDetail() {
    document.getElementById('detail-modal').classList.remove('active');
}

// ========== SWIPE GESTURES ==========
function setupSwipeGestures(card) {
    let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;

    const onStart = (e) => {
        isDragging = true;
        startX = e.touches ? e.touches[0].clientX : e.clientX;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        card.classList.add('dragging');
    };

    const onMove = (e) => {
        if (!isDragging) return;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        currentX = x - startX;
        currentY = y - startY;

        // Check if swiping up (for undo)
        if (currentY < -50 && Math.abs(currentX) < 50) {
            const undoProgress = Math.min(1, Math.abs(currentY) / 150);
            card.style.transform = `translateY(${currentY}px) scale(${1 - undoProgress * 0.1})`;
            card.style.opacity = 1 - undoProgress * 0.3;
            // Show undo overlay
            let undoOverlay = card.querySelector('.card-overlay.undo');
            if (!undoOverlay) {
                undoOverlay = document.createElement('div');
                undoOverlay.className = 'card-overlay undo';
                undoOverlay.innerHTML = '<span>‚Ü© UNDO</span>';
                undoOverlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(100,100,100,0.9);display:flex;align-items:center;justify-content:center;border-radius:20px;opacity:0;transition:opacity 0.2s;z-index:10;';
                undoOverlay.querySelector('span').style.cssText = 'color:#fff;font-size:32px;font-weight:800;';
                card.appendChild(undoOverlay);
            }
            undoOverlay.style.opacity = undoProgress;
        }
        // Check if swiping down (back to list)
        else if (currentY > 50 && Math.abs(currentX) < 50) {
            const backProgress = Math.min(1, currentY / 150);
            card.style.transform = `translateY(${currentY}px) scale(${1 - backProgress * 0.1})`;
            card.style.opacity = 1 - backProgress * 0.3;
            // Show back overlay
            let backOverlay = card.querySelector('.card-overlay.back');
            if (!backOverlay) {
                backOverlay = document.createElement('div');
                backOverlay.className = 'card-overlay back';
                backOverlay.innerHTML = '<span>‚Üê LIST</span>';
                backOverlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,206,209,0.9);display:flex;align-items:center;justify-content:center;border-radius:20px;opacity:0;transition:opacity 0.2s;z-index:10;';
                backOverlay.querySelector('span').style.cssText = 'color:#fff;font-size:32px;font-weight:800;';
                card.appendChild(backOverlay);
            }
            backOverlay.style.opacity = backProgress;
        } else {
            // Normal horizontal swipe
            const rotate = currentX * 0.04;
            card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;
            card.style.opacity = '';

            const passOverlay = card.querySelector('.card-overlay.pass');
            const saveOverlay = card.querySelector('.card-overlay.save');
            const undoOverlay = card.querySelector('.card-overlay.undo');
            const backOverlay = card.querySelector('.card-overlay.back');
            if (undoOverlay) undoOverlay.style.opacity = 0;
            if (backOverlay) backOverlay.style.opacity = 0;

            if (currentX < -40) {
                passOverlay.style.opacity = Math.min(1, Math.abs(currentX) / 120);
                saveOverlay.style.opacity = 0;
            } else if (currentX > 40) {
                saveOverlay.style.opacity = Math.min(1, currentX / 120);
                passOverlay.style.opacity = 0;
            } else {
                passOverlay.style.opacity = 0;
                saveOverlay.style.opacity = 0;
            }
        }
    };

    const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        // Check for swipe up (undo)
        if (currentY < -100 && Math.abs(currentX) < 50) {
            card.style.transition = 'transform 0.3s, opacity 0.3s';
            card.style.transform = '';
            card.style.opacity = '';
            const undoOverlay = card.querySelector('.card-overlay.undo');
            if (undoOverlay) undoOverlay.style.opacity = 0;
            setTimeout(() => card.style.transition = '', 300);
            undoSwipe();
        }
        // Check for swipe down (back to list)
        else if (currentY > 100 && Math.abs(currentX) < 50) {
            card.style.transition = 'transform 0.3s, opacity 0.3s';
            card.style.transform = 'translateY(100vh)';
            card.style.opacity = '0';
            setTimeout(() => {
                exitSwipeMode();
            }, 200);
        } else if (currentX < -100) {
            flyCard('left');
        } else if (currentX > 100) {
            flyCard('right');
        } else {
            card.style.transition = 'transform 0.3s, opacity 0.3s';
            card.style.transform = '';
            card.style.opacity = '';
            card.querySelector('.card-overlay.pass').style.opacity = 0;
            card.querySelector('.card-overlay.save').style.opacity = 0;
            const undoOverlay = card.querySelector('.card-overlay.undo');
            if (undoOverlay) undoOverlay.style.opacity = 0;
            const backOverlay = card.querySelector('.card-overlay.back');
            if (backOverlay) backOverlay.style.opacity = 0;
            setTimeout(() => card.style.transition = '', 300);
        }

        currentX = 0;
        currentY = 0;
    };

    card.addEventListener('touchstart', onStart, { passive: true });
    card.addEventListener('touchmove', onMove, { passive: true });
    card.addEventListener('touchend', onEnd);
    card.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
}

function flyCard(direction) {
    const card = document.querySelector('.card[style*="z-index: 2"]');
    if (!card) return;

    const company = deck[index];
    history.push({ company, direction });

    if (direction === 'right') {
        saved.push(company);
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
    }

    card.classList.add('flying');
    card.style.transform = `translateX(${direction === 'left' ? -150 : 150}vw) rotate(${direction === 'left' ? -30 : 30}deg)`;
    card.style.opacity = '0';

    setTimeout(() => {
        index++;
        renderCards();
        updateUI();
    }, 350);
}

function doSwipe(direction) {
    flyCard(direction);
}

function undoSwipe() {
    if (history.length === 0) return;

    const last = history.pop();
    index--;

    if (last.direction === 'right') {
        saved = saved.filter(c => c.id !== last.company.id);
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
    }

    renderCards();
    updateUI();
}

function resetDeck() {
    buildDeck();
    renderCards();
    updateUI();
}

// ========== SAVED MODAL ==========
function openSaved() {
    renderSavedList();
    document.getElementById('saved-modal').classList.add('active');
}

function closeSaved() {
    document.getElementById('saved-modal').classList.remove('active');
    // Remove alpha index when closing
    const alphaIndex = document.querySelector('.alpha-index');
    if (alphaIndex) alphaIndex.remove();
}

let savedViewMode = 'list'; // 'list', 'grouped', 'alpha', 'funding'
let savedSortOrder = 'asc'; // 'asc' or 'desc'

function parseFunding(funding) {
    if (!funding) return 0;
    const match = funding.match(/\$?([\d.]+)\s*(B|M|K)?/i);
    if (!match) return 0;
    let amount = parseFloat(match[1]);
    const unit = (match[2] || '').toUpperCase();
    if (unit === 'B') amount *= 1000;
    else if (unit === 'K') amount /= 1000;
    return amount;
}

function renderSavedList() {
    const list = document.getElementById('saved-list');
    const footer = document.getElementById('modal-footer');

    // Remove any existing alpha index
    const existingAlpha = document.querySelector('.alpha-index');
    if (existingAlpha) existingAlpha.remove();

    if (saved.length === 0) {
        list.innerHTML = `
            <div class="empty-saved">
                <div class="icon">üíæ</div>
                <p>No saved companies yet.<br>Swipe right to save!</p>
            </div>
        `;
        footer.innerHTML = '';
        return;
    }

    // Calculate analytics
    const categoryCount = {};
    let totalFunding = 0;
    saved.forEach(c => {
        const cat = getCategoryLabel(c.category);
        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        totalFunding += parseFunding(c.funding);
    });
    const sortedCategories = Object.entries(categoryCount).sort((a, b) => b[1] - a[1]);
    const fundingDisplay = totalFunding >= 1000 ? `$${(totalFunding / 1000).toFixed(1)}B` : `$${totalFunding.toFixed(0)}M`;

    // Analytics box
    let html = `
        <div class="analytics-box">
            <div class="analytics-title">Watchlist Analytics</div>
            ${sortedCategories.slice(0, 4).map(([cat, count]) => `
                <div class="analytics-row">
                    <span>${cat}</span>
                    <span class="analytics-value">${count}</span>
                </div>
            `).join('')}
            <div class="analytics-total">${fundingDisplay}+</div>
            <div class="analytics-label">Total Funding Raised</div>
        </div>
    `;

    // View toggle and sort controls
    html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="view-toggle">
                <button class="${savedViewMode === 'list' ? 'active' : ''}" onclick="setViewMode('list')">List</button>
                <button class="${savedViewMode === 'grouped' ? 'active' : ''}" onclick="setViewMode('grouped')">Category</button>
            </div>
            <button type="button" id="clear-all-btn" style="background:rgba(220,38,38,0.1);border:1px solid #dc2626;color:#dc2626;font-size:13px;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600">Clear All</button>
        </div>
        <div class="sort-controls">
            <button class="sort-btn ${savedViewMode === 'alpha' ? 'active' : ''}" onclick="setViewMode('alpha')">
                A-Z <span class="arrow">${savedViewMode === 'alpha' ? (savedSortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}</span>
            </button>
            <button class="sort-btn ${savedViewMode === 'funding' ? 'active' : ''}" onclick="setViewMode('funding')">
                $ Funding <span class="arrow">${savedViewMode === 'funding' ? (savedSortOrder === 'asc' ? '‚Üë' : '‚Üì') : ''}</span>
            </button>
        </div>
    `;

    // Get sorted list based on view mode
    let displayList = [...saved];

    if (savedViewMode === 'alpha') {
        displayList.sort((a, b) => {
            const cmp = a.name.localeCompare(b.name);
            return savedSortOrder === 'asc' ? cmp : -cmp;
        });
    } else if (savedViewMode === 'funding') {
        displayList.sort((a, b) => {
            const cmp = parseFunding(b.funding) - parseFunding(a.funding);
            return savedSortOrder === 'asc' ? -cmp : cmp;
        });
    }

    // Render based on view mode
    if (savedViewMode === 'grouped') {
        const grouped = {};
        saved.forEach(c => {
            const cat = getCategoryLabel(c.category);
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(c);
        });
        Object.entries(grouped).sort((a, b) => b[1].length - a[1].length).forEach(([cat, companies]) => {
            html += `<div class="category-group">
                <div class="category-group-header">${cat} (${companies.length})</div>
                ${companies.map((c, idx) => renderSavedItem(c, idx)).join('')}
            </div>`;
        });
    } else if (savedViewMode === 'alpha') {
        // Group by first letter
        const letters = {};
        displayList.forEach(c => {
            const letter = c.name.charAt(0).toUpperCase();
            if (!letters[letter]) letters[letter] = [];
            letters[letter].push(c);
        });
        const sortedLetters = Object.keys(letters).sort((a, b) =>
            savedSortOrder === 'asc' ? a.localeCompare(b) : b.localeCompare(a)
        );
        sortedLetters.forEach(letter => {
            html += `<div class="letter-header" id="letter-${letter}">${letter}</div>`;
            html += letters[letter].map((c, idx) => renderSavedItem(c, idx)).join('');
        });
        // Add floating A-Z index
        setTimeout(() => addAlphaIndex(sortedLetters), 0);
    } else if (savedViewMode === 'funding') {
        displayList.forEach((c, idx) => {
            html += renderSavedItem(c, idx);
        });
    } else {
        html += saved.map((c, idx) => renderSavedItem(c, idx)).join('');
    }

    list.innerHTML = html;

    // Attach Clear All button listener
    const clearBtn = document.getElementById('clear-all-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (confirm('Clear all saved companies?')) {
                saved = [];
                localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
                updateUI();
                renderSavedList();
            }
        });
    }

    initDragAndDrop();

    // Email gate for sending watchlist
    if (!userEmail) {
        footer.innerHTML = `
            <div class="email-gate">
                <h3>Get Your Watchlist</h3>
                <p>Enter your email to receive your saved companies with all details.</p>
                <input type="email" class="email-input" id="email-input" placeholder="your@email.com">
                <button class="email-submit" onclick="submitEmail()">Send My Watchlist</button>
            </div>
        `;
    } else {
        footer.innerHTML = `
            <p style="color:var(--text-dim);font-size:13px;text-align:center;margin-bottom:12px">Watchlist sent to ${userEmail}</p>
            <button class="export-btn" style="background:var(--gold)" onclick="resendEmail()">Resend Email</button>
        `;
    }
}

function removeSaved(id) {
    saved = saved.filter(c => c.id !== id);
    localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
    updateUI();
    renderSavedList();
}

function clearAllSaved() {
    if (confirm('Clear all saved companies?')) {
        saved = [];
        localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
        updateUI();
        renderSavedList();
    }
}

function renderSavedItem(c, idx) {
    return `
        <div class="saved-item" draggable="true" data-id="${c.id}" data-idx="${idx}">
            <button class="remove-btn" onclick="event.stopPropagation();removeSaved(${c.id})">√ó</button>
            <div class="saved-name">${c.name}</div>
            <div class="saved-info">${c.product || ''} ‚Ä¢ ${c.hq || ''}</div>
            <div class="saved-funding">${c.funding || ''}</div>
        </div>
    `;
}

function setViewMode(mode) {
    // Toggle sort order if clicking same mode
    if (mode === savedViewMode && (mode === 'alpha' || mode === 'funding')) {
        savedSortOrder = savedSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        savedViewMode = mode;
        savedSortOrder = mode === 'funding' ? 'desc' : 'asc'; // Funding defaults to highest first
    }
    renderSavedList();
}

function addAlphaIndex(availableLetters) {
    const modal = document.getElementById('saved-modal');
    if (!modal) return;

    // Remove existing
    const existing = document.querySelector('.alpha-index');
    if (existing) existing.remove();

    const allLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const alphaDiv = document.createElement('div');
    alphaDiv.className = 'alpha-index';

    allLetters.forEach(letter => {
        const span = document.createElement('span');
        span.textContent = letter;
        if (availableLetters.includes(letter)) {
            span.onclick = () => scrollToSavedLetter(letter);
        } else {
            span.className = 'disabled';
        }
        alphaDiv.appendChild(span);
    });

    modal.appendChild(alphaDiv);
}

function scrollToSavedLetter(letter) {
    const el = document.getElementById(`letter-${letter}`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Highlight briefly
        el.style.background = 'var(--gold)';
        el.style.color = 'var(--navy)';
        setTimeout(() => {
            el.style.background = '';
            el.style.color = '';
        }, 500);
    }
}

function initDragAndDrop() {
    const items = document.querySelectorAll('.saved-item[draggable="true"]');
    let draggedItem = null;
    let draggedId = null;

    items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            draggedId = parseInt(item.dataset.id);
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            document.querySelectorAll('.saved-item').forEach(i => i.classList.remove('drag-over'));
            draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (item !== draggedItem) {
                item.classList.add('drag-over');
            }
        });

        item.addEventListener('dragleave', () => {
            item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('drag-over');
            if (item === draggedItem) return;

            const targetId = parseInt(item.dataset.id);
            const fromIdx = saved.findIndex(c => c.id === draggedId);
            const toIdx = saved.findIndex(c => c.id === targetId);

            if (fromIdx !== -1 && toIdx !== -1) {
                const [moved] = saved.splice(fromIdx, 1);
                saved.splice(toIdx, 0, moved);
                localStorage.setItem('ai_tracker_saved', JSON.stringify(saved));
                renderSavedList();
            }
        });
    });
}

// Google Apps Script Web App URL
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznKu5bdmenevru1tWPIreFRzVSC00bbcBb2wPFLHu40QGgsrGO_4jhLXSGTMhJXClu/exec';

async function submitEmail() {
    const email = document.getElementById('email-input').value.trim();
    if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
    }

    // Show loading state
    const submitBtn = document.querySelector('.email-submit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Sending...';
    submitBtn.disabled = true;

    try {
        // Send to Google Apps Script
        if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    companies: saved,
                    timestamp: new Date().toISOString()
                })
            });
        }

        userEmail = email;
        localStorage.setItem('ai_tracker_email', email);

        // Show success message
        alert('Your watchlist has been sent to ' + email + '!');
        renderSavedList();

    } catch (error) {
        console.error('Error sending data:', error);
        // Still save locally even if API fails
        userEmail = email;
        localStorage.setItem('ai_tracker_email', email);
        renderSavedList();
    }

    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
}

async function resendEmail() {
    if (!userEmail || saved.length === 0) return;

    try {
        if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    companies: saved,
                    timestamp: new Date().toISOString()
                })
            });
            alert('Watchlist resent to ' + userEmail + '!');
        } else {
            alert('Apps Script URL not configured');
        }
    } catch (error) {
        console.error('Error resending:', error);
        alert('Error sending email. Please try again.');
    }
}

function exportCSV() {
    if (saved.length === 0) return;

    const headers = ['Name', 'Product', 'Category', 'Funding', 'HQ', 'Employees', 'Website', 'CEO', 'Founded'];
    const rows = saved.map(c => [
        c.name, c.product, c.category, c.funding, c.hq, c.employees, c.website, c.ceo, c.founded
    ]);

    const csv = [headers, ...rows].map(r => r.map(v => `"${v || ''}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai_companies_saved.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// Load companies from master JSON, then init
(async function() {
    try {
        const response = await fetch('companies.json');
        companies = await response.json();
        console.log('[AI Book] Loaded ' + companies.length + ' companies from JSON');
        init();
    } catch (error) {
        console.error('[AI Book] Failed to load companies:', error);
        document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#fff;background:#0a0f1a;min-height:100vh;"><h2>Loading Error</h2><p>Could not load company data. Make sure companies.json is in the same folder.</p></div>';
    }
})();
</script>
</body>
</html>
